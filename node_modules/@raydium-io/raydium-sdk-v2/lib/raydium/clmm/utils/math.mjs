var Zn=Object.defineProperty,jn=Object.defineProperties;var Qn=Object.getOwnPropertyDescriptors;var on=Object.getOwnPropertySymbols;var Jn=Object.prototype.hasOwnProperty,$n=Object.prototype.propertyIsEnumerable;var sn=(r,e,t)=>e in r?Zn(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Y=(r,e)=>{for(var t in e||(e={}))Jn.call(e,t)&&sn(r,t,e[t]);if(on)for(var t of on(e))$n.call(e,t)&&sn(r,t,e[t]);return r},ne=(r,e)=>jn(r,Qn(e));import C from"bn.js";var Ze=9e15,Ke=1e9,Lt="0123456789abcdef",ft="2.3025850929940456840179914546843642076011014886287729760333279009675726096773524802359972050895982983419677840422862486334095254650828067566662873690987816894829072083255546808437998948262331985283935053089653777326288461633662222876982198867465436674744042432743651550489343149393914796194044002221051017141748003688084012647080685567743216228355220114804663715659121373450747856947683463616792101806445070648000277502684916746550586856935673420670581136429224554405758925724208241314695689016758940256776311356919292033376587141660230105703089634572075440370847469940168269282808481184289314848524948644871927809676271275775397027668605952496716674183485704422507197965004714951050492214776567636938662976979522110718264549734772662425709429322582798502585509785265383207606726317164309505995087807523710333101197857547331541421808427543863591778117054309827482385045648019095610299291824318237525357709750539565187697510374970888692180205189339507238539205144634197265287286965110862571492198849978748873771345686209167058",pt="3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632789",Et={precision:20,rounding:4,modulo:1,toExpNeg:-7,toExpPos:21,minE:-Ze,maxE:Ze,crypto:!1},ln,Le,P=!0,ht="[DecimalError] ",ve=ht+"Invalid argument: ",mn=ht+"Precision limit exceeded",dn=ht+"crypto unavailable",fn="[object Decimal]",oe=Math.floor,J=Math.pow,er=/^0b([01]+(\.[01]*)?|\.[01]+)(p[+-]?\d+)?$/i,tr=/^0x([0-9a-f]+(\.[0-9a-f]*)?|\.[0-9a-f]+)(p[+-]?\d+)?$/i,nr=/^0o([0-7]+(\.[0-7]*)?|\.[0-7]+)(p[+-]?\d+)?$/i,pn=/^(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,Ae=1e7,A=7,rr=9007199254740991,ir=ft.length-1,Rt=pt.length-1,p={toStringTag:fn};p.absoluteValue=p.abs=function(){var r=new this.constructor(this);return r.s<0&&(r.s=1),w(r)};p.ceil=function(){return w(new this.constructor(this),this.e+1,2)};p.clampedTo=p.clamp=function(r,e){var t,n=this,i=n.constructor;if(r=new i(r),e=new i(e),!r.s||!e.s)return new i(NaN);if(r.gt(e))throw Error(ve+e);return t=n.cmp(r),t<0?r:n.cmp(e)>0?e:new i(n)};p.comparedTo=p.cmp=function(r){var e,t,n,i,o=this,s=o.d,a=(r=new o.constructor(r)).d,u=o.s,c=r.s;if(!s||!a)return!u||!c?NaN:u!==c?u:s===a?0:!s^u<0?1:-1;if(!s[0]||!a[0])return s[0]?u:a[0]?-c:0;if(u!==c)return u;if(o.e!==r.e)return o.e>r.e^u<0?1:-1;for(n=s.length,i=a.length,e=0,t=n<i?n:i;e<t;++e)if(s[e]!==a[e])return s[e]>a[e]^u<0?1:-1;return n===i?0:n>i^u<0?1:-1};p.cosine=p.cos=function(){var r,e,t=this,n=t.constructor;return t.d?t.d[0]?(r=n.precision,e=n.rounding,n.precision=r+Math.max(t.e,t.sd())+A,n.rounding=1,t=or(n,wn(n,t)),n.precision=r,n.rounding=e,w(Le==2||Le==3?t.neg():t,r,e,!0)):new n(1):new n(NaN)};p.cubeRoot=p.cbrt=function(){var r,e,t,n,i,o,s,a,u,c,l=this,m=l.constructor;if(!l.isFinite()||l.isZero())return new m(l);for(P=!1,o=l.s*J(l.s*l,1/3),!o||Math.abs(o)==1/0?(t=ie(l.d),r=l.e,(o=(r-t.length+1)%3)&&(t+=o==1||o==-2?"0":"00"),o=J(t,1/3),r=oe((r+1)/3)-(r%3==(r<0?-1:2)),o==1/0?t="5e"+r:(t=o.toExponential(),t=t.slice(0,t.indexOf("e")+1)+r),n=new m(t),n.s=l.s):n=new m(o.toString()),s=(r=m.precision)+3;;)if(a=n,u=a.times(a).times(a),c=u.plus(l),n=_(c.plus(l).times(a),c.plus(u),s+2,1),ie(a.d).slice(0,s)===(t=ie(n.d)).slice(0,s))if(t=t.slice(s-3,s+1),t=="9999"||!i&&t=="4999"){if(!i&&(w(a,r+1,0),a.times(a).times(a).eq(l))){n=a;break}s+=4,i=1}else{(!+t||!+t.slice(1)&&t.charAt(0)=="5")&&(w(n,r+1,1),e=!n.times(n).times(n).eq(l));break}return P=!0,w(n,r,m.rounding,e)};p.decimalPlaces=p.dp=function(){var r,e=this.d,t=NaN;if(e){if(r=e.length-1,t=(r-oe(this.e/A))*A,r=e[r],r)for(;r%10==0;r/=10)t--;t<0&&(t=0)}return t};p.dividedBy=p.div=function(r){return _(this,new this.constructor(r))};p.dividedToIntegerBy=p.divToInt=function(r){var e=this,t=e.constructor;return w(_(e,new t(r),0,1,1),t.precision,t.rounding)};p.equals=p.eq=function(r){return this.cmp(r)===0};p.floor=function(){return w(new this.constructor(this),this.e+1,3)};p.greaterThan=p.gt=function(r){return this.cmp(r)>0};p.greaterThanOrEqualTo=p.gte=function(r){var e=this.cmp(r);return e==1||e===0};p.hyperbolicCosine=p.cosh=function(){var r,e,t,n,i,o=this,s=o.constructor,a=new s(1);if(!o.isFinite())return new s(o.s?1/0:NaN);if(o.isZero())return a;t=s.precision,n=s.rounding,s.precision=t+Math.max(o.e,o.sd())+4,s.rounding=1,i=o.d.length,i<32?(r=Math.ceil(i/3),e=(1/yt(4,r)).toString()):(r=16,e="2.3283064365386962890625e-10"),o=je(s,1,o.times(e),new s(1),!0);for(var u,c=r,l=new s(8);c--;)u=o.times(o),o=a.minus(u.times(l.minus(u.times(l))));return w(o,s.precision=t,s.rounding=n,!0)};p.hyperbolicSine=p.sinh=function(){var r,e,t,n,i=this,o=i.constructor;if(!i.isFinite()||i.isZero())return new o(i);if(e=o.precision,t=o.rounding,o.precision=e+Math.max(i.e,i.sd())+4,o.rounding=1,n=i.d.length,n<3)i=je(o,2,i,i,!0);else{r=1.4*Math.sqrt(n),r=r>16?16:r|0,i=i.times(1/yt(5,r)),i=je(o,2,i,i,!0);for(var s,a=new o(5),u=new o(16),c=new o(20);r--;)s=i.times(i),i=i.times(a.plus(s.times(u.times(s).plus(c))))}return o.precision=e,o.rounding=t,w(i,e,t,!0)};p.hyperbolicTangent=p.tanh=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+7,n.rounding=1,_(t.sinh(),t.cosh(),n.precision=r,n.rounding=e)):new n(t.s)};p.inverseCosine=p.acos=function(){var r,e=this,t=e.constructor,n=e.abs().cmp(1),i=t.precision,o=t.rounding;return n!==-1?n===0?e.isNeg()?xe(t,i,o):new t(0):new t(NaN):e.isZero()?xe(t,i+4,o).times(.5):(t.precision=i+6,t.rounding=1,e=e.asin(),r=xe(t,i+4,o).times(.5),t.precision=i,t.rounding=o,r.minus(e))};p.inverseHyperbolicCosine=p.acosh=function(){var r,e,t=this,n=t.constructor;return t.lte(1)?new n(t.eq(1)?0:NaN):t.isFinite()?(r=n.precision,e=n.rounding,n.precision=r+Math.max(Math.abs(t.e),t.sd())+4,n.rounding=1,P=!1,t=t.times(t).minus(1).sqrt().plus(t),P=!0,n.precision=r,n.rounding=e,t.ln()):new n(t)};p.inverseHyperbolicSine=p.asinh=function(){var r,e,t=this,n=t.constructor;return!t.isFinite()||t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+2*Math.max(Math.abs(t.e),t.sd())+6,n.rounding=1,P=!1,t=t.times(t).plus(1).sqrt().plus(t),P=!0,n.precision=r,n.rounding=e,t.ln())};p.inverseHyperbolicTangent=p.atanh=function(){var r,e,t,n,i=this,o=i.constructor;return i.isFinite()?i.e>=0?new o(i.abs().eq(1)?i.s/0:i.isZero()?i:NaN):(r=o.precision,e=o.rounding,n=i.sd(),Math.max(n,r)<2*-i.e-1?w(new o(i),r,e,!0):(o.precision=t=n-i.e,i=_(i.plus(1),new o(1).minus(i),t+r,1),o.precision=r+4,o.rounding=1,i=i.ln(),o.precision=r,o.rounding=e,i.times(.5))):new o(NaN)};p.inverseSine=p.asin=function(){var r,e,t,n,i=this,o=i.constructor;return i.isZero()?new o(i):(e=i.abs().cmp(1),t=o.precision,n=o.rounding,e!==-1?e===0?(r=xe(o,t+4,n).times(.5),r.s=i.s,r):new o(NaN):(o.precision=t+6,o.rounding=1,i=i.div(new o(1).minus(i.times(i)).sqrt().plus(1)).atan(),o.precision=t,o.rounding=n,i.times(2)))};p.inverseTangent=p.atan=function(){var r,e,t,n,i,o,s,a,u,c=this,l=c.constructor,m=l.precision,d=l.rounding;if(c.isFinite()){if(c.isZero())return new l(c);if(c.abs().eq(1)&&m+4<=Rt)return s=xe(l,m+4,d).times(.25),s.s=c.s,s}else{if(!c.s)return new l(NaN);if(m+4<=Rt)return s=xe(l,m+4,d).times(.5),s.s=c.s,s}for(l.precision=a=m+10,l.rounding=1,t=Math.min(28,a/A+2|0),r=t;r;--r)c=c.div(c.times(c).plus(1).sqrt().plus(1));for(P=!1,e=Math.ceil(a/A),n=1,u=c.times(c),s=new l(c),i=c;r!==-1;)if(i=i.times(u),o=s.minus(i.div(n+=2)),i=i.times(u),s=o.plus(i.div(n+=2)),s.d[e]!==void 0)for(r=e;s.d[r]===o.d[r]&&r--;);return t&&(s=s.times(2<<t-1)),P=!0,w(s,l.precision=m,l.rounding=d,!0)};p.isFinite=function(){return!!this.d};p.isInteger=p.isInt=function(){return!!this.d&&oe(this.e/A)>this.d.length-2};p.isNaN=function(){return!this.s};p.isNegative=p.isNeg=function(){return this.s<0};p.isPositive=p.isPos=function(){return this.s>0};p.isZero=function(){return!!this.d&&this.d[0]===0};p.lessThan=p.lt=function(r){return this.cmp(r)<0};p.lessThanOrEqualTo=p.lte=function(r){return this.cmp(r)<1};p.logarithm=p.log=function(r){var e,t,n,i,o,s,a,u,c=this,l=c.constructor,m=l.precision,d=l.rounding,f=5;if(r==null)r=new l(10),e=!0;else{if(r=new l(r),t=r.d,r.s<0||!t||!t[0]||r.eq(1))return new l(NaN);e=r.eq(10)}if(t=c.d,c.s<0||!t||!t[0]||c.eq(1))return new l(t&&!t[0]?-1/0:c.s!=1?NaN:t?0:1/0);if(e)if(t.length>1)o=!0;else{for(i=t[0];i%10===0;)i/=10;o=i!==1}if(P=!1,a=m+f,s=_e(c,a),n=e?gt(l,a+10):_e(r,a),u=_(s,n,a,1),tt(u.d,i=m,d))do if(a+=10,s=_e(c,a),n=e?gt(l,a+10):_e(r,a),u=_(s,n,a,1),!o){+ie(u.d).slice(i+1,i+15)+1==1e14&&(u=w(u,m+1,0));break}while(tt(u.d,i+=10,d));return P=!0,w(u,m,d)};p.minus=p.sub=function(r){var e,t,n,i,o,s,a,u,c,l,m,d,f=this,b=f.constructor;if(r=new b(r),!f.d||!r.d)return!f.s||!r.s?r=new b(NaN):f.d?r.s=-r.s:r=new b(r.d||f.s!==r.s?f:NaN),r;if(f.s!=r.s)return r.s=-r.s,f.plus(r);if(c=f.d,d=r.d,a=b.precision,u=b.rounding,!c[0]||!d[0]){if(d[0])r.s=-r.s;else if(c[0])r=new b(f);else return new b(u===3?-0:0);return P?w(r,a,u):r}if(t=oe(r.e/A),l=oe(f.e/A),c=c.slice(),o=l-t,o){for(m=o<0,m?(e=c,o=-o,s=d.length):(e=d,t=l,s=c.length),n=Math.max(Math.ceil(a/A),s)+2,o>n&&(o=n,e.length=1),e.reverse(),n=o;n--;)e.push(0);e.reverse()}else{for(n=c.length,s=d.length,m=n<s,m&&(s=n),n=0;n<s;n++)if(c[n]!=d[n]){m=c[n]<d[n];break}o=0}for(m&&(e=c,c=d,d=e,r.s=-r.s),s=c.length,n=d.length-s;n>0;--n)c[s++]=0;for(n=d.length;n>o;){if(c[--n]<d[n]){for(i=n;i&&c[--i]===0;)c[i]=Ae-1;--c[i],c[n]+=Ae}c[n]-=d[n]}for(;c[--s]===0;)c.pop();for(;c[0]===0;c.shift())--t;return c[0]?(r.d=c,r.e=bt(c,t),P?w(r,a,u):r):new b(u===3?-0:0)};p.modulo=p.mod=function(r){var e,t=this,n=t.constructor;return r=new n(r),!t.d||!r.s||r.d&&!r.d[0]?new n(NaN):!r.d||t.d&&!t.d[0]?w(new n(t),n.precision,n.rounding):(P=!1,n.modulo==9?(e=_(t,r.abs(),0,3,1),e.s*=r.s):e=_(t,r,0,n.modulo,1),e=e.times(r),P=!0,t.minus(e))};p.naturalExponential=p.exp=function(){return Ft(this)};p.naturalLogarithm=p.ln=function(){return _e(this)};p.negated=p.neg=function(){var r=new this.constructor(this);return r.s=-r.s,w(r)};p.plus=p.add=function(r){var e,t,n,i,o,s,a,u,c,l,m=this,d=m.constructor;if(r=new d(r),!m.d||!r.d)return!m.s||!r.s?r=new d(NaN):m.d||(r=new d(r.d||m.s===r.s?m:NaN)),r;if(m.s!=r.s)return r.s=-r.s,m.minus(r);if(c=m.d,l=r.d,a=d.precision,u=d.rounding,!c[0]||!l[0])return l[0]||(r=new d(m)),P?w(r,a,u):r;if(o=oe(m.e/A),n=oe(r.e/A),c=c.slice(),i=o-n,i){for(i<0?(t=c,i=-i,s=l.length):(t=l,n=o,s=c.length),o=Math.ceil(a/A),s=o>s?o+1:s+1,i>s&&(i=s,t.length=1),t.reverse();i--;)t.push(0);t.reverse()}for(s=c.length,i=l.length,s-i<0&&(i=s,t=l,l=c,c=t),e=0;i;)e=(c[--i]=c[i]+l[i]+e)/Ae|0,c[i]%=Ae;for(e&&(c.unshift(e),++n),s=c.length;c[--s]==0;)c.pop();return r.d=c,r.e=bt(c,n),P?w(r,a,u):r};p.precision=p.sd=function(r){var e,t=this;if(r!==void 0&&r!==!!r&&r!==1&&r!==0)throw Error(ve+r);return t.d?(e=gn(t.d),r&&t.e+1>e&&(e=t.e+1)):e=NaN,e};p.round=function(){var r=this,e=r.constructor;return w(new e(r),r.e+1,e.rounding)};p.sine=p.sin=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+Math.max(t.e,t.sd())+A,n.rounding=1,t=ar(n,wn(n,t)),n.precision=r,n.rounding=e,w(Le>2?t.neg():t,r,e,!0)):new n(NaN)};p.squareRoot=p.sqrt=function(){var r,e,t,n,i,o,s=this,a=s.d,u=s.e,c=s.s,l=s.constructor;if(c!==1||!a||!a[0])return new l(!c||c<0&&(!a||a[0])?NaN:a?s:1/0);for(P=!1,c=Math.sqrt(+s),c==0||c==1/0?(e=ie(a),(e.length+u)%2==0&&(e+="0"),c=Math.sqrt(e),u=oe((u+1)/2)-(u<0||u%2),c==1/0?e="5e"+u:(e=c.toExponential(),e=e.slice(0,e.indexOf("e")+1)+u),n=new l(e)):n=new l(c.toString()),t=(u=l.precision)+3;;)if(o=n,n=o.plus(_(s,o,t+2,1)).times(.5),ie(o.d).slice(0,t)===(e=ie(n.d)).slice(0,t))if(e=e.slice(t-3,t+1),e=="9999"||!i&&e=="4999"){if(!i&&(w(o,u+1,0),o.times(o).eq(s))){n=o;break}t+=4,i=1}else{(!+e||!+e.slice(1)&&e.charAt(0)=="5")&&(w(n,u+1,1),r=!n.times(n).eq(s));break}return P=!0,w(n,u,l.rounding,r)};p.tangent=p.tan=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+10,n.rounding=1,t=t.sin(),t.s=1,t=_(t,new n(1).minus(t.times(t)).sqrt(),r+10,0),n.precision=r,n.rounding=e,w(Le==2||Le==4?t.neg():t,r,e,!0)):new n(NaN)};p.times=p.mul=function(r){var e,t,n,i,o,s,a,u,c,l=this,m=l.constructor,d=l.d,f=(r=new m(r)).d;if(r.s*=l.s,!d||!d[0]||!f||!f[0])return new m(!r.s||d&&!d[0]&&!f||f&&!f[0]&&!d?NaN:!d||!f?r.s/0:r.s*0);for(t=oe(l.e/A)+oe(r.e/A),u=d.length,c=f.length,u<c&&(o=d,d=f,f=o,s=u,u=c,c=s),o=[],s=u+c,n=s;n--;)o.push(0);for(n=c;--n>=0;){for(e=0,i=u+n;i>n;)a=o[i]+f[n]*d[i-n-1]+e,o[i--]=a%Ae|0,e=a/Ae|0;o[i]=(o[i]+e)%Ae|0}for(;!o[--s];)o.pop();return e?++t:o.shift(),r.d=o,r.e=bt(o,t),P?w(r,m.precision,m.rounding):r};p.toBinary=function(r,e){return Dt(this,2,r,e)};p.toDecimalPlaces=p.toDP=function(r,e){var t=this,n=t.constructor;return t=new n(t),r===void 0?t:(me(r,0,Ke),e===void 0?e=n.rounding:me(e,0,8),w(t,r+t.e+1,e))};p.toExponential=function(r,e){var t,n=this,i=n.constructor;return r===void 0?t=Be(n,!0):(me(r,0,Ke),e===void 0?e=i.rounding:me(e,0,8),n=w(new i(n),r+1,e),t=Be(n,!0,r+1)),n.isNeg()&&!n.isZero()?"-"+t:t};p.toFixed=function(r,e){var t,n,i=this,o=i.constructor;return r===void 0?t=Be(i):(me(r,0,Ke),e===void 0?e=o.rounding:me(e,0,8),n=w(new o(i),r+i.e+1,e),t=Be(n,!1,r+n.e+1)),i.isNeg()&&!i.isZero()?"-"+t:t};p.toFraction=function(r){var e,t,n,i,o,s,a,u,c,l,m,d,f=this,b=f.d,g=f.constructor;if(!b)return new g(f);if(c=t=new g(1),n=u=new g(0),e=new g(n),o=e.e=gn(b)-f.e-1,s=o%A,e.d[0]=J(10,s<0?A+s:s),r==null)r=o>0?e:c;else{if(a=new g(r),!a.isInt()||a.lt(c))throw Error(ve+a);r=a.gt(e)?o>0?e:c:a}for(P=!1,a=new g(ie(b)),l=g.precision,g.precision=o=b.length*A*2;m=_(a,e,0,1,1),i=t.plus(m.times(n)),i.cmp(r)!=1;)t=n,n=i,i=c,c=u.plus(m.times(i)),u=i,i=e,e=a.minus(m.times(i)),a=i;return i=_(r.minus(t),n,0,1,1),u=u.plus(i.times(c)),t=t.plus(i.times(n)),u.s=c.s=f.s,d=_(c,n,o,1).minus(f).abs().cmp(_(u,t,o,1).minus(f).abs())<1?[c,n]:[u,t],g.precision=l,P=!0,d};p.toHexadecimal=p.toHex=function(r,e){return Dt(this,16,r,e)};p.toNearest=function(r,e){var t=this,n=t.constructor;if(t=new n(t),r==null){if(!t.d)return t;r=new n(1),e=n.rounding}else{if(r=new n(r),e===void 0?e=n.rounding:me(e,0,8),!t.d)return r.s?t:r;if(!r.d)return r.s&&(r.s=t.s),r}return r.d[0]?(P=!1,t=_(t,r,0,e,1).times(r),P=!0,w(t)):(r.s=t.s,t=r),t};p.toNumber=function(){return+this};p.toOctal=function(r,e){return Dt(this,8,r,e)};p.toPower=p.pow=function(r){var e,t,n,i,o,s,a=this,u=a.constructor,c=+(r=new u(r));if(!a.d||!r.d||!a.d[0]||!r.d[0])return new u(J(+a,c));if(a=new u(a),a.eq(1))return a;if(n=u.precision,o=u.rounding,r.eq(1))return w(a,n,o);if(e=oe(r.e/A),e>=r.d.length-1&&(t=c<0?-c:c)<=rr)return i=hn(u,a,t,n),r.s<0?new u(1).div(i):w(i,n,o);if(s=a.s,s<0){if(e<r.d.length-1)return new u(NaN);if((r.d[e]&1)==0&&(s=1),a.e==0&&a.d[0]==1&&a.d.length==1)return a.s=s,a}return t=J(+a,c),e=t==0||!isFinite(t)?oe(c*(Math.log("0."+ie(a.d))/Math.LN10+a.e+1)):new u(t+"").e,e>u.maxE+1||e<u.minE-1?new u(e>0?s/0:0):(P=!1,u.rounding=a.s=1,t=Math.min(12,(e+"").length),i=Ft(r.times(_e(a,n+t)),n),i.d&&(i=w(i,n+5,1),tt(i.d,n,o)&&(e=n+10,i=w(Ft(r.times(_e(a,e+t)),e),e+5,1),+ie(i.d).slice(n+1,n+15)+1==1e14&&(i=w(i,n+1,0)))),i.s=s,P=!0,u.rounding=o,w(i,n,o))};p.toPrecision=function(r,e){var t,n=this,i=n.constructor;return r===void 0?t=Be(n,n.e<=i.toExpNeg||n.e>=i.toExpPos):(me(r,1,Ke),e===void 0?e=i.rounding:me(e,0,8),n=w(new i(n),r,e),t=Be(n,r<=n.e||n.e<=i.toExpNeg,r)),n.isNeg()&&!n.isZero()?"-"+t:t};p.toSignificantDigits=p.toSD=function(r,e){var t=this,n=t.constructor;return r===void 0?(r=n.precision,e=n.rounding):(me(r,1,Ke),e===void 0?e=n.rounding:me(e,0,8)),w(new n(t),r,e)};p.toString=function(){var r=this,e=r.constructor,t=Be(r,r.e<=e.toExpNeg||r.e>=e.toExpPos);return r.isNeg()&&!r.isZero()?"-"+t:t};p.truncated=p.trunc=function(){return w(new this.constructor(this),this.e+1,1)};p.valueOf=p.toJSON=function(){var r=this,e=r.constructor,t=Be(r,r.e<=e.toExpNeg||r.e>=e.toExpPos);return r.isNeg()?"-"+t:t};function ie(r){var e,t,n,i=r.length-1,o="",s=r[0];if(i>0){for(o+=s,e=1;e<i;e++)n=r[e]+"",t=A-n.length,t&&(o+=Me(t)),o+=n;s=r[e],n=s+"",t=A-n.length,t&&(o+=Me(t))}else if(s===0)return"0";for(;s%10===0;)s/=10;return o+s}function me(r,e,t){if(r!==~~r||r<e||r>t)throw Error(ve+r)}function tt(r,e,t,n){var i,o,s,a;for(o=r[0];o>=10;o/=10)--e;return--e<0?(e+=A,i=0):(i=Math.ceil((e+1)/A),e%=A),o=J(10,A-e),a=r[i]%o|0,n==null?e<3?(e==0?a=a/100|0:e==1&&(a=a/10|0),s=t<4&&a==99999||t>3&&a==49999||a==5e4||a==0):s=(t<4&&a+1==o||t>3&&a+1==o/2)&&(r[i+1]/o/100|0)==J(10,e-2)-1||(a==o/2||a==0)&&(r[i+1]/o/100|0)==0:e<4?(e==0?a=a/1e3|0:e==1?a=a/100|0:e==2&&(a=a/10|0),s=(n||t<4)&&a==9999||!n&&t>3&&a==4999):s=((n||t<4)&&a+1==o||!n&&t>3&&a+1==o/2)&&(r[i+1]/o/1e3|0)==J(10,e-3)-1,s}function dt(r,e,t){for(var n,i=[0],o,s=0,a=r.length;s<a;){for(o=i.length;o--;)i[o]*=e;for(i[0]+=Lt.indexOf(r.charAt(s++)),n=0;n<i.length;n++)i[n]>t-1&&(i[n+1]===void 0&&(i[n+1]=0),i[n+1]+=i[n]/t|0,i[n]%=t)}return i.reverse()}function or(r,e){var t,n,i;if(e.isZero())return e;n=e.d.length,n<32?(t=Math.ceil(n/3),i=(1/yt(4,t)).toString()):(t=16,i="2.3283064365386962890625e-10"),r.precision+=t,e=je(r,1,e.times(i),new r(1));for(var o=t;o--;){var s=e.times(e);e=s.times(s).minus(s).times(8).plus(1)}return r.precision-=t,e}var _=function(){function r(n,i,o){var s,a=0,u=n.length;for(n=n.slice();u--;)s=n[u]*i+a,n[u]=s%o|0,a=s/o|0;return a&&n.unshift(a),n}function e(n,i,o,s){var a,u;if(o!=s)u=o>s?1:-1;else for(a=u=0;a<o;a++)if(n[a]!=i[a]){u=n[a]>i[a]?1:-1;break}return u}function t(n,i,o,s){for(var a=0;o--;)n[o]-=a,a=n[o]<i[o]?1:0,n[o]=a*s+n[o]-i[o];for(;!n[0]&&n.length>1;)n.shift()}return function(n,i,o,s,a,u){var c,l,m,d,f,b,g,h,y,B,T,R,x,q,G,X,te,V,U,Pe,pe=n.constructor,De=n.s==i.s?1:-1,Q=n.d,M=i.d;if(!Q||!Q[0]||!M||!M[0])return new pe(!n.s||!i.s||(Q?M&&Q[0]==M[0]:!M)?NaN:Q&&Q[0]==0||!M?De*0:De/0);for(u?(f=1,l=n.e-i.e):(u=Ae,f=A,l=oe(n.e/f)-oe(i.e/f)),U=M.length,te=Q.length,y=new pe(De),B=y.d=[],m=0;M[m]==(Q[m]||0);m++);if(M[m]>(Q[m]||0)&&l--,o==null?(q=o=pe.precision,s=pe.rounding):a?q=o+(n.e-i.e)+1:q=o,q<0)B.push(1),b=!0;else{if(q=q/f+2|0,m=0,U==1){for(d=0,M=M[0],q++;(m<te||d)&&q--;m++)G=d*u+(Q[m]||0),B[m]=G/M|0,d=G%M|0;b=d||m<te}else{for(d=u/(M[0]+1)|0,d>1&&(M=r(M,d,u),Q=r(Q,d,u),U=M.length,te=Q.length),X=U,T=Q.slice(0,U),R=T.length;R<U;)T[R++]=0;Pe=M.slice(),Pe.unshift(0),V=M[0],M[1]>=u/2&&++V;do d=0,c=e(M,T,U,R),c<0?(x=T[0],U!=R&&(x=x*u+(T[1]||0)),d=x/V|0,d>1?(d>=u&&(d=u-1),g=r(M,d,u),h=g.length,R=T.length,c=e(g,T,h,R),c==1&&(d--,t(g,U<h?Pe:M,h,u))):(d==0&&(c=d=1),g=M.slice()),h=g.length,h<R&&g.unshift(0),t(T,g,R,u),c==-1&&(R=T.length,c=e(M,T,U,R),c<1&&(d++,t(T,U<R?Pe:M,R,u))),R=T.length):c===0&&(d++,T=[0]),B[m++]=d,c&&T[0]?T[R++]=Q[X]||0:(T=[Q[X]],R=1);while((X++<te||T[0]!==void 0)&&q--);b=T[0]!==void 0}B[0]||B.shift()}if(f==1)y.e=l,ln=b;else{for(m=1,d=B[0];d>=10;d/=10)m++;y.e=m+l*f-1,w(y,a?o+y.e+1:o,s,b)}return y}}();function w(r,e,t,n){var i,o,s,a,u,c,l,m,d,f=r.constructor;e:if(e!=null){if(m=r.d,!m)return r;for(i=1,a=m[0];a>=10;a/=10)i++;if(o=e-i,o<0)o+=A,s=e,l=m[d=0],u=l/J(10,i-s-1)%10|0;else if(d=Math.ceil((o+1)/A),a=m.length,d>=a)if(n){for(;a++<=d;)m.push(0);l=u=0,i=1,o%=A,s=o-A+1}else break e;else{for(l=a=m[d],i=1;a>=10;a/=10)i++;o%=A,s=o-A+i,u=s<0?0:l/J(10,i-s-1)%10|0}if(n=n||e<0||m[d+1]!==void 0||(s<0?l:l%J(10,i-s-1)),c=t<4?(u||n)&&(t==0||t==(r.s<0?3:2)):u>5||u==5&&(t==4||n||t==6&&(o>0?s>0?l/J(10,i-s):0:m[d-1])%10&1||t==(r.s<0?8:7)),e<1||!m[0])return m.length=0,c?(e-=r.e+1,m[0]=J(10,(A-e%A)%A),r.e=-e||0):m[0]=r.e=0,r;if(o==0?(m.length=d,a=1,d--):(m.length=d+1,a=J(10,A-o),m[d]=s>0?(l/J(10,i-s)%J(10,s)|0)*a:0),c)for(;;)if(d==0){for(o=1,s=m[0];s>=10;s/=10)o++;for(s=m[0]+=a,a=1;s>=10;s/=10)a++;o!=a&&(r.e++,m[0]==Ae&&(m[0]=1));break}else{if(m[d]+=a,m[d]!=Ae)break;m[d--]=0,a=1}for(o=m.length;m[--o]===0;)m.pop()}return P&&(r.e>f.maxE?(r.d=null,r.e=NaN):r.e<f.minE&&(r.e=0,r.d=[0])),r}function Be(r,e,t){if(!r.isFinite())return yn(r);var n,i=r.e,o=ie(r.d),s=o.length;return e?(t&&(n=t-s)>0?o=o.charAt(0)+"."+o.slice(1)+Me(n):s>1&&(o=o.charAt(0)+"."+o.slice(1)),o=o+(r.e<0?"e":"e+")+r.e):i<0?(o="0."+Me(-i-1)+o,t&&(n=t-s)>0&&(o+=Me(n))):i>=s?(o+=Me(i+1-s),t&&(n=t-i-1)>0&&(o=o+"."+Me(n))):((n=i+1)<s&&(o=o.slice(0,n)+"."+o.slice(n)),t&&(n=t-s)>0&&(i+1===s&&(o+="."),o+=Me(n))),o}function bt(r,e){var t=r[0];for(e*=A;t>=10;t/=10)e++;return e}function gt(r,e,t){if(e>ir)throw P=!0,t&&(r.precision=t),Error(mn);return w(new r(ft),e,1,!0)}function xe(r,e,t){if(e>Rt)throw Error(mn);return w(new r(pt),e,t,!0)}function gn(r){var e=r.length-1,t=e*A+1;if(e=r[e],e){for(;e%10==0;e/=10)t--;for(e=r[0];e>=10;e/=10)t++}return t}function Me(r){for(var e="";r--;)e+="0";return e}function hn(r,e,t,n){var i,o=new r(1),s=Math.ceil(n/A+4);for(P=!1;;){if(t%2&&(o=o.times(e),un(o.d,s)&&(i=!0)),t=oe(t/2),t===0){t=o.d.length-1,i&&o.d[t]===0&&++o.d[t];break}e=e.times(e),un(e.d,s)}return P=!0,o}function an(r){return r.d[r.d.length-1]&1}function bn(r,e,t){for(var n,i=new r(e[0]),o=0;++o<e.length;)if(n=new r(e[o]),n.s)i[t](n)&&(i=n);else{i=n;break}return i}function Ft(r,e){var t,n,i,o,s,a,u,c=0,l=0,m=0,d=r.constructor,f=d.rounding,b=d.precision;if(!r.d||!r.d[0]||r.e>17)return new d(r.d?r.d[0]?r.s<0?0:1/0:1:r.s?r.s<0?0:r:0/0);for(e==null?(P=!1,u=b):u=e,a=new d(.03125);r.e>-2;)r=r.times(a),m+=5;for(n=Math.log(J(2,m))/Math.LN10*2+5|0,u+=n,t=o=s=new d(1),d.precision=u;;){if(o=w(o.times(r),u,1),t=t.times(++l),a=s.plus(_(o,t,u,1)),ie(a.d).slice(0,u)===ie(s.d).slice(0,u)){for(i=m;i--;)s=w(s.times(s),u,1);if(e==null)if(c<3&&tt(s.d,u-n,f,c))d.precision=u+=10,t=o=a=new d(1),l=0,c++;else return w(s,d.precision=b,f,P=!0);else return d.precision=b,s}s=a}}function _e(r,e){var t,n,i,o,s,a,u,c,l,m,d,f=1,b=10,g=r,h=g.d,y=g.constructor,B=y.rounding,T=y.precision;if(g.s<0||!h||!h[0]||!g.e&&h[0]==1&&h.length==1)return new y(h&&!h[0]?-1/0:g.s!=1?NaN:h?0:g);if(e==null?(P=!1,l=T):l=e,y.precision=l+=b,t=ie(h),n=t.charAt(0),Math.abs(o=g.e)<15e14){for(;n<7&&n!=1||n==1&&t.charAt(1)>3;)g=g.times(r),t=ie(g.d),n=t.charAt(0),f++;o=g.e,n>1?(g=new y("0."+t),o++):g=new y(n+"."+t.slice(1))}else return c=gt(y,l+2,T).times(o+""),g=_e(new y(n+"."+t.slice(1)),l-b).plus(c),y.precision=T,e==null?w(g,T,B,P=!0):g;for(m=g,u=s=g=_(g.minus(1),g.plus(1),l,1),d=w(g.times(g),l,1),i=3;;){if(s=w(s.times(d),l,1),c=u.plus(_(s,new y(i),l,1)),ie(c.d).slice(0,l)===ie(u.d).slice(0,l))if(u=u.times(2),o!==0&&(u=u.plus(gt(y,l+2,T).times(o+""))),u=_(u,new y(f),l,1),e==null)if(tt(u.d,l-b,B,a))y.precision=l+=b,c=s=g=_(m.minus(1),m.plus(1),l,1),d=w(g.times(g),l,1),i=a=1;else return w(u,y.precision=T,B,P=!0);else return y.precision=T,u;u=c,i+=2}}function yn(r){return String(r.s*r.s/0)}function Ot(r,e){var t,n,i;for((t=e.indexOf("."))>-1&&(e=e.replace(".","")),(n=e.search(/e/i))>0?(t<0&&(t=n),t+=+e.slice(n+1),e=e.substring(0,n)):t<0&&(t=e.length),n=0;e.charCodeAt(n)===48;n++);for(i=e.length;e.charCodeAt(i-1)===48;--i);if(e=e.slice(n,i),e){if(i-=n,r.e=t=t-n-1,r.d=[],n=(t+1)%A,t<0&&(n+=A),n<i){for(n&&r.d.push(+e.slice(0,n)),i-=A;n<i;)r.d.push(+e.slice(n,n+=A));e=e.slice(n),n=A-e.length}else n-=i;for(;n--;)e+="0";r.d.push(+e),P&&(r.e>r.constructor.maxE?(r.d=null,r.e=NaN):r.e<r.constructor.minE&&(r.e=0,r.d=[0]))}else r.e=0,r.d=[0];return r}function sr(r,e){var t,n,i,o,s,a,u,c,l;if(e.indexOf("_")>-1){if(e=e.replace(/(\d)_(?=\d)/g,"$1"),pn.test(e))return Ot(r,e)}else if(e==="Infinity"||e==="NaN")return+e||(r.s=NaN),r.e=NaN,r.d=null,r;if(tr.test(e))t=16,e=e.toLowerCase();else if(er.test(e))t=2;else if(nr.test(e))t=8;else throw Error(ve+e);for(o=e.search(/p/i),o>0?(u=+e.slice(o+1),e=e.substring(2,o)):e=e.slice(2),o=e.indexOf("."),s=o>=0,n=r.constructor,s&&(e=e.replace(".",""),a=e.length,o=a-o,i=hn(n,new n(t),o,o*2)),c=dt(e,t,Ae),l=c.length-1,o=l;c[o]===0;--o)c.pop();return o<0?new n(r.s*0):(r.e=bt(c,l),r.d=c,P=!1,s&&(r=_(r,i,a*4)),u&&(r=r.times(Math.abs(u)<54?J(2,u):nt.pow(2,u))),P=!0,r)}function ar(r,e){var t,n=e.d.length;if(n<3)return e.isZero()?e:je(r,2,e,e);t=1.4*Math.sqrt(n),t=t>16?16:t|0,e=e.times(1/yt(5,t)),e=je(r,2,e,e);for(var i,o=new r(5),s=new r(16),a=new r(20);t--;)i=e.times(e),e=e.times(o.plus(i.times(s.times(i).minus(a))));return e}function je(r,e,t,n,i){var o,s,a,u,c=1,l=r.precision,m=Math.ceil(l/A);for(P=!1,u=t.times(t),a=new r(n);;){if(s=_(a.times(u),new r(e++*e++),l,1),a=i?n.plus(s):n.minus(s),n=_(s.times(u),new r(e++*e++),l,1),s=a.plus(n),s.d[m]!==void 0){for(o=m;s.d[o]===a.d[o]&&o--;);if(o==-1)break}o=a,a=n,n=s,s=o,c++}return P=!0,s.d.length=m+1,s}function yt(r,e){for(var t=r;--e;)t*=r;return t}function wn(r,e){var t,n=e.s<0,i=xe(r,r.precision,1),o=i.times(.5);if(e=e.abs(),e.lte(o))return Le=n?4:1,e;if(t=e.divToInt(i),t.isZero())Le=n?3:2;else{if(e=e.minus(t.times(i)),e.lte(o))return Le=an(t)?n?2:3:n?4:1,e;Le=an(t)?n?1:4:n?3:2}return e.minus(i).abs()}function Dt(r,e,t,n){var i,o,s,a,u,c,l,m,d,f=r.constructor,b=t!==void 0;if(b?(me(t,1,Ke),n===void 0?n=f.rounding:me(n,0,8)):(t=f.precision,n=f.rounding),!r.isFinite())l=yn(r);else{for(l=Be(r),s=l.indexOf("."),b?(i=2,e==16?t=t*4-3:e==8&&(t=t*3-2)):i=e,s>=0&&(l=l.replace(".",""),d=new f(1),d.e=l.length-s,d.d=dt(Be(d),10,i),d.e=d.d.length),m=dt(l,10,i),o=u=m.length;m[--u]==0;)m.pop();if(!m[0])l=b?"0p+0":"0";else{if(s<0?o--:(r=new f(r),r.d=m,r.e=o,r=_(r,d,t,n,0,i),m=r.d,o=r.e,c=ln),s=m[t],a=i/2,c=c||m[t+1]!==void 0,c=n<4?(s!==void 0||c)&&(n===0||n===(r.s<0?3:2)):s>a||s===a&&(n===4||c||n===6&&m[t-1]&1||n===(r.s<0?8:7)),m.length=t,c)for(;++m[--t]>i-1;)m[t]=0,t||(++o,m.unshift(1));for(u=m.length;!m[u-1];--u);for(s=0,l="";s<u;s++)l+=Lt.charAt(m[s]);if(b){if(u>1)if(e==16||e==8){for(s=e==16?4:3,--u;u%s;u++)l+="0";for(m=dt(l,i,e),u=m.length;!m[u-1];--u);for(s=1,l="1.";s<u;s++)l+=Lt.charAt(m[s])}else l=l.charAt(0)+"."+l.slice(1);l=l+(o<0?"p":"p+")+o}else if(o<0){for(;++o;)l="0"+l;l="0."+l}else if(++o>u)for(o-=u;o--;)l+="0";else o<u&&(l=l.slice(0,o)+"."+l.slice(o))}l=(e==16?"0x":e==2?"0b":e==8?"0o":"")+l}return r.s<0?"-"+l:l}function un(r,e){if(r.length>e)return r.length=e,!0}function ur(r){return new this(r).abs()}function cr(r){return new this(r).acos()}function lr(r){return new this(r).acosh()}function mr(r,e){return new this(r).plus(e)}function dr(r){return new this(r).asin()}function fr(r){return new this(r).asinh()}function pr(r){return new this(r).atan()}function gr(r){return new this(r).atanh()}function hr(r,e){r=new this(r),e=new this(e);var t,n=this.precision,i=this.rounding,o=n+4;return!r.s||!e.s?t=new this(NaN):!r.d&&!e.d?(t=xe(this,o,1).times(e.s>0?.25:.75),t.s=r.s):!e.d||r.isZero()?(t=e.s<0?xe(this,n,i):new this(0),t.s=r.s):!r.d||e.isZero()?(t=xe(this,o,1).times(.5),t.s=r.s):e.s<0?(this.precision=o,this.rounding=1,t=this.atan(_(r,e,o,1)),e=xe(this,o,1),this.precision=n,this.rounding=i,t=r.s<0?t.minus(e):t.plus(e)):t=this.atan(_(r,e,o,1)),t}function br(r){return new this(r).cbrt()}function yr(r){return w(r=new this(r),r.e+1,2)}function wr(r,e,t){return new this(r).clamp(e,t)}function Tr(r){if(!r||typeof r!="object")throw Error(ht+"Object expected");var e,t,n,i=r.defaults===!0,o=["precision",1,Ke,"rounding",0,8,"toExpNeg",-Ze,0,"toExpPos",0,Ze,"maxE",0,Ze,"minE",-Ze,0,"modulo",0,9];for(e=0;e<o.length;e+=3)if(t=o[e],i&&(this[t]=Et[t]),(n=r[t])!==void 0)if(oe(n)===n&&n>=o[e+1]&&n<=o[e+2])this[t]=n;else throw Error(ve+t+": "+n);if(t="crypto",i&&(this[t]=Et[t]),(n=r[t])!==void 0)if(n===!0||n===!1||n===0||n===1)if(n)if(typeof crypto<"u"&&crypto&&(crypto.getRandomValues||crypto.randomBytes))this[t]=!0;else throw Error(dn);else this[t]=!1;else throw Error(ve+t+": "+n);return this}function xr(r){return new this(r).cos()}function Ar(r){return new this(r).cosh()}function Tn(r){var e,t,n;function i(o){var s,a,u,c=this;if(!(c instanceof i))return new i(o);if(c.constructor=i,cn(o)){c.s=o.s,P?!o.d||o.e>i.maxE?(c.e=NaN,c.d=null):o.e<i.minE?(c.e=0,c.d=[0]):(c.e=o.e,c.d=o.d.slice()):(c.e=o.e,c.d=o.d?o.d.slice():o.d);return}if(u=typeof o,u==="number"){if(o===0){c.s=1/o<0?-1:1,c.e=0,c.d=[0];return}if(o<0?(o=-o,c.s=-1):c.s=1,o===~~o&&o<1e7){for(s=0,a=o;a>=10;a/=10)s++;P?s>i.maxE?(c.e=NaN,c.d=null):s<i.minE?(c.e=0,c.d=[0]):(c.e=s,c.d=[o]):(c.e=s,c.d=[o]);return}else if(o*0!==0){o||(c.s=NaN),c.e=NaN,c.d=null;return}return Ot(c,o.toString())}else if(u!=="string")throw Error(ve+o);return(a=o.charCodeAt(0))===45?(o=o.slice(1),c.s=-1):(a===43&&(o=o.slice(1)),c.s=1),pn.test(o)?Ot(c,o):sr(c,o)}if(i.prototype=p,i.ROUND_UP=0,i.ROUND_DOWN=1,i.ROUND_CEIL=2,i.ROUND_FLOOR=3,i.ROUND_HALF_UP=4,i.ROUND_HALF_DOWN=5,i.ROUND_HALF_EVEN=6,i.ROUND_HALF_CEIL=7,i.ROUND_HALF_FLOOR=8,i.EUCLID=9,i.config=i.set=Tr,i.clone=Tn,i.isDecimal=cn,i.abs=ur,i.acos=cr,i.acosh=lr,i.add=mr,i.asin=dr,i.asinh=fr,i.atan=pr,i.atanh=gr,i.atan2=hr,i.cbrt=br,i.ceil=yr,i.clamp=wr,i.cos=xr,i.cosh=Ar,i.div=kr,i.exp=Pr,i.floor=Br,i.hypot=Ir,i.ln=Nr,i.log=Sr,i.log10=Lr,i.log2=Cr,i.max=Er,i.min=Rr,i.mod=Fr,i.mul=Or,i.pow=Dr,i.random=Mr,i.round=_r,i.sign=vr,i.sin=Kr,i.sinh=qr,i.sqrt=Gr,i.sub=Vr,i.sum=Ur,i.tan=Wr,i.tanh=Xr,i.trunc=zr,r===void 0&&(r={}),r&&r.defaults!==!0)for(n=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"],e=0;e<n.length;)r.hasOwnProperty(t=n[e++])||(r[t]=this[t]);return i.config(r),i}function kr(r,e){return new this(r).div(e)}function Pr(r){return new this(r).exp()}function Br(r){return w(r=new this(r),r.e+1,3)}function Ir(){var r,e,t=new this(0);for(P=!1,r=0;r<arguments.length;)if(e=new this(arguments[r++]),e.d)t.d&&(t=t.plus(e.times(e)));else{if(e.s)return P=!0,new this(1/0);t=e}return P=!0,t.sqrt()}function cn(r){return r instanceof nt||r&&r.toStringTag===fn||!1}function Nr(r){return new this(r).ln()}function Sr(r,e){return new this(r).log(e)}function Cr(r){return new this(r).log(2)}function Lr(r){return new this(r).log(10)}function Er(){return bn(this,arguments,"lt")}function Rr(){return bn(this,arguments,"gt")}function Fr(r,e){return new this(r).mod(e)}function Or(r,e){return new this(r).mul(e)}function Dr(r,e){return new this(r).pow(e)}function Mr(r){var e,t,n,i,o=0,s=new this(1),a=[];if(r===void 0?r=this.precision:me(r,1,Ke),n=Math.ceil(r/A),this.crypto)if(crypto.getRandomValues)for(e=crypto.getRandomValues(new Uint32Array(n));o<n;)i=e[o],i>=429e7?e[o]=crypto.getRandomValues(new Uint32Array(1))[0]:a[o++]=i%1e7;else if(crypto.randomBytes){for(e=crypto.randomBytes(n*=4);o<n;)i=e[o]+(e[o+1]<<8)+(e[o+2]<<16)+((e[o+3]&127)<<24),i>=214e7?crypto.randomBytes(4).copy(e,o):(a.push(i%1e7),o+=4);o=n/4}else throw Error(dn);else for(;o<n;)a[o++]=Math.random()*1e7|0;for(n=a[--o],r%=A,n&&r&&(i=J(10,A-r),a[o]=(n/i|0)*i);a[o]===0;o--)a.pop();if(o<0)t=0,a=[0];else{for(t=-1;a[0]===0;t-=A)a.shift();for(n=1,i=a[0];i>=10;i/=10)n++;n<A&&(t-=A-n)}return s.e=t,s.d=a,s}function _r(r){return w(r=new this(r),r.e+1,this.rounding)}function vr(r){return r=new this(r),r.d?r.d[0]?r.s:0*r.s:r.s||NaN}function Kr(r){return new this(r).sin()}function qr(r){return new this(r).sinh()}function Gr(r){return new this(r).sqrt()}function Vr(r,e){return new this(r).sub(e)}function Ur(){var r=0,e=arguments,t=new this(e[r]);for(P=!1;t.s&&++r<e.length;)t=t.plus(e[r]);return P=!0,w(t,this.precision,this.rounding)}function Wr(r){return new this(r).tan()}function Xr(r){return new this(r).tanh()}function zr(r){return w(r=new this(r),r.e+1,1)}p[Symbol.for("nodejs.util.inspect.custom")]=p.toString;p[Symbol.toStringTag]="Decimal";var nt=p.constructor=Tn(Et);ft=new nt(ft);pt=new nt(pt);var k=nt;import Ie from"bn.js";var Z=new Ie(0),Ne=new Ie(1),Ee=new Ie(-1),ge=new Ie(1).shln(64),wt=new Ie(1).shln(128),Mt=ge.sub(Ne),rt=64,xn=wt.subn(1),se=-443636,ce=-se,Qe=new Ie("4295048016"),Je=new Ie("79226673521066979257578248091"),An=16,kn="59543866431248",Pn="184467440737095516",Bn="15793534762490258745",Tt=new Ie(10).pow(new Ie(6));var Gi=new Ie("18446744073700000000");import{get as In,set as Hr}from"lodash";import Sn from"dayjs";import Yr from"dayjs/plugin/utc";Sn.extend(Yr);var _t=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Sn().utc().format("YYYY/MM/DD HH:mm:ss UTC")}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},Nn={},Zr={};function he(r){let e=In(Nn,r);if(!e){let t=In(Zr,r);e=new _t({name:r,logLevel:t}),Hr(Nn,r,e)}return e}import{PublicKey as _s}from"@solana/web3.js";import Ks from"bn.js";import mi from"big.js";import It from"bn.js";import de from"bn.js";import{PublicKey as Gt}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as jr}from"@solana/spl-token";import{PublicKey as W,SystemProgram as Qr,SYSVAR_RENT_PUBKEY as Jr}from"@solana/web3.js";function vt({pubkey:r,isSigner:e=!1,isWritable:t=!0}){return{pubkey:r,isWritable:t,isSigner:e}}var ji=[vt({pubkey:jr,isWritable:!1}),vt({pubkey:Qr.programId,isWritable:!1}),vt({pubkey:Jr,isWritable:!1})];function Kt({publicKey:r,transformSol:e}){let t=Cn(r.toString());if(t instanceof W)return e&&t.equals(Ge)?xt:t;if(e&&t.toString()===Ge.toBase58())return xt;if(typeof t=="string"){if(t===W.default.toBase58())return W.default;try{return new W(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function Cn(r){try{return new W(r)}catch{return r}}var Qi=new W("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),Ji=new W("SysvarRent111111111111111111111111111111111"),$i=new W("SysvarC1ock11111111111111111111111111111111"),$r=new W("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),eo=new W("Sysvar1nstructions1111111111111111111111111"),to=new W("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),no=new W("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),ro=new W("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),io=new W("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),oo=new W("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),so=new W("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),ao=new W("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),uo=new W("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),co=new W("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),lo=new W("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),mo=new W("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),xt=new W("So11111111111111111111111111111111111111112"),Ge=W.default;function qt(r){return Kt({publicKey:r,transformSol:!0})}import{PublicKey as ei}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Ln}from"@solana/spl-token";var At={chainId:101,address:ei.default.toBase58(),programId:Ln.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},Ve={chainId:101,address:"So11111111111111111111111111111111111111112",programId:Ln.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};var Vt=class{constructor({mint:e,decimals:t,symbol:n,name:i,skipMint:o=!1,isToken2022:s=!1}){if(e===Ge.toBase58()||e instanceof Gt&&Ge.equals(e)){this.decimals=Ve.decimals,this.symbol=Ve.symbol,this.name=Ve.name,this.mint=new Gt(Ve.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=i||e.toString().substring(0,6),this.mint=o?Gt.default:Kt({publicKey:e}),this.isToken2022=s}equals(e){return this===e?!0:this.mint.equals(e.mint)}},Re=Vt;Re.WSOL=new Vt(ne(Y({},Ve),{mint:Ve.address}));import Pt from"big.js";import ri from"bn.js";import ii from"decimal.js-light";import ti from"toformat";var ni=ti,it=ni;var kt=he("module/fraction"),Ut=it(Pt),ot=it(ii),oi={[0]:ot.ROUND_DOWN,[1]:ot.ROUND_HALF_UP,[2]:ot.ROUND_UP},si={[0]:Pt.roundDown,[1]:Pt.roundHalfUp,[2]:Pt.roundUp},D=class{constructor(e,t=new ri(1)){this.numerator=ye(e),this.denominator=ye(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new D(this.denominator,this.numerator)}add(e){let t=e instanceof D?e:new D(ye(e));return this.denominator.eq(t.denominator)?new D(this.numerator.add(t.numerator),this.denominator):new D(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof D?e:new D(ye(e));return this.denominator.eq(t.denominator)?new D(this.numerator.sub(t.numerator),this.denominator):new D(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof D?e:new D(ye(e));return new D(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof D?e:new D(ye(e));return new D(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||kt.logWithError(`${e} is not an integer.`),e<=0&&kt.logWithError(`${e} is not positive.`),ot.set({precision:e+1,rounding:oi[n]});let i=new ot(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return i.toFormat(i.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||kt.logWithError(`${e} is not an integer.`),e<0&&kt.logWithError(`${e} is negative.`),Ut.DP=e,Ut.RM=si[n]||1,new Ut(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var ui=he("Raydium_price"),ke=class extends D{constructor(t){let{baseToken:n,quoteToken:i,numerator:o,denominator:s}=t;super(o,s);this.baseToken=n,this.quoteToken=i,this.scalar=new D(Wt(n.decimals),Wt(i.decimals))}get raw(){return new D(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new ke({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&ui.logWithError("mul token not equals");let n=super.mul(t);return new ke({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:n.denominator,numerator:n.numerator})}toSignificant(t=this.quoteToken.decimals,n,i){return this.adjusted.toSignificant(t,n,i)}toFixed(t=this.quoteToken.decimals,n,i){return this.adjusted.toFixed(t,n,i)}};var Xt=class{constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},Bt=Xt;Bt.SOL=new Xt(At);import ci from"bn.js";var En=new D(new ci(100)),Ue=class extends D{toSignificant(e=5,t,n){return this.mul(En).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(En).toFixed(e,t,n)}};var li=new de(0),us=new de(1),cs=new de(2),ls=new de(3),ms=new de(5),zt=new de(10),ds=new de(100),fs=new de(1e3),ps=new de(1e4),Rn=9007199254740991;function ye(r){let e=he("Raydium_parseBigNumberish");if(r instanceof de)return r;if(typeof r=="string"){if(r.match(/^-?[0-9]+$/))return new de(r);e.logWithError(`invalid BigNumberish string: ${r}`)}return typeof r=="number"?(r%1&&e.logWithError(`BigNumberish number underflow: ${r}`),(r>=Rn||r<=-Rn)&&e.logWithError(`BigNumberish number overflow: ${r}`),new de(String(r))):typeof r=="bigint"?new de(r.toString()):(e.error(`invalid BigNumberish value: ${r}`),new de(0))}function Wt(r){return zt.pow(ye(r))}var di=he("Raydium_amount"),Fn=it(mi);function fi(r,e){let t="0",n="0";if(r.includes(".")){let i=r.split(".");i.length===2?([t,n]=i,n=n.padEnd(e,"0")):di.logWithError(`invalid number string, num: ${r}`)}else t=r;return[t,n.slice(0,e)||n]}var ae=class extends D{constructor(t,n,i=!0,o){let s=new It(0),a=zt.pow(new It(t.decimals));if(i)s=ye(n);else{let u=new It(0),c=new It(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[l,m]=fi(n.toString(),t.decimals);u=ye(l),c=ye(m)}u=u.mul(a),s=u.add(c)}super(s,a);this.logger=he(o||"TokenAmount"),this.token=t}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(t){return this.token.equals(t.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(t.raw)}lt(t){return this.token.equals(t.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(t.raw)}add(t){return this.token.equals(t.token)||this.logger.logWithError("add token not equals"),new ae(this.token,this.raw.add(t.raw))}subtract(t){return this.token.equals(t.token)||this.logger.logWithError("sub token not equals"),new ae(this.token,this.raw.sub(t.raw))}toSignificant(t=this.token.decimals,n,i=0){return super.toSignificant(t,n,i)}toFixed(t=this.token.decimals,n,i=0){return t>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(t,n,i)}toExact(t={groupSeparator:""}){return Fn.DP=this.token.decimals,new Fn(this.numerator.toString()).div(this.denominator.toString()).toFormat(t)}};import{PublicKey as Ea,sendAndConfirmTransaction as Ra,Transaction as Oa,TransactionMessage as Ma,VersionedTransaction as _a}from"@solana/web3.js";import Ka from"axios";import{PublicKey as pi,ComputeBudgetProgram as Hs,Transaction as Zs,TransactionMessage as Qs,Keypair as Js,VersionedTransaction as ea}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as na}from"@solana/spl-token";var oa=he("Raydium_txUtil");function Nt(r,e){let[t,n]=pi.findProgramAddressSync(r,e);return{publicKey:t,nonce:n}}import{PublicKey as hi,AddressLookupTableAccount as On}from"@solana/web3.js";import{PublicKey as gi}from"@solana/web3.js";import{getTransferFeeConfig as da,unpackMint as fa}from"@solana/spl-token";var Ht=he("Raydium_accountInfo_util");async function We(r,e,t){let{batchRequest:n,commitment:i="confirmed"}=Y({batchRequest:!1},t),o=Yt(e,100),s=new Array(o.length).fill([]);if(n){let a=o.map(l=>{let m=r._buildArgs([l.map(d=>d.toBase58())],i,"base64");return{methodName:"getMultipleAccounts",args:m}}),u=Yt(a,10);s=(await(await Promise.all(u.map(async l=>await r._rpcBatchRequest(l)))).flat()).map(l=>(l.error&&Ht.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${l.error.message}`),l.result.value.map(m=>{if(m){let{data:d,executable:f,lamports:b,owner:g,rentEpoch:h}=m;return d.length!==2&&d[1]!=="base64"&&Ht.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(d[0],"base64"),executable:f,lamports:b,owner:new gi(g),rentEpoch:h}}return null})))}else try{s=await Promise.all(o.map(a=>r.getMultipleAccountsInfo(a,i)))}catch(a){a instanceof Error&&Ht.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${a.message}`)}return s.flat()}async function Zt(r,e,t){let n=await We(r,e.map(i=>i.pubkey),t);return e.map((i,o)=>ne(Y({},i),{accountInfo:n[o]}))}var bi={"2immgwYNHBbyVQKVGCEkgWpi53bLwWNRMB5G2nbgYV17":new On({key:new hi("2immgwYNHBbyVQKVGCEkgWpi53bLwWNRMB5G2nbgYV17"),state:On.deserialize(Buffer.from("AQAAAP//////////d49+DAAAAAAAAQZMWvw7GUNJdaccNBVnb57OKakxL2BHLYvhRwVILRsgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMGRm/lIRcy/+ytunLDm+e8jOW7xfcSayxDmzpAAAAABt324ddloZPZy+FGzut5rBy0he1fWzeROoz1hX7/AKkG3fbh7nWP3hhCXbzkbM3athr8TYO5DSf+vfko2KGL/AVKU1D4XciC1hSlVnJ4iilt3x6rq9CmBniISTL07vagBqfVFxksXFEhjMlMPUrxf1ja7gibof1E49vZigAAAAAGp9UXGMd0yShWY5hpHV62i164o5tLbVxzVVshAAAAAIyXJY9OJInxuz0QKRSODYMLWhOZ2v8QhASOe9jb6fhZC3BlsePRfEU4nVJ/awTDzVi4bHMaoP21SbbRvAP4KUbIScv+6Yw2LHF/6K0ZjUPibbSWXCirYPGuuVl7zT789IUPLW4CpHr4JNCatp3ELXDLKMv6JJ+37le50lbBJ2LvDQdRqCgtphMF/imcN7mY5YRx2xE1A3MQ+L4QRaYK9u4GRfZP3LsAd00a+IkCpA22UNQMKdq5BFbJuwuOLqc8zxCTDlqxBG8J0HcxtfogQHDK06ukzfaXiNDKAob1MqBHS9lJxDYCwz8gd5DtFqNSTKG5l1zxIaKpDP/sffi2is1H9aKveyXSu5StXElYRl9SD5As0DHE4N0GLnf84/siiKXVyp4Ez121kLcUui/jLLFZEz/BwZK3Ilf9B9OcsEAeDMKAy2vjGSxQODgBz0QwGA+eP4ZjIjrIAQaXENv31QfLlOdXSRCkaybRniDHF4C8YcwhcvsqrOVuTP4B2Na+9wLdtrB31uz2rtlFI5kahdsnp/d1SrASDInYCtTYtdoke4kX+hoKWcEWM4Tle8pTUkUVv4BxS6fje/EzKBE4Qu9N9LMnrw/JNO0hqMVB4rk/2ou4AB1loQ7FZoPwut2o4KZB+0p9xnbrQKw038qjpHar+PyDwvxBRcu5hpHw3dguezeWv+IwvgW5icu8EGkhGa9AkFPPJT7VMSFb8xowveU=","base64"))})};function Yt(r,e=1,t=[]){let n=[...r];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}import{PublicKey as fe}from"@solana/web3.js";var Za=new fe("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),ja=new fe("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),Qa=new fe("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),Ja=new fe("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),$a=new fe("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),eu=new fe("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),tu=new fe("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),nu=new fe("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),ru=new fe("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),iu=new fe("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),ou=new fe("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),su=new fe("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),au=new fe("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),uu=new fe("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi");import{PublicKey as mu}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as pu}from"@solana/spl-token";import j from"bn.js";var Se=1e4;function St(r,e,t,n){if(e===void 0)return{amount:r,fee:void 0,expirationTime:void 0};let i=t.epoch<e.newerTransferFee.epoch?e.olderTransferFee:e.newerTransferFee,o=new j(i.maximumFee.toString()),s=t.epoch<e.newerTransferFee.epoch?(Number(e.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(i.transferFeeBasisPoints===Se){let a=new j(i.maximumFee.toString());return{amount:r.add(a),fee:a,expirationTime:s}}else{let a=$e(r.mul(new j(Se)),new j(Se-i.transferFeeBasisPoints)),u=new j(i.maximumFee.toString()),c=a.sub(r).gt(u)?r.add(u):a,l=$e(c.mul(new j(i.transferFeeBasisPoints)),new j(Se)),m=l.gt(o)?o:l;return{amount:c,fee:m,expirationTime:s}}else{let a=$e(r.mul(new j(i.transferFeeBasisPoints)),new j(Se)),u=a.gt(o)?o:a;return{amount:r,fee:u,expirationTime:s}}}function ue(r,e,t,n){if(e===void 0)return{amount:r,fee:void 0,expirationTime:void 0};let i=ne(Y({},e),{olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}}),o=t.epoch<i.newerTransferFee.epoch?i.olderTransferFee:i.newerTransferFee,s=new j(o.maximumFee.toString()),a=t.epoch<i.newerTransferFee.epoch?(Number(i.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(o.transferFeeBasisPoints===Se){let u=new j(o.maximumFee.toString());return{amount:r.add(u),fee:u,expirationTime:a}}else{let u=$e(r.mul(new j(Se)),new j(Se-o.transferFeeBasisPoints)),c=new j(o.maximumFee.toString()),l=u.sub(r).gt(c)?r.add(c):u,m=$e(l.mul(new j(o.transferFeeBasisPoints)),new j(Se)),d=m.gt(s)?s:m;return{amount:l,fee:d,expirationTime:a}}else{let u=$e(r.mul(new j(o.transferFeeBasisPoints)),new j(Se)),c=u.gt(s)?s:u;return{amount:r,fee:c,expirationTime:a}}}function Xe(r,e){return r===void 0?e:e===void 0?r:Math.min(r,e)}function $e(r,e){let{div:t,mod:n}=r.divmod(e);return n.gt(new j(0))?t.add(new j(1)):t}function Dn(r){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,r,!1),new Uint8Array(e)}function jt(r,e){let t=0;for(let n=r-1;n>=0&&!e.testn(n);n--)t++;return t}function Qt(r,e){let t=0;for(let n=0;n<r&&!e.testn(n);n++)t++;return t}function st(r,e){for(let t=0;t<r;t++)if(e.testn(t))return!1;return!0}function Mn(r,e){return st(r,e)?null:jt(r,e)}function _n(r,e){return st(r,e)?null:Qt(r,e)}var Ku=Buffer.from("amm_config","utf8"),qu=Buffer.from("pool","utf8"),Gu=Buffer.from("pool_vault","utf8"),Vu=Buffer.from("pool_reward_vault","utf8"),yi=Buffer.from("position","utf8"),wi=Buffer.from("tick_array","utf8"),Uu=Buffer.from("operation","utf8"),Wu=Buffer.from("pool_tick_array_bitmap_extension","utf8");function le(r,e,t){return Nt([wi,e.toBuffer(),Dn(t)],r)}function vn(r,e){return Nt([yi,e.toBuffer()],r)}import{PublicKey as Yn}from"@solana/web3.js";import H from"bn.js";import Mi from"bn.js";import{PublicKey as Si}from"@solana/web3.js";import Vn,{isBN as Un}from"bn.js";import{bits as Hu,BitStructure as Yu,blob as Ti,Blob as Zu,cstr as ju,f32 as Qu,f32be as Ju,f64 as $u,f64be as ec,greedy as tc,Layout as xi,ns64 as nc,ns64be as rc,nu64 as ic,nu64be as oc,offset as sc,s16 as ac,s16be as uc,s24 as cc,s24be as lc,s32 as Ai,s32be as mc,s40 as dc,s40be as fc,s48 as pc,s48be as gc,s8 as hc,seq as ki,struct as bc,Structure as Pi,u16 as Bi,u16be as yc,u24 as wc,u24be as Tc,u32 as xc,u32be as Ac,u40 as kc,u40be as Pc,u48 as Bc,u48be as Ic,u8 as Ii,UInt as Ni,union as Nc,Union as Sc,unionLayoutDiscriminator as Cc,utf8 as Lc}from"@solana/buffer-layout";var Jt=xi,Kn=Pi;var $t=Ni;var qn=Ii,et=Bi;var qe=Ai;var Gn=ki;var we=Ti;var at=class extends Jt{constructor(t,n,i){super(t,i);this.blob=we(t),this.signed=n}decode(t,n=0){let i=new Vn(this.blob.decode(t,n),10,"le");return this.signed?i.fromTwos(this.span*8).clone():i}encode(t,n,i=0){return typeof t=="number"&&(t=new Vn(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),n,i)}};function Te(r){return new $t(1,r)}function ut(r){return new $t(4,r)}function v(r){return new at(8,!1,r)}function K(r){return new at(16,!1,r)}function Wn(r){return new at(16,!0,r)}var Ct=class extends Jt{constructor(t,n,i,o){super(t.span,o);this.layout=t,this.decoder=n,this.encoder=i}decode(t,n){return this.decoder(this.layout.decode(t,n))}encode(t,n,i){return this.layout.encode(this.encoder(t),n,i)}getSpan(t,n){return this.layout.getSpan(t,n)}};function $(r){return new Ct(we(32),e=>new Si(e),e=>e.toBuffer(),r)}function Xn(r){return new Ct(qn(),Ci,Li,r)}function Ci(r){if(r===0)return!1;if(r===1)return!0;throw new Error("Invalid bool: "+r)}function Li(r){return r?1:0}var en=class extends Kn{decode(e,t){return super.decode(e,t)}};function be(r,e,t){return new en(r,e,t)}function z(r,e,t){let n,i=typeof e=="number"?e:Un(e)?e.toNumber():new Proxy(e,{get(o,s){if(!n){let a=Reflect.get(o,"count");n=Un(a)?a.toNumber():a,Reflect.set(o,"count",n)}return Reflect.get(o,s)},set(o,s,a){return s==="count"&&(n=a),Reflect.set(o,s,a)}});return Gn(r,i,t)}var tn=14,Fe=class{static maxTickInTickarrayBitmap(e){return e*ee*ze}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(i+=1);let o=n*i;return e<0?{minValue:-o,maxValue:-o+n}:{minValue:o,maxValue:o+n}}static nextInitializedTickArrayStartIndex(e,t,n,i){if(!F.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let o=this.maxTickInTickarrayBitmap(n),s=i?t-F.tickCount(n):t+F.tickCount(n);if(s<-o||s>=o)return{isInit:!1,tickIndex:t};let a=n*ee,u=s/a+512;s<0&&s%a!=0&&u--;let c=Math.abs(u);if(i){let l=e.shln(1024-c-1),m=Mn(1024,l);if(m!==null){let d=(c-m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:-o}}else{let l=e.shrn(c),m=_n(1024,l);if(m!==null){let d=(c+m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:o-F.tickCount(n)}}}},ct=class{static getBitmapOffset(e,t){if(!F.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=Fe.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&i--,i}static getBitmap(e,t,n){let i=this.getBitmapOffset(e,t);return e<0?{offset:i,tickarrayBitmap:n.negativeTickArrayBitmap[i]}:{offset:i,tickarrayBitmap:n.positiveTickArrayBitmap[i]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:i}=this.extensionTickBoundary(t);if(e>=i&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=Fe.maxTickInTickarrayBitmap(e),n=-t;if(ce<=t)throw Error(`extensionTickBoundary check error: ${ce}, ${t}`);if(n<=se)throw Error(`extensionTickBoundary check error: ${n}, ${se}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:i}=this.getBitmap(e,t,n),o=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:I.mergeTickArrayBitmap(i).testn(o),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,i){let o=F.tickCount(t),s=n?e-o:e+o,{tickarrayBitmap:a}=this.getBitmap(s,t,i);return this.nextInitializedTickArrayInBitmap(a,s,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,i){let{minValue:o,maxValue:s}=Fe.getBitmapTickBoundary(t,n),a=this.tickArrayOffsetInBitmap(t,n);if(i){let u=I.mergeTickArrayBitmap(e).shln(ze-1-a),c=st(512,u)?null:jt(512,u);if(c!==null){let l=t-c*F.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:o}}else{let u=I.mergeTickArrayBitmap(e).shrn(a),c=st(512,u)?null:Qt(512,u);if(c!==null){let l=t+c*F.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s-F.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%Fe.maxTickInTickarrayBitmap(t),i=Math.floor(n/F.tickCount(t));return e<0&&n!=0&&(i=ze-i),i}};var Qc=be([we(8),Te("bump"),et("index"),$(""),ut("protocolFeeRate"),ut("tradeFeeRate"),et("tickSpacing"),z(v(),8,"")]),Ei=be([ut("blockTimestamp"),K("sqrtPriceX64"),K("cumulativeTimePriceX64"),z(K(),1,"")]),Jc=be([we(8),Xn("initialized"),$("poolId"),z(Ei,1e3,"observations"),z(K(),5,"")]),Ri=be([Te("rewardState"),v("openTime"),v("endTime"),v("lastUpdateTime"),K("emissionsPerSecondX64"),v("rewardTotalEmissioned"),v("rewardClaimed"),$("tokenMint"),$("tokenVault"),$("creator"),K("rewardGrowthGlobalX64")]),$c=be([we(8),Te("bump"),$("ammConfig"),$("creator"),$("mintA"),$("mintB"),$("vaultA"),$("vaultB"),$("observationId"),Te("mintDecimalsA"),Te("mintDecimalsB"),et("tickSpacing"),K("liquidity"),K("sqrtPriceX64"),qe("tickCurrent"),et("observationIndex"),et("observationUpdateDuration"),K("feeGrowthGlobalX64A"),K("feeGrowthGlobalX64B"),v("protocolFeesTokenA"),v("protocolFeesTokenB"),K("swapInAmountTokenA"),K("swapOutAmountTokenB"),K("swapInAmountTokenB"),K("swapOutAmountTokenA"),Te("status"),z(Te(),7,""),z(Ri,3,"rewardInfos"),z(v(),16,"tickArrayBitmap"),v("totalFeesTokenA"),v("totalFeesClaimedTokenA"),v("totalFeesTokenB"),v("totalFeesClaimedTokenB"),v("fundFeesTokenA"),v("fundFeesTokenB"),v("startTime"),z(v(),15*4-3,"padding")]),Fi=be([K("growthInsideLastX64"),v("rewardAmountOwed")]),zn=be([we(8),Te("bump"),$("nftMint"),$("poolId"),qe("tickLower"),qe("tickUpper"),K("liquidity"),K("feeGrowthInsideLastX64A"),K("feeGrowthInsideLastX64B"),v("tokenFeesOwedA"),v("tokenFeesOwedB"),z(Fi,3,"rewardInfos"),z(v(),8,"")]),el=be([we(8),Te("bump"),$("poolId"),qe("tickLowerIndex"),qe("tickUpperIndex"),K("liquidity"),K("feeGrowthInsideLastX64A"),K("feeGrowthInsideLastX64B"),v("tokenFeesOwedA"),v("tokenFeesOwedB"),z(K(),3,"rewardGrowthInside"),z(v(),8,"")]),Oi=be([qe("tick"),Wn("liquidityNet"),K("liquidityGross"),K("feeGrowthOutsideX64A"),K("feeGrowthOutsideX64B"),z(K(),3,"rewardGrowthsOutsideX64"),z(ut(),13,"")]),lt=be([we(8),$("poolId"),qe("startTickIndex"),z(Oi,ee,"ticks"),Te("initializedTickCount"),z(Te(),115,"")]),tl=be([we(329),z($(),100,"whitelistMints")]),Hn=be([we(8),$("poolId"),z(z(v(),8),tn,"positiveTickArrayBitmap"),z(z(v(),8),tn,"negativeTickArrayBitmap")]);var Di=15,F=class{static async getTickArrays(e,t,n,i,o,s,a){let u=[],c=I.getTickArrayStartIndexByTick(i,o),l=I.getInitializedTickArrayInRange(s,a,o,c,Math.floor(Di/2));for(let f=0;f<l.length;f++){let{publicKey:b}=le(t,n,l[f]);u.push(b)}let m=(await We(e,u)).map(f=>f!==null?lt.decode(f.data):null),d={};for(let f=0;f<u.length;f++){let b=m[f];b!==null&&(d[b.startTickIndex]=ne(Y({},b),{address:u[f]}))}return d}static nextInitializedTick(e,t,n,i,o,s){let{initializedTick:a,tickArrayAddress:u,tickArrayStartTickIndex:c}=this.nextInitializedTickInOneArray(e,t,n,i,o,s);for(;a==null||a.liquidityGross.lten(0);){if(c=I.getNextTickArrayStartIndex(c,o,s),this.checkIsValidStartIndex(c,o))throw new Error("No enough initialized tickArray");let l=n[c];if(l===void 0)continue;let{nextTick:m,tickArrayAddress:d,tickArrayStartTickIndex:f}=this.firstInitializedTickInOneArray(e,t,l,s);[a,u,c]=[m,d,f]}if(a==null)throw new Error("No invaild tickArray cache");return{nextTick:a,tickArrayAddress:u,tickArrayStartTickIndex:c}}static nextInitializedTickArray(e,t,n,i,o){let s=Math.floor(e/F.tickCount(t)),a=n?I.searchLowBitFromStart(i,o,s-1,1,t):I.searchHightBitFromStart(i,o,s+1,1,t);return a.length>0?{isExist:!0,nextStartIndex:a[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,i){let o;if(i){let a=ee-1;for(;a>=0;){let u=n.ticks[a];if(u.liquidityGross.gtn(0)){o=u;break}a=a-1}}else{let a=0;for(;a<ee;){let u=n.ticks[a];if(u.liquidityGross.gtn(0)){o=u;break}a=a+1}}let{publicKey:s}=le(e,t,n.startTickIndex);return{nextTick:o,tickArrayAddress:s,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,i,o,s){let a=I.getTickArrayStartIndexByTick(i,o),u=Math.floor((i-a)/o),c=n[a];if(c==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:a};let l;if(s)for(;u>=0;){let d=c.ticks[u];if(d.liquidityGross.gtn(0)){l=d;break}u=u-1}else for(u=u+1;u<ee;){let d=c.ticks[u];if(d.liquidityGross.gtn(0)){l=d;break}u=u+1}let{publicKey:m}=le(e,t,a);return{initializedTick:l,tickArrayAddress:m,tickArrayStartTickIndex:c.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if(I.checkIsOutOfBoundary(e)){if(e>ce)return!1;let n=I.getTickArrayStartIndexByTick(se,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return ee*e}};var ee=60,ze=512,I=class{static getTickArrayAddressByTick(e,t,n,i){let o=I.getTickArrayStartIndexByTick(n,i),{publicKey:s}=le(e,t,o);return s}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=I.getTickArrayStartIndexByTick(e,t),i=Math.floor((e-n)/t);if(i<0||i>=ee)throw new Error("tick offset in array overflow");return i}static getTickArrayBitIndex(e,t){let n=F.tickCount(t),i=e/n;return e<0&&e%n!=0?i=Math.ceil(i)-1:i=Math.floor(i),i}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*F.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*ee,i=Math.floor(e/n)+512;return Math.abs(i)}static checkTickArrayIsInitialized(e,t,n){let i=n*ee,o=Math.floor(t/i)+512,s=Math.abs(o);return{isInitialized:e.testn(s),startIndex:(s-512)*i}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*ee:e+t*ee}static mergeTickArrayBitmap(e){let t=new Mi(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,i,o){let s=Math.floor(i/(n*ee));return[...I.searchLowBitFromStart(e,t,s-1,o,n),...I.searchHightBitFromStart(e,t,s,o,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return I.searchHightBitFromStart(e,t,0,ze,n)}static getAllInitializedTickArrayInfo(e,t,n,i,o){let s=[],a=I.getAllInitializedTickArrayStartIndex(n,i,o);for(let u of a){let{publicKey:c}=le(e,t,u);s.push({tickArrayStartIndex:u,tickArrayAddress:c})}return s}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,i,o){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(c=>I.mergeTickArrayBitmap(c)),a=[];for(;n>=-7680;){let c=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[c].testn(l)&&a.push(n),n--,a.length===i)break}let u=F.tickCount(o);return a.map(c=>c*u)}static searchHightBitFromStart(e,t,n,i,o){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(c=>I.mergeTickArrayBitmap(c)),a=[];for(;n<7680;){let c=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[c].testn(l)&&a.push(n),n++,a.length===i)break}let u=F.tickCount(o);return a.map(c=>c*u)}static checkIsOutOfBoundary(e){return e<se||e>ce}static nextInitTick(e,t,n,i,o){if(F.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let a=Math.floor((t-e.startTickIndex)/n);if(i)for(;a>=0;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a-1}else for(o||(a=a+1);a<ee;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a+1}return null}static firstInitializedTick(e,t){if(t){let n=ee-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<ee;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let i=N.getSqrtPriceX64FromTick(t),o=N.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:o,tickSqrtPriceX64:i}:{tick:t,price:new k(1).div(o),tickSqrtPriceX64:i}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let i=n?t:new k(1).div(t),o=He.getTickWithPriceAndTickspacing(i,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=N.getSqrtPriceX64FromTick(o),a=N.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:o,price:a}:{tick:o,price:new k(1).div(a)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let i=N.getSqrtPriceX64FromTick(t),o=N.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:o,tickSqrtPriceX64:i}:{tick:t,price:new k(1).div(o),tickSqrtPriceX64:i}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let i=n?t:new k(1).div(t),o=He.getTickWithPriceAndTickspacing(i,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=N.getSqrtPriceX64FromTick(o),a=N.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:o,price:a}:{tick:o,price:new k(1).div(a)}}};import Ce from"bn.js";var mt=class{static getfeeGrowthInside(e,t,n){let i=new Ce(0),o=new Ce(0);e.tickCurrent>=t.tick?(i=t.feeGrowthOutsideX64A,o=t.feeGrowthOutsideX64B):(i=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),o=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let s=new Ce(0),a=new Ce(0);e.tickCurrent<n.tick?(s=n.feeGrowthOutsideX64A,a=n.feeGrowthOutsideX64B):(s=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),a=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let u=S.wrappingSubU128(S.wrappingSubU128(e.feeGrowthGlobalX64A,i),s),c=S.wrappingSubU128(S.wrappingSubU128(e.feeGrowthGlobalX64B,o),a);return{feeGrowthInsideX64A:u,feeGrowthInsideBX64:c}}static GetPositionFees(e,t,n,i){let{feeGrowthInsideX64A:o,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,i),a=S.mulDivFloor(S.wrappingSubU128(o,t.feeGrowthInsideLastX64A),t.liquidity,ge),u=t.tokenFeesOwedA.add(a),c=S.mulDivFloor(S.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,ge),l=t.tokenFeesOwedB.add(c);return{tokenFeeAmountA:u,tokenFeeAmountB:l}}static GetPositionFeesV2(e,t,n,i){let{feeGrowthInsideX64A:o,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,i),a=S.mulDivFloor(S.wrappingSubU128(o,t.feeGrowthInsideLastX64A),t.liquidity,ge),u=t.tokenFeesOwedA.add(a),c=S.mulDivFloor(S.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,ge),l=t.tokenFeesOwedB.add(c);return{tokenFeeAmountA:u,tokenFeeAmountB:l}}static GetPositionRewardsV2(e,t,n,i){let o=[],s=this.getRewardGrowthInsideV2(e.tickCurrent,n,i,e.rewardInfos);for(let a=0;a<s.length;a++){let u=s[a],c=t.rewardInfos[a],l=S.wrappingSubU128(u,c.growthInsideLastX64),m=S.mulDivFloor(l,t.liquidity,ge),d=c.rewardAmountOwed.add(m);o.push(d)}return o}static GetPositionRewards(e,t,n,i){let o=[],s=this.getRewardGrowthInside(e.tickCurrent,n,i,e.rewardInfos);for(let a=0;a<s.length;a++){let u=s[a],c=t.rewardInfos[a],l=S.wrappingSubU128(u,c.growthInsideLastX64),m=S.mulDivFloor(l,t.liquidity,ge),d=c.rewardAmountOwed.add(m);o.push(d)}return o}static getRewardGrowthInside(e,t,n,i){let o=[];for(let s=0;s<i.length;s++){let a=new Ce(0);t.liquidityGross.eqn(0)?a=i[s].rewardGrowthGlobalX64:e<t.tick?a=i[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let u=new Ce(0);n.liquidityGross.eqn(0)||(e<n.tick?u=n.rewardGrowthsOutsideX64[s]:u=i[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),o.push(S.wrappingSubU128(S.wrappingSubU128(i[s].rewardGrowthGlobalX64,a),u))}return o}static getRewardGrowthInsideV2(e,t,n,i){let o=[];for(let s=0;s<i.length;s++){let a=new Ce(0);t.liquidityGross.eqn(0)?a=i[s].rewardGrowthGlobalX64:e<t.tick?a=i[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let u=new Ce(0);n.liquidityGross.eqn(0)||(e<n.tick?u=n.rewardGrowthsOutsideX64[s]:u=i[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),o.push(S.wrappingSubU128(S.wrappingSubU128(i[s].rewardGrowthGlobalX64,a),u))}return o}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:i,add:o,epochInfo:s}){var h,y,B,T;let a=N.priceToSqrtPriceX64(new k(e.price),e.mintA.decimals,e.mintB.decimals),u=N.getSqrtPriceX64FromTick(t.tickLower),c=N.getSqrtPriceX64FromTick(t.tickUpper),l=o?1+i:1-i,m=O.getAmountsFromLiquidity(a,u,c,n,o),[d,f]=[ue(m.amountA,(h=e.mintA.extensions)==null?void 0:h.feeConfig,s,!0),ue(m.amountB,(y=e.mintB.extensions)==null?void 0:y.feeConfig,s,!0)],[b,g]=[ue(new Ce(new k(m.amountA.toString()).mul(l).toFixed(0)),(B=e.mintA.extensions)==null?void 0:B.feeConfig,s,!0),ue(new Ce(new k(m.amountB.toString()).mul(l).toFixed(0)),(T=e.mintB.extensions)==null?void 0:T.feeConfig,s,!0)];return{liquidity:n,amountA:d,amountB:f,amountSlippageA:b,amountSlippageB:g,expirationTime:Xe(d.expirationTime,f.expirationTime)}}};var Oe=class{static getOutputAmountAndRemainAccounts(e,t,n,i,o){let s=n.equals(e.mintA.mint),a=[],{isExist:u,startIndex:c,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!u||c===void 0||!l)throw new Error("Invalid tick array");a.push(l);let{amountCalculated:m,accounts:d,sqrtPriceX64:f,feeAmount:b}=Ye.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i,c,o);return a.push(...d),{expectedAmountOut:m.mul(Ee),remainingAccounts:a,executionPrice:f,feeAmount:b}}static getInputAmountAndRemainAccounts(e,t,n,i,o){let s=n.equals(e.mintB.mint),a=[],{isExist:u,startIndex:c,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!u||c===void 0||!l)throw new Error("Invalid tick array");try{let g=this.preInitializedTickArrayStartIndex(e,s);if(g.isExist){let{publicKey:h}=le(e.programId,e.id,g.nextStartIndex);a.push(h)}}catch{}a.push(l);let{amountCalculated:m,accounts:d,sqrtPriceX64:f,feeAmount:b}=Ye.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i.mul(Ee),c,o);return a.push(...d),{expectedAmountIn:m,remainingAccounts:a,executionPrice:f,feeAmount:b}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:i}=Oe.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?ct.checkTickArrayIsInit(F.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):I.checkTickArrayIsInitialized(I.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:a}=le(e.programId,e.id,i);return{isExist:!0,startIndex:i,nextAccountMeta:a}}let{isExist:o,nextStartIndex:s}=this.nextInitializedTickArrayStartIndex(e,F.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(o){let{publicKey:a}=le(e.programId,e.id,s);return{isExist:!0,startIndex:s,nextAccountMeta:a}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/F.tickCount(e.tickSpacing)),i=t?I.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):I.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return i.length>0?{isExist:!0,nextStartIndex:i[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=F.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:i,tickIndex:o}=Fe.nextInitializedTickArrayStartIndex(I.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(i)return{isExist:!0,nextStartIndex:o};t=o;let{isInit:s,tickIndex:a}=ct.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(s)return{isExist:!0,nextStartIndex:a};if(t=a,t<se||t>ce)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:i,rewardInfos:o}){var a,u,c;let s=[];for(let l=0;l<o.length;l++){let m=o[l],d=(c=(a=t.rewardDefaultInfos[l])==null?void 0:a.mint.programId)!=null?c:(u=await e.getAccountInfo(m.tokenMint))==null?void 0:u.owner;if(d===void 0)throw Error("get new reward mint info error");let f=ne(Y({},m),{perSecond:S.x64ToDecimal(m.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new Yn(d)});if(f.tokenMint.equals(Yn.default))continue;if(n<=f.openTime.toNumber()||i.eq(Z)){s.push(f);continue}let b=new H(Math.min(f.endTime.toNumber(),n)),g=b.sub(f.lastUpdateTime),h=S.mulDivFloor(g,f.emissionsPerSecondX64,i),y=f.rewardGrowthGlobalX64.add(h),B=S.mulDivFloor(g,f.emissionsPerSecondX64,ge),T=f.rewardTotalEmissioned.add(B);s.push(ne(Y({},f),{rewardGrowthGlobalX64:y,rewardTotalEmissioned:T,lastUpdateTime:b}))}return s}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:i}=this.tickRange(e);for(let o of t){let s=I.getTickArrayStartIndexByTick(o,e);if(s>=n||s<i)return!0}return!1}static tickRange(e){let t=Fe.maxTickInTickarrayBitmap(e),n=-t;return t>ce&&(t=F.getArrayStartIndex(ce,e)+F.tickCount(e)),n<se&&(n=F.getArrayStartIndex(se,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!F.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/F.tickCount(t)*ze}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let i=await Zt(e,t.map(s=>({pubkey:s})),{batchRequest:n}),o={};for(let s of i)s.accountInfo!==null&&(o[s.pubkey.toString()]=Hn.decode(s.accountInfo.data));return o}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let i={},o=[];for(let u of t){let c=I.getTickArrayStartIndexByTick(u.tickCurrent,u.tickSpacing),l=I.getInitializedTickArrayInRange(u.tickArrayBitmap,u.exBitmapInfo,u.tickSpacing,c,7);for(let m of l){let{publicKey:d}=le(u.programId,u.id,m);o.push({pubkey:d}),i[d.toString()]=u.id}}let s=await Zt(e,o,{batchRequest:n}),a={};for(let u of s){if(!u.accountInfo)continue;let c=i[u.pubkey.toString()];if(!c)continue;a[c.toString()]===void 0&&(a[c.toString()]={});let l=lt.decode(u.accountInfo.data);a[c.toString()][l.startTickIndex]=ne(Y({},l),{address:u.pubkey})}return a}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:i=!1,updateOwnerRewardAndFee:o=!0}){var a;let s=[];for(let u=0;u<e.length;u++){let c=e[u];c!==null&&(s.find(l=>l.equals(c.state.programId))||s.push(c.state.programId))}if(n){let u=n.tokenAccounts.map(d=>d.accountInfo.mint),c=[];for(let d of u)for(let f of s)c.push(vn(f,d).publicKey);let l=await We(t,c,{batchRequest:i}),m={};for(let d of l){if(d===null)continue;let f=zn.decode(d.data),b=f.poolId.toString(),g=e.find(X=>X.state.id.toBase58()===b);if(g===void 0)continue;let h=g.state,y=I._getTickPriceLegacy({poolInfo:h,tick:f.tickLower,baseIn:!0}),B=I._getTickPriceLegacy({poolInfo:h,tick:f.tickUpper,baseIn:!0}),{amountA:T,amountB:R}=O.getAmountsFromLiquidity(h.sqrtPriceX64,y.tickSqrtPriceX64,B.tickSqrtPriceX64,f.liquidity,!1),x=1/(1-Math.sqrt(Math.sqrt(y.price.div(B.price).toNumber())));g.positionAccount=[...(a=g.positionAccount)!=null?a:[],{poolId:f.poolId,nftMint:f.nftMint,priceLower:y.price,priceUpper:B.price,amountA:T,amountB:R,tickLower:f.tickLower,tickUpper:f.tickUpper,liquidity:f.liquidity,feeGrowthInsideLastX64A:f.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:f.feeGrowthInsideLastX64B,tokenFeesOwedA:f.tokenFeesOwedA,tokenFeesOwedB:f.tokenFeesOwedB,rewardInfos:f.rewardInfos.map(X=>ne(Y({},X),{pendingReward:new H(0)})),leverage:x,tokenFeeAmountA:new H(0),tokenFeeAmountB:new H(0)}];let q=await I.getTickArrayAddressByTick(g.state.programId,f.poolId,f.tickLower,g.state.tickSpacing),G=await I.getTickArrayAddressByTick(g.state.programId,f.poolId,f.tickUpper,g.state.tickSpacing);m[`${g.state.programId.toString()}-${f.poolId.toString()}-${f.tickLower}`]=q,m[`${g.state.programId.toString()}-${f.poolId.toString()}-${f.tickUpper}`]=G}if(o){let d=Object.values(m),f=await We(t,d,{batchRequest:i}),b={};for(let g=0;g<d.length;g++){let h=f[g];if(h===null)continue;let y=d[g].toString();b[y]=lt.decode(h.data)}for(let{state:g,positionAccount:h}of e)if(!!h)for(let y of h){let B=`${g.programId.toString()}-${g.id.toString()}-${y.tickLower}`,T=`${g.programId.toString()}-${g.id.toString()}-${y.tickUpper}`,R=b[m[B].toString()],x=b[m[T].toString()],q=R.ticks[I.getTickOffsetInArray(y.tickLower,g.tickSpacing)],G=x.ticks[I.getTickOffsetInArray(y.tickUpper,g.tickSpacing)],{tokenFeeAmountA:X,tokenFeeAmountB:te}=await mt.GetPositionFees(g,y,q,G),V=await mt.GetPositionRewards(g,y,q,G);y.tokenFeeAmountA=X.gte(new H(0))?X:new H(0),y.tokenFeeAmountB=te.gte(new H(0))?te:new H(0);for(let U=0;U<V.length;U++)y.rewardInfos[U].pendingReward=V[U].gte(new H(0))?V[U]:new H(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,token2022Infos:i,epochInfo:o,amountIn:s,slippage:a,priceLimit:u=new k(0)}){var te,V,U,Pe;let c;u.equals(new k(0))?c=n.equals(e.mintA.mint)?Qe.add(new H(1)):Je.sub(new H(1)):c=N.priceToSqrtPriceX64(u,e.mintA.decimals,e.mintB.decimals);let l=St(s,(te=i[n.toString()])==null?void 0:te.feeConfig,o,!1),{expectedAmountOut:m,remainingAccounts:d,executionPrice:f,feeAmount:b}=Oe.getOutputAmountAndRemainAccounts(e,t,n,l.amount.sub((V=l.fee)!=null?V:Z),c),g=e.mintA.mint.equals(n)?e.mintB.mint:e.mintA.mint,h=St(m,(U=i[g.toString()])==null?void 0:U.feeConfig,o,!1),y=N.sqrtPriceX64ToPrice(f,e.mintA.decimals,e.mintB.decimals),B=n.equals(e.mintA.mint)?y:new k(1).div(y),T=m.mul(new H(Math.floor((1-a)*1e10))).div(new H(1e10)),R=St(T,(Pe=i[g.toString()])==null?void 0:Pe.feeConfig,o,!1),x=e.mintA.mint.equals(n)?e.currentPrice:new k(1).div(e.currentPrice),q=new k(B).sub(x).abs(),G=x,X=new Ue(new k(q).mul(10**15).toFixed(0),new k(G).mul(10**15).toFixed(0));return{realAmountIn:l,amountOut:h,minAmountOut:R,expirationTime:Xe(l.expirationTime,h.expirationTime),currentPrice:e.currentPrice,executionPrice:B,priceImpact:X,fee:b,remainingAccounts:d}}static async computeAmountOutFormat({poolInfo:e,tickArrayCache:t,token2022Infos:n,amountIn:i,tokenOut:o,slippage:s,epochInfo:a}){let u=i.token.equals(Re.WSOL)?xt:i.token.mint,c=s.numerator.toNumber()/s.denominator.toNumber(),l=o.mint.equals(Ge)?new Re({mint:"sol",decimals:At.decimals}):o,{realAmountIn:m,amountOut:d,minAmountOut:f,expirationTime:b,currentPrice:g,executionPrice:h,priceImpact:y,fee:B,remainingAccounts:T}=await Oe.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:u,amountIn:i.raw,slippage:c,token2022Infos:n,epochInfo:a}),R=ne(Y({},m),{amount:new ae(i.token,m.amount),fee:m.fee===void 0?void 0:new ae(i.token,m.fee)}),x=ne(Y({},d),{amount:new ae(l,d.amount),fee:d.fee===void 0?void 0:new ae(l,d.fee)}),q=ne(Y({},f),{amount:new ae(l,f.amount),fee:f.fee===void 0?void 0:new ae(l,f.fee)}),G=new ke({baseToken:i.token,denominator:new H(10).pow(new H(20+i.token.decimals)),quoteToken:l,numerator:g.mul(new k(10**(20+l.decimals))).toFixed(0)}),X=new ke({baseToken:i.token,denominator:new H(10).pow(new H(20+i.token.decimals)),quoteToken:l,numerator:h.mul(new k(10**(20+l.decimals))).toFixed(0)}),te=new ae(i.token,B);return{realAmountIn:R,amountOut:x,minAmountOut:q,expirationTime:b,currentPrice:G,executionPrice:X,priceImpact:y,fee:te,remainingAccounts:T}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:i}){var b,g,h;let o=e[t],s=I.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),a=I.getTickPrice({poolInfo:e,tick:i,baseIn:!0}).price.toNumber(),u=Math.max(s,o.priceMin),l=Math.min(a,o.priceMax)-u,m=a-s,d=o.priceMax-o.priceMin,f;return l<=0?f=0:m===l?f=d/l:d===l?f=l/m:f=l/d*(l/m),{feeApr:o.feeApr*f,rewardsApr:[(b=o.rewardApr[0])!=null?b:0*f,(g=o.rewardApr[1])!=null?g:0*f,(h=o.rewardApr[2])!=null?h:0*f],apr:o.apr*f}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:i,liquidity:o,positionTickLowerIndex:s,positionTickUpperIndex:a,chainTime:u}){let c=n==="day"?1:n==="week"?7:n==="month"?30:0,l=e[n],m=i[qt(e.mintA.address).toString()],d=i[qt(e.mintB.address).toString()],f=e.mintA.decimals,b=e.mintB.decimals;if(!l||!m||!d)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let g=N.priceToSqrtPriceX64(new k(e.price),e.mintA.decimals,e.mintB.decimals),h=N.getSqrtPriceX64FromTick(s),y=N.getSqrtPriceX64FromTick(a),{amountSlippageA:B,amountSlippageB:T}=O.getAmountsFromLiquidityWithSlippage(g,h,y,t,!1,!1,0),{amountSlippageA:R,amountSlippageB:x}=O.getAmountsFromLiquidityWithSlippage(g,h,y,o,!1,!1,0),q=new k(B.toString()).div(new k(10).pow(f)).mul(m.value).add(new k(T.toString()).div(new k(10).pow(b)).mul(d.value)),G=new k(R.toString()).div(new k(10).pow(f)).mul(m.value).add(new k(x.toString()).div(new k(10).pow(b)).mul(d.value)),X=G.div(q.add(G)).div(G),V=new k(l.volumeFee).mul(365).div(c).mul(X).mul(100).toNumber(),U=3600*24*365,Pe=e.rewardDefaultInfos.map(pe=>{var M,rn;let De=pe.mint.decimals,Q=i[pe.mint.address];return u<((M=pe.startTime)!=null?M:0)||u>((rn=pe.endTime)!=null?rn:0)||!pe.perSecond||!Q||De===void 0?0:new k(Q.value).mul(new k(pe.perSecond).mul(U)).div(new k(10).pow(De)).mul(X).mul(100).toNumber()});return{feeApr:V,rewardsApr:Pe,apr:V+Pe.reduce((pe,De)=>pe+De,0)}}static getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:i,amount:o,slippage:s,add:a,epochInfo:u,amountHasFee:c}){var y,B;let l=N.priceToSqrtPriceX64(new k(e.price),e.mintA.decimals,e.mintB.decimals),m=N.getSqrtPriceX64FromTick(n),d=N.getSqrtPriceX64FromTick(i),f=a?1-s:1+s,b=ue(o,(y=e[t?"mintA":"mintB"].extensions)==null?void 0:y.feeConfig,u,!c),g=new H(new k(b.amount.sub((B=b.fee)!=null?B:Z).toString()).mul(f).toFixed(0)),h;if(l.lte(m))h=t?O.getLiquidityFromTokenAmountA(m,d,g,!a):new H(0);else if(l.lte(d)){let T=O.getLiquidityFromTokenAmountA(l,d,g,!a),R=O.getLiquidityFromTokenAmountB(m,l,g);h=t?T:R}else h=t?new H(0):O.getLiquidityFromTokenAmountB(m,d,g);return Oe.getAmountsFromLiquidity({epochInfo:u,poolInfo:e,tickLower:n,tickUpper:i,liquidity:h,slippage:s,add:a})}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:i,liquidity:o,slippage:s,add:a}){var h,y,B,T;let u=N.getSqrtPriceX64FromTick(n),c=N.getSqrtPriceX64FromTick(i),l=a?1+s:1-s,m=O.getAmountsFromLiquidity(N.priceToSqrtPriceX64(new k(t.price),t.mintA.decimals,t.mintB.decimals),u,c,o,a),[d,f]=[ue(m.amountA,(h=t.mintA.extensions)==null?void 0:h.feeConfig,e,!0),ue(m.amountB,(y=t.mintB.extensions)==null?void 0:y.feeConfig,e,!0)],[b,g]=[ue(m.amountA.muln(l),(B=t.mintA.extensions)==null?void 0:B.feeConfig,e,!0),ue(m.amountB.muln(l),(T=t.mintB.extensions)==null?void 0:T.feeConfig,e,!0)];return{liquidity:o,amountA:d,amountB:f,amountSlippageA:b,amountSlippageB:g,expirationTime:Xe(d.expirationTime,f.expirationTime)}}};var S=class{static mulDivRoundingUp(e,t,n){let i=e.mul(t),o=i.div(n);return i.mod(n).eq(Z)||(o=o.add(Ne)),o}static mulDivFloor(e,t,n){if(n.eq(Z))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(Z))throw new Error("division by 0");return e.mul(t).add(n.sub(Ne)).div(n)}static x64ToDecimal(e,t){return new k(e.toString()).div(k.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new C(e.mul(k.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add(wt).sub(t).mod(wt)}};function re(r,e){return nn(r.mul(e),64,256)}function _i(r,e,t){let n=r.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function nn(r,e,t){let n=r.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var N=class{static sqrtPriceX64ToPrice(e,t,n){return S.x64ToDecimal(e).pow(2).mul(k.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return S.decimalToX64(e.mul(k.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,i){if(!e.gt(Z))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(Z))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,i){if(!e.gt(Z))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(Z))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,i){if(n.eq(Z))return e;let o=t.shln(rt);if(i){let s=o,a=o.add(n.mul(e));return a.gte(s)?S.mulDivCeil(s,e,a):S.mulDivRoundingUp(s,Ne,s.div(e).add(n))}else{let s=n.mul(e);if(!o.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let a=o.sub(s);return S.mulDivCeil(o,e,a)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,i){let o=n.shln(rt);if(i)return e.add(o.div(t));{let s=S.mulDivRoundingUp(o,Ne,t);if(!e.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(s)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<se||e>ce)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new C("18445821805675395072"):new C("18446744073709551616");return(t&2)!=0&&(n=re(n,new C("18444899583751176192"))),(t&4)!=0&&(n=re(n,new C("18443055278223355904"))),(t&8)!=0&&(n=re(n,new C("18439367220385607680"))),(t&16)!=0&&(n=re(n,new C("18431993317065453568"))),(t&32)!=0&&(n=re(n,new C("18417254355718170624"))),(t&64)!=0&&(n=re(n,new C("18387811781193609216"))),(t&128)!=0&&(n=re(n,new C("18329067761203558400"))),(t&256)!=0&&(n=re(n,new C("18212142134806163456"))),(t&512)!=0&&(n=re(n,new C("17980523815641700352"))),(t&1024)!=0&&(n=re(n,new C("17526086738831433728"))),(t&2048)!=0&&(n=re(n,new C("16651378430235570176"))),(t&4096)!=0&&(n=re(n,new C("15030750278694412288"))),(t&8192)!=0&&(n=re(n,new C("12247334978884435968"))),(t&16384)!=0&&(n=re(n,new C("8131365268886854656"))),(t&32768)!=0&&(n=re(n,new C("3584323654725218816"))),(t&65536)!=0&&(n=re(n,new C("696457651848324352"))),(t&131072)!=0&&(n=re(n,new C("26294789957507116"))),(t&262144)!=0&&(n=re(n,new C("37481735321082"))),e>0&&(n=xn.div(n)),n}static getTickFromPrice(e,t,n){return N.getTickFromSqrtPriceX64(N.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(Je)||e.lt(Qe))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new C(t-64),i=_i(n,32,128),o=new C("8000000000000000","hex"),s=0,a=new C(0),u=t>=64?e.shrn(t-63):e.shln(63-t);for(;o.gt(new C(0))&&s<An;){u=u.mul(u);let b=u.shrn(127);u=u.shrn(63+b.toNumber()),a=a.add(o.mul(b)),o=o.shrn(1),s+=1}let c=a.shrn(32),m=i.add(c).mul(new C(kn)),d=nn(m.sub(new C(Pn)),64,128).toNumber(),f=nn(m.add(new C(Bn)),64,128).toNumber();return d==f?d:N.getSqrtPriceX64FromTick(f).lte(e)?f:d}},He=class{static getTickWithPriceAndTickspacing(e,t,n,i){let s=N.getTickFromSqrtPriceX64(N.priceToSqrtPriceX64(e,n,i))/t;return s<0?s=Math.floor(s):s=Math.ceil(s),s*t}static roundPriceWithTickspacing(e,t,n,i){let o=He.getTickWithPriceAndTickspacing(e,t,n,i),s=N.getSqrtPriceX64FromTick(o);return N.sqrtPriceX64ToPrice(s,n,i)}},O=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(Z))throw new Error("sqrtPriceX64A must greater than 0");let o=n.ushln(rt),s=t.sub(e);return i?S.mulDivRoundingUp(S.mulDivCeil(o,s,t),Ne,e):S.mulDivFloor(o,s,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(Z))throw new Error("sqrtPriceX64A must greater than 0");return i?S.mulDivCeil(n,t.sub(e),ge):S.mulDivFloor(n,t.sub(e),ge)}static getLiquidityFromTokenAmountA(e,t,n,i){e.gt(t)&&([e,t]=[t,e]);let o=n.mul(e).mul(t),s=t.sub(e),a=o.div(s);return i?S.mulDivRoundingUp(a,Ne,Mt):a.shrn(rt)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),S.mulDivFloor(n,Mt,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,i,o){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return O.getLiquidityFromTokenAmountA(t,n,i,!1);if(e.lt(n)){let s=O.getLiquidityFromTokenAmountA(e,n,i,!1),a=O.getLiquidityFromTokenAmountB(t,e,o);return s.lt(a)?s:a}else return O.getLiquidityFromTokenAmountB(t,n,o)}static getAmountsFromLiquidity(e,t,n,i,o){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:O.getTokenAmountAFromLiquidity(t,n,i,o),amountB:new C(0)};if(e.lt(n)){let s=O.getTokenAmountAFromLiquidity(e,n,i,o),a=O.getTokenAmountBFromLiquidity(t,e,i,o);return{amountA:s,amountB:a}}else return{amountA:new C(0),amountB:O.getTokenAmountBFromLiquidity(t,n,i,o)}}static getAmountsFromLiquidityWithSlippage(e,t,n,i,o,s,a){let{amountA:u,amountB:c}=O.getAmountsFromLiquidity(e,t,n,i,s),l=o?1+a:1-a,m=new C(new k(u.toString()).mul(l).toFixed(0)),d=new C(new k(c.toString()).mul(l).toFixed(0));return{amountSlippageA:m,amountSlippageB:d}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:i,slippage:o,add:s,epochInfo:a,amountAddFee:u}){var B,T,R,x;let c=N.priceToSqrtPriceX64(new k(e.price),e.mintA.decimals,e.mintB.decimals),l=N.getSqrtPriceX64FromTick(t),m=N.getSqrtPriceX64FromTick(n),d=s?1+o:1-o,f=O.getAmountsFromLiquidity(c,l,m,i,s),[b,g]=[ue(f.amountA,(B=e.mintA.extensions)==null?void 0:B.feeConfig,a,u),ue(f.amountB,(T=e.mintB.extensions)==null?void 0:T.feeConfig,a,u)],[h,y]=[ue(new C(new k(f.amountA.toString()).mul(d).toFixed(0)),(R=e.mintA.extensions)==null?void 0:R.feeConfig,a,u),ue(new C(new k(f.amountB.toString()).mul(d).toFixed(0)),(x=e.mintB.extensions)==null?void 0:x.feeConfig,a,u)];return{liquidity:i,amountA:b,amountB:g,amountSlippageA:h,amountSlippageB:y,expirationTime:Xe(b.expirationTime,g.expirationTime)}}},Ye=class{static swapCompute(e,t,n,i,o,s,a,u,c,l,m,d,f,b){if(d.eq(Z))throw new Error("amountSpecified must not be 0");if(b||(b=s?Qe.add(Ne):Je.sub(Ne)),s){if(b.lt(Qe))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(b.gte(m))throw new Error("sqrtPriceX64 must smaller than current")}else{if(b.gt(Je))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(b.lte(m))throw new Error("sqrtPriceX64 must greater than current")}let g=d.gt(Z),h={amountSpecifiedRemaining:d,amountCalculated:Z,sqrtPriceX64:m,tick:c>f?Math.min(f+F.tickCount(l)-1,c):f,accounts:[],liquidity:u,feeAmount:new C(0)},y=f,B=n[f],T=0,R=!s&&B.startTickIndex===h.tick;for(;!h.amountSpecifiedRemaining.eq(Z)&&!h.sqrtPriceX64.eq(b);){if(T>10)throw Error("liquidity limit");let x={};x.sqrtPriceStartX64=h.sqrtPriceX64;let q=I.nextInitTick(B,h.tick,l,s,R),G=q||null,X=null;if(!(G!=null&&G.liquidityGross.gtn(0))){let V=Oe.nextInitializedTickArrayStartIndex({tickCurrent:h.tick,tickSpacing:l,tickArrayBitmap:i,exBitmapInfo:o},y,s);if(!V.isExist)throw Error("swapCompute LiquidityInsufficient");y=V.nextStartIndex;let{publicKey:U}=le(e,t,y);X=U,B=n[y],G=I.firstInitializedTick(B,s)}x.tickNext=G.tick,x.initialized=G.liquidityGross.gtn(0),f!==y&&X&&(h.accounts.push(X),f=y),x.tickNext<se?x.tickNext=se:x.tickNext>ce&&(x.tickNext=ce),x.sqrtPriceNextX64=N.getSqrtPriceX64FromTick(x.tickNext);let te;if(s&&x.sqrtPriceNextX64.lt(b)||!s&&x.sqrtPriceNextX64.gt(b)?te=b:te=x.sqrtPriceNextX64,[h.sqrtPriceX64,x.amountIn,x.amountOut,x.feeAmount]=Ye.swapStepCompute(h.sqrtPriceX64,te,h.liquidity,h.amountSpecifiedRemaining,a),h.feeAmount=h.feeAmount.add(x.feeAmount),g?(h.amountSpecifiedRemaining=h.amountSpecifiedRemaining.sub(x.amountIn.add(x.feeAmount)),h.amountCalculated=h.amountCalculated.sub(x.amountOut)):(h.amountSpecifiedRemaining=h.amountSpecifiedRemaining.add(x.amountOut),h.amountCalculated=h.amountCalculated.add(x.amountIn.add(x.feeAmount))),h.sqrtPriceX64.eq(x.sqrtPriceNextX64)){if(x.initialized){let V=G.liquidityNet;s&&(V=V.mul(Ee)),h.liquidity=O.addDelta(h.liquidity,V)}R=x.tickNext!=h.tick&&!s&&B.startTickIndex===x.tickNext,h.tick=s?x.tickNext-1:x.tickNext}else if(h.sqrtPriceX64!=x.sqrtPriceStartX64){let V=N.getTickFromSqrtPriceX64(h.sqrtPriceX64);R=V!=h.tick&&!s&&B.startTickIndex===V,h.tick=V}++T}try{let{nextStartIndex:x,isExist:q}=F.nextInitializedTickArray(h.tick,l,s,i,o);q&&f!==x&&(h.accounts.push(le(e,t,x).publicKey),f=x)}catch{}return{amountCalculated:h.amountCalculated,feeAmount:h.feeAmount,sqrtPriceX64:h.sqrtPriceX64,liquidity:h.liquidity,tickCurrent:h.tick,accounts:h.accounts}}static swapStepCompute(e,t,n,i,o){let s={sqrtPriceX64Next:new C(0),amountIn:new C(0),amountOut:new C(0),feeAmount:new C(0)},a=e.gte(t),u=i.gte(Z);if(u){let l=S.mulDivFloor(i,Tt.sub(new C(o.toString())),Tt);s.amountIn=a?O.getTokenAmountAFromLiquidity(t,e,n,!0):O.getTokenAmountBFromLiquidity(e,t,n,!0),l.gte(s.amountIn)?s.sqrtPriceX64Next=t:s.sqrtPriceX64Next=N.getNextSqrtPriceX64FromInput(e,n,l,a)}else s.amountOut=a?O.getTokenAmountBFromLiquidity(t,e,n,!1):O.getTokenAmountAFromLiquidity(e,t,n,!1),i.mul(Ee).gte(s.amountOut)?s.sqrtPriceX64Next=t:s.sqrtPriceX64Next=N.getNextSqrtPriceX64FromOutput(e,n,i.mul(Ee),a);let c=t.eq(s.sqrtPriceX64Next);return a?(c&&u||(s.amountIn=O.getTokenAmountAFromLiquidity(s.sqrtPriceX64Next,e,n,!0)),c&&!u||(s.amountOut=O.getTokenAmountBFromLiquidity(s.sqrtPriceX64Next,e,n,!1))):(s.amountIn=c&&u?s.amountIn:O.getTokenAmountBFromLiquidity(e,s.sqrtPriceX64Next,n,!0),s.amountOut=c&&!u?s.amountOut:O.getTokenAmountAFromLiquidity(e,s.sqrtPriceX64Next,n,!1)),!u&&s.amountOut.gt(i.mul(Ee))&&(s.amountOut=i.mul(Ee)),u&&!s.sqrtPriceX64Next.eq(t)?s.feeAmount=i.sub(s.amountIn):s.feeAmount=S.mulDivCeil(s.amountIn,new C(o),Tt.sub(new C(o))),[s.sqrtPriceX64Next,s.amountIn,s.amountOut,s.feeAmount]}};export{O as LiquidityMath,S as MathUtil,N as SqrtPriceMath,Ye as SwapMath,He as TickMath};
//# sourceMappingURL=math.mjs.map