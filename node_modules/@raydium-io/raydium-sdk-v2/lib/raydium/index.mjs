var Za=Object.defineProperty,Ja=Object.defineProperties;var $a=Object.getOwnPropertyDescriptors;var yr=Object.getOwnPropertySymbols;var Vo=Object.prototype.hasOwnProperty,Eo=Object.prototype.propertyIsEnumerable;var _o=(r,e,t)=>e in r?Za(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,M=(r,e)=>{for(var t in e||(e={}))Vo.call(e,t)&&_o(r,t,e[t]);if(yr)for(var t of yr(e))Eo.call(e,t)&&_o(r,t,e[t]);return r},D=(r,e)=>Ja(r,$a(e));var Ne=(r,e)=>{var t={};for(var n in r)Vo.call(r,n)&&e.indexOf(n)<0&&(t[n]=r[n]);if(r!=null&&yr)for(var n of yr(r))e.indexOf(n)<0&&Eo.call(r,n)&&(t[n]=r[n]);return t};import{merge as Km}from"lodash";import Cc from"axios";import{get as Fo,set as eu}from"lodash";import Wo from"dayjs";import tu from"dayjs/plugin/utc";Wo.extend(tu);var si=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Wo().utc().format("YYYY/MM/DD HH:mm:ss UTC")}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},vo={},nu={};function oe(r){let e=Fo(vo,r);if(!e){let t=Fo(nu,r);e=new si({name:r,logLevel:t}),eu(vo,r,e)}return e}import{PublicKey as pc}from"@solana/web3.js";import fc from"bn.js";import lc from"big.js";import Rr from"bn.js";import Ce from"bn.js";var cn=9e15,Ft=1e9,ai="0123456789abcdef",gr="2.3025850929940456840179914546843642076011014886287729760333279009675726096773524802359972050895982983419677840422862486334095254650828067566662873690987816894829072083255546808437998948262331985283935053089653777326288461633662222876982198867465436674744042432743651550489343149393914796194044002221051017141748003688084012647080685567743216228355220114804663715659121373450747856947683463616792101806445070648000277502684916746550586856935673420670581136429224554405758925724208241314695689016758940256776311356919292033376587141660230105703089634572075440370847469940168269282808481184289314848524948644871927809676271275775397027668605952496716674183485704422507197965004714951050492214776567636938662976979522110718264549734772662425709429322582798502585509785265383207606726317164309505995087807523710333101197857547331541421808427543863591778117054309827482385045648019095610299291824318237525357709750539565187697510374970888692180205189339507238539205144634197265287286965110862571492198849978748873771345686209167058",wr="3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632789",ui={precision:20,rounding:4,modulo:1,toExpNeg:-7,toExpPos:21,minE:-cn,maxE:cn,crypto:!1},Go,St,J=!0,Ar="[DecimalError] ",Et=Ar+"Invalid argument: ",Xo=Ar+"Precision limit exceeded",zo=Ar+"crypto unavailable",Yo="[object Decimal]",Fe=Math.floor,Be=Math.pow,ru=/^0b([01]+(\.[01]*)?|\.[01]+)(p[+-]?\d+)?$/i,iu=/^0x([0-9a-f]+(\.[0-9a-f]*)?|\.[0-9a-f]+)(p[+-]?\d+)?$/i,ou=/^0o([0-7]+(\.[0-7]*)?|\.[0-7]+)(p[+-]?\d+)?$/i,Qo=/^(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,ct=1e7,Y=7,su=9007199254740991,au=gr.length-1,ci=wr.length-1,S={toStringTag:Yo};S.absoluteValue=S.abs=function(){var r=new this.constructor(this);return r.s<0&&(r.s=1),U(r)};S.ceil=function(){return U(new this.constructor(this),this.e+1,2)};S.clampedTo=S.clamp=function(r,e){var t,n=this,i=n.constructor;if(r=new i(r),e=new i(e),!r.s||!e.s)return new i(NaN);if(r.gt(e))throw Error(Et+e);return t=n.cmp(r),t<0?r:n.cmp(e)>0?e:new i(n)};S.comparedTo=S.cmp=function(r){var e,t,n,i,o=this,s=o.d,a=(r=new o.constructor(r)).d,u=o.s,c=r.s;if(!s||!a)return!u||!c?NaN:u!==c?u:s===a?0:!s^u<0?1:-1;if(!s[0]||!a[0])return s[0]?u:a[0]?-c:0;if(u!==c)return u;if(o.e!==r.e)return o.e>r.e^u<0?1:-1;for(n=s.length,i=a.length,e=0,t=n<i?n:i;e<t;++e)if(s[e]!==a[e])return s[e]>a[e]^u<0?1:-1;return n===i?0:n>i^u<0?1:-1};S.cosine=S.cos=function(){var r,e,t=this,n=t.constructor;return t.d?t.d[0]?(r=n.precision,e=n.rounding,n.precision=r+Math.max(t.e,t.sd())+Y,n.rounding=1,t=uu(n,$o(n,t)),n.precision=r,n.rounding=e,U(St==2||St==3?t.neg():t,r,e,!0)):new n(1):new n(NaN)};S.cubeRoot=S.cbrt=function(){var r,e,t,n,i,o,s,a,u,c,l=this,m=l.constructor;if(!l.isFinite()||l.isZero())return new m(l);for(J=!1,o=l.s*Be(l.s*l,1/3),!o||Math.abs(o)==1/0?(t=Me(l.d),r=l.e,(o=(r-t.length+1)%3)&&(t+=o==1||o==-2?"0":"00"),o=Be(t,1/3),r=Fe((r+1)/3)-(r%3==(r<0?-1:2)),o==1/0?t="5e"+r:(t=o.toExponential(),t=t.slice(0,t.indexOf("e")+1)+r),n=new m(t),n.s=l.s):n=new m(o.toString()),s=(r=m.precision)+3;;)if(a=n,u=a.times(a).times(a),c=u.plus(l),n=be(c.plus(l).times(a),c.plus(u),s+2,1),Me(a.d).slice(0,s)===(t=Me(n.d)).slice(0,s))if(t=t.slice(s-3,s+1),t=="9999"||!i&&t=="4999"){if(!i&&(U(a,r+1,0),a.times(a).times(a).eq(l))){n=a;break}s+=4,i=1}else{(!+t||!+t.slice(1)&&t.charAt(0)=="5")&&(U(n,r+1,1),e=!n.times(n).times(n).eq(l));break}return J=!0,U(n,r,m.rounding,e)};S.decimalPlaces=S.dp=function(){var r,e=this.d,t=NaN;if(e){if(r=e.length-1,t=(r-Fe(this.e/Y))*Y,r=e[r],r)for(;r%10==0;r/=10)t--;t<0&&(t=0)}return t};S.dividedBy=S.div=function(r){return be(this,new this.constructor(r))};S.dividedToIntegerBy=S.divToInt=function(r){var e=this,t=e.constructor;return U(be(e,new t(r),0,1,1),t.precision,t.rounding)};S.equals=S.eq=function(r){return this.cmp(r)===0};S.floor=function(){return U(new this.constructor(this),this.e+1,3)};S.greaterThan=S.gt=function(r){return this.cmp(r)>0};S.greaterThanOrEqualTo=S.gte=function(r){var e=this.cmp(r);return e==1||e===0};S.hyperbolicCosine=S.cosh=function(){var r,e,t,n,i,o=this,s=o.constructor,a=new s(1);if(!o.isFinite())return new s(o.s?1/0:NaN);if(o.isZero())return a;t=s.precision,n=s.rounding,s.precision=t+Math.max(o.e,o.sd())+4,s.rounding=1,i=o.d.length,i<32?(r=Math.ceil(i/3),e=(1/Pr(4,r)).toString()):(r=16,e="2.3283064365386962890625e-10"),o=ln(s,1,o.times(e),new s(1),!0);for(var u,c=r,l=new s(8);c--;)u=o.times(o),o=a.minus(u.times(l.minus(u.times(l))));return U(o,s.precision=t,s.rounding=n,!0)};S.hyperbolicSine=S.sinh=function(){var r,e,t,n,i=this,o=i.constructor;if(!i.isFinite()||i.isZero())return new o(i);if(e=o.precision,t=o.rounding,o.precision=e+Math.max(i.e,i.sd())+4,o.rounding=1,n=i.d.length,n<3)i=ln(o,2,i,i,!0);else{r=1.4*Math.sqrt(n),r=r>16?16:r|0,i=i.times(1/Pr(5,r)),i=ln(o,2,i,i,!0);for(var s,a=new o(5),u=new o(16),c=new o(20);r--;)s=i.times(i),i=i.times(a.plus(s.times(u.times(s).plus(c))))}return o.precision=e,o.rounding=t,U(i,e,t,!0)};S.hyperbolicTangent=S.tanh=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+7,n.rounding=1,be(t.sinh(),t.cosh(),n.precision=r,n.rounding=e)):new n(t.s)};S.inverseCosine=S.acos=function(){var r,e=this,t=e.constructor,n=e.abs().cmp(1),i=t.precision,o=t.rounding;return n!==-1?n===0?e.isNeg()?ut(t,i,o):new t(0):new t(NaN):e.isZero()?ut(t,i+4,o).times(.5):(t.precision=i+6,t.rounding=1,e=e.asin(),r=ut(t,i+4,o).times(.5),t.precision=i,t.rounding=o,r.minus(e))};S.inverseHyperbolicCosine=S.acosh=function(){var r,e,t=this,n=t.constructor;return t.lte(1)?new n(t.eq(1)?0:NaN):t.isFinite()?(r=n.precision,e=n.rounding,n.precision=r+Math.max(Math.abs(t.e),t.sd())+4,n.rounding=1,J=!1,t=t.times(t).minus(1).sqrt().plus(t),J=!0,n.precision=r,n.rounding=e,t.ln()):new n(t)};S.inverseHyperbolicSine=S.asinh=function(){var r,e,t=this,n=t.constructor;return!t.isFinite()||t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+2*Math.max(Math.abs(t.e),t.sd())+6,n.rounding=1,J=!1,t=t.times(t).plus(1).sqrt().plus(t),J=!0,n.precision=r,n.rounding=e,t.ln())};S.inverseHyperbolicTangent=S.atanh=function(){var r,e,t,n,i=this,o=i.constructor;return i.isFinite()?i.e>=0?new o(i.abs().eq(1)?i.s/0:i.isZero()?i:NaN):(r=o.precision,e=o.rounding,n=i.sd(),Math.max(n,r)<2*-i.e-1?U(new o(i),r,e,!0):(o.precision=t=n-i.e,i=be(i.plus(1),new o(1).minus(i),t+r,1),o.precision=r+4,o.rounding=1,i=i.ln(),o.precision=r,o.rounding=e,i.times(.5))):new o(NaN)};S.inverseSine=S.asin=function(){var r,e,t,n,i=this,o=i.constructor;return i.isZero()?new o(i):(e=i.abs().cmp(1),t=o.precision,n=o.rounding,e!==-1?e===0?(r=ut(o,t+4,n).times(.5),r.s=i.s,r):new o(NaN):(o.precision=t+6,o.rounding=1,i=i.div(new o(1).minus(i.times(i)).sqrt().plus(1)).atan(),o.precision=t,o.rounding=n,i.times(2)))};S.inverseTangent=S.atan=function(){var r,e,t,n,i,o,s,a,u,c=this,l=c.constructor,m=l.precision,p=l.rounding;if(c.isFinite()){if(c.isZero())return new l(c);if(c.abs().eq(1)&&m+4<=ci)return s=ut(l,m+4,p).times(.25),s.s=c.s,s}else{if(!c.s)return new l(NaN);if(m+4<=ci)return s=ut(l,m+4,p).times(.5),s.s=c.s,s}for(l.precision=a=m+10,l.rounding=1,t=Math.min(28,a/Y+2|0),r=t;r;--r)c=c.div(c.times(c).plus(1).sqrt().plus(1));for(J=!1,e=Math.ceil(a/Y),n=1,u=c.times(c),s=new l(c),i=c;r!==-1;)if(i=i.times(u),o=s.minus(i.div(n+=2)),i=i.times(u),s=o.plus(i.div(n+=2)),s.d[e]!==void 0)for(r=e;s.d[r]===o.d[r]&&r--;);return t&&(s=s.times(2<<t-1)),J=!0,U(s,l.precision=m,l.rounding=p,!0)};S.isFinite=function(){return!!this.d};S.isInteger=S.isInt=function(){return!!this.d&&Fe(this.e/Y)>this.d.length-2};S.isNaN=function(){return!this.s};S.isNegative=S.isNeg=function(){return this.s<0};S.isPositive=S.isPos=function(){return this.s>0};S.isZero=function(){return!!this.d&&this.d[0]===0};S.lessThan=S.lt=function(r){return this.cmp(r)<0};S.lessThanOrEqualTo=S.lte=function(r){return this.cmp(r)<1};S.logarithm=S.log=function(r){var e,t,n,i,o,s,a,u,c=this,l=c.constructor,m=l.precision,p=l.rounding,d=5;if(r==null)r=new l(10),e=!0;else{if(r=new l(r),t=r.d,r.s<0||!t||!t[0]||r.eq(1))return new l(NaN);e=r.eq(10)}if(t=c.d,c.s<0||!t||!t[0]||c.eq(1))return new l(t&&!t[0]?-1/0:c.s!=1?NaN:t?0:1/0);if(e)if(t.length>1)o=!0;else{for(i=t[0];i%10===0;)i/=10;o=i!==1}if(J=!1,a=m+d,s=Vt(c,a),n=e?kr(l,a+10):Vt(r,a),u=be(s,n,a,1),Kn(u.d,i=m,p))do if(a+=10,s=Vt(c,a),n=e?kr(l,a+10):Vt(r,a),u=be(s,n,a,1),!o){+Me(u.d).slice(i+1,i+15)+1==1e14&&(u=U(u,m+1,0));break}while(Kn(u.d,i+=10,p));return J=!0,U(u,m,p)};S.minus=S.sub=function(r){var e,t,n,i,o,s,a,u,c,l,m,p,d=this,y=d.constructor;if(r=new y(r),!d.d||!r.d)return!d.s||!r.s?r=new y(NaN):d.d?r.s=-r.s:r=new y(r.d||d.s!==r.s?d:NaN),r;if(d.s!=r.s)return r.s=-r.s,d.plus(r);if(c=d.d,p=r.d,a=y.precision,u=y.rounding,!c[0]||!p[0]){if(p[0])r.s=-r.s;else if(c[0])r=new y(d);else return new y(u===3?-0:0);return J?U(r,a,u):r}if(t=Fe(r.e/Y),l=Fe(d.e/Y),c=c.slice(),o=l-t,o){for(m=o<0,m?(e=c,o=-o,s=p.length):(e=p,t=l,s=c.length),n=Math.max(Math.ceil(a/Y),s)+2,o>n&&(o=n,e.length=1),e.reverse(),n=o;n--;)e.push(0);e.reverse()}else{for(n=c.length,s=p.length,m=n<s,m&&(s=n),n=0;n<s;n++)if(c[n]!=p[n]){m=c[n]<p[n];break}o=0}for(m&&(e=c,c=p,p=e,r.s=-r.s),s=c.length,n=p.length-s;n>0;--n)c[s++]=0;for(n=p.length;n>o;){if(c[--n]<p[n]){for(i=n;i&&c[--i]===0;)c[i]=ct-1;--c[i],c[n]+=ct}c[n]-=p[n]}for(;c[--s]===0;)c.pop();for(;c[0]===0;c.shift())--t;return c[0]?(r.d=c,r.e=hr(c,t),J?U(r,a,u):r):new y(u===3?-0:0)};S.modulo=S.mod=function(r){var e,t=this,n=t.constructor;return r=new n(r),!t.d||!r.s||r.d&&!r.d[0]?new n(NaN):!r.d||t.d&&!t.d[0]?U(new n(t),n.precision,n.rounding):(J=!1,n.modulo==9?(e=be(t,r.abs(),0,3,1),e.s*=r.s):e=be(t,r,0,n.modulo,1),e=e.times(r),J=!0,t.minus(e))};S.naturalExponential=S.exp=function(){return li(this)};S.naturalLogarithm=S.ln=function(){return Vt(this)};S.negated=S.neg=function(){var r=new this.constructor(this);return r.s=-r.s,U(r)};S.plus=S.add=function(r){var e,t,n,i,o,s,a,u,c,l,m=this,p=m.constructor;if(r=new p(r),!m.d||!r.d)return!m.s||!r.s?r=new p(NaN):m.d||(r=new p(r.d||m.s===r.s?m:NaN)),r;if(m.s!=r.s)return r.s=-r.s,m.minus(r);if(c=m.d,l=r.d,a=p.precision,u=p.rounding,!c[0]||!l[0])return l[0]||(r=new p(m)),J?U(r,a,u):r;if(o=Fe(m.e/Y),n=Fe(r.e/Y),c=c.slice(),i=o-n,i){for(i<0?(t=c,i=-i,s=l.length):(t=l,n=o,s=c.length),o=Math.ceil(a/Y),s=o>s?o+1:s+1,i>s&&(i=s,t.length=1),t.reverse();i--;)t.push(0);t.reverse()}for(s=c.length,i=l.length,s-i<0&&(i=s,t=l,l=c,c=t),e=0;i;)e=(c[--i]=c[i]+l[i]+e)/ct|0,c[i]%=ct;for(e&&(c.unshift(e),++n),s=c.length;c[--s]==0;)c.pop();return r.d=c,r.e=hr(c,n),J?U(r,a,u):r};S.precision=S.sd=function(r){var e,t=this;if(r!==void 0&&r!==!!r&&r!==1&&r!==0)throw Error(Et+r);return t.d?(e=jo(t.d),r&&t.e+1>e&&(e=t.e+1)):e=NaN,e};S.round=function(){var r=this,e=r.constructor;return U(new e(r),r.e+1,e.rounding)};S.sine=S.sin=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+Math.max(t.e,t.sd())+Y,n.rounding=1,t=lu(n,$o(n,t)),n.precision=r,n.rounding=e,U(St>2?t.neg():t,r,e,!0)):new n(NaN)};S.squareRoot=S.sqrt=function(){var r,e,t,n,i,o,s=this,a=s.d,u=s.e,c=s.s,l=s.constructor;if(c!==1||!a||!a[0])return new l(!c||c<0&&(!a||a[0])?NaN:a?s:1/0);for(J=!1,c=Math.sqrt(+s),c==0||c==1/0?(e=Me(a),(e.length+u)%2==0&&(e+="0"),c=Math.sqrt(e),u=Fe((u+1)/2)-(u<0||u%2),c==1/0?e="5e"+u:(e=c.toExponential(),e=e.slice(0,e.indexOf("e")+1)+u),n=new l(e)):n=new l(c.toString()),t=(u=l.precision)+3;;)if(o=n,n=o.plus(be(s,o,t+2,1)).times(.5),Me(o.d).slice(0,t)===(e=Me(n.d)).slice(0,t))if(e=e.slice(t-3,t+1),e=="9999"||!i&&e=="4999"){if(!i&&(U(o,u+1,0),o.times(o).eq(s))){n=o;break}t+=4,i=1}else{(!+e||!+e.slice(1)&&e.charAt(0)=="5")&&(U(n,u+1,1),r=!n.times(n).eq(s));break}return J=!0,U(n,u,l.rounding,r)};S.tangent=S.tan=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+10,n.rounding=1,t=t.sin(),t.s=1,t=be(t,new n(1).minus(t.times(t)).sqrt(),r+10,0),n.precision=r,n.rounding=e,U(St==2||St==4?t.neg():t,r,e,!0)):new n(NaN)};S.times=S.mul=function(r){var e,t,n,i,o,s,a,u,c,l=this,m=l.constructor,p=l.d,d=(r=new m(r)).d;if(r.s*=l.s,!p||!p[0]||!d||!d[0])return new m(!r.s||p&&!p[0]&&!d||d&&!d[0]&&!p?NaN:!p||!d?r.s/0:r.s*0);for(t=Fe(l.e/Y)+Fe(r.e/Y),u=p.length,c=d.length,u<c&&(o=p,p=d,d=o,s=u,u=c,c=s),o=[],s=u+c,n=s;n--;)o.push(0);for(n=c;--n>=0;){for(e=0,i=u+n;i>n;)a=o[i]+d[n]*p[i-n-1]+e,o[i--]=a%ct|0,e=a/ct|0;o[i]=(o[i]+e)%ct|0}for(;!o[--s];)o.pop();return e?++t:o.shift(),r.d=o,r.e=hr(o,t),J?U(r,m.precision,m.rounding):r};S.toBinary=function(r,e){return di(this,2,r,e)};S.toDecimalPlaces=S.toDP=function(r,e){var t=this,n=t.constructor;return t=new n(t),r===void 0?t:(Qe(r,0,Ft),e===void 0?e=n.rounding:Qe(e,0,8),U(t,r+t.e+1,e))};S.toExponential=function(r,e){var t,n=this,i=n.constructor;return r===void 0?t=bt(n,!0):(Qe(r,0,Ft),e===void 0?e=i.rounding:Qe(e,0,8),n=U(new i(n),r+1,e),t=bt(n,!0,r+1)),n.isNeg()&&!n.isZero()?"-"+t:t};S.toFixed=function(r,e){var t,n,i=this,o=i.constructor;return r===void 0?t=bt(i):(Qe(r,0,Ft),e===void 0?e=o.rounding:Qe(e,0,8),n=U(new o(i),r+i.e+1,e),t=bt(n,!1,r+n.e+1)),i.isNeg()&&!i.isZero()?"-"+t:t};S.toFraction=function(r){var e,t,n,i,o,s,a,u,c,l,m,p,d=this,y=d.d,f=d.constructor;if(!y)return new f(d);if(c=t=new f(1),n=u=new f(0),e=new f(n),o=e.e=jo(y)-d.e-1,s=o%Y,e.d[0]=Be(10,s<0?Y+s:s),r==null)r=o>0?e:c;else{if(a=new f(r),!a.isInt()||a.lt(c))throw Error(Et+a);r=a.gt(e)?o>0?e:c:a}for(J=!1,a=new f(Me(y)),l=f.precision,f.precision=o=y.length*Y*2;m=be(a,e,0,1,1),i=t.plus(m.times(n)),i.cmp(r)!=1;)t=n,n=i,i=c,c=u.plus(m.times(i)),u=i,i=e,e=a.minus(m.times(i)),a=i;return i=be(r.minus(t),n,0,1,1),u=u.plus(i.times(c)),t=t.plus(i.times(n)),u.s=c.s=d.s,p=be(c,n,o,1).minus(d).abs().cmp(be(u,t,o,1).minus(d).abs())<1?[c,n]:[u,t],f.precision=l,J=!0,p};S.toHexadecimal=S.toHex=function(r,e){return di(this,16,r,e)};S.toNearest=function(r,e){var t=this,n=t.constructor;if(t=new n(t),r==null){if(!t.d)return t;r=new n(1),e=n.rounding}else{if(r=new n(r),e===void 0?e=n.rounding:Qe(e,0,8),!t.d)return r.s?t:r;if(!r.d)return r.s&&(r.s=t.s),r}return r.d[0]?(J=!1,t=be(t,r,0,e,1).times(r),J=!0,U(t)):(r.s=t.s,t=r),t};S.toNumber=function(){return+this};S.toOctal=function(r,e){return di(this,8,r,e)};S.toPower=S.pow=function(r){var e,t,n,i,o,s,a=this,u=a.constructor,c=+(r=new u(r));if(!a.d||!r.d||!a.d[0]||!r.d[0])return new u(Be(+a,c));if(a=new u(a),a.eq(1))return a;if(n=u.precision,o=u.rounding,r.eq(1))return U(a,n,o);if(e=Fe(r.e/Y),e>=r.d.length-1&&(t=c<0?-c:c)<=su)return i=Ho(u,a,t,n),r.s<0?new u(1).div(i):U(i,n,o);if(s=a.s,s<0){if(e<r.d.length-1)return new u(NaN);if((r.d[e]&1)==0&&(s=1),a.e==0&&a.d[0]==1&&a.d.length==1)return a.s=s,a}return t=Be(+a,c),e=t==0||!isFinite(t)?Fe(c*(Math.log("0."+Me(a.d))/Math.LN10+a.e+1)):new u(t+"").e,e>u.maxE+1||e<u.minE-1?new u(e>0?s/0:0):(J=!1,u.rounding=a.s=1,t=Math.min(12,(e+"").length),i=li(r.times(Vt(a,n+t)),n),i.d&&(i=U(i,n+5,1),Kn(i.d,n,o)&&(e=n+10,i=U(li(r.times(Vt(a,e+t)),e),e+5,1),+Me(i.d).slice(n+1,n+15)+1==1e14&&(i=U(i,n+1,0)))),i.s=s,J=!0,u.rounding=o,U(i,n,o))};S.toPrecision=function(r,e){var t,n=this,i=n.constructor;return r===void 0?t=bt(n,n.e<=i.toExpNeg||n.e>=i.toExpPos):(Qe(r,1,Ft),e===void 0?e=i.rounding:Qe(e,0,8),n=U(new i(n),r,e),t=bt(n,r<=n.e||n.e<=i.toExpNeg,r)),n.isNeg()&&!n.isZero()?"-"+t:t};S.toSignificantDigits=S.toSD=function(r,e){var t=this,n=t.constructor;return r===void 0?(r=n.precision,e=n.rounding):(Qe(r,1,Ft),e===void 0?e=n.rounding:Qe(e,0,8)),U(new n(t),r,e)};S.toString=function(){var r=this,e=r.constructor,t=bt(r,r.e<=e.toExpNeg||r.e>=e.toExpPos);return r.isNeg()&&!r.isZero()?"-"+t:t};S.truncated=S.trunc=function(){return U(new this.constructor(this),this.e+1,1)};S.valueOf=S.toJSON=function(){var r=this,e=r.constructor,t=bt(r,r.e<=e.toExpNeg||r.e>=e.toExpPos);return r.isNeg()?"-"+t:t};function Me(r){var e,t,n,i=r.length-1,o="",s=r[0];if(i>0){for(o+=s,e=1;e<i;e++)n=r[e]+"",t=Y-n.length,t&&(o+=_t(t)),o+=n;s=r[e],n=s+"",t=Y-n.length,t&&(o+=_t(t))}else if(s===0)return"0";for(;s%10===0;)s/=10;return o+s}function Qe(r,e,t){if(r!==~~r||r<e||r>t)throw Error(Et+r)}function Kn(r,e,t,n){var i,o,s,a;for(o=r[0];o>=10;o/=10)--e;return--e<0?(e+=Y,i=0):(i=Math.ceil((e+1)/Y),e%=Y),o=Be(10,Y-e),a=r[i]%o|0,n==null?e<3?(e==0?a=a/100|0:e==1&&(a=a/10|0),s=t<4&&a==99999||t>3&&a==49999||a==5e4||a==0):s=(t<4&&a+1==o||t>3&&a+1==o/2)&&(r[i+1]/o/100|0)==Be(10,e-2)-1||(a==o/2||a==0)&&(r[i+1]/o/100|0)==0:e<4?(e==0?a=a/1e3|0:e==1?a=a/100|0:e==2&&(a=a/10|0),s=(n||t<4)&&a==9999||!n&&t>3&&a==4999):s=((n||t<4)&&a+1==o||!n&&t>3&&a+1==o/2)&&(r[i+1]/o/1e3|0)==Be(10,e-3)-1,s}function br(r,e,t){for(var n,i=[0],o,s=0,a=r.length;s<a;){for(o=i.length;o--;)i[o]*=e;for(i[0]+=ai.indexOf(r.charAt(s++)),n=0;n<i.length;n++)i[n]>t-1&&(i[n+1]===void 0&&(i[n+1]=0),i[n+1]+=i[n]/t|0,i[n]%=t)}return i.reverse()}function uu(r,e){var t,n,i;if(e.isZero())return e;n=e.d.length,n<32?(t=Math.ceil(n/3),i=(1/Pr(4,t)).toString()):(t=16,i="2.3283064365386962890625e-10"),r.precision+=t,e=ln(r,1,e.times(i),new r(1));for(var o=t;o--;){var s=e.times(e);e=s.times(s).minus(s).times(8).plus(1)}return r.precision-=t,e}var be=function(){function r(n,i,o){var s,a=0,u=n.length;for(n=n.slice();u--;)s=n[u]*i+a,n[u]=s%o|0,a=s/o|0;return a&&n.unshift(a),n}function e(n,i,o,s){var a,u;if(o!=s)u=o>s?1:-1;else for(a=u=0;a<o;a++)if(n[a]!=i[a]){u=n[a]>i[a]?1:-1;break}return u}function t(n,i,o,s){for(var a=0;o--;)n[o]-=a,a=n[o]<i[o]?1:0,n[o]=a*s+n[o]-i[o];for(;!n[0]&&n.length>1;)n.shift()}return function(n,i,o,s,a,u){var c,l,m,p,d,y,f,b,w,h,A,P,T,I,x,O,N,L,E,Z,W=n.constructor,ee=n.s==i.s?1:-1,Q=n.d,te=i.d;if(!Q||!Q[0]||!te||!te[0])return new W(!n.s||!i.s||(Q?te&&Q[0]==te[0]:!te)?NaN:Q&&Q[0]==0||!te?ee*0:ee/0);for(u?(d=1,l=n.e-i.e):(u=ct,d=Y,l=Fe(n.e/d)-Fe(i.e/d)),E=te.length,N=Q.length,w=new W(ee),h=w.d=[],m=0;te[m]==(Q[m]||0);m++);if(te[m]>(Q[m]||0)&&l--,o==null?(I=o=W.precision,s=W.rounding):a?I=o+(n.e-i.e)+1:I=o,I<0)h.push(1),y=!0;else{if(I=I/d+2|0,m=0,E==1){for(p=0,te=te[0],I++;(m<N||p)&&I--;m++)x=p*u+(Q[m]||0),h[m]=x/te|0,p=x%te|0;y=p||m<N}else{for(p=u/(te[0]+1)|0,p>1&&(te=r(te,p,u),Q=r(Q,p,u),E=te.length,N=Q.length),O=E,A=Q.slice(0,E),P=A.length;P<E;)A[P++]=0;Z=te.slice(),Z.unshift(0),L=te[0],te[1]>=u/2&&++L;do p=0,c=e(te,A,E,P),c<0?(T=A[0],E!=P&&(T=T*u+(A[1]||0)),p=T/L|0,p>1?(p>=u&&(p=u-1),f=r(te,p,u),b=f.length,P=A.length,c=e(f,A,b,P),c==1&&(p--,t(f,E<b?Z:te,b,u))):(p==0&&(c=p=1),f=te.slice()),b=f.length,b<P&&f.unshift(0),t(A,f,P,u),c==-1&&(P=A.length,c=e(te,A,E,P),c<1&&(p++,t(A,E<P?Z:te,P,u))),P=A.length):c===0&&(p++,A=[0]),h[m++]=p,c&&A[0]?A[P++]=Q[O]||0:(A=[Q[O]],P=1);while((O++<N||A[0]!==void 0)&&I--);y=A[0]!==void 0}h[0]||h.shift()}if(d==1)w.e=l,Go=y;else{for(m=1,p=h[0];p>=10;p/=10)m++;w.e=m+l*d-1,U(w,a?o+w.e+1:o,s,y)}return w}}();function U(r,e,t,n){var i,o,s,a,u,c,l,m,p,d=r.constructor;e:if(e!=null){if(m=r.d,!m)return r;for(i=1,a=m[0];a>=10;a/=10)i++;if(o=e-i,o<0)o+=Y,s=e,l=m[p=0],u=l/Be(10,i-s-1)%10|0;else if(p=Math.ceil((o+1)/Y),a=m.length,p>=a)if(n){for(;a++<=p;)m.push(0);l=u=0,i=1,o%=Y,s=o-Y+1}else break e;else{for(l=a=m[p],i=1;a>=10;a/=10)i++;o%=Y,s=o-Y+i,u=s<0?0:l/Be(10,i-s-1)%10|0}if(n=n||e<0||m[p+1]!==void 0||(s<0?l:l%Be(10,i-s-1)),c=t<4?(u||n)&&(t==0||t==(r.s<0?3:2)):u>5||u==5&&(t==4||n||t==6&&(o>0?s>0?l/Be(10,i-s):0:m[p-1])%10&1||t==(r.s<0?8:7)),e<1||!m[0])return m.length=0,c?(e-=r.e+1,m[0]=Be(10,(Y-e%Y)%Y),r.e=-e||0):m[0]=r.e=0,r;if(o==0?(m.length=p,a=1,p--):(m.length=p+1,a=Be(10,Y-o),m[p]=s>0?(l/Be(10,i-s)%Be(10,s)|0)*a:0),c)for(;;)if(p==0){for(o=1,s=m[0];s>=10;s/=10)o++;for(s=m[0]+=a,a=1;s>=10;s/=10)a++;o!=a&&(r.e++,m[0]==ct&&(m[0]=1));break}else{if(m[p]+=a,m[p]!=ct)break;m[p--]=0,a=1}for(o=m.length;m[--o]===0;)m.pop()}return J&&(r.e>d.maxE?(r.d=null,r.e=NaN):r.e<d.minE&&(r.e=0,r.d=[0])),r}function bt(r,e,t){if(!r.isFinite())return Jo(r);var n,i=r.e,o=Me(r.d),s=o.length;return e?(t&&(n=t-s)>0?o=o.charAt(0)+"."+o.slice(1)+_t(n):s>1&&(o=o.charAt(0)+"."+o.slice(1)),o=o+(r.e<0?"e":"e+")+r.e):i<0?(o="0."+_t(-i-1)+o,t&&(n=t-s)>0&&(o+=_t(n))):i>=s?(o+=_t(i+1-s),t&&(n=t-i-1)>0&&(o=o+"."+_t(n))):((n=i+1)<s&&(o=o.slice(0,n)+"."+o.slice(n)),t&&(n=t-s)>0&&(i+1===s&&(o+="."),o+=_t(n))),o}function hr(r,e){var t=r[0];for(e*=Y;t>=10;t/=10)e++;return e}function kr(r,e,t){if(e>au)throw J=!0,t&&(r.precision=t),Error(Xo);return U(new r(gr),e,1,!0)}function ut(r,e,t){if(e>ci)throw Error(Xo);return U(new r(wr),e,t,!0)}function jo(r){var e=r.length-1,t=e*Y+1;if(e=r[e],e){for(;e%10==0;e/=10)t--;for(e=r[0];e>=10;e/=10)t++}return t}function _t(r){for(var e="";r--;)e+="0";return e}function Ho(r,e,t,n){var i,o=new r(1),s=Math.ceil(n/Y+4);for(J=!1;;){if(t%2&&(o=o.times(e),qo(o.d,s)&&(i=!0)),t=Fe(t/2),t===0){t=o.d.length-1,i&&o.d[t]===0&&++o.d[t];break}e=e.times(e),qo(e.d,s)}return J=!0,o}function Do(r){return r.d[r.d.length-1]&1}function Zo(r,e,t){for(var n,i=new r(e[0]),o=0;++o<e.length;)if(n=new r(e[o]),n.s)i[t](n)&&(i=n);else{i=n;break}return i}function li(r,e){var t,n,i,o,s,a,u,c=0,l=0,m=0,p=r.constructor,d=p.rounding,y=p.precision;if(!r.d||!r.d[0]||r.e>17)return new p(r.d?r.d[0]?r.s<0?0:1/0:1:r.s?r.s<0?0:r:0/0);for(e==null?(J=!1,u=y):u=e,a=new p(.03125);r.e>-2;)r=r.times(a),m+=5;for(n=Math.log(Be(2,m))/Math.LN10*2+5|0,u+=n,t=o=s=new p(1),p.precision=u;;){if(o=U(o.times(r),u,1),t=t.times(++l),a=s.plus(be(o,t,u,1)),Me(a.d).slice(0,u)===Me(s.d).slice(0,u)){for(i=m;i--;)s=U(s.times(s),u,1);if(e==null)if(c<3&&Kn(s.d,u-n,d,c))p.precision=u+=10,t=o=a=new p(1),l=0,c++;else return U(s,p.precision=y,d,J=!0);else return p.precision=y,s}s=a}}function Vt(r,e){var t,n,i,o,s,a,u,c,l,m,p,d=1,y=10,f=r,b=f.d,w=f.constructor,h=w.rounding,A=w.precision;if(f.s<0||!b||!b[0]||!f.e&&b[0]==1&&b.length==1)return new w(b&&!b[0]?-1/0:f.s!=1?NaN:b?0:f);if(e==null?(J=!1,l=A):l=e,w.precision=l+=y,t=Me(b),n=t.charAt(0),Math.abs(o=f.e)<15e14){for(;n<7&&n!=1||n==1&&t.charAt(1)>3;)f=f.times(r),t=Me(f.d),n=t.charAt(0),d++;o=f.e,n>1?(f=new w("0."+t),o++):f=new w(n+"."+t.slice(1))}else return c=kr(w,l+2,A).times(o+""),f=Vt(new w(n+"."+t.slice(1)),l-y).plus(c),w.precision=A,e==null?U(f,A,h,J=!0):f;for(m=f,u=s=f=be(f.minus(1),f.plus(1),l,1),p=U(f.times(f),l,1),i=3;;){if(s=U(s.times(p),l,1),c=u.plus(be(s,new w(i),l,1)),Me(c.d).slice(0,l)===Me(u.d).slice(0,l))if(u=u.times(2),o!==0&&(u=u.plus(kr(w,l+2,A).times(o+""))),u=be(u,new w(d),l,1),e==null)if(Kn(u.d,l-y,h,a))w.precision=l+=y,c=s=f=be(m.minus(1),m.plus(1),l,1),p=U(f.times(f),l,1),i=a=1;else return U(u,w.precision=A,h,J=!0);else return w.precision=A,u;u=c,i+=2}}function Jo(r){return String(r.s*r.s/0)}function mi(r,e){var t,n,i;for((t=e.indexOf("."))>-1&&(e=e.replace(".","")),(n=e.search(/e/i))>0?(t<0&&(t=n),t+=+e.slice(n+1),e=e.substring(0,n)):t<0&&(t=e.length),n=0;e.charCodeAt(n)===48;n++);for(i=e.length;e.charCodeAt(i-1)===48;--i);if(e=e.slice(n,i),e){if(i-=n,r.e=t=t-n-1,r.d=[],n=(t+1)%Y,t<0&&(n+=Y),n<i){for(n&&r.d.push(+e.slice(0,n)),i-=Y;n<i;)r.d.push(+e.slice(n,n+=Y));e=e.slice(n),n=Y-e.length}else n-=i;for(;n--;)e+="0";r.d.push(+e),J&&(r.e>r.constructor.maxE?(r.d=null,r.e=NaN):r.e<r.constructor.minE&&(r.e=0,r.d=[0]))}else r.e=0,r.d=[0];return r}function cu(r,e){var t,n,i,o,s,a,u,c,l;if(e.indexOf("_")>-1){if(e=e.replace(/(\d)_(?=\d)/g,"$1"),Qo.test(e))return mi(r,e)}else if(e==="Infinity"||e==="NaN")return+e||(r.s=NaN),r.e=NaN,r.d=null,r;if(iu.test(e))t=16,e=e.toLowerCase();else if(ru.test(e))t=2;else if(ou.test(e))t=8;else throw Error(Et+e);for(o=e.search(/p/i),o>0?(u=+e.slice(o+1),e=e.substring(2,o)):e=e.slice(2),o=e.indexOf("."),s=o>=0,n=r.constructor,s&&(e=e.replace(".",""),a=e.length,o=a-o,i=Ho(n,new n(t),o,o*2)),c=br(e,t,ct),l=c.length-1,o=l;c[o]===0;--o)c.pop();return o<0?new n(r.s*0):(r.e=hr(c,l),r.d=c,J=!1,s&&(r=be(r,i,a*4)),u&&(r=r.times(Math.abs(u)<54?Be(2,u):Cn.pow(2,u))),J=!0,r)}function lu(r,e){var t,n=e.d.length;if(n<3)return e.isZero()?e:ln(r,2,e,e);t=1.4*Math.sqrt(n),t=t>16?16:t|0,e=e.times(1/Pr(5,t)),e=ln(r,2,e,e);for(var i,o=new r(5),s=new r(16),a=new r(20);t--;)i=e.times(e),e=e.times(o.plus(i.times(s.times(i).minus(a))));return e}function ln(r,e,t,n,i){var o,s,a,u,c=1,l=r.precision,m=Math.ceil(l/Y);for(J=!1,u=t.times(t),a=new r(n);;){if(s=be(a.times(u),new r(e++*e++),l,1),a=i?n.plus(s):n.minus(s),n=be(s.times(u),new r(e++*e++),l,1),s=a.plus(n),s.d[m]!==void 0){for(o=m;s.d[o]===a.d[o]&&o--;);if(o==-1)break}o=a,a=n,n=s,s=o,c++}return J=!0,s.d.length=m+1,s}function Pr(r,e){for(var t=r;--e;)t*=r;return t}function $o(r,e){var t,n=e.s<0,i=ut(r,r.precision,1),o=i.times(.5);if(e=e.abs(),e.lte(o))return St=n?4:1,e;if(t=e.divToInt(i),t.isZero())St=n?3:2;else{if(e=e.minus(t.times(i)),e.lte(o))return St=Do(t)?n?2:3:n?4:1,e;St=Do(t)?n?1:4:n?3:2}return e.minus(i).abs()}function di(r,e,t,n){var i,o,s,a,u,c,l,m,p,d=r.constructor,y=t!==void 0;if(y?(Qe(t,1,Ft),n===void 0?n=d.rounding:Qe(n,0,8)):(t=d.precision,n=d.rounding),!r.isFinite())l=Jo(r);else{for(l=bt(r),s=l.indexOf("."),y?(i=2,e==16?t=t*4-3:e==8&&(t=t*3-2)):i=e,s>=0&&(l=l.replace(".",""),p=new d(1),p.e=l.length-s,p.d=br(bt(p),10,i),p.e=p.d.length),m=br(l,10,i),o=u=m.length;m[--u]==0;)m.pop();if(!m[0])l=y?"0p+0":"0";else{if(s<0?o--:(r=new d(r),r.d=m,r.e=o,r=be(r,p,t,n,0,i),m=r.d,o=r.e,c=Go),s=m[t],a=i/2,c=c||m[t+1]!==void 0,c=n<4?(s!==void 0||c)&&(n===0||n===(r.s<0?3:2)):s>a||s===a&&(n===4||c||n===6&&m[t-1]&1||n===(r.s<0?8:7)),m.length=t,c)for(;++m[--t]>i-1;)m[t]=0,t||(++o,m.unshift(1));for(u=m.length;!m[u-1];--u);for(s=0,l="";s<u;s++)l+=ai.charAt(m[s]);if(y){if(u>1)if(e==16||e==8){for(s=e==16?4:3,--u;u%s;u++)l+="0";for(m=br(l,i,e),u=m.length;!m[u-1];--u);for(s=1,l="1.";s<u;s++)l+=ai.charAt(m[s])}else l=l.charAt(0)+"."+l.slice(1);l=l+(o<0?"p":"p+")+o}else if(o<0){for(;++o;)l="0"+l;l="0."+l}else if(++o>u)for(o-=u;o--;)l+="0";else o<u&&(l=l.slice(0,o)+"."+l.slice(o))}l=(e==16?"0x":e==2?"0b":e==8?"0o":"")+l}return r.s<0?"-"+l:l}function qo(r,e){if(r.length>e)return r.length=e,!0}function mu(r){return new this(r).abs()}function du(r){return new this(r).acos()}function pu(r){return new this(r).acosh()}function fu(r,e){return new this(r).plus(e)}function yu(r){return new this(r).asin()}function bu(r){return new this(r).asinh()}function gu(r){return new this(r).atan()}function wu(r){return new this(r).atanh()}function ku(r,e){r=new this(r),e=new this(e);var t,n=this.precision,i=this.rounding,o=n+4;return!r.s||!e.s?t=new this(NaN):!r.d&&!e.d?(t=ut(this,o,1).times(e.s>0?.25:.75),t.s=r.s):!e.d||r.isZero()?(t=e.s<0?ut(this,n,i):new this(0),t.s=r.s):!r.d||e.isZero()?(t=ut(this,o,1).times(.5),t.s=r.s):e.s<0?(this.precision=o,this.rounding=1,t=this.atan(be(r,e,o,1)),e=ut(this,o,1),this.precision=n,this.rounding=i,t=r.s<0?t.minus(e):t.plus(e)):t=this.atan(be(r,e,o,1)),t}function Au(r){return new this(r).cbrt()}function hu(r){return U(r=new this(r),r.e+1,2)}function Pu(r,e,t){return new this(r).clamp(e,t)}function Tu(r){if(!r||typeof r!="object")throw Error(Ar+"Object expected");var e,t,n,i=r.defaults===!0,o=["precision",1,Ft,"rounding",0,8,"toExpNeg",-cn,0,"toExpPos",0,cn,"maxE",0,cn,"minE",-cn,0,"modulo",0,9];for(e=0;e<o.length;e+=3)if(t=o[e],i&&(this[t]=ui[t]),(n=r[t])!==void 0)if(Fe(n)===n&&n>=o[e+1]&&n<=o[e+2])this[t]=n;else throw Error(Et+t+": "+n);if(t="crypto",i&&(this[t]=ui[t]),(n=r[t])!==void 0)if(n===!0||n===!1||n===0||n===1)if(n)if(typeof crypto<"u"&&crypto&&(crypto.getRandomValues||crypto.randomBytes))this[t]=!0;else throw Error(zo);else this[t]=!1;else throw Error(Et+t+": "+n);return this}function Iu(r){return new this(r).cos()}function xu(r){return new this(r).cosh()}function es(r){var e,t,n;function i(o){var s,a,u,c=this;if(!(c instanceof i))return new i(o);if(c.constructor=i,Uo(o)){c.s=o.s,J?!o.d||o.e>i.maxE?(c.e=NaN,c.d=null):o.e<i.minE?(c.e=0,c.d=[0]):(c.e=o.e,c.d=o.d.slice()):(c.e=o.e,c.d=o.d?o.d.slice():o.d);return}if(u=typeof o,u==="number"){if(o===0){c.s=1/o<0?-1:1,c.e=0,c.d=[0];return}if(o<0?(o=-o,c.s=-1):c.s=1,o===~~o&&o<1e7){for(s=0,a=o;a>=10;a/=10)s++;J?s>i.maxE?(c.e=NaN,c.d=null):s<i.minE?(c.e=0,c.d=[0]):(c.e=s,c.d=[o]):(c.e=s,c.d=[o]);return}else if(o*0!==0){o||(c.s=NaN),c.e=NaN,c.d=null;return}return mi(c,o.toString())}else if(u!=="string")throw Error(Et+o);return(a=o.charCodeAt(0))===45?(o=o.slice(1),c.s=-1):(a===43&&(o=o.slice(1)),c.s=1),Qo.test(o)?mi(c,o):cu(c,o)}if(i.prototype=S,i.ROUND_UP=0,i.ROUND_DOWN=1,i.ROUND_CEIL=2,i.ROUND_FLOOR=3,i.ROUND_HALF_UP=4,i.ROUND_HALF_DOWN=5,i.ROUND_HALF_EVEN=6,i.ROUND_HALF_CEIL=7,i.ROUND_HALF_FLOOR=8,i.EUCLID=9,i.config=i.set=Tu,i.clone=es,i.isDecimal=Uo,i.abs=mu,i.acos=du,i.acosh=pu,i.add=fu,i.asin=yu,i.asinh=bu,i.atan=gu,i.atanh=wu,i.atan2=ku,i.cbrt=Au,i.ceil=hu,i.clamp=Pu,i.cos=Iu,i.cosh=xu,i.div=Bu,i.exp=Su,i.floor=Ku,i.hypot=Cu,i.ln=Ru,i.log=Lu,i.log10=Nu,i.log2=Ou,i.max=Mu,i.min=_u,i.mod=Vu,i.mul=Eu,i.pow=Fu,i.random=vu,i.round=Wu,i.sign=Du,i.sin=qu,i.sinh=Uu,i.sqrt=Gu,i.sub=Xu,i.sum=zu,i.tan=Yu,i.tanh=Qu,i.trunc=ju,r===void 0&&(r={}),r&&r.defaults!==!0)for(n=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"],e=0;e<n.length;)r.hasOwnProperty(t=n[e++])||(r[t]=this[t]);return i.config(r),i}function Bu(r,e){return new this(r).div(e)}function Su(r){return new this(r).exp()}function Ku(r){return U(r=new this(r),r.e+1,3)}function Cu(){var r,e,t=new this(0);for(J=!1,r=0;r<arguments.length;)if(e=new this(arguments[r++]),e.d)t.d&&(t=t.plus(e.times(e)));else{if(e.s)return J=!0,new this(1/0);t=e}return J=!0,t.sqrt()}function Uo(r){return r instanceof Cn||r&&r.toStringTag===Yo||!1}function Ru(r){return new this(r).ln()}function Lu(r,e){return new this(r).log(e)}function Ou(r){return new this(r).log(2)}function Nu(r){return new this(r).log(10)}function Mu(){return Zo(this,arguments,"lt")}function _u(){return Zo(this,arguments,"gt")}function Vu(r,e){return new this(r).mod(e)}function Eu(r,e){return new this(r).mul(e)}function Fu(r,e){return new this(r).pow(e)}function vu(r){var e,t,n,i,o=0,s=new this(1),a=[];if(r===void 0?r=this.precision:Qe(r,1,Ft),n=Math.ceil(r/Y),this.crypto)if(crypto.getRandomValues)for(e=crypto.getRandomValues(new Uint32Array(n));o<n;)i=e[o],i>=429e7?e[o]=crypto.getRandomValues(new Uint32Array(1))[0]:a[o++]=i%1e7;else if(crypto.randomBytes){for(e=crypto.randomBytes(n*=4);o<n;)i=e[o]+(e[o+1]<<8)+(e[o+2]<<16)+((e[o+3]&127)<<24),i>=214e7?crypto.randomBytes(4).copy(e,o):(a.push(i%1e7),o+=4);o=n/4}else throw Error(zo);else for(;o<n;)a[o++]=Math.random()*1e7|0;for(n=a[--o],r%=Y,n&&r&&(i=Be(10,Y-r),a[o]=(n/i|0)*i);a[o]===0;o--)a.pop();if(o<0)t=0,a=[0];else{for(t=-1;a[0]===0;t-=Y)a.shift();for(n=1,i=a[0];i>=10;i/=10)n++;n<Y&&(t-=Y-n)}return s.e=t,s.d=a,s}function Wu(r){return U(r=new this(r),r.e+1,this.rounding)}function Du(r){return r=new this(r),r.d?r.d[0]?r.s:0*r.s:r.s||NaN}function qu(r){return new this(r).sin()}function Uu(r){return new this(r).sinh()}function Gu(r){return new this(r).sqrt()}function Xu(r,e){return new this(r).sub(e)}function zu(){var r=0,e=arguments,t=new this(e[r]);for(J=!1;t.s&&++r<e.length;)t=t.plus(e[r]);return J=!0,U(t,this.precision,this.rounding)}function Yu(r){return new this(r).tan()}function Qu(r){return new this(r).tanh()}function ju(r){return U(r=new this(r),r.e+1,1)}S[Symbol.for("nodejs.util.inspect.custom")]=S.toString;S[Symbol.toStringTag]="Decimal";var Cn=S.constructor=es(ui);gr=new Cn(gr);wr=new Cn(wr);var v=Cn;import{PublicKey as bi}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Hu}from"@solana/spl-token";import{PublicKey as he,SystemProgram as Zu,SYSVAR_RENT_PUBKEY as Ju}from"@solana/web3.js";function k({pubkey:r,isSigner:e=!1,isWritable:t=!0}){return{pubkey:r,isWritable:t,isSigner:e}}var pi=[k({pubkey:Hu,isWritable:!1}),k({pubkey:Zu.programId,isWritable:!1}),k({pubkey:Ju,isWritable:!1})];function mn({publicKey:r,transformSol:e}){let t=fi(r.toString());if(t instanceof he)return e&&t.equals(de)?$:t;if(e&&t.toString()===de.toBase58())return $;if(typeof t=="string"){if(t===he.default.toBase58())return he.default;try{return new he(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function fi(r){try{return new he(r)}catch{return r}}var dn=new he("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),rt=new he("SysvarRent111111111111111111111111111111111"),yi=new he("SysvarC1ock11111111111111111111111111111111"),pn=new he("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),Tr=new he("Sysvar1nstructions1111111111111111111111111"),vm=new he("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Wm=new he("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),Dm=new he("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),qm=new he("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),Um=new he("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),Gm=new he("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),Xm=new he("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),zm=new he("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),Ym=new he("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),Qm=new he("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),jm=new he("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),$=new he("So11111111111111111111111111111111111111112"),de=he.default;function vt(r){return mn({publicKey:r,transformSol:!0})}import{PublicKey as $u}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as ts}from"@solana/spl-token";var Ge={chainId:101,address:$u.default.toBase58(),programId:ts.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},Se={chainId:101,address:"So11111111111111111111111111111111111111112",programId:ts.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};var gi=class{constructor({mint:e,decimals:t,symbol:n,name:i,skipMint:o=!1,isToken2022:s=!1}){if(e===de.toBase58()||e instanceof bi&&de.equals(e)){this.decimals=Se.decimals,this.symbol=Se.symbol,this.name=Se.name,this.mint=new bi(Se.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=i||e.toString().substring(0,6),this.mint=o?bi.default:mn({publicKey:e}),this.isToken2022=s}equals(e){return this===e?!0:this.mint.equals(e.mint)}},ce=gi;ce.WSOL=new gi(D(M({},Se),{mint:Se.address}));import xr from"big.js";import nc from"bn.js";import rc from"decimal.js-light";import ec from"toformat";var tc=ec,Rn=tc;var Ir=oe("module/fraction"),wi=Rn(xr),Ln=Rn(rc),ic={[0]:Ln.ROUND_DOWN,[1]:Ln.ROUND_HALF_UP,[2]:Ln.ROUND_UP},oc={[0]:xr.roundDown,[1]:xr.roundHalfUp,[2]:xr.roundUp},ie=class{constructor(e,t=new nc(1)){this.numerator=X(e),this.denominator=X(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new ie(this.denominator,this.numerator)}add(e){let t=e instanceof ie?e:new ie(X(e));return this.denominator.eq(t.denominator)?new ie(this.numerator.add(t.numerator),this.denominator):new ie(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof ie?e:new ie(X(e));return this.denominator.eq(t.denominator)?new ie(this.numerator.sub(t.numerator),this.denominator):new ie(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof ie?e:new ie(X(e));return new ie(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof ie?e:new ie(X(e));return new ie(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||Ir.logWithError(`${e} is not an integer.`),e<=0&&Ir.logWithError(`${e} is not positive.`),Ln.set({precision:e+1,rounding:ic[n]});let i=new Ln(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return i.toFormat(i.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||Ir.logWithError(`${e} is not an integer.`),e<0&&Ir.logWithError(`${e} is negative.`),wi.DP=e,wi.RM=oc[n]||1,new wi(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var ac=oe("Raydium_price"),$e=class extends ie{constructor(t){let{baseToken:n,quoteToken:i,numerator:o,denominator:s}=t;super(o,s);this.baseToken=n,this.quoteToken=i,this.scalar=new ie(ki(n.decimals),ki(i.decimals))}get raw(){return new ie(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new $e({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&ac.logWithError("mul token not equals");let n=super.mul(t);return new $e({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:n.denominator,numerator:n.numerator})}toSignificant(t=this.quoteToken.decimals,n,i){return this.adjusted.toSignificant(t,n,i)}toFixed(t=this.quoteToken.decimals,n,i){return this.adjusted.toFixed(t,n,i)}};var Ai=class{constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},Br=Ai;Br.SOL=new Ai(Ge);import uc from"bn.js";var ns=new ie(new uc(100)),et=class extends ie{toSignificant(e=5,t,n){return this.mul(ns).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(ns).toFixed(e,t,n)}};var je=new Ce(0),Sr=new Ce(1),Gd=new Ce(2),Xd=new Ce(3),zd=new Ce(5),Kr=new Ce(10),Yd=new Ce(100),Qd=new Ce(1e3),jd=new Ce(1e4),rs=9007199254740991;function X(r){let e=oe("Raydium_parseBigNumberish");if(r instanceof Ce)return r;if(typeof r=="string"){if(r.match(/^-?[0-9]+$/))return new Ce(r);e.logWithError(`invalid BigNumberish string: ${r}`)}return typeof r=="number"?(r%1&&e.logWithError(`BigNumberish number underflow: ${r}`),(r>=rs||r<=-rs)&&e.logWithError(`BigNumberish number overflow: ${r}`),new Ce(String(r))):typeof r=="bigint"?new Ce(r.toString()):(e.error(`invalid BigNumberish value: ${r}`),new Ce(0))}function ki(r){return Kr.pow(X(r))}function fn(r){var a;if(r===void 0)return{denominator:"1",numerator:"0"};if(r instanceof Ce)return{numerator:r.toString(),denominator:"1"};if(r instanceof ie)return{denominator:r.denominator.toString(),numerator:r.numerator.toString()};let e=String(r),[,t="",n="",i=""]=(a=e.replace(",","").match(/(-?)(\d*)\.?(\d*)/))!=null?a:[],o="1"+"0".repeat(i.length),s=t+(n==="0"?"":n)+i||"0";return{denominator:o,numerator:s,sign:t,int:n,dec:i}}function Cr(r,e){let t=r.divmod(e);return t.mod.isZero()?t.div:t.div.isNeg()?t.div.isubn(1):t.div.iaddn(1)}function cc(r){var n;let[,e="",t=""]=(n=r.toFixed(2).match(/(-?)(\d*)\.?(\d*)/))!=null?n:[];return`${e}${t}`}function hi(r,e=0){return r instanceof Ce?r:new Ce(cc(is(r).mul(Kr.pow(new Ce(String(e))))))}function is(r){if(r instanceof et)return new ie(r.numerator,r.denominator);if(r instanceof $e)return r.adjusted;if(r instanceof ge)try{return is(r.toExact())}catch{return new ie(je)}if(r instanceof ie)return r;let e=String(r),t=fn(e);return new ie(t.numerator,t.denominator)}var mc=oe("Raydium_amount"),ss=Rn(lc);function dc(r,e){let t="0",n="0";if(r.includes(".")){let i=r.split(".");i.length===2?([t,n]=i,n=n.padEnd(e,"0")):mc.logWithError(`invalid number string, num: ${r}`)}else t=r;return[t,n.slice(0,e)||n]}var ge=class extends ie{constructor(t,n,i=!0,o){let s=new Rr(0),a=Kr.pow(new Rr(t.decimals));if(i)s=X(n);else{let u=new Rr(0),c=new Rr(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[l,m]=dc(n.toString(),t.decimals);u=X(l),c=X(m)}u=u.mul(a),s=u.add(c)}super(s,a);this.logger=oe(o||"TokenAmount"),this.token=t}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(t){return this.token.equals(t.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(t.raw)}lt(t){return this.token.equals(t.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(t.raw)}add(t){return this.token.equals(t.token)||this.logger.logWithError("add token not equals"),new ge(this.token,this.raw.add(t.raw))}subtract(t){return this.token.equals(t.token)||this.logger.logWithError("sub token not equals"),new ge(this.token,this.raw.sub(t.raw))}toSignificant(t=this.token.decimals,n,i=0){return super.toSignificant(t,n,i)}toFixed(t=this.token.decimals,n,i=0){return t>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(t,n,i)}toExact(t={groupSeparator:""}){return ss.DP=this.token.decimals,new ss(this.numerator.toString()).div(this.denominator.toString()).toFormat(t)}};function os(r){return typeof r=="object"&&r!==null&&![ce,ge,pc,ie,fc,$e,et].some(e=>typeof e=="object"&&r instanceof e)}function pe(r){return typeof r=="string"?fi(r):Array.isArray(r)?r.map(e=>pe(e)):os(r)?Object.fromEntries(Object.entries(r).map(([e,t])=>[e,pe(t)])):r}import{PublicKey as _n,sendAndConfirmTransaction as xi,Transaction as Vn,TransactionMessage as En,VersionedTransaction as Fn}from"@solana/web3.js";import Ac from"axios";var _={CreateAccount:"CreateAccount",InitAccount:"InitAccount",CreateATA:"CreateATA",CloseAccount:"CloseAccount",TransferAmount:"TransferAmount",InitMint:"InitMint",MintTo:"MintTo",InitMarket:"InitMarket",Util1216OwnerClaim:"Util1216OwnerClaim",SetComputeUnitPrice:"SetComputeUnitPrice",SetComputeUnitLimit:"SetComputeUnitLimit",ClmmCreatePool:"ClmmCreatePool",ClmmOpenPosition:"ClmmOpenPosition",ClmmIncreasePosition:"ClmmIncreasePosition",ClmmDecreasePosition:"ClmmDecreasePosition",ClmmClosePosition:"ClmmClosePosition",ClmmSwapBaseIn:"ClmmSwapBaseIn",ClmmSwapBaseOut:"ClmmSwapBaseOut",ClmmInitReward:"ClmmInitReward",ClmmSetReward:"ClmmSetReward",ClmmCollectReward:"ClmmCollectReward",AmmV4Swap:"AmmV4Swap",AmmV4AddLiquidity:"AmmV4AddLiquidity",AmmV4RemoveLiquidity:"AmmV4RemoveLiquidity",AmmV4SimulatePoolInfo:"AmmV4SimulatePoolInfo",AmmV4SwapBaseIn:"AmmV4SwapBaseIn",AmmV4SwapBaseOut:"AmmV4SwapBaseOut",AmmV4CreatePool:"AmmV4CreatePool",AmmV4InitPool:"AmmV4InitPool",AmmV5AddLiquidity:"AmmV5AddLiquidity",AmmV5RemoveLiquidity:"AmmV5RemoveLiquidity",AmmV5SimulatePoolInfo:"AmmV5SimulatePoolInfo",AmmV5SwapBaseIn:"AmmV5SwapBaseIn",AmmV5SwapBaseOut:"AmmV5SwapBaseOut",RouteSwap:"RouteSwap",RouteSwap1:"RouteSwap1",RouteSwap2:"RouteSwap2",FarmV3Deposit:"FarmV3Deposit",FarmV3Withdraw:"FarmV3Withdraw",FarmV3CreateLedger:"FarmV3CreateLedger",FarmV5Deposit:"FarmV5Deposit",FarmV5Withdraw:"FarmV5Withdraw",FarmV5CreateLedger:"FarmV5CreateLedger",FarmV6Deposit:"FarmV6Deposit",FarmV6Withdraw:"FarmV6Withdraw",FarmV6Create:"FarmV6Create",FarmV6Restart:"FarmV6Restart",FarmV6CreatorAddReward:"FarmV6CreatorAddReward",FarmV6CreatorWithdraw:"FarmV6CreatorWithdraw"};import{PublicKey as us,ComputeBudgetProgram as as,Transaction as Lr,TransactionMessage as yc,Keypair as cs,VersionedTransaction as ls}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as bc}from"@solana/spl-token";var Kt=oe("Raydium_txUtil"),ms=1644;function yn(r){let e=[],t=[];return r.microLamports&&(e.push(as.setComputeUnitPrice({microLamports:r.microLamports})),t.push(_.SetComputeUnitPrice)),r.units&&(e.push(as.setComputeUnitLimit({units:r.units})),t.push(_.SetComputeUnitLimit)),{instructions:e,instructionTypes:t}}async function bn(r){var e,t;try{return((t=await((e=r.getLatestBlockhash)==null?void 0:e.call(r)))==null?void 0:t.blockhash)||(await r.getRecentBlockhash()).blockhash}catch{return(await r.getRecentBlockhash()).blockhash}}function Ct(r,e){r.length<1&&Kt.logWithError(`no instructions provided: ${r.toString()}`),e.length<1&&Kt.logWithError(`no signers provided:, ${e.toString()}`);let t=new Lr;t.recentBlockhash="11111111111111111111111111111111",t.feePayer=e[0],t.add(...r);try{return Buffer.from(t.serialize({verifySignatures:!1})).toString("base64").length<ms}catch{return!1}}async function ds(r,e,t,n=!0){let i=new us("RaydiumSimuLateTransaction11111111111111111"),o=[],s=new Lr;s.feePayer=i;for(let c of e)Ct([...s.instructions,c],[i])||(o.push(s),s=new Lr,s.feePayer=i),s.add(c);s.instructions.length>0&&o.push(s);let a=[];try{if(a=await gc(r,o,n),a.find(c=>c.err!==null))throw Error("rpc simulateTransaction error")}catch(c){c instanceof Error&&Kt.logWithError("failed to simulate for instructions","RPC_ERROR",{message:c.message})}let u=[];for(let c of a)if(Kt.debug("simulate result:",c),c.logs){let l=c.logs.filter(m=>m&&m.includes(t));Kt.debug("filteredLog:",u),l.length||Kt.logWithError("simulate log not match keyword","keyword",t),u.push(...l)}return u}function ps(r,e){let t=r.match(/{["\w:,]+}/g);return!t||t.length!==1?Kt.logWithError(`simulate log fail to match json, keyword: ${e}`):t[0]}function Rt(r,e){let n=new RegExp(`"${e}":(\\d+)`,"g").exec(r);return!n||n.length!==2?Kt.logWithError(`simulate log fail to match key", key: ${e}`):n[1]}function le(r,e){let[t,n]=us.findProgramAddressSync(r,e);return{publicKey:t,nonce:n}}async function gc(r,e,t){let n=[];if(t){let i=await r.getLatestBlockhash(),o=[];for(let c of e){c.recentBlockhash=i.blockhash,c.lastValidBlockHeight=i.lastValidBlockHeight;let m=c._compile().serialize(),d=c._serialize(m).toString("base64");o.push(d)}let s=o.map(c=>{let l=r._buildArgs([c],void 0,"base64");return{methodName:"simulateTransaction",args:l}}),a=[],u=20;for(let c=0;c<Math.ceil(s.length/u);c++)a.push(s.slice(c*u,(c+1)*u));n=await(await Promise.all(a.map(async c=>(await r._rpcBatchRequest(c)).map(l=>l.result.value)))).flat()}else try{n=await Promise.all(e.map(async i=>await(await r.simulateTransaction(i)).value))}catch(i){i instanceof Error&&Kt.logWithError("failed to get info for multiple accounts","RPC_ERROR",{message:i.message})}return n}function On({instructions:r,payer:e,signers:t}){return Ct(r,[e,...t])}function Nn({instructions:r,payer:e,lookupTableAddressAccount:t,recentBlockhash:n=cs.generate().publicKey.toString()}){let o=new yc({payerKey:e,recentBlockhash:n,instructions:r}).compileToV0Message(Object.values(t!=null?t:{}));try{return Buffer.from(new ls(o).serialize()).toString("base64").length<ms}catch{return!1}}var wc=r=>Buffer.isBuffer(r)?r:r instanceof Uint8Array?Buffer.from(r.buffer,r.byteOffset,r.byteLength):Buffer.from(r);function Ht(r){let e=[];return r.forEach(t=>{t instanceof Lr&&(t.recentBlockhash||(t.recentBlockhash=bc.toBase58()),t.feePayer||(t.feePayer=cs.generate().publicKey));let n=t.serialize({requireAllSignatures:!1,verifySignatures:!1});t instanceof ls&&(n=wc(n));let i=n.toString("base64");e.push(i)}),console.log("simulate tx string:",e),e}import{PublicKey as fs,AddressLookupTableAccount as Or}from"@solana/web3.js";import{PublicKey as kc}from"@solana/web3.js";import{getTransferFeeConfig as Vp,unpackMint as Ep}from"@solana/spl-token";var Pi=oe("Raydium_accountInfo_util");async function gt(r,e,t){let{batchRequest:n,commitment:i="confirmed"}=M({batchRequest:!1},t),o=Ti(e,100),s=new Array(o.length).fill([]);if(n){let a=o.map(l=>{let m=r._buildArgs([l.map(p=>p.toBase58())],i,"base64");return{methodName:"getMultipleAccounts",args:m}}),u=Ti(a,10);s=(await(await Promise.all(u.map(async l=>await r._rpcBatchRequest(l)))).flat()).map(l=>(l.error&&Pi.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${l.error.message}`),l.result.value.map(m=>{if(m){let{data:p,executable:d,lamports:y,owner:f,rentEpoch:b}=m;return p.length!==2&&p[1]!=="base64"&&Pi.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(p[0],"base64"),executable:d,lamports:y,owner:new kc(f),rentEpoch:b}}return null})))}else try{s=await Promise.all(o.map(a=>r.getMultipleAccountsInfo(a,i)))}catch(a){a instanceof Error&&Pi.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${a.message}`)}return s.flat()}async function Mn(r,e,t){let n=await gt(r,e.map(i=>i.pubkey),t);return e.map((i,o)=>D(M({},i),{accountInfo:n[o]}))}async function Ii({connection:r,address:e}){let t=await gt(r,[...new Set(e.map(i=>i.toString()))].map(i=>new fs(i))),n={};for(let i=0;i<e.length;i++){let o=t[i],s=e[i];if(!o)continue;let a=new Or({key:s,state:Or.deserialize(o.data)});n[s.toString()]=a,Nr[s.toString()]=a}return n}var Nr={"2immgwYNHBbyVQKVGCEkgWpi53bLwWNRMB5G2nbgYV17":new Or({key:new fs("2immgwYNHBbyVQKVGCEkgWpi53bLwWNRMB5G2nbgYV17"),state:Or.deserialize(Buffer.from("AQAAAP//////////d49+DAAAAAAAAQZMWvw7GUNJdaccNBVnb57OKakxL2BHLYvhRwVILRsgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMGRm/lIRcy/+ytunLDm+e8jOW7xfcSayxDmzpAAAAABt324ddloZPZy+FGzut5rBy0he1fWzeROoz1hX7/AKkG3fbh7nWP3hhCXbzkbM3athr8TYO5DSf+vfko2KGL/AVKU1D4XciC1hSlVnJ4iilt3x6rq9CmBniISTL07vagBqfVFxksXFEhjMlMPUrxf1ja7gibof1E49vZigAAAAAGp9UXGMd0yShWY5hpHV62i164o5tLbVxzVVshAAAAAIyXJY9OJInxuz0QKRSODYMLWhOZ2v8QhASOe9jb6fhZC3BlsePRfEU4nVJ/awTDzVi4bHMaoP21SbbRvAP4KUbIScv+6Yw2LHF/6K0ZjUPibbSWXCirYPGuuVl7zT789IUPLW4CpHr4JNCatp3ELXDLKMv6JJ+37le50lbBJ2LvDQdRqCgtphMF/imcN7mY5YRx2xE1A3MQ+L4QRaYK9u4GRfZP3LsAd00a+IkCpA22UNQMKdq5BFbJuwuOLqc8zxCTDlqxBG8J0HcxtfogQHDK06ukzfaXiNDKAob1MqBHS9lJxDYCwz8gd5DtFqNSTKG5l1zxIaKpDP/sffi2is1H9aKveyXSu5StXElYRl9SD5As0DHE4N0GLnf84/siiKXVyp4Ez121kLcUui/jLLFZEz/BwZK3Ilf9B9OcsEAeDMKAy2vjGSxQODgBz0QwGA+eP4ZjIjrIAQaXENv31QfLlOdXSRCkaybRniDHF4C8YcwhcvsqrOVuTP4B2Na+9wLdtrB31uz2rtlFI5kahdsnp/d1SrASDInYCtTYtdoke4kX+hoKWcEWM4Tle8pTUkUVv4BxS6fje/EzKBE4Qu9N9LMnrw/JNO0hqMVB4rk/2ou4AB1loQ7FZoPwut2o4KZB+0p9xnbrQKw038qjpHar+PyDwvxBRcu5hpHw3dguezeWv+IwvgW5icu8EGkhGa9AkFPPJT7VMSFb8xowveU=","base64"))})};var Mr=class{constructor(e){this.instructions=[];this.endInstructions=[];this.lookupTableAddress=[];this.signers=[];this.instructionTypes=[];this.endInstructionTypes=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers,instructionTypes:this.instructionTypes,endInstructionTypes:this.endInstructionTypes,lookupTableAddress:this.lookupTableAddress}}get allInstructions(){return[...this.instructions,...this.endInstructions]}async getComputeBudgetConfig(){var n;let e=(await Ac.get(`https://solanacompass.com/api/fees?cacheFreshTime=${3e5}`)).data,{avg:t}=(n=e==null?void 0:e[15])!=null?n:{};if(!!t)return{units:6e5,microLamports:Math.min(Math.ceil(t*1e6/6e5),25e3)}}addCustomComputeBudget(e){if(e){let{instructions:t,instructionTypes:n}=yn(e);return this.instructions.unshift(...t),this.instructionTypes.unshift(...n),!0}return!1}async calComputeBudget({config:e,defaultIns:t}){try{let n=e||await this.getComputeBudgetConfig();if(this.addCustomComputeBudget(n))return;t&&this.instructions.unshift(...t)}catch{t&&this.instructions.unshift(...t)}}addInstruction({instructions:e=[],endInstructions:t=[],signers:n=[],instructionTypes:i=[],endInstructionTypes:o=[],lookupTableAddress:s=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...n),this.instructionTypes.push(...i),this.endInstructionTypes.push(...o),this.lookupTableAddress.push(...s.filter(a=>a!==_n.default.toString())),this}async versionBuild({txVersion:e,extInfo:t}){return e===0?await this.buildV0(M({},t||{})):this.build(t)}build(e){let t=new Vn;return this.allInstructions.length&&t.add(...this.allInstructions),t.feePayer=this.feePayer,{builder:this,transaction:t,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async()=>{var i;let n=await bn(this.connection);if(t.recentBlockhash=n,this.signers.length&&t.sign(...this.signers),Ht([t]),(i=this.owner)!=null&&i.isKeyPair)return{txId:await xi(this.connection,t,this.signers),signedTx:t};if(this.signAllTransactions){let o=await this.signAllTransactions([t]);return{txId:await this.connection.sendRawTransaction(o[0].serialize(),{skipPreflight:!0}),signedTx:o[0]}}throw new Error("please connect wallet first")},extInfo:e||{}}}buildMultiTx(e){let{extraPreBuildData:t=[],extInfo:n}=e,{transaction:i}=this.build(n),o=t.filter(c=>c.transaction.instructions.length>0),s=[i,...o.map(c=>c.transaction)],a=[this.signers,...o.map(c=>c.signers)],u=[...this.instructionTypes,...o.map(c=>c.instructionTypes).flat()];return{builder:this,transactions:s,signers:a,instructionTypes:u,execute:async c=>{var d;let{sequentially:l,onTxUpdate:m}=c||{},p=await bn(this.connection);if((d=this.owner)!=null&&d.isKeyPair)return{txIds:await await Promise.all(s.map(async(y,f)=>(y.recentBlockhash=p,await xi(this.connection,y,a[f])))),signedTxs:s};if(this.signAllTransactions){let y=s.map((b,w)=>(b.recentBlockhash=p,a[w].length&&b.sign(...a[w]),b));Ht(y);let f=await this.signAllTransactions(y);if(l){let b=0,w=[],h=async()=>{if(!f[b])return;let A=await this.connection.sendRawTransaction(f[b].serialize(),{skipPreflight:!0});w.push({txId:A,status:"sent",signedTx:f[b]}),m==null||m([...w]),b++,this.connection.onSignature(A,P=>{let T=w.findIndex(I=>I.txId===A);T>-1&&(w[T].status=P.err?"error":"success"),m==null||m([...w]),h()},"processed"),this.connection.getSignatureStatus(A)};return await h(),{txIds:w.map(A=>A.txId),signedTxs:f}}else{let b=[];for(let w=0;w<f.length;w+=1){let h=await this.connection.sendRawTransaction(f[w].serialize(),{skipPreflight:!0});b.push(h)}return{txIds:b,signedTxs:f}}}throw new Error("please connect wallet first")},extInfo:n||{}}}async versionMultiBuild({extraPreBuildData:e,txVersion:t,extInfo:n}){return t===0?await this.buildV0MultiTx({extraPreBuildData:e,buildProps:n||{}}):this.buildMultiTx({extraPreBuildData:e,extInfo:n})}async buildV0(e){let p=e||{},{lookupTableCache:t={},lookupTableAddress:n=[],forerunCreate:i}=p,o=Ne(p,["lookupTableCache","lookupTableAddress","forerunCreate"]),s=M(M({},Nr),t),a=Array.from(new Set([...n,...this.lookupTableAddress])),u=[];for(let d of a)s[d]===void 0&&u.push(new _n(d));let c=await Ii({connection:this.connection,address:u});for(let[d,y]of Object.entries(c))s[d]=y;let l=new En({payerKey:this.feePayer,recentBlockhash:i?_n.default.toBase58():await bn(this.connection),instructions:[...this.allInstructions]}).compileToV0Message(Object.values(s)),m=new Fn(l);return m.sign(this.signers),{builder:this,transaction:m,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async()=>{var d;if(Ht([m]),(d=this.owner)!=null&&d.isKeyPair)return m.sign([this.owner.signer]),{txId:await this.connection.sendTransaction(m,{skipPreflight:!0}),signedTx:m};if(this.signAllTransactions){let y=await this.signAllTransactions([m]);return{txId:await this.connection.sendTransaction(y[0],{skipPreflight:!0}),signedTx:y[0]}}throw new Error("please connect wallet first")},extInfo:o||{}}}async buildV0MultiTx(e){let{extraPreBuildData:t=[],buildProps:n}=e,{transaction:i}=await this.buildV0(n),o=t.filter(c=>c.builder.instructions.length>0),s=[i,...o.map(c=>c.transaction)],a=[this.signers,...o.map(c=>c.signers)],u=[...this.instructionTypes,...o.map(c=>c.instructionTypes).flat()];return s.forEach(async(c,l)=>{c.sign(a[l])}),{builder:this,transactions:s,signers:a,instructionTypes:u,buildProps:n,execute:async c=>{var p;Ht(s);let{sequentially:l,onTxUpdate:m}=c||{};if((p=this.owner)!=null&&p.isKeyPair)return s.forEach(d=>d.sign([this.owner.signer])),{txIds:await Promise.all(s.map(async d=>await this.connection.sendTransaction(d))),signedTxs:s};if(this.signAllTransactions){let d=await this.signAllTransactions(s);if(l){let y=0,f=[],b=async()=>{if(!d[y])return;let w=await this.connection.sendTransaction(d[y],{skipPreflight:!0});f.push({txId:w,status:"sent",signedTx:d[y]}),m==null||m([...f]),y++,this.connection.onSignature(w,h=>{let A=f.findIndex(P=>P.txId===w);A>-1&&(f[A].status=h.err?"error":"success"),m==null||m([...f]),b()},"processed"),this.connection.getSignatureStatus(w)};return b(),{txIds:[],signedTxs:d}}else{let y=[];for(let f=0;f<d.length;f+=1){let b=await this.connection.sendTransaction(d[f],{skipPreflight:!0});y.push(b)}return{txIds:y,signedTxs:d}}}throw new Error("please connect wallet first")},extInfo:n||{}}}async sizeCheckBuild(e){let c=e||{},{autoComputeBudget:t=!1}=c,n=Ne(c,["autoComputeBudget"]),i={instructions:[],instructionTypes:[]};if(t){let l=t?await this.getComputeBudgetConfig():void 0;i=t&&l?yn(l):{instructions:[],instructionTypes:[]}}let o=this.signers.reduce((l,m)=>D(M({},l),{[m.publicKey.toBase58()]:m}),{}),s=[],a=[],u=[];if(this.allInstructions.forEach(l=>{let m=[...u,l],p=t?[...i.instructions,...m]:m,y=[...new Set(m.map(f=>f.keys.filter(b=>b.isSigner).map(b=>b.pubkey.toString())).flat()).values()].map(f=>new _n(f));if(u.length<12&&On({instructions:p,payer:this.feePayer,signers:y})||On({instructions:m,payer:this.feePayer,signers:y}))u.push(l);else{if(u.length===0)throw Error("item ins too big");On({instructions:t?[...i.instructions,...u]:[...u],payer:this.feePayer,signers:y})?s.push(new Vn().add(...i.instructions,...u)):s.push(new Vn().add(...u)),a.push(Array.from(new Set(u.map(f=>f.keys.filter(b=>b.isSigner).map(b=>b.pubkey.toString())).flat())).map(f=>o[f]).filter(f=>f!==void 0)),u=[l]}}),u.length>0){let m=[...new Set(u.map(p=>p.keys.filter(d=>d.isSigner).map(d=>d.pubkey.toString())).flat()).values()].map(p=>o[p]).filter(p=>p!==void 0);On({instructions:t?[...i.instructions,...u]:[...u],payer:this.feePayer,signers:m.map(p=>p.publicKey)})?s.push(new Vn().add(...i.instructions,...u)):s.push(new Vn().add(...u)),a.push(m)}return s.forEach(l=>l.feePayer=this.feePayer),{builder:this,transactions:s,signers:a,instructionTypes:this.instructionTypes,execute:async l=>{var y;let{sequentially:m,onTxUpdate:p}=l||{},d=await bn(this.connection);if(s.forEach(async(f,b)=>{f.recentBlockhash=d,a[b].length&&f.sign(...a[b])}),Ht(s),(y=this.owner)!=null&&y.isKeyPair)return{txIds:await Promise.all(s.map(async(f,b)=>await xi(this.connection,f,a[b]))),signedTxs:s};if(this.signAllTransactions){let f=await this.signAllTransactions(s);if(m){let b=0,w=[],h=async()=>{if(!f[b])return;let A=await this.connection.sendRawTransaction(f[b].serialize(),{skipPreflight:!0});w.push({txId:A,status:"sent",signedTx:f[b]}),p==null||p([...w]),b++,this.connection.onSignature(A,P=>{let T=w.findIndex(I=>I.txId===A);T>-1&&(w[T].status=P.err?"error":"success"),p==null||p([...w]),h()},"processed"),this.connection.getSignatureStatus(A)};return await h(),{txIds:w.map(A=>A.txId),signedTxs:f}}else{let b=[];for(let w=0;w<f.length;w+=1){let h=await this.connection.sendRawTransaction(f[w].serialize(),{skipPreflight:!0});b.push(h)}return{txIds:b,signedTxs:f}}}throw new Error("please connect wallet first")},extInfo:n||{}}}async sizeCheckBuildV0(e){let b=e||{},{autoComputeBudget:t=!1,lookupTableCache:n={},lookupTableAddress:i=[]}=b,o=Ne(b,["autoComputeBudget","lookupTableCache","lookupTableAddress"]),s=M(M({},Nr),n),a=Array.from(new Set([...this.lookupTableAddress,...i])),u=[];for(let w of a)s[w]===void 0&&u.push(new _n(w));let c=await Ii({connection:this.connection,address:u});for(let[w,h]of Object.entries(c))s[w]=h;let l={instructions:[],instructionTypes:[]};if(t){let w=t?await this.getComputeBudgetConfig():void 0;l=t&&w?yn(w):{instructions:[],instructionTypes:[]}}let m=await bn(this.connection),p=this.signers.reduce((w,h)=>D(M({},w),{[h.publicKey.toBase58()]:h}),{}),d=[],y=[],f=[];if(this.allInstructions.forEach(w=>{let h=[...f,w],A=t?[...l.instructions,...h]:h;if(f.length<12&&Nn({instructions:A,payer:this.feePayer,lookupTableAddressAccount:s})||Nn({instructions:h,payer:this.feePayer,lookupTableAddressAccount:s}))f.push(w);else{if(f.length===0)throw Error("item ins too big");let P={};for(let T of[...new Set(a)])s[T]!==void 0&&(P[T]=s[T]);if(t&&Nn({instructions:[...l.instructions,...f],payer:this.feePayer,lookupTableAddressAccount:s,recentBlockhash:m})){let T=new En({payerKey:this.feePayer,recentBlockhash:m,instructions:[...l.instructions,...f]}).compileToV0Message(Object.values(s));d.push(new Fn(T))}else{let T=new En({payerKey:this.feePayer,recentBlockhash:m,instructions:[...f]}).compileToV0Message(Object.values(s));d.push(new Fn(T))}y.push(Array.from(new Set(f.map(T=>T.keys.filter(I=>I.isSigner).map(I=>I.pubkey.toString())).flat())).map(T=>p[T]).filter(T=>T!==void 0)),f=[w]}}),f.length>0){let h=[...new Set(f.map(A=>A.keys.filter(P=>P.isSigner).map(P=>P.pubkey.toString())).flat()).values()].map(A=>p[A]).filter(A=>A!==void 0);if(t&&Nn({instructions:[...l.instructions,...f],payer:this.feePayer,lookupTableAddressAccount:s,recentBlockhash:m})){let A=new En({payerKey:this.feePayer,recentBlockhash:m,instructions:[...l.instructions,...f]}).compileToV0Message(Object.values(s));d.push(new Fn(A))}else{let A=new En({payerKey:this.feePayer,recentBlockhash:m,instructions:[...f]}).compileToV0Message(Object.values(s));d.push(new Fn(A))}y.push(h)}return{builder:this,transactions:d,buildProps:e,signers:y,instructionTypes:this.instructionTypes,execute:async w=>{var P;let{sequentially:h,onTxUpdate:A}=w||{};if(d.map(async(T,I)=>{y[I].length&&T.sign(y[I])}),Ht(d),(P=this.owner)!=null&&P.isKeyPair)return{txIds:await Promise.all(d.map(async T=>await this.connection.sendTransaction(T,{skipPreflight:!0}))),signedTxs:d};if(this.signAllTransactions){let T=await this.signAllTransactions(d);if(h){let I=0,x=[],O=async()=>{if(!T[I])return;let N=await this.connection.sendTransaction(T[I],{skipPreflight:!0});x.push({txId:N,status:"sent",signedTx:T[I]}),A==null||A([...x]),I++,this.connection.onSignature(N,L=>{let E=x.findIndex(Z=>Z.txId===N);E>-1&&(x[E].status=L.err?"error":"success"),A==null||A([...x]),O()},"processed"),this.connection.getSignatureStatus(N)};return O(),{txIds:[],signedTxs:T}}else{let I=[];for(let x=0;x<T.length;x+=1){let O=await this.connection.sendTransaction(T[x],{skipPreflight:!0});I.push(O)}return{txIds:I,signedTxs:T}}}throw new Error("please connect wallet first")},extInfo:o||{}}}};var lt=class{constructor(e){this._owner=e}get publicKey(){return lt.isKeyPair(this._owner)?this._owner.publicKey:this._owner}get signer(){return lt.isKeyPair(this._owner)?this._owner:void 0}get isKeyPair(){return lt.isKeyPair(this._owner)}get isPublicKey(){return lt.isPublicKey(this._owner)}static isKeyPair(e){return e.secretKey!==void 0}static isPublicKey(e){return!lt.isKeyPair(e)}};function Ti(r,e=1,t=[]){let n=[...r];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}var ys=r=>typeof r=="number";function bs(r,e,t){let n=ys(e)?e*((t==null?void 0:t.unit)==="s"?1e3:1):e;return new Date(r).getTime()<=n}function gs(r,e,t){let n=ys(e)?e*((t==null?void 0:t.unit)==="s"?1e3:1):e;return new Date(r).getTime()>n}import{PublicKey as He}from"@solana/web3.js";var ws=new He("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),ks=new He("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),vn=new He("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),sf=new He("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),af=new He("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),Si=new He("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),uf=new He("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),cf=new He("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),lf=new He("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),mf=new He("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),hc=new He("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),Pc=new He("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),Tc=new He("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),Ic=new He("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),Wn={IDO_PROGRAM_ID_V1:hc,IDO_PROGRAM_ID_V2:Pc,IDO_PROGRAM_ID_V3:Tc,IDO_PROGRAM_ID_V4:Ic};import{PublicKey as xc}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Bc}from"@solana/spl-token";function we(r,e,t){return le([r.toBuffer(),(t!=null?t:Bc).toBuffer(),e.toBuffer()],new xc("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"))}import xe from"bn.js";var wt=1e4;function wn(r,e,t,n){if(e===void 0)return{amount:r,fee:void 0,expirationTime:void 0};let i=t.epoch<e.newerTransferFee.epoch?e.olderTransferFee:e.newerTransferFee,o=new xe(i.maximumFee.toString()),s=t.epoch<e.newerTransferFee.epoch?(Number(e.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(i.transferFeeBasisPoints===wt){let a=new xe(i.maximumFee.toString());return{amount:r.add(a),fee:a,expirationTime:s}}else{let a=gn(r.mul(new xe(wt)),new xe(wt-i.transferFeeBasisPoints)),u=new xe(i.maximumFee.toString()),c=a.sub(r).gt(u)?r.add(u):a,l=gn(c.mul(new xe(i.transferFeeBasisPoints)),new xe(wt)),m=l.gt(o)?o:l;return{amount:c,fee:m,expirationTime:s}}else{let a=gn(r.mul(new xe(i.transferFeeBasisPoints)),new xe(wt)),u=a.gt(o)?o:a;return{amount:r,fee:u,expirationTime:s}}}function Re(r,e,t,n){if(e===void 0)return{amount:r,fee:void 0,expirationTime:void 0};let i=D(M({},e),{olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}}),o=t.epoch<i.newerTransferFee.epoch?i.olderTransferFee:i.newerTransferFee,s=new xe(o.maximumFee.toString()),a=t.epoch<i.newerTransferFee.epoch?(Number(i.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(o.transferFeeBasisPoints===wt){let u=new xe(o.maximumFee.toString());return{amount:r.add(u),fee:u,expirationTime:a}}else{let u=gn(r.mul(new xe(wt)),new xe(wt-o.transferFeeBasisPoints)),c=new xe(o.maximumFee.toString()),l=u.sub(r).gt(c)?r.add(c):u,m=gn(l.mul(new xe(o.transferFeeBasisPoints)),new xe(wt)),p=m.gt(s)?s:m;return{amount:l,fee:p,expirationTime:a}}else{let u=gn(r.mul(new xe(o.transferFeeBasisPoints)),new xe(wt)),c=u.gt(s)?s:u;return{amount:r,fee:c,expirationTime:a}}}function Zt(r,e){return r===void 0?e:e===void 0?r:Math.min(r,e)}function gn(r,e){let{div:t,mod:n}=r.divmod(e);return n.gt(new xe(0))?t.add(new xe(1)):t}var Wt={BASE_HOST:"https://uapi.raydium.io",OWNER_BASE_HOST:"https://owner.raydium.io",COINGECKO:"https://api.coingecko.com/api/v3/simple/price",FARM_ARP:"/main/farm/info",FARM_ARP_LINE:"/main/farm-apr-tv",AMM_V3_CONFIG:"/v3/pools/clmm-config",VERSION:"/v3/main/version",PRICE:"/v2/main/price",CHECK_AVAILABILITY:"/v3/main/AvailabilityCheckAPI",RPCS:"/v3/main/rpcs",INFO:"/v3/main/info",STAKE_POOLS:"/v3/main/stake-pools",CHAIN_TIME:"/v3/main/chain-time",TOKEN_LIST:"/v3/mint/list",TOKEN_INFO:"/v3/mint/item/{mint}",JUP_TOKEN_LIST:"https://token.jup.ag/{type}",POOL_LIST:"/v3/pools/info/{type}/{sort}/{order}/{page_size}/{page}",POOL_SEARCH_BY_ID:"/v3/pools/info/ids/{ids}",POOL_SEARCH:"/v3/pools/info/search/{search_text}/{type}/{sort}/{order}/{page_size}/{page}",POOL_SEARCH_MINT:"/v3/pools/info/mint/{mint1}/{type}/{sort}/{order}/{page_size}/{page}",POOL_SEARCH_MINT_2:"/v3/pools/info/mint/{mint1}/{mint2}/{type}/{sort}/{order}/{page_size}/{page}",POOL_SEARCH_LP:"/v3/pools/info/lps/{lp_mints}",POOL_KEY_BY_ID:"/v3/pools/key/id/{id}",POOLS_KEY:"/v3/pools/key/{type}/{page_size}/{page}",POOLS_KEY_BY_MINT:"/v3/pools/key/mint/{mint1}/{type}/{page_size}/{page}",POOLS_KEY_BY_MINT_2:"/v3/pools/key/mint/{mint1}/{mint2}/{type}/{page_size}/{page}",POOL_LIQUIDITY_LINE:"/v3/pools/line/liquidity/{id}",POOL_POSITION_LINE:"/v3/pools/line/position/{id}",FARM_INFO:"/v3/farms/info/ids/{ids}",FARM_LP_INFO:"/v3/farms/info/lp/{pool_lp}/{page_size}/{page}",FARM_LIST:"/v3/farms/info/list/all/{page_size}/{page}",FARM_KEYS:"/v3/farms/key/ids/{ids}",OWNER_CREATED_FARM:"/v1/create-pool/{owner}",OWNER_IDO:"/v1/ido/{owner}",OWNER_STAKE_FARMS:"/v1/position/stake/{owner}",IDO_KEYS:"/v3/ido/key/ids/{ids}",SWAP_HOST:"https://transaction.raydium.io",SWAP_COMPUTE:"/v1/compute/",SWAP_TX:"/v1/transaction/",MINT_PRICE:"/v3/mint/price",MIGRATE_CONFIG:"/v3/main/migrate-lp"},mt=M({},Wt);var As="ray_tab_hash",Ki="ray_req_hash",Sc=()=>{if(typeof window===void 0)return"";let r=sessionStorage.getItem(As);return r||(r=`ray-${Date.now()}`,sessionStorage.setItem(As,r)),r},_r=async n=>{var i=n,{logCount:r=1e3,removeLastLog:e}=i,t=Ne(i,["logCount","removeLastLog"]);if(typeof window===void 0)return new Promise(s=>s());let o=JSON.parse(localStorage.getItem(Ki)||"[]").slice(0,r-1);e&&o.pop(),new Blob([JSON.stringify(t.data)]).size>1024&&(t.data=JSON.stringify(t.data).substring(0,200)+"..."),o.unshift(D(M({},t),{time:Date.now(),session:Sc()}));try{localStorage.setItem(Ki,JSON.stringify(o))}catch{if(e){let s=!1,a=JSON.stringify(t.data).substring(0,100);for(o[0].data=a+(a.length>100?"...":"");!s;){o.pop();let u=JSON.stringify(t.data).substring(0,100);o[0].data=u+(u.length>100?"...":"");try{localStorage.setItem(Ki,JSON.stringify(o)),s=!0}catch{s=!1}}return new Promise(u=>u())}return _r(D(M({},t),{logCount:r,removeLastLog:!0}))}};var Vr=oe("Raydium_Api"),Ci=new Map;var Er=class{constructor({cluster:e,timeout:t,logRequests:n,logCount:i,urlConfigs:o}){this.cluster=e,this.urlConfigs=o||{},this.logCount=i||1e3,this.api=Cc.create({baseURL:this.urlConfigs.BASE_HOST||Wt.BASE_HOST,timeout:t}),this.api.interceptors.request.use(s=>{let{method:a,baseURL:u,url:c}=s;return Vr.debug(`${a==null?void 0:a.toUpperCase()} ${u}${c}`),s},s=>(Vr.error("Request failed"),Promise.reject(s))),this.api.interceptors.response.use(s=>{let{config:a,data:u,status:c}=s,{method:l,baseURL:m,url:p}=a;return n&&_r({status:c,url:`${m}${p}`,params:a.params,data:u,logCount:this.logCount}),Vr.debug(`${l==null?void 0:l.toUpperCase()} ${m}${p}  ${c}`),u},s=>{let{config:a,response:u={}}=s,{status:c}=u,{method:l,baseURL:m,url:p}=a;return n&&_r({status:c,url:`${m}${p}`,params:a.params,data:s.message,logCount:this.logCount}),Vr.error(`${l.toUpperCase()} ${m}${p} ${c||s.message}`),Promise.reject(s)})}async getClmmConfigs(){return(await this.api.get(this.urlConfigs.AMM_V3_CONFIG||Wt.AMM_V3_CONFIG)).data}async getClmmPoolLines(e){return(await this.api.get(`${this.urlConfigs.POOL_LIQUIDITY_LINE||Wt.POOL_LIQUIDITY_LINE}?pool_id=${e}`)).data}async getRaydiumTokenPrice(){return this.api.get(this.urlConfigs.PRICE||Wt.PRICE)}async getBlockSlotCountForSecond(e){if(!e)return 2;let n=(await this.api.post(e,{id:"getRecentPerformanceSamples",jsonrpc:"2.0",method:"getRecentPerformanceSamples",params:[4]})).result.map(i=>i.numSlots);return n.reduce((i,o)=>i+o,0)/n.length/60}async getChainTimeOffset(){return this.api.get(this.urlConfigs.CHAIN_TIME||Wt.CHAIN_TIME)}async getRpcs(){return this.api.get(this.urlConfigs.RPCS||Wt.RPCS)}async getTokenList(){return(await this.api.get(this.urlConfigs.TOKEN_LIST||mt.TOKEN_LIST,{})).data}async getJupTokenList(e){return this.api.get("/",{baseURL:(this.urlConfigs.JUP_TOKEN_LIST||mt.JUP_TOKEN_LIST).replace("{type}",e||"all")})}async getTokenInfo(e){return(await this.api.get((this.urlConfigs.TOKEN_INFO||mt.TOKEN_INFO).replace("{mint}",e.toString()))).data}async getPoolList(e={}){let{type:t="all",sort:n="liquidity",order:i="desc",page:o=0}=e;return(await this.api.get((this.urlConfigs.POOL_LIST||mt.POOL_LIST).replace("{type}",t).replace("{sort}",n).replace("{order}",i).replace("{page}",String(o)))).data}async searchPoolById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.POOL_SEARCH_BY_ID||mt.POOL_SEARCH_BY_ID).replace("{ids}",t))).data}async searchPoolByMint(e){let{mint:t,type:n="all",sort:i="liquidity",order:o="desc",page:s=0}=e;return(await this.api.get((this.urlConfigs.POOL_SEARCH_MINT||mt.POOL_SEARCH_MINT).replace("{mint1}",t).replace("{type}",n).replace("{sort}",i).replace("{order}",o).replace("{page}",String(s)))).data}async searchPoolByMints(e){let{mint1:t,mint2:n,type:i="all",sort:o="liquidity",order:s="desc",page:a=0}=e,[u,c]=t>n?[t,n]:[n,t];return(await this.api.get((this.urlConfigs.POOL_SEARCH_MINT_2||mt.POOL_SEARCH_MINT_2).replace("{mint1}",c).replace("{mint2}",u).replace("{type}",i).replace("{sort}",o).replace("{order}",s).replace("{page}",String(a)))).data}async fetchPoolKeysById(e){let{id:t}=e;if(Ci.has(t))return Ci.get(t);let n=await this.api.get((this.urlConfigs.POOL_KEY_BY_ID||mt.POOL_KEY_BY_ID).replace("{id}",t));return Ci.set(t,n.data),n.data}async fetchFarmKeysById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_KEYS||mt.FARM_KEYS).replace("{ids}",t))).data}async fetchAvailabilityStatus(){return(await this.api.get(this.urlConfigs.CHECK_AVAILABILITY||mt.CHECK_AVAILABILITY)).data}};var Fr="please provide owner in load() initialization or you can set by calling raydium.setOwner(owner)",hs="please provide connection in load() initialization or set it by raydium.setConnection(connection)";import{createAssociatedTokenAccountInstruction as Wi,TOKEN_PROGRAM_ID as Xt,AccountLayout as An}from"@solana/spl-token";import{PublicKey as zr,SystemProgram as il}from"@solana/web3.js";var Ri=(...r)=>r.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),Te=class{constructor({scope:e,moduleName:t}){this.disabled=!1;this.scope=e,this.logger=oe(t)}createTxBuilder(e){return this.scope.checkOwner(),new Mr({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,owner:this.scope.owner,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(Ri(e))}logInfo(...e){this.logger.info(Ri(e))}logAndCreateError(...e){let t=Ri(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{createInitializeAccountInstruction as Jc,createCloseAccountInstruction as $c,createTransferInstruction as el,TOKEN_PROGRAM_ID as kn}from"@solana/spl-token";import{PublicKey as tl,SystemProgram as nl}from"@solana/web3.js";import rl from"bn.js";import{PublicKey as _s,Keypair as Qc}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as jc}from"@solana/spl-token";import Hc from"bn.js";import{PublicKey as Dc}from"@solana/web3.js";import Bs,{isBN as Ss}from"bn.js";import{bits as Rc,BitStructure as py,blob as Lc,Blob as fy,cstr as yy,f32 as by,f32be as gy,f64 as wy,f64be as ky,greedy as Ay,Layout as Oc,ns64 as hy,ns64be as Py,nu64 as Nc,nu64be as Ty,offset as Iy,s16 as xy,s16be as By,s24 as Sy,s24be as Ky,s32 as Mc,s32be as Cy,s40 as Ry,s40be as Ly,s48 as Oy,s48be as Ny,s8 as My,seq as _c,struct as _y,Structure as Vc,u16 as Ec,u16be as Vy,u24 as Ey,u24be as Fy,u32 as Fc,u32be as vy,u40 as Wy,u40be as Dy,u48 as qy,u48be as Uy,u8 as vc,UInt as Wc,union as Gy,Union as Xy,unionLayoutDiscriminator as zy,utf8 as Yy}from"@solana/buffer-layout";var vr=Oc,Ps=Vc;var Li=Wc;var Ts=vc,Dt=Ec;var Oi=Fc;var Is=Nc;var _e=Mc;var xs=_c;var ke=Lc;var Ni=Rc;var Jt=class extends vr{constructor(t,n,i){super(t,i);this.blob=ke(t),this.signed=n}decode(t,n=0){let i=new Bs(this.blob.decode(t,n),10,"le");return this.signed?i.fromTwos(this.span*8).clone():i}encode(t,n,i=0){return typeof t=="number"&&(t=new Bs(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),n,i)}},Wr=class extends vr{constructor(t){super(8,t);this._lower=Ni(Oi(),!1),this._upper=Ni(Oi(),!1)}addBoolean(t){this._lower.fields.length<32?this._lower.addBoolean(t):this._upper.addBoolean(t)}decode(t,n=0){let i=this._lower.decode(t,n),o=this._upper.decode(t,n+this._lower.span);return M(M({},i),o)}encode(t,n,i=0){return this._lower.encode(t,n,i)+this._upper.encode(t,n,i+this._lower.span)}};function V(r){return new Li(1,r)}function ve(r){return new Li(4,r)}function g(r){return new Jt(8,!1,r)}function z(r){return new Jt(16,!1,r)}function Ks(r){return new Jt(1,!0,r)}function qr(r){return new Jt(8,!0,r)}function Cs(r){return new Jt(16,!0,r)}var Dr=class extends vr{constructor(t,n,i,o){super(t.span,o);this.layout=t,this.decoder=n,this.encoder=i}decode(t,n){return this.decoder(this.layout.decode(t,n))}encode(t,n,i){return this.layout.encode(this.encoder(t),n,i)}getSpan(t,n){return this.layout.getSpan(t,n)}};function B(r){return new Dr(ke(32),e=>new Dc(e),e=>e.toBuffer(),r)}function Xe(r){return new Dr(Ts(),qc,Uc,r)}function qc(r){if(r===0)return!1;if(r===1)return!0;throw new Error("Invalid bool: "+r)}function Uc(r){return r?1:0}var Mi=class extends Ps{decode(e,t){return super.decode(e,t)}};function R(r,e,t){return new Mi(r,e,t)}function G(r,e,t){let n,i=typeof e=="number"?e:Ss(e)?e.toNumber():new Proxy(e,{get(o,s){if(!n){let a=Reflect.get(o,"count");n=Ss(a)?a.toNumber():a,Reflect.set(o,"count",n)}return Reflect.get(o,s)},set(o,s,a){return s==="count"&&(n=a),Reflect.set(o,s,a)}});return xs(r,i,t)}var qt=R([B("mint"),B("owner"),g("amount"),ve("delegateOption"),B("delegate"),V("state"),ve("isNativeOption"),g("isNative"),g("delegatedAmount"),ve("closeAuthorityOption"),B("closeAuthority")]);function Gc(r){return r instanceof Uint8Array||r!=null&&typeof r=="object"&&r.constructor.name==="Uint8Array"}function _i(r,...e){if(!Gc(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${r.length}`)}function Vi(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function Rs(r,e){_i(r);let t=e.outputLen;if(r.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var Gr=r=>new DataView(r.buffer,r.byteOffset,r.byteLength),dt=(r,e)=>r<<32-e|r>>>e;var ub=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function Xc(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function Ei(r){return typeof r=="string"&&(r=Xc(r)),_i(r),r}var Ur=class{clone(){return this._cloneInto()}},cb={}.toString;function Ls(r){let e=n=>r().update(Ei(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function zc(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);let i=BigInt(32),o=BigInt(4294967295),s=Number(t>>i&o),a=Number(t&o),u=n?4:0,c=n?0:4;r.setUint32(e+u,s,n),r.setUint32(e+c,a,n)}var Os=(r,e,t)=>r&e^~r&t,Ns=(r,e,t)=>r&e^r&t^e&t,Xr=class extends Ur{constructor(e,t,n,i){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=i,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=Gr(this.buffer)}update(e){Vi(this);let{view:t,buffer:n,blockLen:i}=this;e=Ei(e);let o=e.length;for(let s=0;s<o;){let a=Math.min(i-this.pos,o-s);if(a===i){let u=Gr(e);for(;i<=o-s;s+=i)this.process(u,s);continue}n.set(e.subarray(s,s+a),this.pos),this.pos+=a,s+=a,this.pos===i&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Vi(this),Rs(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:i,isLE:o}=this,{pos:s}=this;t[s++]=128,this.buffer.subarray(s).fill(0),this.padOffset>i-s&&(this.process(n,0),s=0);for(let m=s;m<i;m++)t[m]=0;zc(n,i-8,BigInt(this.length*8),o),this.process(n,0);let a=Gr(e),u=this.outputLen;if(u%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let c=u/4,l=this.get();if(c>l.length)throw new Error("_sha2: outputLen bigger than state");for(let m=0;m<c;m++)a.setUint32(4*m,l[m],o)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:i,finished:o,destroyed:s,pos:a}=this;return e.length=i,e.pos=a,e.finished=o,e.destroyed=s,i%t&&e.buffer.set(n),e}};var Yc=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Ut=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Gt=new Uint32Array(64),Fi=class extends Xr{constructor(){super(64,32,8,!1),this.A=Ut[0]|0,this.B=Ut[1]|0,this.C=Ut[2]|0,this.D=Ut[3]|0,this.E=Ut[4]|0,this.F=Ut[5]|0,this.G=Ut[6]|0,this.H=Ut[7]|0}get(){let{A:e,B:t,C:n,D:i,E:o,F:s,G:a,H:u}=this;return[e,t,n,i,o,s,a,u]}set(e,t,n,i,o,s,a,u){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=o|0,this.F=s|0,this.G=a|0,this.H=u|0}process(e,t){for(let m=0;m<16;m++,t+=4)Gt[m]=e.getUint32(t,!1);for(let m=16;m<64;m++){let p=Gt[m-15],d=Gt[m-2],y=dt(p,7)^dt(p,18)^p>>>3,f=dt(d,17)^dt(d,19)^d>>>10;Gt[m]=f+Gt[m-7]+y+Gt[m-16]|0}let{A:n,B:i,C:o,D:s,E:a,F:u,G:c,H:l}=this;for(let m=0;m<64;m++){let p=dt(a,6)^dt(a,11)^dt(a,25),d=l+p+Os(a,u,c)+Yc[m]+Gt[m]|0,f=(dt(n,2)^dt(n,13)^dt(n,22))+Ns(n,i,o)|0;l=c,c=u,u=a,a=s+d|0,s=o,o=i,i=n,n=d+f|0}n=n+this.A|0,i=i+this.B|0,o=o+this.C|0,s=s+this.D|0,a=a+this.E|0,u=u+this.F|0,c=c+this.G|0,l=l+this.H|0,this.set(n,i,o,s,a,u,c,l)}roundClean(){Gt.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var Ms=Ls(()=>new Fi);var Bb=oe("Raydium_Util");function Vs({owner:r,solAccountResp:e,tokenAccountResp:t}){let n=[],i=[];for(let{pubkey:o,account:s}of t.value){let a=qt.decode(s.data),{mint:u,amount:c}=a;n.push({publicKey:o,mint:u,amount:c,isAssociated:we(r,u,s.owner).publicKey.equals(o),isNative:!1,programId:s.owner}),i.push({pubkey:o,accountInfo:a,programId:s.owner})}return e&&n.push({mint:_s.default,amount:new Hc(e.lamports),isNative:!0,programId:e.owner}),{tokenAccounts:n,tokenAccountRawInfos:i}}function We({fromPublicKey:r,programId:e=jc}){let t=Qc.generate().publicKey.toBase58().slice(0,32);return{publicKey:Zc(r,t,e),seed:t}}function Zc(r,e,t){let n=Buffer.concat([r.toBuffer(),Buffer.from(e),t.toBuffer()]),i=Ms(n);return new _s(i)}function vi(r){let{mint:e,tokenAccount:t,owner:n,programId:i=kn}=r;return Jc(t,e,n,i)}function Lt(r){let{tokenAccount:e,payer:t,multiSigners:n=[],owner:i,programId:o=kn}=r;return $c(e,t,i,n,o)}async function kt(r){let{connection:e,amount:t,commitment:n,payer:i,owner:o,skipCloseAccount:s}=r,a=await e.getMinimumBalanceForRentExemption(qt.span,n),u=X(t).add(new rl(a)),c=We({fromPublicKey:i,programId:kn});return{addresses:{newAccount:c.publicKey},signers:[],instructions:[nl.createAccountWithSeed({fromPubkey:i,basePubkey:i,seed:c.seed,newAccountPubkey:c.publicKey,lamports:u.toNumber(),space:qt.span,programId:kn}),vi({mint:new tl(Se.address),tokenAccount:c.publicKey,owner:o,programId:kn})],instructionTypes:[_.CreateAccount,_.InitAccount],endInstructionTypes:s?[]:[_.CloseAccount],endInstructions:s?[]:[Lt({tokenAccount:c.publicKey,payer:i,owner:o})]}}function Dn({source:r,destination:e,owner:t,amount:n,multiSigners:i=[],tokenProgram:o=kn}){return el(r,e,t,BigInt(String(n)),i,o)}var qn=class extends Te{constructor(t){super(t);this._tokenAccounts=[];this._tokenAccountRawInfos=[];this._accountListener=[];this._clientOwnedToken=!1;let{tokenAccounts:n,tokenAccountRawInfos:i}=t;this._tokenAccounts=n||[],this._tokenAccountRawInfos=i||[],this._clientOwnedToken=!!(n||i)}get tokenAccounts(){return this._tokenAccounts}get tokenAccountRawInfos(){return this._tokenAccountRawInfos}updateTokenAccount({tokenAccounts:t,tokenAccountRawInfos:n}){return t&&(this._tokenAccounts=t),n&&(this._tokenAccountRawInfos=n),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=void 0,this._clientOwnedToken=!0,this}addAccountChangeListener(t){return this._accountListener.push(t),this}removeAccountChangeListener(t){return this._accountListener=this._accountListener.filter(n=>n!==t),this}getAssociatedTokenAccount(t,n){return we(this.scope.ownerPubKey,t,n).publicKey}async fetchWalletTokenAccounts(t){if(this._clientOwnedToken||!(t!=null&&t.forceUpdate)&&this._tokenAccounts.length)return{tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos};this.scope.checkOwner();let i=M(M({},{}),t),[o,s]=await Promise.all([this.scope.connection.getAccountInfo(this.scope.ownerPubKey,i.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:Xt},i.commitment)]),{tokenAccounts:a,tokenAccountRawInfos:u}=Vs({owner:this.scope.ownerPubKey,solAccountResp:o,tokenAccountResp:s});return this._tokenAccounts=a,this._tokenAccountRawInfos=u,this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=this.scope.connection.onAccountChange(this.scope.ownerPubKey,()=>this.fetchWalletTokenAccounts({forceUpdate:!0}),"confirmed"),{tokenAccounts:a,tokenAccountRawInfos:u}}async getCreatedTokenAccount({mint:t,programId:n=Xt,associatedOnly:i=!0}){await this.fetchWalletTokenAccounts();let o=this._tokenAccounts.filter(({mint:a})=>a==null?void 0:a.equals(t)).sort((a,u)=>a.amount.lt(u.amount)?1:-1),s=this.getAssociatedTokenAccount(t,n);for(let a of o){let{publicKey:u}=a;if(u)return i&&s.equals(u),u}}async getOrCreateTokenAccount(t){var y,f,b;await this.fetchWalletTokenAccounts();let{mint:n,createInfo:i,associatedOnly:o,owner:s,notUseTokenAccount:a=!1,skipCloseAccount:u=!1,checkCreateATAOwner:c=!1}=t,l=new zr(t.tokenProgram||Xt),m=this.getAssociatedTokenAccount(n,new zr(l)),p=(a?[]:this.tokenAccountRawInfos).filter(w=>w.accountInfo.mint.equals(n)&&(!o||w.pubkey.equals(m))).sort((w,h)=>w.accountInfo.amount.lt(h.accountInfo.amount)?1:-1);if(i===void 0||p.length>0)return p.length>0?{account:p[0].pubkey}:{};let d={instructions:[],endInstructions:[],signers:[],instructionTypes:[],endInstructionTypes:[]};if(o){let w=Wi(s,m,s,n,l);if(c){let h=await this.scope.connection.getAccountInfo(m);if(h===null)(y=d.instructions)==null||y.push(w),d.instructionTypes.push(_.CreateATA);else if(!(h.owner.equals(l)&&An.decode(h.data).mint.equals(n)&&An.decode(h.data).owner.equals(s)))throw Error(`create ata check error -> mint: ${n.toString()}, ata: ${m.toString()}`)}else d.instructions.push(w),d.instructionTypes.push(_.CreateATA);if(n.equals($)&&i.amount){let h=await kt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:i.payer||this.scope.ownerPubKey,amount:(f=i.amount)!=null?f:0,skipCloseAccount:u});d.instructions.push(...h.instructions||[]),d.endInstructions.push(...h.endInstructions||[]),d.instructionTypes.push(...h.instructionTypes||[]),d.endInstructionTypes.push(...h.endInstructionTypes||[]),i.amount&&(d.instructions.push(Dn({source:h.addresses.newAccount,destination:m,owner:this.scope.ownerPubKey,amount:i.amount,tokenProgram:Xt})),d.instructionTypes.push(_.TransferAmount))}return u||(d.endInstructions.push(Lt({owner:s,payer:i.payer||s,tokenAccount:m,programId:l})),d.endInstructionTypes.push(_.CloseAccount)),{account:m,instructionParams:d}}else if(n.equals($)){let w=await kt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:i.payer||this.scope.ownerPubKey,amount:(b=i.amount)!=null?b:0,skipCloseAccount:u});return d.instructions.push(...w.instructions||[]),d.endInstructions.push(...w.endInstructions||[]),d.signers.push(...w.signers||[]),d.instructionTypes.push(...w.instructionTypes||[]),d.endInstructionTypes.push(...w.endInstructionTypes||[]),{account:w.addresses.newAccount,instructionParams:d}}else{let w=We({fromPublicKey:s,programId:l}),h=await this.scope.connection.getMinimumBalanceForRentExemption(An.span),A=il.createAccountWithSeed({fromPubkey:s,basePubkey:s,seed:w.seed,newAccountPubkey:w.publicKey,lamports:h,space:An.span,programId:l});return d.instructions.push(A,vi({mint:n,tokenAccount:w.publicKey,owner:this.scope.ownerPubKey,programId:l})),d.instructionTypes.push(_.CreateAccount),d.instructionTypes.push(_.InitAccount),u||(d.endInstructions.push(Lt({owner:s,payer:i.payer||s,tokenAccount:w.publicKey,programId:l})),d.endInstructionTypes.push(_.CloseAccount)),{account:w.publicKey,instructionParams:d}}}async checkOrCreateAta({mint:t,programId:n=Xt,autoUnwrapWSOLToSOL:i}){var u;await this.fetchWalletTokenAccounts();let o=(u=this.scope.account.tokenAccounts.find(({mint:c})=>(c==null?void 0:c.toBase58())===t.toBase58()))==null?void 0:u.publicKey,s=this.scope.ownerPubKey,a={};if(!o){let c=this.getAssociatedTokenAccount(t,n),l=await Wi(s,c,s,t,n);a.instructions=[l],a.instructionTypes=[_.CreateATA],o=c}return i&&$.toBase58()===t.toBase58()&&(a.endInstructions=[Lt({owner:s,payer:s,tokenAccount:o,programId:n})],a.endInstructionTypes=[_.CloseAccount]),{pubKey:o,newInstructions:a}}async handleTokenAccount(t){let{side:n,amount:i,mint:o,programId:s=Xt,tokenAccount:a,payer:u=this.scope.ownerPubKey,bypassAssociatedCheck:c,skipCloseAccount:l,checkCreateATAOwner:m}=t,p=this.getAssociatedTokenAccount(o,s);if(new zr($).equals(o)){let d=await kt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:u,amount:i,skipCloseAccount:l});return M({tokenAccount:d.addresses.newAccount},d)}else if(!a||n==="out"&&!p.equals(a)&&!c){let d=[],y=Wi(this.scope.ownerPubKey,p,this.scope.ownerPubKey,o,s);if(m){let f=await this.scope.connection.getAccountInfo(p);if(f===null)d.push(y);else if(!(f.owner.equals(Xt)&&An.decode(f.data).mint.equals(o)&&An.decode(f.data).owner.equals(this.scope.ownerPubKey)))throw Error(`create ata check error -> mint: ${o.toString()}, ata: ${p.toString()}`)}else d.push(y);return{tokenAccount:p,instructions:d,instructionTypes:[_.CreateATA]}}return{tokenAccount:a}}async processTokenAccount(t){let{mint:n,programId:i=Xt,amount:o,useSOLBalance:s,handleTokenAccount:a}=t,u,c=this.createTxBuilder();if(n.equals(new zr($))&&s){let l=await this.handleTokenAccount({side:"in",amount:o||0,mint:n,bypassAssociatedCheck:!0,programId:i}),{tokenAccount:p}=l,d=Ne(l,["tokenAccount"]);u=p,c.addInstruction(d)}else if(u=await this.getCreatedTokenAccount({mint:n,associatedOnly:!1,programId:i}),!u&&a){let m=await this.scope.account.handleTokenAccount({side:"in",amount:0,mint:n,bypassAssociatedCheck:!0,programId:i}),{tokenAccount:p}=m,d=Ne(m,["tokenAccount"]);u=p,c.addInstruction(d)}return M({tokenAccount:u},c.AllTxData)}};import{createAssociatedTokenAccountInstruction as xl}from"@solana/spl-token";import{PublicKey as Ae,SystemProgram as Bl}from"@solana/web3.js";import{PublicKey as Us}from"@solana/web3.js";var Di=R([V("instruction")]),qi=R([V("instruction")]),ol=R([g("rewardState"),g("rewardOpenTime"),g("rewardEndTime"),g("rewardLastUpdateTime"),g("totalReward"),g("totalRewardEmissioned"),g("rewardClaimed"),g("rewardPerSecond"),z("accRewardPerShare"),B("rewardVault"),B("rewardMint"),B("rewardSender"),g("rewardType"),G(g(),15,"padding")]),sl=R([g("state"),g("nonce"),B("lpVault"),B("rewardVault"),B(),B(),g(),g(),g("totalReward"),z("perShareReward"),g("lastSlot"),g("perSlotReward")]),al=R([g("state"),g("nonce"),B("lpVault"),B("rewardVaultA"),g("totalRewardA"),z("perShareRewardA"),g("perSlotRewardA"),V("option"),B("rewardVaultB"),ke(7),g("totalRewardB"),z("perShareRewardB"),g("perSlotRewardB"),g("lastSlot"),B()]),ul=R([g(),g("state"),g("nonce"),g("validRewardTokenNum"),z("rewardMultiplier"),g("rewardPeriodMax"),g("rewardPeriodMin"),g("rewardPeriodExtend"),B("lpMint"),B("lpVault"),G(ol,5,"rewardInfos"),B("creator"),B(),G(g(),32,"padding")]),Es=new Proxy(sl,{get(r,e,t){return e==="decode"?(...n)=>{let i=r.decode(...n);return D(M({},i),{version:3,rewardInfos:[{rewardVault:i.rewardVault,totalReward:i.totalReward,perSlotReward:i.perSlotReward,perShareReward:i.perShareReward}]})}:Reflect.get(r,e,t)}}),Fs=new Proxy(al,{get(r,e,t){return e==="decode"?(...n)=>{let i=r.decode(...n);return D(M({},i),{version:5,rewardInfos:[{rewardVault:i.rewardVaultA,totalReward:i.totalRewardA,perSlotReward:i.perSlotRewardA,perShareReward:i.perShareRewardA},{rewardVault:i.rewardVaultB,totalReward:i.totalRewardB,perSlotReward:i.perSlotRewardB,perShareReward:i.perShareRewardB}]})}:Reflect.get(r,e,t)}}),Un=new Proxy(ul,{get(r,e,t){return e==="decode"?(...n)=>{let i=r.decode(...n);return D(M({},i),{version:6,rewardInfos:i.rewardInfos.map(o=>{var s;return D(M({},o),{rewardType:((s=Object.entries(zt).find(a=>String(a[1])===o.rewardType.toString()))!=null?s:["Standard SPL"])[0]})})})}:Reflect.get(r,e,t)}}),cl=R([g("isSet"),g("rewardPerSecond"),g("rewardOpenTime"),g("rewardEndTime"),g("rewardType")]),Ui=R([V("instruction"),g("nonce"),G(cl,5,"rewardTimeInfo")]),Gi=R([V("instruction"),g("rewardReopenTime"),g("rewardEndTime"),g("rewardPerSecond")]),Xi=R([V("instruction"),g("isSet"),g("rewardPerSecond"),g("rewardOpenTime"),g("rewardEndTime"),g("rewardType")]),ig=R([g("state"),B("id"),B("owner"),g("deposited"),G(g(),1,"rewardDebts")]),Gn=R([g("state"),B("id"),B("owner"),g("deposited"),G(z(),1,"rewardDebts"),g(""),g("voteLockedBalance"),G(g(),15)]),og=R([g("state"),B("id"),B("owner"),g("deposited"),G(g(),2,"rewardDebts")]),vs=R([g("state"),B("id"),B("owner"),g("deposited"),G(z(),2,"rewardDebts"),G(g(),17)]),Ws=R([g(),g("state"),B("id"),B("owner"),g("deposited"),G(z(),5,"rewardDebts"),G(g(),16)]),ze=R([V("instruction"),g("amount")]),ll=R([B("mint"),B("grantAuthority"),g("baselineVoteWeightScaledFactor"),g("maxExtraLockupVoteWeightScaledFactor"),g("lockupSaturationSecs"),Ks("digitShift"),G(V(),7,"reserved1"),G(g(),7,"reserved2")]),Ds=R([ke(8),B("governanceProgramId"),B("realm"),B("realmGoverningTokenMint"),B("realmAuthority"),G(V(),32,"reserved1"),G(ll,4,"votingMints"),qr("timeOffset"),V("bump"),G(V(),7,"reserved2"),G(g(),11,"reserved3")]),ml=R([qr("startTime"),qr("endTime"),V("kind"),G(V(),15,"reserved")]),dl=R([G(ml,1,"lockup"),g("amountDeposited_native"),g("amountInitiallyLockedNative"),Xe("isUsed"),Xe("allowClawback"),V("votingMintConfigIdx"),G(V(),29,"reserved")]),qs=R([ke(8),B("voterAuthority"),B("registrar"),G(dl,32,"deposits"),V("voterBump"),V("voterWweightRecordBump"),G(V(),94,"reserved")]);var pg=oe("Raydium_farm_config"),Gs=new Us("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Xs=new Us("FrspKwj8i3pNmKwXreTveC4fu7KL5ZbGeXdZBe2XViu1"),zs={3:Es,5:Fs,6:Un},Ys={3:Gn,5:vs,6:Ws},zi=r=>[3,5,6].indexOf(r)!==-1,Yi=r=>{var s;let{version:e,rewardInfos:t,rewardTokenAccountsPublicKeys:n}=r,i=`rewardInfo:${JSON.stringify(t)}, rewardAccount:${JSON.stringify(n)}`,o={3:()=>{if(t.length!==1||n.length!==1)return`rewardInfos or rewardTokenAccounts lengths not equal 1: ${i}`},5:()=>{if(t.length!==n.length)return`rewardInfos and rewardTokenAccounts lengths not equal: ${i}`},6:()=>{if(!n.length||t.length!==n.length)return`no rewardTokenAccounts or rewardInfos and rewardTokenAccounts lengths not equal: ${i}`}};return(s=o[e])==null?void 0:s.call(o)},zt={"Standard SPL":0,"Option tokens":1},pt={[ws.toString()]:3,[ks.toString()]:5,[vn.toString()]:6};import{PublicKey as re,SystemProgram as $t,SYSVAR_RENT_PUBKEY as yl,SYSVAR_CLOCK_PUBKEY as Yn,TransactionInstruction as Le}from"@solana/web3.js";import{createAssociatedTokenAccountInstruction as bl,TOKEN_PROGRAM_ID as tt,ASSOCIATED_TOKEN_PROGRAM_ID as gl}from"@solana/spl-token";import Qr from"bn.js";function Qi(r,e,t){return le([e.toBuffer(),Buffer.from("registrar","utf8"),t.toBuffer()],r)}function ji(r,e){return le([e.toBuffer(),Buffer.from("voting_mint_seed","utf8")],r)}function Hi(r,e){return le([e.toBuffer()],r)}function Zi(r,e,t){return le([e.toBuffer(),Buffer.from("voter","utf8"),t.toBuffer()],r)}function Ji(r,e,t){return le([e.toBuffer(),Buffer.from("voter-weight-record","utf8"),t.toBuffer()],r)}function $i(r,e,t,n){return le([Buffer.from("governance","utf8"),e.toBuffer(),t.toBuffer(),n.toBuffer()],r)}import Ze from"bn.js";var Xn=oe("Raydium.farm.util");function zn({programId:r,poolId:e,mint:t,type:n}){let{publicKey:i}=le([e.toBuffer(),t.toBuffer(),Buffer.from(n==="lpVault"?"lp_vault_associated_seed":n==="rewardVault"?"reward_vault_associated_seed":"","utf-8")],r);return i}function Je({programId:r,poolId:e,owner:t,version:n}){let{publicKey:i}=le([e.toBuffer(),t.toBuffer(),Buffer.from(n===6?"farmer_info_associated_seed":"staker_info_v2_associated_seed","utf-8")],r);return i}var Qs=({programId:r,poolId:e})=>le([e.toBuffer()],r);function js(r){return{isSet:new Ze(1),rewardPerSecond:X(r.perSecond),rewardOpenTime:X(r.openTime),rewardEndTime:X(r.endTime),rewardType:X(zt[r.rewardType])}}function eo(r){return X(r.endTime).sub(X(r.openTime)).mul(X(r.perSecond))}function Yr(r){let e=Ys[r];return e||Xn.logWithError("invalid version",r),e}function pl(r){let e=zs[r];return e||Xn.logWithError("invalid version",r),e}function fl(r,e,t,n){if(r.version===3||r.version===5){if(r.lastSlot.gte(new Ze(t)))return r;let i=new Ze(t).sub(r.lastSlot);r.lastSlot=new Ze(t);for(let o of r.rewardInfos){if(e.amount.eq(new Ze(0)))continue;let s=o.perSlotReward.mul(i);o.perShareReward=o.perShareReward.add(s.mul(new Ze(10).pow(new Ze(r.version===3?9:15))).div(e.amount)),o.totalReward=o.totalReward.add(s)}}else if(r.version===6)for(let i of r.rewardInfos){if(i.rewardState.eq(new Ze(0)))continue;let o=Ze.min(new Ze(n),i.rewardEndTime);if(i.rewardOpenTime.gte(o))continue;let a=o.sub(i.rewardLastUpdateTime).mul(i.rewardPerSecond),u=i.totalReward.sub(i.totalRewardEmissioned);u.lt(a)?(a=u,i.rewardLastUpdateTime=i.rewardLastUpdateTime.add(u.div(i.rewardPerSecond))):i.rewardLastUpdateTime=o,!e.amount.eq(new Ze(0))&&(i.accRewardPerShare=i.accRewardPerShare.add(a.mul(r.rewardMultiplier).div(e.amount)),i.totalRewardEmissioned=i.totalRewardEmissioned.add(a))}return r}async function Rg({connection:r,farmPools:e,owner:t,config:n,chainTime:i}){let o=!1,s=!1,a=new Ze(10),u=[];for(let p of e){let d=pe(p);d.version===6?s=!0:o=!0,u.push({pubkey:d.id,version:d.version,key:"state",poolId:d.id},{pubkey:d.lpVault,version:d.version,key:"lpVault",poolId:d.id}),t&&u.push({pubkey:Je({programId:d.programId,poolId:d.id,owner:t,version:p.version}),version:d.version,key:"ledger",poolId:d.id})}let c={},l=await Mn(r,u,n);for(let{pubkey:p,version:d,key:y,poolId:f,accountInfo:b}of l){let w=f.toBase58();if(c[w]=M({},c[w]),y==="state"){let h=pl(d);(!b||!b.data||b.data.length!==h.span)&&Xn.logWithError(`invalid farm state account info, pools.id, ${p}`),c[w].state=h.decode(b.data)}else if(y==="lpVault")(!b||!b.data||b.data.length!==qt.span)&&Xn.logWithError(`invalid farm lp vault account info, pools.lpVault, ${p}`),c[w].lpVault=qt.decode(b.data);else if(y==="ledger"){let h=Yr(d);b&&b.data&&(b.data.length!==h.span&&Xn.logWithError(`invalid farm ledger account info, ledger, ${p}`),c[w].ledger=h.decode(b.data))}}let m=s||o?await r.getSlot():0;for(let p of Object.keys(c))c[p]!==void 0&&(c[p].state=fl(c[p].state,c[p].lpVault,m,i));for(let[p,{state:d,ledger:y}]of Object.entries(c))if(y){let f=d.version===6?d.rewardMultiplier:d.rewardInfos.length===1?a.pow(new Ze(9)):a.pow(new Ze(15)),b=d.rewardInfos.map((w,h)=>{let A=y.rewardDebts[h];return y.deposited.mul(d.version===6?w.accRewardPerShare:w.perShareReward).div(f).sub(A)});c[p].wrapped=D(M({},c[p].wrapped),{pendingRewards:b})}return c}function Lg(r,e=Date.now()){if(r.version===6){let t=r.state.rewardInfos;if(t.every(({rewardOpenTime:n})=>bs(e,n.toNumber(),{unit:"s"})))return"upcoming pool";if(t.every(({rewardEndTime:n})=>gs(e,n.toNumber(),{unit:"s"})))return"closed pool"}else{let t=r.state.rewardInfos.map(({perSlotReward:n})=>n);if(t.length===2){if(String(t[0])==="0"&&String(t[1])!=="0")return"normal fusion pool";if(String(t[0])!=="0"&&String(t[1])!=="0")return"dual fusion pool";if(String(t[0])==="0"&&String(t[1])==="0")return"closed pool"}else if(t.length===1&&String(t[0])==="0")return"closed pool"}}async function to(r,e,t,n){let i=await r.getAccountInfo(e);if(i===null)throw Error("registrar info check error");let s=Ds.decode(i.data).votingMints.findIndex(l=>l.mint.equals(n));if(s===-1)throw Error("find voter mint error");let a=await r.getAccountInfo(t);if(a===null)return{index:s,isInit:!1};let c=qs.decode(a.data).deposits.findIndex(l=>l.isUsed&&l.votingMintConfigIdx===s);return c===-1?{index:s,isInit:!1}:{index:c,isInit:!0}}var wl=oe("Raydium_farm_instruction"),Qn={voterStakeRegistryCreateVoter:Buffer.from([6,24,245,52,243,255,148,25]),voterStakeRegistryCreateDepositEntry:Buffer.from([185,131,167,186,159,125,19,67]),voterStakeRegistryDeposit:Buffer.from([242,35,198,137,82,225,242,182]),voterStakeRegistryWithdraw:Buffer.from([183,18,70,156,148,109,161,34]),voterStakeRegistryUpdateVoterWeightRecord:Buffer.from([45,185,3,36,109,190,115,169])};function Hs(r){let{version:e,id:t,ledger:n,programId:i,owner:o}=r,s={3:9,5:10}[e];s||wl.logWithError(`invalid farm pool version: ${e}`);let a=Buffer.alloc(Di.span);Di.encode({instruction:s},a);let u=[k({pubkey:t}),k({pubkey:n}),k({pubkey:o,isWritable:!1}),k({pubkey:$t.programId,isWritable:!1}),k({pubkey:yl,isWritable:!1})];return{instruction:new Le({programId:i,keys:u,data:a}),instructionType:_.FarmV3CreateLedger}}function Zs(r){var n;let e=Buffer.alloc(Ui.span);Ui.encode({instruction:0,nonce:new Qr(r.nonce),rewardTimeInfo:r.rewardInfoConfig},e);let t=[...pi,k({pubkey:r.farmId}),k({pubkey:r.farmAuthority,isWritable:!1}),k({pubkey:r.lpVault}),k({pubkey:r.lpMint,isWritable:!1}),k({pubkey:r.lockVault}),k({pubkey:r.lockMint,isWritable:!1}),k({pubkey:(n=r.lockUserAccount)!=null?n:de}),k({pubkey:r.owner,isWritable:!1,isSigner:!0})];for(let i of r.rewardInfo)t.push(k({pubkey:i.rewardMint,isWritable:!1}),k({pubkey:i.rewardVault}),k({pubkey:i.userRewardToken}));return{instruction:new Le({programId:r.programId,keys:t,data:e}),instructionType:_.FarmV6Create}}function Js(r){let e=Buffer.alloc(qi.span);qi.encode({instruction:5},e);let t=[k({pubkey:tt,isWritable:!1}),k({pubkey:r.id}),k({pubkey:r.authority,isWritable:!1}),k({pubkey:r.lpVault,isWritable:!1}),k({pubkey:r.rewardVault}),k({pubkey:r.userRewardToken}),k({pubkey:r.owner,isWritable:!1,isSigner:!0})];return{instruction:new Le({programId:r.programId,keys:t,data:e}),instructionType:_.FarmV6CreatorWithdraw}}function kl(r,e,t,n,i,o,s,a,u,c,l,m,p){let d=R([V("depositEntryIndex"),g("amount")]),y=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:tt,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:Tr,isSigner:!1,isWritable:!1}],f=Buffer.alloc(d.span);d.encode({depositEntryIndex:m,amount:p},f);let b=Buffer.from([...Qn.voterStakeRegistryDeposit,...f]);return new Le({keys:y,programId:r,data:b})}function Al(r,e,t,n){let i=R([]),o=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:$t.programId,isSigner:!1,isWritable:!1}],s=Buffer.alloc(i.span);i.encode({},s);let a=Buffer.from([...Qn.voterStakeRegistryUpdateVoterWeightRecord,...s]);return new Le({keys:o,programId:r,data:a})}function hl(r,e,t,n,i,o,s,a,u,c,l,m,p,d,y){let f=R([V("depositEntryIndex"),g("amount")]),b=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:tt,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Tr,isSigner:!1,isWritable:!1}],w=Buffer.alloc(f.span);f.encode({depositEntryIndex:d,amount:y},w);let h=Buffer.from([...Qn.voterStakeRegistryWithdraw,...w]);return new Le({keys:b,programId:r,data:h})}function Pl(r,e,t,n,i,o){let s=R([V("ins")]),a=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:$t.programId,isSigner:!1,isWritable:!1}],u=Buffer.alloc(s.span);return s.encode({ins:23},u),new Le({keys:a,programId:r,data:u})}function Tl(r,e,t,n,i,o,s,a){let u=R([V("voterBump"),V("voterWeightRecordBump")]),c=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:$t.programId,isSigner:!1,isWritable:!1},{pubkey:rt,isSigner:!1,isWritable:!1},{pubkey:Tr,isSigner:!1,isWritable:!1}],l=Buffer.alloc(u.span);u.encode({voterBump:s,voterWeightRecordBump:a},l);let m=Buffer.from([...Qn.voterStakeRegistryCreateVoter,...l]);return new Le({keys:c,programId:r,data:m})}function Il(r,e,t,n,i,o,s,a,u,c,l,m){let p=R([V("depositEntryIndex"),V("kind"),V("option"),g("startTs"),ve("periods"),Xe("allowClawback")]),d=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!0,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:$t.programId,isSigner:!1,isWritable:!1},{pubkey:tt,isSigner:!1,isWritable:!1},{pubkey:gl,isSigner:!1,isWritable:!1},{pubkey:rt,isSigner:!1,isWritable:!1}],y=Buffer.alloc(p.span);p.encode({depositEntryIndex:a,kind:u,option:c===void 0?0:1,startTs:c,periods:l,allowClawback:m},y);let f=Buffer.from([...Qn.voterStakeRegistryCreateDepositEntry,...y]);return new Le({keys:d,programId:r,data:f})}async function Qg({connection:r,programId:e,governanceProgramId:t,voteWeightAddinProgramId:n,realm:i,communityTokenMint:o,owner:s,poolId:a,tokenProgram:u}){let c=Qi(n,i,o).publicKey,l=Je({programId:e,poolId:a,owner:s,version:3}),m=await r.getAccountInfo(l);if(m===null)throw Error("user is not staker");let p=Gn.decode(m.data),d=p.deposited.sub(p.voteLockedBalance);if(console.log("amount",d.toString()),d.eq(new Qr(0)))throw Error("user do not has new stake amount");let y=ji(e,a).publicKey,f=Hi(e,a).publicKey,{publicKey:b,nonce:w}=Zi(n,c,s),h=we(b,y,u).publicKey,{publicKey:A,nonce:P}=Ji(n,c,s),T=$i(t,i,o,s).publicKey,I=[],x=we(s,y,u).publicKey;if(await r.getAccountInfo(x)===null&&I.push(bl(s,x,s,y)),await r.getAccountInfo(b)===null){let Z=Pl(t,i,s,o,s,T);I.push(Z,Tl(n,c,b,A,s,s,w,P))}let{index:L,isInit:E}=await to(r,c,b,y);return E||I.push(Il(n,c,b,h,s,s,y,L,0,void 0,0,!1)),I.push(kl(n,c,b,h,x,s,l,a,y,f,e,L,d),Al(n,c,b,A)),I}async function jg({connection:r,programId:e,governanceProgramId:t,voteWeightAddinProgramId:n,realm:i,communityTokenMint:o,owner:s,poolId:a,tokenProgram:u}){let c=Qi(n,i,o).publicKey,l=Je({programId:e,poolId:a,owner:s,version:3}),m=await r.getAccountInfo(l);if(m===null)throw Error("user is not staker");let p=Gn.decode(m.data);if(p.voteLockedBalance.eq(new Qr(0)))throw Error("user has vote locked balance = 0");let d=ji(e,a).publicKey,y=Hi(e,a).publicKey,{publicKey:f}=Zi(n,c,s),b=we(f,d,u).publicKey,{publicKey:w}=Ji(n,c,s),h=$i(t,i,o,s).publicKey,A=[],{index:P,isInit:T}=await to(r,c,f,d);if(!T)throw Error("deposit entry index check error");return A.push(hl(n,c,f,s,h,w,b,we(s,d,u).publicKey,l,a,d,y,e,P,p.voteLockedBalance)),A}function no({payer:r,rewardVault:e,userRewardTokenPub:t,farmKeys:n,rewardInfo:i}){let o=Buffer.alloc(Gi.span);Gi.encode({instruction:3,rewardReopenTime:X(i.openTime),rewardEndTime:X(i.endTime),rewardPerSecond:X(i.perSecond)},o);let s=[k({pubkey:tt,isWritable:!1}),k({pubkey:n.id}),k({pubkey:n.lpVault,isWritable:!1}),k({pubkey:e}),k({pubkey:t}),k({pubkey:r,isWritable:!1,isSigner:!0})];return new Le({programId:n.programId,keys:s,data:o})}function ro({payer:r,userRewardTokenPub:e,farmKeys:t,rewardVault:n,rewardInfo:i}){let o=Buffer.alloc(Xi.span);Xi.encode({instruction:4,isSet:new Qr(1),rewardPerSecond:X(i.perSecond),rewardOpenTime:X(i.openTime),rewardEndTime:X(i.endTime),rewardType:X(zt[i.rewardType])},o);let s=[...pi,k({pubkey:t.id}),k({pubkey:t.authority,isWritable:!1}),k({pubkey:i.mint,isWritable:!1}),k({pubkey:n}),k({pubkey:e}),k({pubkey:r,isWritable:!1,isSigner:!0})];return new Le({programId:t.programId,keys:s,data:o})}function Hg(r){let{farmInfo:e,farmKeys:t,version:n,lpAccount:i,rewardAccounts:o,owner:s,instruction:a,amount:u,deposit:c}=r,[l,m]=[new re(e.programId),new re(e.id)],p=Je({programId:l,poolId:m,owner:s,version:n}),d=Buffer.alloc(ze.span);ze.encode({instruction:a,amount:u},d);let y=n===6?[k({pubkey:tt,isWritable:!1}),...c?[k({pubkey:$t.programId,isWritable:!1})]:[],k({pubkey:m}),k({pubkey:new re(t.authority),isWritable:!1}),k({pubkey:new re(t.lpVault)}),k({pubkey:p}),k({pubkey:s,isWritable:!1,isSigner:!0}),k({pubkey:i})]:[k({pubkey:m}),k({pubkey:new re(t.authority),isWritable:!1}),k({pubkey:p}),k({pubkey:s,isWritable:!1,isSigner:!0}),k({pubkey:i}),k({pubkey:new re(t.lpVault)}),k({pubkey:o[0]}),k({pubkey:new re(t.rewardInfos[0].vault)}),k({pubkey:Yn,isWritable:!1}),k({pubkey:tt,isWritable:!1})];if(n===5)for(let f=1;f<t.rewardInfos.length;f++)y.push(k({pubkey:o[f]})),y.push(k({pubkey:new re(t.rewardInfos[f].vault)}));if(n===6)for(let f=0;f<t.rewardInfos.length;f++)y.push(k({pubkey:new re(t.rewardInfos[f].vault)})),y.push(k({pubkey:o[f]}));return new Le({programId:l,keys:y,data:d})}function jn(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:o,amount:s}=r,[a,u]=[new re(e.programId),new re(e.id)],c=Je({programId:a,poolId:u,owner:o,version:6}),l=Buffer.alloc(ze.span);ze.encode({instruction:2,amount:X(s)},l);let m=[k({pubkey:tt,isWritable:!1}),k({pubkey:u}),k({pubkey:new re(t.authority),isWritable:!1}),k({pubkey:new re(t.lpVault)}),k({pubkey:c}),k({pubkey:o,isWritable:!1,isSigner:!0}),k({pubkey:n})];for(let p=0;p<t.rewardInfos.length;p++)m.push(k({pubkey:new re(t.rewardInfos[p].vault)})),m.push(k({pubkey:i[p]}));return new Le({programId:a,keys:m,data:l})}function Hn(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:o,amount:s,userAuxiliaryLedgers:a}=r,[u,c]=[new re(e.programId),new re(e.id)],l=Je({programId:u,poolId:c,owner:o,version:5}),m=Buffer.alloc(ze.span);ze.encode({instruction:12,amount:X(s)},m);let p=[k({pubkey:c}),k({pubkey:new re(t.authority),isWritable:!1}),k({pubkey:l}),k({pubkey:o,isWritable:!1,isSigner:!0}),k({pubkey:n}),k({pubkey:new re(t.lpVault)}),k({pubkey:i[0]}),k({pubkey:new re(t.rewardInfos[0].vault)}),k({pubkey:Yn,isWritable:!1}),k({pubkey:tt,isWritable:!1})];for(let d=1;d<t.rewardInfos.length;d++)p.push(k({pubkey:i[d]})),p.push(k({pubkey:new re(t.rewardInfos[d].vault)}));if(a)for(let d of a)p.push(k({pubkey:d}));return new Le({programId:u,keys:p,data:m})}function Zn(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:o,amount:s,userAuxiliaryLedgers:a}=r,[u,c]=[new re(e.programId),new re(e.id)],l=Je({programId:u,poolId:c,owner:o,version:3}),m=Buffer.alloc(ze.span);ze.encode({instruction:11,amount:X(s)},m);let p=[k({pubkey:c}),k({pubkey:new re(t.authority),isWritable:!1}),k({pubkey:l}),k({pubkey:o,isWritable:!1,isSigner:!0}),k({pubkey:n}),k({pubkey:new re(t.lpVault)}),k({pubkey:i[0]}),k({pubkey:new re(t.rewardInfos[0].vault)}),k({pubkey:Yn,isWritable:!1}),k({pubkey:tt,isWritable:!1})];if(a)for(let d of a)p.push(k({pubkey:d}));return new Le({programId:u,keys:p,data:m})}function $s(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:o,amount:s,userAuxiliaryLedgers:a}=r,[u,c]=[new re(e.programId),new re(e.id)],l=Je({programId:u,poolId:c,owner:o,version:3}),m=Buffer.alloc(ze.span);ze.encode({instruction:10,amount:X(s)},m);let p=[k({pubkey:c}),k({pubkey:new re(t.authority),isWritable:!1}),k({pubkey:l}),k({pubkey:o,isWritable:!1,isSigner:!0}),k({pubkey:n}),k({pubkey:new re(t.lpVault)}),k({pubkey:i[0]}),k({pubkey:new re(t.rewardInfos[0].vault)}),k({pubkey:Yn,isWritable:!1}),k({pubkey:tt,isWritable:!1})];if(a)for(let d of a)p.push(k({pubkey:d}));return new Le({programId:u,keys:p,data:m})}function ea(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:o,amount:s,userAuxiliaryLedgers:a}=r,[u,c]=[new re(e.programId),new re(e.id)],l=Je({programId:u,poolId:c,owner:o,version:5}),m=Buffer.alloc(ze.span);ze.encode({instruction:11,amount:X(s)},m);let p=[k({pubkey:c}),k({pubkey:new re(t.authority),isWritable:!1}),k({pubkey:l}),k({pubkey:o,isWritable:!1,isSigner:!0}),k({pubkey:n}),k({pubkey:new re(t.lpVault)}),k({pubkey:i[0]}),k({pubkey:new re(t.rewardInfos[0].vault)}),k({pubkey:Yn,isWritable:!1}),k({pubkey:tt,isWritable:!1})];for(let d=1;d<t.rewardInfos.length;d++)p.push(k({pubkey:i[d]})),p.push(k({pubkey:new re(t.rewardInfos[d].vault)}));if(a)for(let d of a)p.push(k({pubkey:d}));return new Le({programId:u,keys:p,data:m})}function ta(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:o,amount:s}=r,[a,u]=[new re(e.programId),new re(e.id)],c=Je({programId:a,poolId:u,owner:o,version:6}),l=Buffer.alloc(ze.span);ze.encode({instruction:1,amount:X(s)},l);let m=[k({pubkey:tt,isWritable:!1}),k({pubkey:$t.programId,isWritable:!1}),k({pubkey:u}),k({pubkey:new re(t.authority),isWritable:!1}),k({pubkey:new re(t.lpVault)}),k({pubkey:c}),k({pubkey:o,isWritable:!1,isSigner:!0}),k({pubkey:n})];for(let p=0;p<t.rewardInfos.length;p++)m.push(k({pubkey:new re(t.rewardInfos[p].vault)})),m.push(k({pubkey:i[p]}));return new Le({programId:a,keys:m,data:l})}var Jn=class extends Te{async _getUserRewardInfo({payer:e,rewardInfo:t}){if(t.mint.equals(de)){let n=await kt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:e,amount:eo(t)});return{rewardPubKey:n.addresses.newAccount,newInstruction:n}}return{rewardPubKey:await this.scope.account.getCreatedTokenAccount({mint:t.mint,associatedOnly:!1})}}async create({poolInfo:e,rewardInfos:t,payer:n,programId:i=vn,txVersion:o}){this.checkDisabled(),this.scope.checkOwner();let a={lpMint:new Ae(e.lpMint.address),lockInfo:{lockMint:Gs,lockVault:Xs},version:6,rewardInfos:t,programId:i},u=this.createTxBuilder(),c=n!=null?n:this.scope.ownerPubKey,l=We({fromPublicKey:c,programId:a.programId}),m=await this.scope.connection.getMinimumBalanceForRentExemption(Un.span);u.addInstruction({instructions:[Bl.createAccountWithSeed({fromPubkey:c,basePubkey:c,seed:l.seed,newAccountPubkey:l.publicKey,lamports:m,space:Un.span,programId:a.programId})]});let{publicKey:p,nonce:d}=Qs({programId:new Ae(a.programId),poolId:l.publicKey}),y=zn({programId:a.programId,poolId:l.publicKey,mint:a.lpMint,type:"lpVault"}),f=[],b=[];for(let P of a.rewardInfos){P.openTime>=P.endTime&&this.logAndCreateError("start time error","rewardInfo.rewardOpenTime",P.openTime.toString()),isNaN(zt[P.rewardType])&&this.logAndCreateError("rewardType error",P.rewardType),Number(P.perSecond)<=0&&this.logAndCreateError("rewardPerSecond error",P.perSecond),f.push(js(P));let{rewardPubKey:T,newInstruction:I}=await this._getUserRewardInfo({rewardInfo:P,payer:c});I&&u.addInstruction(I),T||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let x=P.mint.equals(de)?new Ae(Se.address):P.mint;b.push({rewardMint:x,rewardVault:zn({programId:a.programId,poolId:l.publicKey,mint:x,type:"rewardVault"}),userRewardToken:T})}let w=await this.scope.account.getCreatedTokenAccount({mint:a.lockInfo.lockMint});w||this.logAndCreateError("cannot found lock vault","tokenAccounts",this.scope.account.tokenAccounts);let{instruction:h,instructionType:A}=Zs({farmId:l.publicKey,owner:this.scope.ownerPubKey,farmAuthority:p,lpVault:y,lpMint:a.lpMint,lockVault:a.lockInfo.lockVault,lockMint:a.lockInfo.lockMint,lockUserAccount:w,programId:a.programId,rewardInfo:b,rewardInfoConfig:f,nonce:d});return u.addInstruction({instructions:[h],instructionTypes:[A]}).versionBuild({txVersion:o,extInfo:{farmId:l.publicKey,farmAuthority:p,lpVault:y,lockUserAccount:w,nonce:d}})}async restartReward({farmInfo:e,payer:t,newRewardInfo:n,txVersion:i}){var b;let o=pt[e.programId];o!==6&&this.logAndCreateError("invalid farm version ",o);let s=pe((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),a={id:s.id,rewardInfos:e.rewardInfos,lpVault:s.lpVault,programId:s.programId};n.openTime>=n.endTime&&this.logAndCreateError("start time error","newRewardInfo",n);let u=t||this.scope.ownerPubKey,c=n.mint.equals(de)?new Ae(Se.address):n.mint,l=a.rewardInfos.findIndex(w=>new Ae(w.mint.address).equals(c)),m=s.rewardInfos[l];m||this.logAndCreateError("configuration does not exist","rewardMint",c);let p=(b=m.vault)!=null?b:de,d=this.createTxBuilder(),{rewardPubKey:y,newInstruction:f}=await this._getUserRewardInfo({rewardInfo:n,payer:u});return f&&d.addInstruction(f),y||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts),d.addInstruction({instructions:[no({payer:this.scope.ownerPubKey,rewardVault:p,userRewardTokenPub:y,farmKeys:a,rewardInfo:n})],instructionTypes:[_.FarmV6Restart]}).versionBuild({txVersion:i})}async restartRewards({farmInfo:e,payer:t,newRewardInfos:n,txVersion:i}){var l;let o=pt[e.programId];o!==6&&this.logAndCreateError("invalid farm version ",o);let s=pe((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),a={id:s.id,rewardInfos:e.rewardInfos,lpVault:s.lpVault,programId:s.programId};n.forEach(m=>{m.openTime>=m.endTime&&this.logAndCreateError("start time error","newRewardInfo",m)});let u=t||this.scope.ownerPubKey,c=this.createTxBuilder();for(let m of n){let p=m.mint.equals(de)?new Ae(Se.address):m.mint,d=a.rewardInfos.findIndex(A=>new Ae(A.mint.address).equals(p)),y=s.rewardInfos[d];y||this.logAndCreateError("configuration does not exist","rewardMint",p);let f=(l=y.vault)!=null?l:de,{rewardPubKey:b,newInstruction:w}=await this._getUserRewardInfo({rewardInfo:m,payer:u});w&&c.addInstruction(w),b||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let h=no({payer:this.scope.ownerPubKey,rewardVault:f,userRewardTokenPub:b,farmKeys:a,rewardInfo:m});c.addInstruction({instructions:[h],instructionTypes:[_.FarmV6Restart]})}return c.versionBuild({txVersion:i})}async addNewRewardToken(e){let{txVersion:t,farmInfo:n,newRewardInfo:i,payer:o}=e,s=pt[n.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=pe((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=o!=null?o:this.scope.ownerPubKey,c=this.createTxBuilder(),l=i.mint.equals(de)?new Ae(Se.address):i.mint,m=zn({programId:new Ae(n.programId),poolId:new Ae(n.id),mint:l,type:"rewardVault"}),{rewardPubKey:p,newInstruction:d}=await this._getUserRewardInfo({rewardInfo:i,payer:u});return d&&c.addInstruction(d),p||this.logAndCreateError("annot found target token accounts",this.scope.account.tokenAccounts),i.mint=l,c.addInstruction({instructions:[ro({payer:this.scope.ownerPubKey,userRewardTokenPub:p,farmKeys:a,rewardVault:m,rewardInfo:i})],instructionTypes:[_.FarmV6CreatorAddReward]}).versionBuild({txVersion:t})}async addNewRewardsToken(e){let{txVersion:t,farmInfo:n,newRewardInfos:i,payer:o}=e,s=pt[n.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=pe((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=o!=null?o:this.scope.ownerPubKey,c=this.createTxBuilder();for(let l of i){let m=l.mint.equals(de)?new Ae(Se.address):l.mint,p=zn({programId:new Ae(n.programId),poolId:new Ae(n.id),mint:m,type:"rewardVault"}),{rewardPubKey:d,newInstruction:y}=await this._getUserRewardInfo({rewardInfo:l,payer:u});y&&c.addInstruction(y),d||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let f=ro({payer:this.scope.ownerPubKey,userRewardTokenPub:d,farmKeys:a,rewardVault:p,rewardInfo:D(M({},l),{mint:m})});c.addInstruction({instructions:[f],instructionTypes:[_.FarmV6CreatorAddReward]})}return c.versionBuild({txVersion:t})}async deposit(e){let{txVersion:t,farmInfo:n,amount:i,feePayer:o,useSOLBalance:s,associatedOnly:a=!0,checkCreateATAOwner:u=!1,userAuxiliaryLedgers:c,computeBudgetConfig:l}=e;this.scope.availability.addFarm===!1&&this.logAndCreateError("farm deposit feature disabled in your region");let{rewardInfos:m,programId:p}=n,d=pt[p];zi(d)||this.logAndCreateError("invalid farm program:",n.programId);let[y,f]=[new Ae(n.programId),new Ae(n.id)],b=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],w=Je({programId:y,poolId:f,owner:this.scope.ownerPubKey,version:d}),h=this.createTxBuilder();h.addCustomComputeBudget(l);let A={};for(let W of this.scope.account.tokenAccounts)if(a){let ee=we(this.scope.ownerPubKey,W.mint,W.programId).publicKey;W.publicKey&&ee.equals(W.publicKey)&&(A[W.mint.toString()]=W.publicKey)}else A[W.mint.toString()]=W.publicKey;let P=b.lpMint,T=A[P.address];T||this.logAndCreateError("you don't have any lp","lp zero",A);let I=[];for(let W of m){let ee=s&&W.mint.address===$.toString(),Q=A[W.mint.address];if(!Q){let{account:te,instructionParams:at}=await this.scope.account.getOrCreateTokenAccount({mint:new Ae(W.mint.address),notUseTokenAccount:ee,createInfo:{payer:o||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!ee,associatedOnly:ee?!1:a,checkCreateATAOwner:u});Q=te,at&&h.addInstruction(at)}A[W.mint.address]=Q,I.push(Q)}let x,O=await this.scope.connection.getAccountInfo(w);if(O&&(x=Yr(d).decode(O.data)),n.programId!==vn.toString()&&!x){let{instruction:W,instructionType:ee}=Hs({id:f,programId:y,version:d,ledger:w,owner:this.scope.ownerPubKey});h.addInstruction({instructions:[W],instructionTypes:[ee]})}let N=Yi({version:d,rewardInfos:m,rewardTokenAccountsPublicKeys:I});N&&this.logAndCreateError(N);let L={amount:X(i),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:b,lpAccount:T,rewardAccounts:I,userAuxiliaryLedgers:c==null?void 0:c.map(W=>new Ae(W))},E=d===6?ta(L):d===5?ea(L):$s(L),Z={3:_.FarmV3Deposit,5:_.FarmV5Deposit,6:_.FarmV6Deposit};return h.addInstruction({instructions:[E],instructionTypes:[Z[d]]}).versionBuild({txVersion:t})}async withdraw(e){let{txVersion:t,farmInfo:n,amount:i,deposited:o,useSOLBalance:s,feePayer:a,associatedOnly:u=!0,checkCreateATAOwner:c=!1,userAuxiliaryLedgers:l,computeBudgetConfig:m}=e,{rewardInfos:p}=n;this.scope.availability.removeFarm===!1&&this.logAndCreateError("farm withdraw feature disabled in your region");let d=pt[n.programId];zi(d)||this.logAndCreateError("invalid farm program:",n.programId);let y=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],f=this.createTxBuilder();f.addCustomComputeBudget(m);let b={};for(let N of this.scope.account.tokenAccounts)if(u){let L=we(this.scope.ownerPubKey,N.mint).publicKey;N.publicKey&&L.equals(N.publicKey)&&(b[N.mint.toString()]=N.publicKey)}else b[N.mint.toString()]=N.publicKey;if(o)o.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id});else{let N=Je({programId:new Ae(n.programId),poolId:new Ae(n.id),owner:this.scope.ownerPubKey,version:d}),L=await this.scope.connection.getAccountInfo(N);L||this.logAndCreateError("no lp data",{farmId:n.id,version:d,ledgerData:L}),Yr(d).decode(L.data).deposited.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id})}let w=y.lpMint.address,h=s&&w===$.toString(),A=b[w.toString()];if(!A){let{account:N,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({mint:new Ae(w),notUseTokenAccount:h,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:h?!1:u,checkCreateATAOwner:c});A=N,L&&f.addInstruction(L)}b[w.toString()]=A;let P=[];for(let N of p){let L=s&&N.mint.address===$.toString(),E=b[N.mint.address];if(!E){let{account:Z,instructionParams:W}=await this.scope.account.getOrCreateTokenAccount({mint:new Ae(N.mint.address),notUseTokenAccount:L,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!L,associatedOnly:L?!1:u,checkCreateATAOwner:c});E=Z,W&&f.addInstruction(W)}b[N.mint.address]=E,P.push(E)}let T=Yi({version:d,rewardInfos:p,rewardTokenAccountsPublicKeys:P});T&&this.logAndCreateError(T);let I={amount:X(i),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:y,lpAccount:A,rewardAccounts:P,userAuxiliaryLedgers:l==null?void 0:l.map(N=>new Ae(N))},x=d===6?jn(I):d===5?Hn(I):Zn(I),O={3:_.FarmV3Withdraw,5:_.FarmV5Withdraw,6:_.FarmV6Withdraw};return f.addInstruction({instructions:[x],instructionTypes:[O[d]]}).versionBuild({txVersion:t})}async withdrawFarmReward({farmInfo:e,withdrawMint:t,txVersion:n}){var d;this.scope.checkOwner();let i=pe((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),o=pt[e.programId];o!==6&&this.logAndCreateError("invalid farm version",o);let s=e.rewardInfos.findIndex(y=>y.mint.address===de.toString()?new Ae(Se.address):t),a=i.rewardInfos[s];a||this.logAndCreateError("withdraw mint error","rewardInfos",e);let u=(d=a==null?void 0:a.vault)!=null?d:de,c=this.createTxBuilder(),l;if(t.equals(de)){let y=await kt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:eo(D(M({},a),{perSecond:new v(a.perSecond).mul(10**a.mint.decimals).toString()}))});l=y.addresses.newAccount,c.addInstruction(y)}else{let y=await this.scope.account.getCreatedTokenAccount({mint:t});y===null?(l=await this.scope.account.getAssociatedTokenAccount(t),c.addInstruction({instructions:[xl(this.scope.ownerPubKey,l,this.scope.ownerPubKey,t)],instructionTypes:[_.CreateATA]})):l=y}let{instruction:m,instructionType:p}=Js({programId:i.programId,id:i.id,authority:i.authority,lpVault:i.lpVault,rewardVault:u,userRewardToken:l,owner:this.scope.ownerPubKey});return c.addInstruction({instructions:[m],instructionTypes:[p]}).versionBuild({txVersion:n})}async harvestAllRewards(e){let{farmInfoList:t,useSOLBalance:n,feePayer:i,associatedOnly:o=!0,checkCreateATAOwner:s=!1,userAuxiliaryLedgers:a,txVersion:u,computeBudgetConfig:c}=e,l=this.createTxBuilder();l.addCustomComputeBudget(c);let m={};for(let y of this.scope.account.tokenAccounts)if(o){let f=we(this.scope.ownerPubKey,y.mint).publicKey;y.publicKey&&f.equals(y.publicKey)&&(m[y.mint.toString()]=y.publicKey)}else m[y.mint.toString()]=y.publicKey;let d=(await this.scope.api.fetchFarmKeysById({ids:Object.values(t).map(y=>y.id).join(",")})).reduce((y,f)=>D(M({},y),{[f.id]:f}),{});for(let y of Object.values(t)){let{programId:f,lpMint:b,rewardInfos:w,id:h}=y,A=pt[f],P=b.address,T=n&&P===$.toString(),I=m[P];if(!I){let{account:Z,instructionParams:W}=await this.scope.account.getOrCreateTokenAccount({mint:new Ae(P),notUseTokenAccount:T,createInfo:{payer:i||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:T?!1:o,checkCreateATAOwner:s});I=Z,W&&l.addInstruction(W)}m[P.toString()]=I;let x=[];for(let Z of w){let W=n&&Z.mint.address===$.toString(),ee=m[Z.mint.address];if(!ee){let{account:Q,instructionParams:te}=await this.scope.account.getOrCreateTokenAccount({mint:new Ae(Z.mint.address),notUseTokenAccount:W,createInfo:{payer:i||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!W,associatedOnly:W?!1:o,checkCreateATAOwner:s});ee=Q,te&&l.addInstruction(te)}m[Z.mint.address]=ee,x.push(ee)}let O=d[h],N={amount:je,owner:this.scope.ownerPubKey,farmInfo:y,farmKeys:O,lpAccount:I,rewardAccounts:x,userAuxiliaryLedgers:a==null?void 0:a.map(Z=>new Ae(Z))},L=A===6?jn(N):A===5?Hn(N):Zn(N),E={3:_.FarmV3Withdraw,5:_.FarmV5Withdraw,6:_.FarmV6Withdraw};l.addInstruction({instructions:[L],instructionTypes:[E[A]]})}return u===1?l.sizeCheckBuild():l.sizeCheckBuildV0()}};import{PublicKey as Qt}from"@solana/web3.js";import{NATIVE_MINT as Ma,TOKEN_PROGRAM_ID as ei}from"@solana/spl-token";var kw=R([ve("mintAuthorityOption"),B("mintAuthority"),g("supply"),V("decimals"),V("isInitialized"),ve("freezeAuthorityOption"),B("freezeAuthority")]);import{PublicKey as Sl}from"@solana/web3.js";import{MintLayout as na,TOKEN_PROGRAM_ID as Kl}from"@solana/spl-token";var Sw=async({connection:r,mint:e})=>{let t=await r.getAccountInfo(new Sl(e));return!t||t.data.length!==na.span?void 0:na.decode(t.data)},Kw=({mint:r,decimals:e,programId:t=Kl,logoURI:n="",priority:i=3})=>{let o=r.toBase58().substring(0,6);return{address:r.toBase58(),decimals:e,symbol:o,logoURI:n,extensions:{},chainId:101,programId:t.toString(),name:o,tags:[],priority:i}},ra=r=>new ce({mint:r.address,decimals:r.decimals,symbol:r.symbol,name:r.name}),Cw=i=>{var o=i,{amount:r,isRaw:e,name:t}=o,n=Ne(o,["amount","isRaw","name"]);return new ge(new ce({mint:n.address,decimals:n.decimals,symbol:n.symbol,name:t}),r,e,t)};function Rw(r){return r.address===Ge.address?Se:r}function Lw(r){return r.address===Se.address?Ge:r}import{TOKEN_PROGRAM_ID as $n,ASSOCIATED_TOKEN_PROGRAM_ID as Ul}from"@solana/spl-token";import{PublicKey as fe,TransactionInstruction as Ot,SystemProgram as lo,SYSVAR_RENT_PUBKEY as Gl}from"@solana/web3.js";var io=R([V("instruction"),g("amountIn"),g("minAmountOut")]),oo=R([V("instruction"),g("maxAmountIn"),g("amountOut")]),Ww=R([V("instruction"),V("nonce")]),so=R([V("instruction"),V("nonce"),g("startTime")]),Cl=R([g("status"),g("nonce"),g("maxOrder"),g("depth"),g("baseDecimal"),g("quoteDecimal"),g("state"),g("resetFlag"),g("minSize"),g("volMaxCutRatio"),g("amountWaveRatio"),g("baseLotSize"),g("quoteLotSize"),g("minPriceMultiplier"),g("maxPriceMultiplier"),g("systemDecimalValue"),g("minSeparateNumerator"),g("minSeparateDenominator"),g("tradeFeeNumerator"),g("tradeFeeDenominator"),g("pnlNumerator"),g("pnlDenominator"),g("swapFeeNumerator"),g("swapFeeDenominator"),g("baseNeedTakePnl"),g("quoteNeedTakePnl"),g("quoteTotalPnl"),g("baseTotalPnl"),g("poolOpenTime"),g("punishPcAmount"),g("punishCoinAmount"),g("orderbookToInitTime"),z("swapBaseInAmount"),z("swapQuoteOutAmount"),g("swapBase2QuoteFee"),z("swapQuoteInAmount"),z("swapBaseOutAmount"),g("swapQuote2BaseFee"),B("baseVault"),B("quoteVault"),B("baseMint"),B("quoteMint"),B("lpMint"),B("openOrders"),B("marketId"),B("marketProgramId"),B("targetOrders"),B("withdrawQueue"),B("lpVault"),B("owner"),g("lpReserve"),G(g(),3,"padding")]),Rl=R([g("accountType"),g("status"),g("nonce"),g("maxOrder"),g("depth"),g("baseDecimal"),g("quoteDecimal"),g("state"),g("resetFlag"),g("minSize"),g("volMaxCutRatio"),g("amountWaveRatio"),g("baseLotSize"),g("quoteLotSize"),g("minPriceMultiplier"),g("maxPriceMultiplier"),g("systemDecimalsValue"),g("abortTradeFactor"),g("priceTickMultiplier"),g("priceTick"),g("minSeparateNumerator"),g("minSeparateDenominator"),g("tradeFeeNumerator"),g("tradeFeeDenominator"),g("pnlNumerator"),g("pnlDenominator"),g("swapFeeNumerator"),g("swapFeeDenominator"),g("baseNeedTakePnl"),g("quoteNeedTakePnl"),g("quoteTotalPnl"),g("baseTotalPnl"),g("poolOpenTime"),g("punishPcAmount"),g("punishCoinAmount"),g("orderbookToInitTime"),z("swapBaseInAmount"),z("swapQuoteOutAmount"),z("swapQuoteInAmount"),z("swapBaseOutAmount"),g("swapQuote2BaseFee"),g("swapBase2QuoteFee"),B("baseVault"),B("quoteVault"),B("baseMint"),B("quoteMint"),B("lpMint"),B("modelDataAccount"),B("openOrders"),B("marketId"),B("marketProgramId"),B("targetOrders"),B("owner"),G(g(),64,"padding")]),ao=R([V("instruction"),g("baseAmountIn"),g("quoteAmountIn"),g("fixedSide")]),uo=R([V("instruction"),g("amountIn")]),Dw={4:Cl,5:Rl},ia=R([g("fee")]);import{PublicKey as Ll}from"@solana/web3.js";var hn=new Ll("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),tn=5e4,Ol=R([g("x"),g("y"),g("price")]),Nl=R([g("accountType"),g("status"),g("multiplier"),g("validDataCount"),G(Ol,tn,"DataElement")]);function Ml(r,e){return[0,tn-2]}function _l(r){return[0,tn-2]}function Vl(r){return[0,tn-2]}function El(r,e,t){let[n,i]=Ml(e,t),o=n,s=i,a=0,u=e*r.multiplier/t;for(;o<=s;){if(a=Math.floor((s+o)/2),a===0||a>=tn-2)return[a,a,!1];let c=r.DataElement[a].x*r.multiplier/r.DataElement[a].y,l=r.DataElement[a-1].x*r.multiplier/r.DataElement[a-1].y,m=r.DataElement[a+1].x*r.multiplier/r.DataElement[a+1].y;if(u===c)return[a,a,!0];if(u===l)return[a-1,a-1,!0];if(u===m)return[a+1,a+1,!0];if(u<l)s=a-1;else{if(u>l&&u<c)return[a-1,a,!0];if(u>c&&u<m)return[a,a+1,!0];o=a+1}}return[a,a,!1]}function co(r,e,t){let[n,i,o]=El(r,e,t);if(!o)return 0;if(n===i){let s=r.DataElement[n].x;return e*r.multiplier/s}else{let s=r.DataElement[n].x,a=r.DataElement[n].y,u=r.DataElement[i].x,c=r.DataElement[i].y,l=t*(u*a-s*c),m=s*l,p=(u-s)*(e*a-s*t)*c,d=m+p;return e*r.multiplier*l/d}}function en(r,e,t){return e*r.multiplier/t}function oa(r,e,t){return e*t/r.multiplier}function Fl(r,e){let[t,n]=_l(e),i=t,o=n,s=0,a=e;for(;i<o;){if(s=Math.floor((o+i)/2),s<=0||s>tn-2)return[s,s,!1];let u=r.DataElement[s].x,c=r.DataElement[s-1].x,l=r.DataElement[s+1].x;if(a===u)return[s,s,!0];if(a===c)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<c)o=s-1;else{if(a>c&&a<u)return[s-1,s,!0];if(a>u&&a<l)return[s,s+1,!0];i=s+1}}return[s,s,!1]}function vl(r,e){let[t,n]=Vl(e),i=t,o=n,s=0,a=e;for(;i<=o;){if(s=Math.floor((o+i)/2),s<=0||s>=tn-2)return[s,s,!1];let u=r.DataElement[s].y,c=r.DataElement[s-1].y,l=r.DataElement[s+1].y;if(a===u)return[s,s,!0];if(a===c)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<l)i=s+1;else{if(a<c&&a>u)return[s-1,s,!0];if(a<u&&a>l)return[s,s+1,!0];o=s-1}}return[s,s,!1]}function sa(r,e,t,n){let i=n?e+t:e-t,[o,s,a]=Fl(r,i);if(!a)return[0,0,!1,a];if(o===s)return[r.DataElement[s].price,r.DataElement[s].y,!1,a];{let u=r.DataElement[o].x,c=r.DataElement[s].x,l=r.DataElement[o].price,m=r.DataElement[s].price,p=r.DataElement[o].y,d=r.DataElement[s].y;if(e>=u&&e<=c)return n?[m,d,!0,a]:[l,p,!0,a];{let y,f;return n?(y=l+(m-l)*(e-u)/(c-u),f=p-(i-u)*r.multiplier/m):(y=l+(m-l)*(e-u)/(c-u),f=d+(c-i)*r.multiplier/l),[y,f,!1,a]}}}function Wl(r,e,t,n){let i=n?e-t:e+t,[o,s,a]=vl(r,i);if(!a)return[0,0,!1,a];if(o===s)return[r.DataElement[s].price,r.DataElement[s].x,!1,a];{let u=r.DataElement[o].x,c=r.DataElement[s].x,l=r.DataElement[o].price,m=r.DataElement[s].price,p=r.DataElement[o].y,d=r.DataElement[s].y;if(e>=d&&e<=p)return n?[m,c,!0,a]:[l,u,!0,a];{let y,f;return n?(y=l+(m-l)*(p-e)/(p-d),f=u+m*(p-i)/r.multiplier):(y=l+(m-l)*(p-e)/(p-d),f=c-l*(i-d)/r.multiplier),[y,f,!1,a]}}}function Dl(r,e){let t=sa(r,e,0,!1);return t[3]?t[0]:0}function zw(r,e,t,n){let i=co(r,e,t),o=en(r,e,i),s=en(r,t,i),a=en(r,n,i),u=!0,[c,l,m,p]=sa(r,o,a,u);if(!p)return 0;if(m)return n*r.multiplier/c;{let d=s-l;return oa(r,d,i)}}function Yw(r,e,t,n){let i=co(r,e,t),o=en(r,e,i),s=en(r,t,i),a=en(r,n,i),u=!1,[c,l,m,p]=Wl(r,s,a,u);if(!p)return 0;if(m)return n*c/r.multiplier;{let d=o-l;return oa(r,d,i)}}function ql(r){let e=Nl.decode(r);return{accountType:e.accountType.toNumber(),status:e.status.toNumber(),multiplier:e.multiplier.toNumber(),validDataCount:e.validDataCount.toNumber(),DataElement:e.DataElement.map(t=>({x:t.x.toNumber(),y:t.y.toNumber(),price:t.price.toNumber()}))}}function Qw(r,e,t,n){let i=Dl(r,en(r,e,co(r,e,t)))/r.multiplier;return n?i:1/i}var jr=class{constructor({connection:e}){this._layoutData={accountType:0,status:0,multiplier:0,validDataCount:0,DataElement:[]};this.connection=e}get stableModelData(){return this._layoutData}async initStableModelLayout(){if(this._layoutData.validDataCount===0&&this.connection){let e=await this.connection.getAccountInfo(hn);e&&(this._layoutData=ql(e==null?void 0:e.data))}}};var aa=oe("Raydium_liquidity_instruction");function ua(r){let{poolInfo:e,poolKeys:t,userKeys:n,baseAmountIn:i,quoteAmountIn:o,fixedSide:s}=r,a=Buffer.alloc(ao.span);ao.encode({instruction:3,baseAmountIn:X(i),quoteAmountIn:X(o),fixedSide:s==="base"?je:Sr},a);let u=[k({pubkey:$n,isWritable:!1}),k({pubkey:new fe(e.id)}),k({pubkey:new fe(t.authority),isWritable:!1}),k({pubkey:new fe(t.openOrders),isWritable:!1}),k({pubkey:new fe(t.targetOrders)}),k({pubkey:new fe(e.lpMint.address)}),k({pubkey:new fe(t.vault.A)}),k({pubkey:new fe(t.vault.B)})];return e.pooltype.includes("StablePool")&&u.push(k({pubkey:hn})),u.push(k({pubkey:new fe(e.marketId),isWritable:!1}),k({pubkey:n.baseTokenAccount}),k({pubkey:n.quoteTokenAccount}),k({pubkey:n.lpTokenAccount}),k({pubkey:n.owner,isWritable:!1,isSigner:!0}),k({pubkey:new fe(t.marketEventQueue),isWritable:!1})),new Ot({programId:new fe(e.programId),keys:u,data:a})}function mo(r){let{poolInfo:e,poolKeys:t,userKeys:n,amountIn:i}=r,o=pe(t),s=4;if(e.pooltype.includes("StablePool")&&(s=5),s===4||s===5){let a=Buffer.alloc(uo.span);uo.encode({instruction:4,amountIn:X(i)},a);let u=[k({pubkey:$n,isWritable:!1}),k({pubkey:o.id}),k({pubkey:o.authority,isWritable:!1}),k({pubkey:o.openOrders}),k({pubkey:o.targetOrders}),k({pubkey:o.mintLp.address}),k({pubkey:o.vault.A}),k({pubkey:o.vault.B})];return s===5?u.push(k({pubkey:hn})):(u.push(k({pubkey:o.withdrawQueue})),u.push(k({pubkey:o.vault.Lp}))),u.push(k({pubkey:o.marketProgramId,isWritable:!1}),k({pubkey:o.marketId}),k({pubkey:o.marketBaseVault}),k({pubkey:o.marketQuoteVault}),k({pubkey:o.marketAuthority,isWritable:!1}),k({pubkey:n.lpTokenAccount}),k({pubkey:n.baseTokenAccount}),k({pubkey:n.quoteTokenAccount}),k({pubkey:n.owner,isWritable:!1,isSigner:!0}),k({pubkey:o.marketEventQueue}),k({pubkey:o.marketBids}),k({pubkey:o.marketAsks})),new Ot({programId:o.programId,keys:u,data:a})}return new Ot({programId:o.programId,keys:[]})}function ca({programId:r,ammId:e,ammAuthority:t,ammOpenOrders:n,lpMint:i,coinMint:o,pcMint:s,coinVault:a,pcVault:u,withdrawQueue:c,ammTargetOrders:l,poolTempLp:m,marketProgramId:p,marketId:d,userWallet:y,userCoinVault:f,userPcVault:b,userLpVault:w,nonce:h,openTime:A,coinAmount:P,pcAmount:T,ammConfigId:I,feeDestinationId:x}){let O=R([V("instruction"),V("nonce"),g("openTime"),g("pcAmount"),g("coinAmount")]),N=[{pubkey:$n,isSigner:!1,isWritable:!1},{pubkey:Ul,isSigner:!1,isWritable:!1},{pubkey:lo.programId,isSigner:!1,isWritable:!1},{pubkey:rt,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!1,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:I,isSigner:!1,isWritable:!1},{pubkey:x,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!0,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:w,isSigner:!1,isWritable:!0}],L=Buffer.alloc(O.span);return O.encode({instruction:1,nonce:h,openTime:A,coinAmount:P,pcAmount:T},L),{instruction:new Ot({keys:N,programId:r,data:L}),instructionType:_.AmmV4CreatePool}}function sk(r){let e=R([V("instruction"),V("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let n=[k({pubkey:new fe(r.id),isWritable:!1}),k({pubkey:new fe(r.authority),isWritable:!1}),k({pubkey:new fe(r.openOrders),isWritable:!1}),k({pubkey:new fe(r.vault.A),isWritable:!1}),k({pubkey:new fe(r.vault.B),isWritable:!1}),k({pubkey:new fe(r.mintLp.address),isWritable:!1}),k({pubkey:new fe(r.marketId),isWritable:!1}),k({pubkey:new fe(r.marketEventQueue),isWritable:!1})];return new Ot({programId:new fe(r.programId),keys:n,data:t})}function Xl({poolKeys:r,userKeys:e,amountIn:t,minAmountOut:n},i){let o=pe(r),s=Buffer.alloc(io.span);io.encode({instruction:9,amountIn:X(t),minAmountOut:X(n)},s);let a=[k({pubkey:$n,isWritable:!1}),k({pubkey:o.id}),k({pubkey:o.authority,isWritable:!1}),k({pubkey:o.openOrders})];return i===4&&a.push(k({pubkey:o.targetOrders})),a.push(k({pubkey:o.vault.A}),k({pubkey:o.vault.B})),i===5&&a.push(k({pubkey:hn})),a.push(k({pubkey:o.marketProgramId,isWritable:!1}),k({pubkey:o.marketId}),k({pubkey:o.marketBids}),k({pubkey:o.marketAsks}),k({pubkey:o.marketEventQueue}),k({pubkey:o.marketBaseVault}),k({pubkey:o.marketQuoteVault}),k({pubkey:o.marketAuthority,isWritable:!1}),k({pubkey:e.tokenAccountIn}),k({pubkey:e.tokenAccountOut}),k({pubkey:e.owner,isWritable:!1})),new Ot({programId:o.programId,keys:a,data:s})}function zl({poolKeys:r,userKeys:e,maxAmountIn:t,amountOut:n},i){let o=pe(r),s=Buffer.alloc(oo.span);oo.encode({instruction:11,maxAmountIn:X(t),amountOut:X(n)},s);let a=[k({pubkey:lo.programId,isWritable:!1}),k({pubkey:o.id}),k({pubkey:o.authority,isWritable:!1}),k({pubkey:o.openOrders}),k({pubkey:o.targetOrders}),k({pubkey:o.vault.A}),k({pubkey:o.vault.B})];return i===5&&a.push(k({pubkey:hn})),a.push(k({pubkey:o.marketProgramId,isWritable:!1}),k({pubkey:o.marketId}),k({pubkey:o.marketBids}),k({pubkey:o.marketAsks}),k({pubkey:o.marketEventQueue}),k({pubkey:o.marketBaseVault}),k({pubkey:o.marketQuoteVault}),k({pubkey:o.marketAuthority,isWritable:!1}),k({pubkey:e.tokenAccountIn}),k({pubkey:e.tokenAccountOut}),k({pubkey:e.owner,isWritable:!1,isSigner:!0})),new Ot({programId:o.programId,keys:a,data:s})}function la(r){let{poolKeys:e,version:t,userKeys:n,amountIn:i,amountOut:o,fixedSide:s}=r;if(t===4||t===5){let a={poolKeys:e,userKeys:n};if(s==="in")return Xl(D(M({},a),{amountIn:i,minAmountOut:o}),t);if(s==="out")return zl(D(M({},a),{maxAmountIn:i,amountOut:o}),t);aa.logWithError("invalid params","params",r)}throw aa.logWithError("invalid version","poolKeys.version",t),new Error("invalid version")}function ak({poolKeys:r,userKeys:e,startTime:t}){let n=Buffer.alloc(so.span);so.encode({instruction:0,nonce:5,startTime:X(t)},n);let i=pe(r),o=[k({pubkey:$n,isWritable:!1}),k({pubkey:lo.programId,isWritable:!1}),k({pubkey:Gl,isWritable:!1}),k({pubkey:i.id}),k({pubkey:i.authority,isWritable:!1}),k({pubkey:i.openOrders}),k({pubkey:i.mintLp.address}),k({pubkey:i.mintA.address,isWritable:!1}),k({pubkey:i.mintB.address,isWritable:!1}),k({pubkey:i.vault.A,isWritable:!1}),k({pubkey:i.vault.B,isWritable:!1}),k({pubkey:i.withdrawQueue}),k({pubkey:i.targetOrders}),k({pubkey:e.lpTokenAccount}),k({pubkey:i.vault.Lp,isWritable:!1}),k({pubkey:i.marketProgramId,isWritable:!1}),k({pubkey:i.marketId,isWritable:!1}),k({pubkey:e.payer,isSigner:!0})];return new Ot({programId:i.programId,keys:o,data:n})}function ma({poolKeys:r}){let e=R([V("instruction"),V("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let n=[k({pubkey:new fe(r.id),isWritable:!1}),k({pubkey:new fe(r.authority),isWritable:!1}),k({pubkey:new fe(r.openOrders),isWritable:!1}),k({pubkey:new fe(r.vault.A),isWritable:!1}),k({pubkey:new fe(r.vault.B),isWritable:!1}),k({pubkey:new fe(r.mintLp.address),isWritable:!1}),k({pubkey:new fe(r.marketId),isWritable:!1}),k({pubkey:new fe(r.marketEventQueue),isWritable:!1})];return{instruction:new Ot({programId:new fe(r.programId),keys:n,data:t})}}import{TOKEN_PROGRAM_ID as Ee,TOKEN_2022_PROGRAM_ID as Yt,ASSOCIATED_TOKEN_PROGRAM_ID as Ka}from"@solana/spl-token";import{PublicKey as F,TransactionInstruction as ft,SystemProgram as Pn,Keypair as Ao}from"@solana/web3.js";import Ca from"bn.js";import rm from"bn.js";function da(r){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r,!1),new Uint8Array(e)}function ck(r){let e=new ArrayBuffer(2);return new DataView(e).setInt16(0,r,!1),new Uint8Array(e)}function lk(r){let e=new ArrayBuffer(4);return new DataView(e).setUint32(0,r,!1),new Uint8Array(e)}function Hr(r){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,r,!1),new Uint8Array(e)}function po(r,e){let t=0;for(let n=r-1;n>=0&&!e.testn(n);n--)t++;return t}function fo(r,e){let t=0;for(let n=0;n<r&&!e.testn(n);n++)t++;return t}function er(r,e){for(let t=0;t<r;t++)if(e.testn(t))return!1;return!0}function pa(r,e){return er(r,e)?null:po(r,e)}function fa(r,e){return er(r,e)?null:fo(r,e)}var Yl=Buffer.from("amm_config","utf8"),Ql=Buffer.from("pool","utf8"),jl=Buffer.from("pool_vault","utf8"),Hl=Buffer.from("pool_reward_vault","utf8"),ya=Buffer.from("position","utf8"),Zl=Buffer.from("tick_array","utf8"),Jl=Buffer.from("operation","utf8"),$l=Buffer.from("pool_tick_array_bitmap_extension","utf8");function fk(r,e){return le([Yl,da(e)],r)}function ba(r,e,t,n){return le([Ql,e.toBuffer(),t.toBuffer(),n.toBuffer()],r)}function yo(r,e,t){return le([jl,e.toBuffer(),t.toBuffer()],r)}function ga(r,e,t){return le([Hl,e.toBuffer(),t.toBuffer()],r)}function ye(r,e,t){return le([Zl,e.toBuffer(),Hr(t)],r)}function nn(r,e,t,n){return le([ya,e.toBuffer(),Hr(t),Hr(n)],r)}function At(r,e){return le([ya,e.toBuffer()],r)}function Zr(r){return le([Buffer.from("metadata","utf8"),pn.toBuffer(),r.toBuffer()],pn)}function tr(r){return le([Jl],r)}function ht(r,e){return le([$l,e.toBuffer()],r)}import Pt from"bn.js";var me=new Pt(0),De=new Pt(1),Nt=new Pt(-1),nt=new Pt(1).shln(64),Jr=new Pt(1).shln(128),bo=nt.sub(De),nr=64,wa=Jr.subn(1),qe=-443636,Ye=-qe,Tt=new Pt("4295048016"),It=new Pt("79226673521066979257578248091"),ka=16,Aa="59543866431248",ha="184467440737095516",Pa="15793534762490258745",$r=new Pt(10).pow(new Pt(6)),em=(n=>(n[n.rate_500=500]="rate_500",n[n.rate_3000=3e3]="rate_3000",n[n.rate_10000=1e4]="rate_10000",n))(em||{}),gk={[500]:10,[3e3]:60,[1e4]:200},wk={version:6,liquidity:me,tickCurrent:0,observationIndex:0,observationUpdateDuration:0,feeGrowthGlobalX64A:me,feeGrowthGlobalX64B:me,protocolFeesTokenA:me,protocolFeesTokenB:me,swapInAmountTokenA:me,swapOutAmountTokenB:me,swapInAmountTokenB:me,swapOutAmountTokenA:me,tickArrayBitmap:[],rewardInfos:[],day:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},week:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},month:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},tvl:0},Ta={tvl:0,volumeQuote:0,mintAmountA:0,mintAmountB:0,rewardDefaultInfos:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,day:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},week:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},month:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},pooltype:[]},kk=new Pt("18446744073700000000");var tm=15,ae=class{static async getTickArrays(e,t,n,i,o,s,a){let u=[],c=q.getTickArrayStartIndexByTick(i,o),l=q.getInitializedTickArrayInRange(s,a,o,c,Math.floor(tm/2));for(let d=0;d<l.length;d++){let{publicKey:y}=ye(t,n,l[d]);u.push(y)}let m=(await gt(e,u)).map(d=>d!==null?rr.decode(d.data):null),p={};for(let d=0;d<u.length;d++){let y=m[d];y!==null&&(p[y.startTickIndex]=D(M({},y),{address:u[d]}))}return p}static nextInitializedTick(e,t,n,i,o,s){let{initializedTick:a,tickArrayAddress:u,tickArrayStartTickIndex:c}=this.nextInitializedTickInOneArray(e,t,n,i,o,s);for(;a==null||a.liquidityGross.lten(0);){if(c=q.getNextTickArrayStartIndex(c,o,s),this.checkIsValidStartIndex(c,o))throw new Error("No enough initialized tickArray");let l=n[c];if(l===void 0)continue;let{nextTick:m,tickArrayAddress:p,tickArrayStartTickIndex:d}=this.firstInitializedTickInOneArray(e,t,l,s);[a,u,c]=[m,p,d]}if(a==null)throw new Error("No invaild tickArray cache");return{nextTick:a,tickArrayAddress:u,tickArrayStartTickIndex:c}}static nextInitializedTickArray(e,t,n,i,o){let s=Math.floor(e/ae.tickCount(t)),a=n?q.searchLowBitFromStart(i,o,s-1,1,t):q.searchHightBitFromStart(i,o,s+1,1,t);return a.length>0?{isExist:!0,nextStartIndex:a[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,i){let o;if(i){let a=Ke-1;for(;a>=0;){let u=n.ticks[a];if(u.liquidityGross.gtn(0)){o=u;break}a=a-1}}else{let a=0;for(;a<Ke;){let u=n.ticks[a];if(u.liquidityGross.gtn(0)){o=u;break}a=a+1}}let{publicKey:s}=ye(e,t,n.startTickIndex);return{nextTick:o,tickArrayAddress:s,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,i,o,s){let a=q.getTickArrayStartIndexByTick(i,o),u=Math.floor((i-a)/o),c=n[a];if(c==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:a};let l;if(s)for(;u>=0;){let p=c.ticks[u];if(p.liquidityGross.gtn(0)){l=p;break}u=u-1}else for(u=u+1;u<Ke;){let p=c.ticks[u];if(p.liquidityGross.gtn(0)){l=p;break}u=u+1}let{publicKey:m}=ye(e,t,a);return{initializedTick:l,tickArrayAddress:m,tickArrayStartTickIndex:c.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if(q.checkIsOutOfBoundary(e)){if(e>Ye)return!1;let n=q.getTickArrayStartIndexByTick(qe,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return Ke*e}};import ne from"bn.js";import{PublicKey as Ia}from"@solana/web3.js";import Ie from"bn.js";var go=14,Mt=class{static maxTickInTickarrayBitmap(e){return e*Ke*rn}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(i+=1);let o=n*i;return e<0?{minValue:-o,maxValue:-o+n}:{minValue:o,maxValue:o+n}}static nextInitializedTickArrayStartIndex(e,t,n,i){if(!ae.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let o=this.maxTickInTickarrayBitmap(n),s=i?t-ae.tickCount(n):t+ae.tickCount(n);if(s<-o||s>=o)return{isInit:!1,tickIndex:t};let a=n*Ke,u=s/a+512;s<0&&s%a!=0&&u--;let c=Math.abs(u);if(i){let l=e.shln(1024-c-1),m=pa(1024,l);if(m!==null){let p=(c-m-512)*a;return{isInit:!0,tickIndex:p}}else return{isInit:!1,tickIndex:-o}}else{let l=e.shrn(c),m=fa(1024,l);if(m!==null){let p=(c+m-512)*a;return{isInit:!0,tickIndex:p}}else return{isInit:!1,tickIndex:o-ae.tickCount(n)}}}},ir=class{static getBitmapOffset(e,t){if(!ae.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=Mt.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&i--,i}static getBitmap(e,t,n){let i=this.getBitmapOffset(e,t);return e<0?{offset:i,tickarrayBitmap:n.negativeTickArrayBitmap[i]}:{offset:i,tickarrayBitmap:n.positiveTickArrayBitmap[i]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:i}=this.extensionTickBoundary(t);if(e>=i&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=Mt.maxTickInTickarrayBitmap(e),n=-t;if(Ye<=t)throw Error(`extensionTickBoundary check error: ${Ye}, ${t}`);if(n<=qe)throw Error(`extensionTickBoundary check error: ${n}, ${qe}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:i}=this.getBitmap(e,t,n),o=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:q.mergeTickArrayBitmap(i).testn(o),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,i){let o=ae.tickCount(t),s=n?e-o:e+o,{tickarrayBitmap:a}=this.getBitmap(s,t,i);return this.nextInitializedTickArrayInBitmap(a,s,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,i){let{minValue:o,maxValue:s}=Mt.getBitmapTickBoundary(t,n),a=this.tickArrayOffsetInBitmap(t,n);if(i){let u=q.mergeTickArrayBitmap(e).shln(rn-1-a),c=er(512,u)?null:po(512,u);if(c!==null){let l=t-c*ae.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:o}}else{let u=q.mergeTickArrayBitmap(e).shrn(a),c=er(512,u)?null:fo(512,u);if(c!==null){let l=t+c*ae.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s-ae.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%Mt.maxTickInTickarrayBitmap(t),i=Math.floor(n/ae.tickCount(t));return e<0&&n!=0&&(i=rn-i),i}};import xt from"bn.js";var or=class{static getfeeGrowthInside(e,t,n){let i=new xt(0),o=new xt(0);e.tickCurrent>=t.tick?(i=t.feeGrowthOutsideX64A,o=t.feeGrowthOutsideX64B):(i=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),o=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let s=new xt(0),a=new xt(0);e.tickCurrent<n.tick?(s=n.feeGrowthOutsideX64A,a=n.feeGrowthOutsideX64B):(s=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),a=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let u=H.wrappingSubU128(H.wrappingSubU128(e.feeGrowthGlobalX64A,i),s),c=H.wrappingSubU128(H.wrappingSubU128(e.feeGrowthGlobalX64B,o),a);return{feeGrowthInsideX64A:u,feeGrowthInsideBX64:c}}static GetPositionFees(e,t,n,i){let{feeGrowthInsideX64A:o,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,i),a=H.mulDivFloor(H.wrappingSubU128(o,t.feeGrowthInsideLastX64A),t.liquidity,nt),u=t.tokenFeesOwedA.add(a),c=H.mulDivFloor(H.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,nt),l=t.tokenFeesOwedB.add(c);return{tokenFeeAmountA:u,tokenFeeAmountB:l}}static GetPositionFeesV2(e,t,n,i){let{feeGrowthInsideX64A:o,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,i),a=H.mulDivFloor(H.wrappingSubU128(o,t.feeGrowthInsideLastX64A),t.liquidity,nt),u=t.tokenFeesOwedA.add(a),c=H.mulDivFloor(H.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,nt),l=t.tokenFeesOwedB.add(c);return{tokenFeeAmountA:u,tokenFeeAmountB:l}}static GetPositionRewardsV2(e,t,n,i){let o=[],s=this.getRewardGrowthInsideV2(e.tickCurrent,n,i,e.rewardInfos);for(let a=0;a<s.length;a++){let u=s[a],c=t.rewardInfos[a],l=H.wrappingSubU128(u,c.growthInsideLastX64),m=H.mulDivFloor(l,t.liquidity,nt),p=c.rewardAmountOwed.add(m);o.push(p)}return o}static GetPositionRewards(e,t,n,i){let o=[],s=this.getRewardGrowthInside(e.tickCurrent,n,i,e.rewardInfos);for(let a=0;a<s.length;a++){let u=s[a],c=t.rewardInfos[a],l=H.wrappingSubU128(u,c.growthInsideLastX64),m=H.mulDivFloor(l,t.liquidity,nt),p=c.rewardAmountOwed.add(m);o.push(p)}return o}static getRewardGrowthInside(e,t,n,i){let o=[];for(let s=0;s<i.length;s++){let a=new xt(0);t.liquidityGross.eqn(0)?a=i[s].rewardGrowthGlobalX64:e<t.tick?a=i[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let u=new xt(0);n.liquidityGross.eqn(0)||(e<n.tick?u=n.rewardGrowthsOutsideX64[s]:u=i[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),o.push(H.wrappingSubU128(H.wrappingSubU128(i[s].rewardGrowthGlobalX64,a),u))}return o}static getRewardGrowthInsideV2(e,t,n,i){let o=[];for(let s=0;s<i.length;s++){let a=new xt(0);t.liquidityGross.eqn(0)?a=i[s].rewardGrowthGlobalX64:e<t.tick?a=i[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let u=new xt(0);n.liquidityGross.eqn(0)||(e<n.tick?u=n.rewardGrowthsOutsideX64[s]:u=i[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),o.push(H.wrappingSubU128(H.wrappingSubU128(i[s].rewardGrowthGlobalX64,a),u))}return o}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:i,add:o,epochInfo:s}){var b,w,h,A;let a=j.priceToSqrtPriceX64(new v(e.price),e.mintA.decimals,e.mintB.decimals),u=j.getSqrtPriceX64FromTick(t.tickLower),c=j.getSqrtPriceX64FromTick(t.tickUpper),l=o?1+i:1-i,m=se.getAmountsFromLiquidity(a,u,c,n,o),[p,d]=[Re(m.amountA,(b=e.mintA.extensions)==null?void 0:b.feeConfig,s,!0),Re(m.amountB,(w=e.mintB.extensions)==null?void 0:w.feeConfig,s,!0)],[y,f]=[Re(new xt(new v(m.amountA.toString()).mul(l).toFixed(0)),(h=e.mintA.extensions)==null?void 0:h.feeConfig,s,!0),Re(new xt(new v(m.amountB.toString()).mul(l).toFixed(0)),(A=e.mintB.extensions)==null?void 0:A.feeConfig,s,!0)];return{liquidity:n,amountA:p,amountB:d,amountSlippageA:y,amountSlippageB:f,expirationTime:Zt(p.expirationTime,d.expirationTime)}}};var Ve=class{static getOutputAmountAndRemainAccounts(e,t,n,i,o){let s=n.equals(e.mintA.mint),a=[],{isExist:u,startIndex:c,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!u||c===void 0||!l)throw new Error("Invalid tick array");a.push(l);let{amountCalculated:m,accounts:p,sqrtPriceX64:d,feeAmount:y}=on.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i,c,o);return a.push(...p),{expectedAmountOut:m.mul(Nt),remainingAccounts:a,executionPrice:d,feeAmount:y}}static getInputAmountAndRemainAccounts(e,t,n,i,o){let s=n.equals(e.mintB.mint),a=[],{isExist:u,startIndex:c,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!u||c===void 0||!l)throw new Error("Invalid tick array");try{let f=this.preInitializedTickArrayStartIndex(e,s);if(f.isExist){let{publicKey:b}=ye(e.programId,e.id,f.nextStartIndex);a.push(b)}}catch{}a.push(l);let{amountCalculated:m,accounts:p,sqrtPriceX64:d,feeAmount:y}=on.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i.mul(Nt),c,o);return a.push(...p),{expectedAmountIn:m,remainingAccounts:a,executionPrice:d,feeAmount:y}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:i}=Ve.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?ir.checkTickArrayIsInit(ae.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):q.checkTickArrayIsInitialized(q.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:a}=ye(e.programId,e.id,i);return{isExist:!0,startIndex:i,nextAccountMeta:a}}let{isExist:o,nextStartIndex:s}=this.nextInitializedTickArrayStartIndex(e,ae.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(o){let{publicKey:a}=ye(e.programId,e.id,s);return{isExist:!0,startIndex:s,nextAccountMeta:a}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/ae.tickCount(e.tickSpacing)),i=t?q.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):q.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return i.length>0?{isExist:!0,nextStartIndex:i[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=ae.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:i,tickIndex:o}=Mt.nextInitializedTickArrayStartIndex(q.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(i)return{isExist:!0,nextStartIndex:o};t=o;let{isInit:s,tickIndex:a}=ir.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(s)return{isExist:!0,nextStartIndex:a};if(t=a,t<qe||t>Ye)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:i,rewardInfos:o}){var a,u,c;let s=[];for(let l=0;l<o.length;l++){let m=o[l],p=(c=(a=t.rewardDefaultInfos[l])==null?void 0:a.mint.programId)!=null?c:(u=await e.getAccountInfo(m.tokenMint))==null?void 0:u.owner;if(p===void 0)throw Error("get new reward mint info error");let d=D(M({},m),{perSecond:H.x64ToDecimal(m.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new Ia(p)});if(d.tokenMint.equals(Ia.default))continue;if(n<=d.openTime.toNumber()||i.eq(me)){s.push(d);continue}let y=new Ie(Math.min(d.endTime.toNumber(),n)),f=y.sub(d.lastUpdateTime),b=H.mulDivFloor(f,d.emissionsPerSecondX64,i),w=d.rewardGrowthGlobalX64.add(b),h=H.mulDivFloor(f,d.emissionsPerSecondX64,nt),A=d.rewardTotalEmissioned.add(h);s.push(D(M({},d),{rewardGrowthGlobalX64:w,rewardTotalEmissioned:A,lastUpdateTime:y}))}return s}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:i}=this.tickRange(e);for(let o of t){let s=q.getTickArrayStartIndexByTick(o,e);if(s>=n||s<i)return!0}return!1}static tickRange(e){let t=Mt.maxTickInTickarrayBitmap(e),n=-t;return t>Ye&&(t=ae.getArrayStartIndex(Ye,e)+ae.tickCount(e)),n<qe&&(n=ae.getArrayStartIndex(qe,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!ae.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/ae.tickCount(t)*rn}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let i=await Mn(e,t.map(s=>({pubkey:s})),{batchRequest:n}),o={};for(let s of i)s.accountInfo!==null&&(o[s.pubkey.toString()]=Ba.decode(s.accountInfo.data));return o}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let i={},o=[];for(let u of t){let c=q.getTickArrayStartIndexByTick(u.tickCurrent,u.tickSpacing),l=q.getInitializedTickArrayInRange(u.tickArrayBitmap,u.exBitmapInfo,u.tickSpacing,c,7);for(let m of l){let{publicKey:p}=ye(u.programId,u.id,m);o.push({pubkey:p}),i[p.toString()]=u.id}}let s=await Mn(e,o,{batchRequest:n}),a={};for(let u of s){if(!u.accountInfo)continue;let c=i[u.pubkey.toString()];if(!c)continue;a[c.toString()]===void 0&&(a[c.toString()]={});let l=rr.decode(u.accountInfo.data);a[c.toString()][l.startTickIndex]=D(M({},l),{address:u.pubkey})}return a}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:i=!1,updateOwnerRewardAndFee:o=!0}){var a;let s=[];for(let u=0;u<e.length;u++){let c=e[u];c!==null&&(s.find(l=>l.equals(c.state.programId))||s.push(c.state.programId))}if(n){let u=n.tokenAccounts.map(p=>p.accountInfo.mint),c=[];for(let p of u)for(let d of s)c.push(At(d,p).publicKey);let l=await gt(t,c,{batchRequest:i}),m={};for(let p of l){if(p===null)continue;let d=xa.decode(p.data),y=d.poolId.toString(),f=e.find(O=>O.state.id.toBase58()===y);if(f===void 0)continue;let b=f.state,w=q._getTickPriceLegacy({poolInfo:b,tick:d.tickLower,baseIn:!0}),h=q._getTickPriceLegacy({poolInfo:b,tick:d.tickUpper,baseIn:!0}),{amountA:A,amountB:P}=se.getAmountsFromLiquidity(b.sqrtPriceX64,w.tickSqrtPriceX64,h.tickSqrtPriceX64,d.liquidity,!1),T=1/(1-Math.sqrt(Math.sqrt(w.price.div(h.price).toNumber())));f.positionAccount=[...(a=f.positionAccount)!=null?a:[],{poolId:d.poolId,nftMint:d.nftMint,priceLower:w.price,priceUpper:h.price,amountA:A,amountB:P,tickLower:d.tickLower,tickUpper:d.tickUpper,liquidity:d.liquidity,feeGrowthInsideLastX64A:d.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:d.feeGrowthInsideLastX64B,tokenFeesOwedA:d.tokenFeesOwedA,tokenFeesOwedB:d.tokenFeesOwedB,rewardInfos:d.rewardInfos.map(O=>D(M({},O),{pendingReward:new Ie(0)})),leverage:T,tokenFeeAmountA:new Ie(0),tokenFeeAmountB:new Ie(0)}];let I=await q.getTickArrayAddressByTick(f.state.programId,d.poolId,d.tickLower,f.state.tickSpacing),x=await q.getTickArrayAddressByTick(f.state.programId,d.poolId,d.tickUpper,f.state.tickSpacing);m[`${f.state.programId.toString()}-${d.poolId.toString()}-${d.tickLower}`]=I,m[`${f.state.programId.toString()}-${d.poolId.toString()}-${d.tickUpper}`]=x}if(o){let p=Object.values(m),d=await gt(t,p,{batchRequest:i}),y={};for(let f=0;f<p.length;f++){let b=d[f];if(b===null)continue;let w=p[f].toString();y[w]=rr.decode(b.data)}for(let{state:f,positionAccount:b}of e)if(!!b)for(let w of b){let h=`${f.programId.toString()}-${f.id.toString()}-${w.tickLower}`,A=`${f.programId.toString()}-${f.id.toString()}-${w.tickUpper}`,P=y[m[h].toString()],T=y[m[A].toString()],I=P.ticks[q.getTickOffsetInArray(w.tickLower,f.tickSpacing)],x=T.ticks[q.getTickOffsetInArray(w.tickUpper,f.tickSpacing)],{tokenFeeAmountA:O,tokenFeeAmountB:N}=await or.GetPositionFees(f,w,I,x),L=await or.GetPositionRewards(f,w,I,x);w.tokenFeeAmountA=O.gte(new Ie(0))?O:new Ie(0),w.tokenFeeAmountB=N.gte(new Ie(0))?N:new Ie(0);for(let E=0;E<L.length;E++)w.rewardInfos[E].pendingReward=L[E].gte(new Ie(0))?L[E]:new Ie(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,token2022Infos:i,epochInfo:o,amountIn:s,slippage:a,priceLimit:u=new v(0)}){var N,L,E,Z;let c;u.equals(new v(0))?c=n.equals(e.mintA.mint)?Tt.add(new Ie(1)):It.sub(new Ie(1)):c=j.priceToSqrtPriceX64(u,e.mintA.decimals,e.mintB.decimals);let l=wn(s,(N=i[n.toString()])==null?void 0:N.feeConfig,o,!1),{expectedAmountOut:m,remainingAccounts:p,executionPrice:d,feeAmount:y}=Ve.getOutputAmountAndRemainAccounts(e,t,n,l.amount.sub((L=l.fee)!=null?L:me),c),f=e.mintA.mint.equals(n)?e.mintB.mint:e.mintA.mint,b=wn(m,(E=i[f.toString()])==null?void 0:E.feeConfig,o,!1),w=j.sqrtPriceX64ToPrice(d,e.mintA.decimals,e.mintB.decimals),h=n.equals(e.mintA.mint)?w:new v(1).div(w),A=m.mul(new Ie(Math.floor((1-a)*1e10))).div(new Ie(1e10)),P=wn(A,(Z=i[f.toString()])==null?void 0:Z.feeConfig,o,!1),T=e.mintA.mint.equals(n)?e.currentPrice:new v(1).div(e.currentPrice),I=new v(h).sub(T).abs(),x=T,O=new et(new v(I).mul(10**15).toFixed(0),new v(x).mul(10**15).toFixed(0));return{realAmountIn:l,amountOut:b,minAmountOut:P,expirationTime:Zt(l.expirationTime,b.expirationTime),currentPrice:e.currentPrice,executionPrice:h,priceImpact:O,fee:y,remainingAccounts:p}}static async computeAmountOutFormat({poolInfo:e,tickArrayCache:t,token2022Infos:n,amountIn:i,tokenOut:o,slippage:s,epochInfo:a}){let u=i.token.equals(ce.WSOL)?$:i.token.mint,c=s.numerator.toNumber()/s.denominator.toNumber(),l=o.mint.equals(de)?new ce({mint:"sol",decimals:Ge.decimals}):o,{realAmountIn:m,amountOut:p,minAmountOut:d,expirationTime:y,currentPrice:f,executionPrice:b,priceImpact:w,fee:h,remainingAccounts:A}=await Ve.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:u,amountIn:i.raw,slippage:c,token2022Infos:n,epochInfo:a}),P=D(M({},m),{amount:new ge(i.token,m.amount),fee:m.fee===void 0?void 0:new ge(i.token,m.fee)}),T=D(M({},p),{amount:new ge(l,p.amount),fee:p.fee===void 0?void 0:new ge(l,p.fee)}),I=D(M({},d),{amount:new ge(l,d.amount),fee:d.fee===void 0?void 0:new ge(l,d.fee)}),x=new $e({baseToken:i.token,denominator:new Ie(10).pow(new Ie(20+i.token.decimals)),quoteToken:l,numerator:f.mul(new v(10**(20+l.decimals))).toFixed(0)}),O=new $e({baseToken:i.token,denominator:new Ie(10).pow(new Ie(20+i.token.decimals)),quoteToken:l,numerator:b.mul(new v(10**(20+l.decimals))).toFixed(0)}),N=new ge(i.token,h);return{realAmountIn:P,amountOut:T,minAmountOut:I,expirationTime:y,currentPrice:x,executionPrice:O,priceImpact:w,fee:N,remainingAccounts:A}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:i}){var y,f,b;let o=e[t],s=q.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),a=q.getTickPrice({poolInfo:e,tick:i,baseIn:!0}).price.toNumber(),u=Math.max(s,o.priceMin),l=Math.min(a,o.priceMax)-u,m=a-s,p=o.priceMax-o.priceMin,d;return l<=0?d=0:m===l?d=p/l:p===l?d=l/m:d=l/p*(l/m),{feeApr:o.feeApr*d,rewardsApr:[(y=o.rewardApr[0])!=null?y:0*d,(f=o.rewardApr[1])!=null?f:0*d,(b=o.rewardApr[2])!=null?b:0*d],apr:o.apr*d}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:i,liquidity:o,positionTickLowerIndex:s,positionTickUpperIndex:a,chainTime:u}){let c=n==="day"?1:n==="week"?7:n==="month"?30:0,l=e[n],m=i[vt(e.mintA.address).toString()],p=i[vt(e.mintB.address).toString()],d=e.mintA.decimals,y=e.mintB.decimals;if(!l||!m||!p)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let f=j.priceToSqrtPriceX64(new v(e.price),e.mintA.decimals,e.mintB.decimals),b=j.getSqrtPriceX64FromTick(s),w=j.getSqrtPriceX64FromTick(a),{amountSlippageA:h,amountSlippageB:A}=se.getAmountsFromLiquidityWithSlippage(f,b,w,t,!1,!1,0),{amountSlippageA:P,amountSlippageB:T}=se.getAmountsFromLiquidityWithSlippage(f,b,w,o,!1,!1,0),I=new v(h.toString()).div(new v(10).pow(d)).mul(m.value).add(new v(A.toString()).div(new v(10).pow(y)).mul(p.value)),x=new v(P.toString()).div(new v(10).pow(d)).mul(m.value).add(new v(T.toString()).div(new v(10).pow(y)).mul(p.value)),O=x.div(I.add(x)).div(x),L=new v(l.volumeFee).mul(365).div(c).mul(O).mul(100).toNumber(),E=3600*24*365,Z=e.rewardDefaultInfos.map(W=>{var te,at;let ee=W.mint.decimals,Q=i[W.mint.address];return u<((te=W.startTime)!=null?te:0)||u>((at=W.endTime)!=null?at:0)||!W.perSecond||!Q||ee===void 0?0:new v(Q.value).mul(new v(W.perSecond).mul(E)).div(new v(10).pow(ee)).mul(O).mul(100).toNumber()});return{feeApr:L,rewardsApr:Z,apr:L+Z.reduce((W,ee)=>W+ee,0)}}static getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:i,amount:o,slippage:s,add:a,epochInfo:u,amountHasFee:c}){var w,h;let l=j.priceToSqrtPriceX64(new v(e.price),e.mintA.decimals,e.mintB.decimals),m=j.getSqrtPriceX64FromTick(n),p=j.getSqrtPriceX64FromTick(i),d=a?1-s:1+s,y=Re(o,(w=e[t?"mintA":"mintB"].extensions)==null?void 0:w.feeConfig,u,!c),f=new Ie(new v(y.amount.sub((h=y.fee)!=null?h:me).toString()).mul(d).toFixed(0)),b;if(l.lte(m))b=t?se.getLiquidityFromTokenAmountA(m,p,f,!a):new Ie(0);else if(l.lte(p)){let A=se.getLiquidityFromTokenAmountA(l,p,f,!a),P=se.getLiquidityFromTokenAmountB(m,l,f);b=t?A:P}else b=t?new Ie(0):se.getLiquidityFromTokenAmountB(m,p,f);return Ve.getAmountsFromLiquidity({epochInfo:u,poolInfo:e,tickLower:n,tickUpper:i,liquidity:b,slippage:s,add:a})}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:i,liquidity:o,slippage:s,add:a}){var b,w,h,A;let u=j.getSqrtPriceX64FromTick(n),c=j.getSqrtPriceX64FromTick(i),l=a?1+s:1-s,m=se.getAmountsFromLiquidity(j.priceToSqrtPriceX64(new v(t.price),t.mintA.decimals,t.mintB.decimals),u,c,o,a),[p,d]=[Re(m.amountA,(b=t.mintA.extensions)==null?void 0:b.feeConfig,e,!0),Re(m.amountB,(w=t.mintB.extensions)==null?void 0:w.feeConfig,e,!0)],[y,f]=[Re(m.amountA.muln(l),(h=t.mintA.extensions)==null?void 0:h.feeConfig,e,!0),Re(m.amountB.muln(l),(A=t.mintB.extensions)==null?void 0:A.feeConfig,e,!0)];return{liquidity:o,amountA:p,amountB:d,amountSlippageA:y,amountSlippageB:f,expirationTime:Zt(p.expirationTime,d.expirationTime)}}};function iA({poolInfo:r,tickLower:e,tickUpper:t,amountA:n,amountB:i,slippage:o,add:s,epochInfo:a,amountHasFee:u}){var A,P,T,I;let[c,l,m,p]=e<t?[e,t,n,i]:[t,e,i,n],d=j.priceToSqrtPriceX64(new v(r.price),r.mintA.decimals,r.mintB.decimals),y=j.getSqrtPriceX64FromTick(c),f=j.getSqrtPriceX64FromTick(l),[b,w]=[Re(m,(A=r.mintA.extensions)==null?void 0:A.feeConfig,a,!u),Re(p,(P=r.mintB.extensions)==null?void 0:P.feeConfig,a,!u)],h=se.getLiquidityFromTokenAmounts(d,y,f,b.amount.sub((T=b.fee)!=null?T:me),w.amount.sub((I=w.fee)!=null?I:me));return se.getAmountsOutFromLiquidity({poolInfo:r,tickLower:e,tickUpper:t,liquidity:h,slippage:o,add:s,epochInfo:a,amountAddFee:!u})}var H=class{static mulDivRoundingUp(e,t,n){let i=e.mul(t),o=i.div(n);return i.mod(n).eq(me)||(o=o.add(De)),o}static mulDivFloor(e,t,n){if(n.eq(me))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(me))throw new Error("division by 0");return e.mul(t).add(n.sub(De)).div(n)}static x64ToDecimal(e,t){return new v(e.toString()).div(v.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new ne(e.mul(v.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add(Jr).sub(t).mod(Jr)}};function Oe(r,e){return wo(r.mul(e),64,256)}function nm(r,e,t){let n=r.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function wo(r,e,t){let n=r.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var j=class{static sqrtPriceX64ToPrice(e,t,n){return H.x64ToDecimal(e).pow(2).mul(v.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return H.decimalToX64(e.mul(v.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,i){if(!e.gt(me))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(me))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,i){if(!e.gt(me))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(me))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,i){if(n.eq(me))return e;let o=t.shln(nr);if(i){let s=o,a=o.add(n.mul(e));return a.gte(s)?H.mulDivCeil(s,e,a):H.mulDivRoundingUp(s,De,s.div(e).add(n))}else{let s=n.mul(e);if(!o.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let a=o.sub(s);return H.mulDivCeil(o,e,a)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,i){let o=n.shln(nr);if(i)return e.add(o.div(t));{let s=H.mulDivRoundingUp(o,De,t);if(!e.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(s)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<qe||e>Ye)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new ne("18445821805675395072"):new ne("18446744073709551616");return(t&2)!=0&&(n=Oe(n,new ne("18444899583751176192"))),(t&4)!=0&&(n=Oe(n,new ne("18443055278223355904"))),(t&8)!=0&&(n=Oe(n,new ne("18439367220385607680"))),(t&16)!=0&&(n=Oe(n,new ne("18431993317065453568"))),(t&32)!=0&&(n=Oe(n,new ne("18417254355718170624"))),(t&64)!=0&&(n=Oe(n,new ne("18387811781193609216"))),(t&128)!=0&&(n=Oe(n,new ne("18329067761203558400"))),(t&256)!=0&&(n=Oe(n,new ne("18212142134806163456"))),(t&512)!=0&&(n=Oe(n,new ne("17980523815641700352"))),(t&1024)!=0&&(n=Oe(n,new ne("17526086738831433728"))),(t&2048)!=0&&(n=Oe(n,new ne("16651378430235570176"))),(t&4096)!=0&&(n=Oe(n,new ne("15030750278694412288"))),(t&8192)!=0&&(n=Oe(n,new ne("12247334978884435968"))),(t&16384)!=0&&(n=Oe(n,new ne("8131365268886854656"))),(t&32768)!=0&&(n=Oe(n,new ne("3584323654725218816"))),(t&65536)!=0&&(n=Oe(n,new ne("696457651848324352"))),(t&131072)!=0&&(n=Oe(n,new ne("26294789957507116"))),(t&262144)!=0&&(n=Oe(n,new ne("37481735321082"))),e>0&&(n=wa.div(n)),n}static getTickFromPrice(e,t,n){return j.getTickFromSqrtPriceX64(j.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(It)||e.lt(Tt))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new ne(t-64),i=nm(n,32,128),o=new ne("8000000000000000","hex"),s=0,a=new ne(0),u=t>=64?e.shrn(t-63):e.shln(63-t);for(;o.gt(new ne(0))&&s<ka;){u=u.mul(u);let y=u.shrn(127);u=u.shrn(63+y.toNumber()),a=a.add(o.mul(y)),o=o.shrn(1),s+=1}let c=a.shrn(32),m=i.add(c).mul(new ne(Aa)),p=wo(m.sub(new ne(ha)),64,128).toNumber(),d=wo(m.add(new ne(Pa)),64,128).toNumber();return p==d?p:j.getSqrtPriceX64FromTick(d).lte(e)?d:p}},sn=class{static getTickWithPriceAndTickspacing(e,t,n,i){let s=j.getTickFromSqrtPriceX64(j.priceToSqrtPriceX64(e,n,i))/t;return s<0?s=Math.floor(s):s=Math.ceil(s),s*t}static roundPriceWithTickspacing(e,t,n,i){let o=sn.getTickWithPriceAndTickspacing(e,t,n,i),s=j.getSqrtPriceX64FromTick(o);return j.sqrtPriceX64ToPrice(s,n,i)}},se=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(me))throw new Error("sqrtPriceX64A must greater than 0");let o=n.ushln(nr),s=t.sub(e);return i?H.mulDivRoundingUp(H.mulDivCeil(o,s,t),De,e):H.mulDivFloor(o,s,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(me))throw new Error("sqrtPriceX64A must greater than 0");return i?H.mulDivCeil(n,t.sub(e),nt):H.mulDivFloor(n,t.sub(e),nt)}static getLiquidityFromTokenAmountA(e,t,n,i){e.gt(t)&&([e,t]=[t,e]);let o=n.mul(e).mul(t),s=t.sub(e),a=o.div(s);return i?H.mulDivRoundingUp(a,De,bo):a.shrn(nr)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),H.mulDivFloor(n,bo,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,i,o){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return se.getLiquidityFromTokenAmountA(t,n,i,!1);if(e.lt(n)){let s=se.getLiquidityFromTokenAmountA(e,n,i,!1),a=se.getLiquidityFromTokenAmountB(t,e,o);return s.lt(a)?s:a}else return se.getLiquidityFromTokenAmountB(t,n,o)}static getAmountsFromLiquidity(e,t,n,i,o){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:se.getTokenAmountAFromLiquidity(t,n,i,o),amountB:new ne(0)};if(e.lt(n)){let s=se.getTokenAmountAFromLiquidity(e,n,i,o),a=se.getTokenAmountBFromLiquidity(t,e,i,o);return{amountA:s,amountB:a}}else return{amountA:new ne(0),amountB:se.getTokenAmountBFromLiquidity(t,n,i,o)}}static getAmountsFromLiquidityWithSlippage(e,t,n,i,o,s,a){let{amountA:u,amountB:c}=se.getAmountsFromLiquidity(e,t,n,i,s),l=o?1+a:1-a,m=new ne(new v(u.toString()).mul(l).toFixed(0)),p=new ne(new v(c.toString()).mul(l).toFixed(0));return{amountSlippageA:m,amountSlippageB:p}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:i,slippage:o,add:s,epochInfo:a,amountAddFee:u}){var h,A,P,T;let c=j.priceToSqrtPriceX64(new v(e.price),e.mintA.decimals,e.mintB.decimals),l=j.getSqrtPriceX64FromTick(t),m=j.getSqrtPriceX64FromTick(n),p=s?1+o:1-o,d=se.getAmountsFromLiquidity(c,l,m,i,s),[y,f]=[Re(d.amountA,(h=e.mintA.extensions)==null?void 0:h.feeConfig,a,u),Re(d.amountB,(A=e.mintB.extensions)==null?void 0:A.feeConfig,a,u)],[b,w]=[Re(new ne(new v(d.amountA.toString()).mul(p).toFixed(0)),(P=e.mintA.extensions)==null?void 0:P.feeConfig,a,u),Re(new ne(new v(d.amountB.toString()).mul(p).toFixed(0)),(T=e.mintB.extensions)==null?void 0:T.feeConfig,a,u)];return{liquidity:i,amountA:y,amountB:f,amountSlippageA:b,amountSlippageB:w,expirationTime:Zt(y.expirationTime,f.expirationTime)}}},on=class{static swapCompute(e,t,n,i,o,s,a,u,c,l,m,p,d,y){if(p.eq(me))throw new Error("amountSpecified must not be 0");if(y||(y=s?Tt.add(De):It.sub(De)),s){if(y.lt(Tt))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(y.gte(m))throw new Error("sqrtPriceX64 must smaller than current")}else{if(y.gt(It))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(y.lte(m))throw new Error("sqrtPriceX64 must greater than current")}let f=p.gt(me),b={amountSpecifiedRemaining:p,amountCalculated:me,sqrtPriceX64:m,tick:c>d?Math.min(d+ae.tickCount(l)-1,c):d,accounts:[],liquidity:u,feeAmount:new ne(0)},w=d,h=n[d],A=0,P=!s&&h.startTickIndex===b.tick;for(;!b.amountSpecifiedRemaining.eq(me)&&!b.sqrtPriceX64.eq(y);){if(A>10)throw Error("liquidity limit");let T={};T.sqrtPriceStartX64=b.sqrtPriceX64;let I=q.nextInitTick(h,b.tick,l,s,P),x=I||null,O=null;if(!(x!=null&&x.liquidityGross.gtn(0))){let L=Ve.nextInitializedTickArrayStartIndex({tickCurrent:b.tick,tickSpacing:l,tickArrayBitmap:i,exBitmapInfo:o},w,s);if(!L.isExist)throw Error("swapCompute LiquidityInsufficient");w=L.nextStartIndex;let{publicKey:E}=ye(e,t,w);O=E,h=n[w],x=q.firstInitializedTick(h,s)}T.tickNext=x.tick,T.initialized=x.liquidityGross.gtn(0),d!==w&&O&&(b.accounts.push(O),d=w),T.tickNext<qe?T.tickNext=qe:T.tickNext>Ye&&(T.tickNext=Ye),T.sqrtPriceNextX64=j.getSqrtPriceX64FromTick(T.tickNext);let N;if(s&&T.sqrtPriceNextX64.lt(y)||!s&&T.sqrtPriceNextX64.gt(y)?N=y:N=T.sqrtPriceNextX64,[b.sqrtPriceX64,T.amountIn,T.amountOut,T.feeAmount]=on.swapStepCompute(b.sqrtPriceX64,N,b.liquidity,b.amountSpecifiedRemaining,a),b.feeAmount=b.feeAmount.add(T.feeAmount),f?(b.amountSpecifiedRemaining=b.amountSpecifiedRemaining.sub(T.amountIn.add(T.feeAmount)),b.amountCalculated=b.amountCalculated.sub(T.amountOut)):(b.amountSpecifiedRemaining=b.amountSpecifiedRemaining.add(T.amountOut),b.amountCalculated=b.amountCalculated.add(T.amountIn.add(T.feeAmount))),b.sqrtPriceX64.eq(T.sqrtPriceNextX64)){if(T.initialized){let L=x.liquidityNet;s&&(L=L.mul(Nt)),b.liquidity=se.addDelta(b.liquidity,L)}P=T.tickNext!=b.tick&&!s&&h.startTickIndex===T.tickNext,b.tick=s?T.tickNext-1:T.tickNext}else if(b.sqrtPriceX64!=T.sqrtPriceStartX64){let L=j.getTickFromSqrtPriceX64(b.sqrtPriceX64);P=L!=b.tick&&!s&&h.startTickIndex===L,b.tick=L}++A}try{let{nextStartIndex:T,isExist:I}=ae.nextInitializedTickArray(b.tick,l,s,i,o);I&&d!==T&&(b.accounts.push(ye(e,t,T).publicKey),d=T)}catch{}return{amountCalculated:b.amountCalculated,feeAmount:b.feeAmount,sqrtPriceX64:b.sqrtPriceX64,liquidity:b.liquidity,tickCurrent:b.tick,accounts:b.accounts}}static swapStepCompute(e,t,n,i,o){let s={sqrtPriceX64Next:new ne(0),amountIn:new ne(0),amountOut:new ne(0),feeAmount:new ne(0)},a=e.gte(t),u=i.gte(me);if(u){let l=H.mulDivFloor(i,$r.sub(new ne(o.toString())),$r);s.amountIn=a?se.getTokenAmountAFromLiquidity(t,e,n,!0):se.getTokenAmountBFromLiquidity(e,t,n,!0),l.gte(s.amountIn)?s.sqrtPriceX64Next=t:s.sqrtPriceX64Next=j.getNextSqrtPriceX64FromInput(e,n,l,a)}else s.amountOut=a?se.getTokenAmountBFromLiquidity(t,e,n,!1):se.getTokenAmountAFromLiquidity(e,t,n,!1),i.mul(Nt).gte(s.amountOut)?s.sqrtPriceX64Next=t:s.sqrtPriceX64Next=j.getNextSqrtPriceX64FromOutput(e,n,i.mul(Nt),a);let c=t.eq(s.sqrtPriceX64Next);return a?(c&&u||(s.amountIn=se.getTokenAmountAFromLiquidity(s.sqrtPriceX64Next,e,n,!0)),c&&!u||(s.amountOut=se.getTokenAmountBFromLiquidity(s.sqrtPriceX64Next,e,n,!1))):(s.amountIn=c&&u?s.amountIn:se.getTokenAmountBFromLiquidity(e,s.sqrtPriceX64Next,n,!0),s.amountOut=c&&!u?s.amountOut:se.getTokenAmountAFromLiquidity(e,s.sqrtPriceX64Next,n,!1)),!u&&s.amountOut.gt(i.mul(Nt))&&(s.amountOut=i.mul(Nt)),u&&!s.sqrtPriceX64Next.eq(t)?s.feeAmount=i.sub(s.amountIn):s.feeAmount=H.mulDivCeil(s.amountIn,new ne(o),$r.sub(new ne(o))),[s.sqrtPriceX64Next,s.amountIn,s.amountOut,s.feeAmount]}};var Ke=60,rn=512,q=class{static getTickArrayAddressByTick(e,t,n,i){let o=q.getTickArrayStartIndexByTick(n,i),{publicKey:s}=ye(e,t,o);return s}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=q.getTickArrayStartIndexByTick(e,t),i=Math.floor((e-n)/t);if(i<0||i>=Ke)throw new Error("tick offset in array overflow");return i}static getTickArrayBitIndex(e,t){let n=ae.tickCount(t),i=e/n;return e<0&&e%n!=0?i=Math.ceil(i)-1:i=Math.floor(i),i}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*ae.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*Ke,i=Math.floor(e/n)+512;return Math.abs(i)}static checkTickArrayIsInitialized(e,t,n){let i=n*Ke,o=Math.floor(t/i)+512,s=Math.abs(o);return{isInitialized:e.testn(s),startIndex:(s-512)*i}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*Ke:e+t*Ke}static mergeTickArrayBitmap(e){let t=new rm(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,i,o){let s=Math.floor(i/(n*Ke));return[...q.searchLowBitFromStart(e,t,s-1,o,n),...q.searchHightBitFromStart(e,t,s,o,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return q.searchHightBitFromStart(e,t,0,rn,n)}static getAllInitializedTickArrayInfo(e,t,n,i,o){let s=[],a=q.getAllInitializedTickArrayStartIndex(n,i,o);for(let u of a){let{publicKey:c}=ye(e,t,u);s.push({tickArrayStartIndex:u,tickArrayAddress:c})}return s}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,i,o){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(c=>q.mergeTickArrayBitmap(c)),a=[];for(;n>=-7680;){let c=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[c].testn(l)&&a.push(n),n--,a.length===i)break}let u=ae.tickCount(o);return a.map(c=>c*u)}static searchHightBitFromStart(e,t,n,i,o){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(c=>q.mergeTickArrayBitmap(c)),a=[];for(;n<7680;){let c=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[c].testn(l)&&a.push(n),n++,a.length===i)break}let u=ae.tickCount(o);return a.map(c=>c*u)}static checkIsOutOfBoundary(e){return e<qe||e>Ye}static nextInitTick(e,t,n,i,o){if(ae.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let a=Math.floor((t-e.startTickIndex)/n);if(i)for(;a>=0;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a-1}else for(o||(a=a+1);a<Ke;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a+1}return null}static firstInitializedTick(e,t){if(t){let n=Ke-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<Ke;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let i=j.getSqrtPriceX64FromTick(t),o=j.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:o,tickSqrtPriceX64:i}:{tick:t,price:new v(1).div(o),tickSqrtPriceX64:i}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let i=n?t:new v(1).div(t),o=sn.getTickWithPriceAndTickspacing(i,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=j.getSqrtPriceX64FromTick(o),a=j.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:o,price:a}:{tick:o,price:new v(1).div(a)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let i=j.getSqrtPriceX64FromTick(t),o=j.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:o,tickSqrtPriceX64:i}:{tick:t,price:new v(1).div(o),tickSqrtPriceX64:i}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let i=n?t:new v(1).div(t),o=sn.getTickWithPriceAndTickspacing(i,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=j.getSqrtPriceX64FromTick(o),a=j.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:o,price:a}:{tick:o,price:new v(1).div(a)}}};var KA=R([ke(8),V("bump"),Dt("index"),B(""),ve("protocolFeeRate"),ve("tradeFeeRate"),Dt("tickSpacing"),G(g(),8,"")]),im=R([ve("blockTimestamp"),z("sqrtPriceX64"),z("cumulativeTimePriceX64"),G(z(),1,"")]),ko=R([ke(8),Xe("initialized"),B("poolId"),G(im,1e3,"observations"),G(z(),5,"")]),om=R([V("rewardState"),g("openTime"),g("endTime"),g("lastUpdateTime"),z("emissionsPerSecondX64"),g("rewardTotalEmissioned"),g("rewardClaimed"),B("tokenMint"),B("tokenVault"),B("creator"),z("rewardGrowthGlobalX64")]),CA=R([ke(8),V("bump"),B("ammConfig"),B("creator"),B("mintA"),B("mintB"),B("vaultA"),B("vaultB"),B("observationId"),V("mintDecimalsA"),V("mintDecimalsB"),Dt("tickSpacing"),z("liquidity"),z("sqrtPriceX64"),_e("tickCurrent"),Dt("observationIndex"),Dt("observationUpdateDuration"),z("feeGrowthGlobalX64A"),z("feeGrowthGlobalX64B"),g("protocolFeesTokenA"),g("protocolFeesTokenB"),z("swapInAmountTokenA"),z("swapOutAmountTokenB"),z("swapInAmountTokenB"),z("swapOutAmountTokenA"),V("status"),G(V(),7,""),G(om,3,"rewardInfos"),G(g(),16,"tickArrayBitmap"),g("totalFeesTokenA"),g("totalFeesClaimedTokenA"),g("totalFeesTokenB"),g("totalFeesClaimedTokenB"),g("fundFeesTokenA"),g("fundFeesTokenB"),g("startTime"),G(g(),15*4-3,"padding")]),sm=R([z("growthInsideLastX64"),g("rewardAmountOwed")]),xa=R([ke(8),V("bump"),B("nftMint"),B("poolId"),_e("tickLower"),_e("tickUpper"),z("liquidity"),z("feeGrowthInsideLastX64A"),z("feeGrowthInsideLastX64B"),g("tokenFeesOwedA"),g("tokenFeesOwedB"),G(sm,3,"rewardInfos"),G(g(),8,"")]),RA=R([ke(8),V("bump"),B("poolId"),_e("tickLowerIndex"),_e("tickUpperIndex"),z("liquidity"),z("feeGrowthInsideLastX64A"),z("feeGrowthInsideLastX64B"),g("tokenFeesOwedA"),g("tokenFeesOwedB"),G(z(),3,"rewardGrowthInside"),G(g(),8,"")]),am=R([_e("tick"),Cs("liquidityNet"),z("liquidityGross"),z("feeGrowthOutsideX64A"),z("feeGrowthOutsideX64B"),G(z(),3,"rewardGrowthsOutsideX64"),G(ve(),13,"")]),rr=R([ke(8),B("poolId"),_e("startTickIndex"),G(am,Ke,"ticks"),V("initializedTickCount"),G(V(),115,"")]),Sa=R([ke(329),G(B(),100,"whitelistMints")]),Ba=R([ke(8),B("poolId"),G(G(g(),8),go,"positiveTickArrayBitmap"),G(G(g(),8),go,"negativeTickArrayBitmap")]);var Ra=oe("Raydium_Clmm"),yt={createPool:[233,146,209,142,207,104,64,188],initReward:[95,135,192,196,242,129,230,68],setRewardEmissions:[112,52,167,75,32,201,211,137],openPosition:[77,184,74,214,112,86,241,199],closePosition:[123,134,81,0,49,68,98,98],increaseLiquidity:[133,29,89,223,69,238,176,10],decreaseLiquidity:[58,127,188,62,79,82,196,96],swap:[43,4,237,11,26,201,30,98],collectReward:[18,237,166,197,34,16,213,144]},Pe=class{static createPoolInstruction(e,t,n,i,o,s,a,u,c,l,m,p,d,y){let f=R([z("sqrtPriceX64"),g("startTime")]),b=[{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:Pn.programId,isSigner:!1,isWritable:!1},{pubkey:rt,isSigner:!1,isWritable:!1}],w=Buffer.alloc(f.span);f.encode({sqrtPriceX64:d,startTime:y},w);let h=Buffer.from([...yt.createPool,...w]);return new ft({keys:b,programId:e,data:h})}static async createPoolInstructions(e){let{connection:t,programId:n,owner:i,mintA:o,mintB:s,ammConfigId:a,initialPriceX64:u,startTime:c,forerunCreate:l}=e,m=We({fromPublicKey:i,programId:n}),[p,d]=[new F(o.address),new F(s.address)],y=[Pn.createAccountWithSeed({fromPubkey:i,basePubkey:i,seed:m.seed,newAccountPubkey:m.publicKey,lamports:l?0:await t.getMinimumBalanceForRentExemption(ko.span),space:ko.span,programId:n})],{publicKey:f}=ba(n,a,p,d),{publicKey:b}=yo(n,f,p),{publicKey:w}=yo(n,f,d);return y.push(this.createPoolInstruction(n,f,i,a,m.publicKey,p,b,new F(o.programId||Ee),d,w,new F(s.programId||Ee),ht(n,f).publicKey,u,c)),{signers:[],instructions:y,instructionTypes:[_.CreateAccount,_.ClmmCreatePool],address:{poolId:f,observationId:m.publicKey,mintAVault:b,mintBVault:w},lookupTableAddress:[]}}static openPositionFromLiquidityInstruction(e,t,n,i,o,s,a,u,c,l,m,p,d,y,f,b,w,h,A,P,T,I,x,O,N,L){let E=R([_e("tickLowerIndex"),_e("tickUpperIndex"),_e("tickArrayLowerStartIndex"),_e("tickArrayUpperStartIndex"),z("liquidity"),g("amountMaxA"),g("amountMaxB"),Xe("withMetadata"),V("optionBaseFlag"),Xe("baseFlag")]),Z=[...L?[{pubkey:L,isSigner:!1,isWritable:!0}]:[]],W=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:rt,isSigner:!1,isWritable:!1},{pubkey:Pn.programId,isSigner:!1,isWritable:!1},{pubkey:Ee,isSigner:!1,isWritable:!1},{pubkey:Ka,isSigner:!1,isWritable:!1},{pubkey:pn,isSigner:!1,isWritable:!1},{pubkey:Yt,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:w,isSigner:!1,isWritable:!1},...Z],ee=Buffer.alloc(E.span);E.encode({tickLowerIndex:h,tickUpperIndex:A,tickArrayLowerStartIndex:P,tickArrayUpperStartIndex:T,liquidity:I,amountMaxA:x,amountMaxB:O,withMetadata:N==="create",baseFlag:!1,optionBaseFlag:0},ee);let Q=Buffer.from([...yt.openPosition,...ee]);return new ft({keys:W,programId:e,data:Q})}static async openPositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:o,liquidity:s,amountMaxA:a,amountMaxB:u,withMetadata:c,getEphemeralSigners:l}){let m=[],[p,d]=[new F(e.programId),new F(e.id)],y;if(l)y=new F((await l(1))[0]);else{let O=Ao.generate();m.push(O),y=O.publicKey}let f=q.getTickArrayStartIndexByTick(i,e.config.tickSpacing),b=q.getTickArrayStartIndexByTick(o,e.config.tickSpacing),{publicKey:w}=ye(p,d,f),{publicKey:h}=ye(p,d,b),{publicKey:A}=we(n.wallet,y,Ee),{publicKey:P}=Zr(y),{publicKey:T}=At(p,y),{publicKey:I}=nn(p,d,i,o),x=this.openPositionFromLiquidityInstruction(p,n.feePayer,d,n.wallet,y,A,P,I,w,h,T,n.tokenAccountA,n.tokenAccountB,new F(t.vault.A),new F(t.vault.B),new F(e.mintA.address),new F(e.mintB.address),i,o,f,b,s,a,u,c);return{signers:m,instructions:[x],instructionTypes:[_.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{nftMint:y,tickArrayLower:w,tickArrayUpper:h,positionNftAccount:A,metadataAccount:P,personalPosition:T,protocolPosition:I}}}static async openPositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:o,base:s,baseAmount:a,otherAmountMax:u,withMetadata:c,getEphemeralSigners:l}){let m=[],[p,d]=[new F(e.programId),new F(e.id)],y;if(l)y=new F((await l(1))[0]);else{let O=Ao.generate();m.push(O),y=O.publicKey}let f=q.getTickArrayStartIndexByTick(i,e.config.tickSpacing),b=q.getTickArrayStartIndexByTick(o,e.config.tickSpacing),{publicKey:w}=ye(p,d,f),{publicKey:h}=ye(p,d,b),{publicKey:A}=we(n.wallet,y,Ee),{publicKey:P}=Zr(y),{publicKey:T}=At(p,y),{publicKey:I}=nn(p,d,i,o),x=this.openPositionFromBaseInstruction(p,n.feePayer,d,n.wallet,y,A,P,I,w,h,T,n.tokenAccountA,n.tokenAccountB,new F(t.vault.A),new F(t.vault.B),new F(e.mintA.address),new F(e.mintB.address),i,o,f,b,c,s,a,u,Ve.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[f,b])?ht(p,d).publicKey:void 0);return{address:{nftMint:y,tickArrayLower:w,tickArrayUpper:h,positionNftAccount:A,metadataAccount:P,personalPosition:T,protocolPosition:I},instructions:[x],signers:m,instructionTypes:[_.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static openPositionFromBaseInstruction(e,t,n,i,o,s,a,u,c,l,m,p,d,y,f,b,w,h,A,P,T,I,x,O,N,L){let E=R([_e("tickLowerIndex"),_e("tickUpperIndex"),_e("tickArrayLowerStartIndex"),_e("tickArrayUpperStartIndex"),z("liquidity"),g("amountMaxA"),g("amountMaxB"),Xe("withMetadata"),V("optionBaseFlag"),Xe("baseFlag")]),Z=[...L?[{pubkey:L,isSigner:!1,isWritable:!0}]:[]],W=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:rt,isSigner:!1,isWritable:!1},{pubkey:Pn.programId,isSigner:!1,isWritable:!1},{pubkey:Ee,isSigner:!1,isWritable:!1},{pubkey:Ka,isSigner:!1,isWritable:!1},{pubkey:pn,isSigner:!1,isWritable:!1},{pubkey:Yt,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:w,isSigner:!1,isWritable:!1},...Z],ee=Buffer.alloc(E.span);E.encode({tickLowerIndex:h,tickUpperIndex:A,tickArrayLowerStartIndex:P,tickArrayUpperStartIndex:T,liquidity:new Ca(0),amountMaxA:x==="MintA"?O:N,amountMaxB:x==="MintA"?N:O,withMetadata:I==="create",baseFlag:x==="MintA",optionBaseFlag:1},ee);let Q=Buffer.from([...yt.openPosition,...ee]);return new ft({keys:W,programId:e,data:Q})}static async openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:o,liquidity:s,amountMaxA:a,amountMaxB:u,withMetadata:c,getEphemeralSigners:l}){let m,p=[];if(l)m=new F((await l(1))[0]);else{let O=Ao.generate();p.push(O),m=O.publicKey}let[d,y]=[new F(e.programId),new F(e.id)],f=q.getTickArrayStartIndexByTick(i,e.config.tickSpacing),b=q.getTickArrayStartIndexByTick(o,e.config.tickSpacing),{publicKey:w}=ye(d,y,f),{publicKey:h}=ye(d,y,b),{publicKey:A}=we(n.wallet,m,Ee),{publicKey:P}=Zr(m),{publicKey:T}=At(d,m),{publicKey:I}=nn(d,y,i,o),x=this.openPositionFromLiquidityInstruction(d,n.wallet,y,n.wallet,m,A,P,I,w,h,T,n.tokenAccountA,n.tokenAccountB,new F(t.vault.A),new F(t.vault.B),new F(t.mintA.address),new F(t.mintB.address),i,o,f,b,s,a,u,c,Ve.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[f,b])?ht(d,y).publicKey:void 0);return{address:{nftMint:m,tickArrayLower:w,tickArrayUpper:h,positionNftAccount:A,metadataAccount:P,personalPosition:T,protocolPosition:I},instructions:[x],signers:p,instructionTypes:[_.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static closePositionInstruction(e,t,n,i,o){let s=R([]),a=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:Pn.programId,isSigner:!1,isWritable:!1},{pubkey:Ee,isSigner:!1,isWritable:!1}],u=Buffer.alloc(s.span);s.encode({},u);let c=Buffer.from([...yt.closePosition,...u]);return new ft({keys:a,programId:e,data:c})}static closePositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,ownerPosition:i}){let o=new F(e.programId),{publicKey:s}=we(n.wallet,i.nftMint,Ee),{publicKey:a}=At(o,i.nftMint),u=[];return u.push(this.closePositionInstruction(o,n.wallet,i.nftMint,s,a)),{address:{positionNftAccount:s,personalPosition:a},signers:[],instructions:u,instructionTypes:[_.ClmmClosePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromLiquidityInstruction(e,t,n,i,o,s,a,u,c,l,m,p,d,y,f,b,w,h){let A=R([z("liquidity"),g("amountMaxA"),g("amountMaxB"),V("optionBaseFlag"),Xe("baseFlag")]),P=[...h?[{pubkey:h,isSigner:!1,isWritable:!0}]:[]],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:Ee,isSigner:!1,isWritable:!1},{pubkey:Yt,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...P],I=Buffer.alloc(A.span);A.encode({liquidity:f,amountMaxA:b,amountMaxB:w,optionBaseFlag:0,baseFlag:!1},I);let x=Buffer.from([...yt.increaseLiquidity,...I]);return new ft({keys:T,programId:e,data:x})}static increasePositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,liquidity:o,amountMaxA:s,amountMaxB:a}){let[u,c]=[new F(e.programId),new F(e.id)],l=q.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),m=q.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=ye(u,c,l),{publicKey:d}=ye(u,c,m),{publicKey:y}=we(i.wallet,n.nftMint,Ee),{publicKey:f}=At(u,n.nftMint),{publicKey:b}=nn(u,c,n.tickLower,n.tickUpper),w=this.increasePositionFromLiquidityInstruction(u,i.wallet,y,f,c,b,p,d,i.tokenAccountA,i.tokenAccountB,new F(t.vault.A),new F(t.vault.B),new F(e.mintA.address),new F(e.mintB.address),o,s,a,Ve.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[l,m])?ht(u,c).publicKey:void 0);return{address:{tickArrayLower:p,tickArrayUpper:d,positionNftAccount:y,personalPosition:f,protocolPosition:b},signers:[],instructions:[w],instructionTypes:[_.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,base:o,baseAmount:s,otherAmountMax:a}){let[u,c]=[new F(e.programId),new F(e.id)],l=q.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),m=q.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=ye(u,c,l),{publicKey:d}=ye(u,c,m),{publicKey:y}=we(i.wallet,n.nftMint,Ee),{publicKey:f}=At(u,n.nftMint),{publicKey:b}=nn(u,c,n.tickLower,n.tickUpper);return{address:{tickArrayLower:p,tickArrayUpper:d,positionNftAccount:y,personalPosition:f,protocolPosition:b},instructions:[this.increasePositionFromBaseInstruction(u,i.wallet,y,f,c,b,p,d,i.tokenAccountA,i.tokenAccountB,new F(t.vault.A),new F(t.vault.B),new F(e.mintA.address),new F(e.mintB.address),o,s,a,Ve.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[l,m])?ht(u,c).publicKey:void 0)],signers:[],instructionTypes:[_.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstruction(e,t,n,i,o,s,a,u,c,l,m,p,d,y,f,b,w,h){let A=R([z("liquidity"),g("amountMaxA"),g("amountMaxB"),V("optionBaseFlag"),Xe("baseFlag")]),P=[...h?[{pubkey:h,isSigner:!1,isWritable:!0}]:[]],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:Ee,isSigner:!1,isWritable:!1},{pubkey:Yt,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...P],I=Buffer.alloc(A.span);A.encode({liquidity:new Ca(0),amountMaxA:f==="MintA"?b:w,amountMaxB:f==="MintA"?w:b,baseFlag:f==="MintA",optionBaseFlag:1},I);let x=Buffer.from([...yt.increaseLiquidity,...I]);return new ft({keys:T,programId:e,data:x})}static decreaseLiquidityInstruction(e,t,n,i,o,s,a,u,c,l,m,p,d,y,f,b,w,h,A){let P=R([z("liquidity"),g("amountMinA"),g("amountMinB")]),T=[...A?[{pubkey:A,isSigner:!1,isWritable:!0}]:[],...f.map(N=>[{pubkey:N.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:N.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:N.rewardMint,isSigner:!1,isWritable:!1}]).flat()],I=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:Ee,isSigner:!1,isWritable:!1},{pubkey:Yt,isSigner:!1,isWritable:!1},{pubkey:dn,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...T],x=Buffer.alloc(P.span);P.encode({liquidity:b,amountMinA:w,amountMinB:h},x);let O=Buffer.from([...yt.decreaseLiquidity,...x]);return new ft({keys:I,programId:e,data:O})}static decreaseLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,liquidity:o,amountMinA:s,amountMinB:a,programId:u}){let[c,l]=[new F(e.programId),new F(e.id)],m=q.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),p=q.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:d}=ye(c,l,m),{publicKey:y}=ye(c,l,p),{publicKey:f}=we(i.wallet,n.nftMint,u),{publicKey:b}=At(c,n.nftMint),{publicKey:w}=nn(c,l,n.tickLower,n.tickUpper),h=[];for(let P=0;P<e.rewardDefaultInfos.length;P++)h.push({poolRewardVault:new F(t.rewardInfos[P].vault),ownerRewardVault:i.rewardAccounts[P],rewardMint:new F(e.rewardDefaultInfos[P].mint.address)});let A=[];return A.push(this.decreaseLiquidityInstruction(c,i.wallet,f,b,l,w,d,y,i.tokenAccountA,i.tokenAccountB,new F(t.vault.A),new F(t.vault.B),new F(e.mintA.address),new F(e.mintB.address),h,o,s,a,Ve.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,p])?ht(c,l).publicKey:void 0)),{address:{tickArrayLower:d,tickArrayUpper:y,positionNftAccount:f,personalPosition:b,protocolPosition:w},signers:[],instructions:A,instructionTypes:[_.ClmmDecreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapInstruction(e,t,n,i,o,s,a,u,c,l,m,p,d,y,f,b,w){let h=R([g("amount"),g("otherAmountThreshold"),z("sqrtPriceLimitX64"),Xe("isBaseInput")]),A=[...w?[{pubkey:w,isSigner:!1,isWritable:!0}]:[],...m.map(x=>({pubkey:x,isSigner:!1,isWritable:!0}))],P=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:Ee,isSigner:!1,isWritable:!1},{pubkey:Yt,isSigner:!1,isWritable:!1},{pubkey:dn,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},...A],T=Buffer.alloc(h.span);h.encode({amount:d,otherAmountThreshold:y,sqrtPriceLimitX64:f,isBaseInput:b},T);let I=Buffer.from([...yt.swap,...T]);return new ft({keys:P,programId:e,data:I})}static makeSwapBaseInInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,inputMint:i,amountIn:o,amountOutMin:s,sqrtPriceLimitX64:a,remainingAccounts:u}){let[c,l]=[new F(e.programId),new F(e.id)],[m,p]=[new F(t.vault.A),new F(t.vault.B)],[d,y]=[new F(e.mintA.address),new F(e.mintB.address)],f=e.mintA.address===i.toString(),b=[this.swapInstruction(c,n.wallet,l,new F(e.config.id),f?n.tokenAccountA:n.tokenAccountB,f?n.tokenAccountB:n.tokenAccountA,f?m:p,f?p:m,f?d:y,f?y:d,u,m,o,s,a,!0,ht(c,l).publicKey)];return{signers:[],instructions:b,instructionTypes:[_.ClmmSwapBaseIn],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static initRewardInstruction(e,t,n,i,o,s,a,u,c,l,m,p){let d=R([g("openTime"),g("endTime"),z("emissionsPerSecondX64")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:Pn.programId,isSigner:!1,isWritable:!1},{pubkey:rt,isSigner:!1,isWritable:!1}],f=Buffer.alloc(d.span);d.encode({openTime:X(l),endTime:X(m),emissionsPerSecondX64:p},f);let b=Buffer.from([...yt.initReward,...f]);return new ft({keys:y,programId:e,data:b})}static initRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:i}){let[o,s]=[new F(e.programId),new F(e.id)],a=ga(o,s,i.mint).publicKey,u=tr(o).publicKey,c=[this.initRewardInstruction(o,n.wallet,s,u,new F(e.config.id),n.tokenAccount,i.programId,i.mint,a,i.openTime,i.endTime,i.emissionsPerSecondX64)];return{address:{poolRewardVault:a,operationId:u},signers:[],instructions:c,instructionTypes:[_.ClmmInitReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static setRewardInstruction(e,t,n,i,o,s,a,u,c,l,m,p){let d=R([V("rewardIndex"),z("emissionsPerSecondX64"),g("openTime"),g("endTime")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:Ee,isSigner:!1,isWritable:!1},{pubkey:Yt,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0}],f=Buffer.alloc(d.span);d.encode({rewardIndex:c,emissionsPerSecondX64:p,openTime:X(l),endTime:X(m)},f);let b=Buffer.from([...yt.setRewardEmissions,...f]);return new ft({keys:y,programId:e,data:b})}static setRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:i}){let[o,s]=[new F(e.programId),new F(e.id)],a,u,c;for(let p=0;p<e.rewardDefaultInfos.length;p++)e.rewardDefaultInfos[p].mint.address===i.mint.toString()&&(a=p,u=new F(t.rewardInfos[p].vault),c=new F(t.rewardInfos[p].mint.address));(a===void 0||u===void 0)&&Ra.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let l=tr(o).publicKey,m=[this.setRewardInstruction(o,n.wallet,s,l,new F(e.config.id),n.tokenAccount,u,c,a,i.openTime,i.endTime,i.emissionsPerSecondX64)];return{address:{rewardVault:u,operationId:l},signers:[],instructions:m,instructionTypes:[_.ClmmSetReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static collectRewardInstruction(e,t,n,i,o,s,a){let u=R([V("rewardIndex")]),c=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:Ee,isSigner:!1,isWritable:!1},{pubkey:Yt,isSigner:!1,isWritable:!1},{pubkey:dn,isSigner:!1,isWritable:!1}],l=Buffer.alloc(u.span);u.encode({rewardIndex:a},l);let m=Buffer.from([...yt.collectReward,...l]);return new ft({keys:c,programId:e,data:m})}static collectRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardMint:i}){let[o,s]=[new F(e.programId),new F(e.id)],a,u;for(let l=0;l<e.rewardDefaultInfos.length;l++)e.rewardDefaultInfos[l].mint.address===i.toString()&&(a=l,u=new F(t.rewardInfos[l].vault));(a===void 0||u===void 0)&&Ra.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let c=[this.collectRewardInstruction(o,n.wallet,s,n.tokenAccount,u,i,a)];return{address:{rewardVault:u},signers:[],instructions:c,instructionTypes:[_.ClmmCollectReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapBaseOutInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,outputMint:i,amountOut:o,amountInMax:s,sqrtPriceLimitX64:a,remainingAccounts:u}){let[c,l]=[new F(e.programId),new F(e.id)],[m,p]=[new F(t.vault.A),new F(t.vault.B)],[d,y]=[new F(e.mintA.address),new F(e.mintB.address)],f=e.mintA.address===i.toString(),b=[this.swapInstruction(c,n.wallet,l,new F(e.config.id),f?n.tokenAccountB:n.tokenAccountA,f?n.tokenAccountA:n.tokenAccountB,f?p:m,f?m:p,f?d:y,f?y:d,u,m,o,s,a,!1)];return{signers:[],instructions:b,instructionTypes:[_.ClmmSwapBaseOut],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}};import{PublicKey as mm}from"@solana/web3.js";import{PublicKey as cm}from"@solana/web3.js";import La from"bn.js";var QA=new La(25),jA=new La(1e4),um={4:3,5:3};var lm=oe("Raydium_liquidity_serum");function Oa({programId:r,marketId:e}){let t=[e.toBuffer()],n=0,i;for(;n<100;){try{let o=t.concat(Buffer.from([n]),Buffer.alloc(7));i=cm.createProgramAddressSync(o,r)}catch(o){if(o instanceof TypeError)throw o;n++;continue}return{publicKey:i,nonce:n}}throw lm.logWithError("unable to find a viable program address nonce","params",{programId:r,marketId:e}),new Error("unable to find a viable program address nonce")}import sr from"bn.js";function Po({programId:r}){let{publicKey:e}=le([Buffer.from("amm_config_account_seed","utf-8")],r);return e}function an({name:r,programId:e,marketId:t}){let{publicKey:n}=le([e.toBuffer(),t.toBuffer(),Buffer.from(r,"utf-8")],e);return n}function dm({programId:r,marketId:e}){let{publicKey:t}=le([r.toBuffer(),e.toBuffer(),Buffer.from("open_order_associated_seed","utf-8")],r);return t}function pm({programId:r}){return le([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],r)}function Na({version:r,marketVersion:e,marketId:t,baseMint:n,quoteMint:i,baseDecimals:o,quoteDecimals:s,programId:a,marketProgramId:u}){let c=an({name:"amm_associated_seed",programId:a,marketId:t}),l=an({name:"lp_mint_associated_seed",programId:a,marketId:t}),{publicKey:m,nonce:p}=pm({programId:a}),d=an({name:"coin_vault_associated_seed",programId:a,marketId:t}),y=an({name:"pc_vault_associated_seed",programId:a,marketId:t}),f=an({name:"temp_lp_token_associated_seed",programId:a,marketId:t}),b=dm({programId:a,marketId:t}),w=an({name:"target_associated_seed",programId:a,marketId:t}),h=an({name:"withdraw_associated_seed",programId:a,marketId:t}),{publicKey:A}=Oa({programId:u,marketId:t});return{id:c,baseMint:n,quoteMint:i,lpMint:l,baseDecimals:o,quoteDecimals:s,lpDecimals:o,version:r,programId:a,authority:m,nonce:p,baseVault:d,quoteVault:y,lpVault:f,openOrders:b,targetOrders:w,withdrawQueue:h,marketVersion:e,marketProgramId:u,marketId:t,marketAuthority:A,lookupTableAccount:mm.default,configId:Po({programId:a})}}var ho;async function uh({connection:r,poolKeysList:e,config:t}){ho||(ho=new jr({connection:r}),await ho.initStableModelLayout());let n=e.map(s=>ma({poolKeys:s}));return(await ds(r,n.map(s=>s.instruction),"GetPoolData")).map(s=>{let a=ps(s,"GetPoolData"),u=new sr(Rt(a,"status")),c=Number(Rt(a,"coin_decimals")),l=Number(Rt(a,"pc_decimals")),m=Number(Rt(a,"lp_decimals")),p=new sr(Rt(a,"pool_coin_amount")),d=new sr(Rt(a,"pool_pc_amount")),y=new sr(Rt(a,"pool_lp_supply")),f="0";try{f=Rt(a,"pool_open_time")}catch{}return{status:u,baseDecimals:c,quoteDecimals:l,lpDecimals:m,baseReserve:p,quoteReserve:d,lpSupply:y,startTime:new sr(f)}})}import Bt from"bn.js";var ar=class extends Te{constructor(e){super(e)}async load(){this.checkDisabled()}computePairAmount({poolInfo:e,amount:t,slippage:n,baseIn:i}){let o=new Bt(new v(t).mul(10**e[i?"mintA":"mintB"].decimals).toFixed(0)),s=ra(e[i?"mintB":"mintA"]),[a,u]=[new Bt(new v(e.mintAmountA).mul(10**e.mintA.decimals).toString()),new Bt(new v(e.mintAmountB).mul(10**e.mintB.decimals).toString())];this.logDebug("baseReserve:",a.toString(),"quoteReserve:",u.toString()),this.logDebug("tokenIn:",i?e.mintA.symbol:e.mintB.symbol,"amountIn:",o.toString(),"anotherToken:",i?e.mintB.symbol:e.mintA.symbol,"slippage:",`${n.toSignificant()}%`);let c=i?"base":"quote";this.logDebug("input side:",c);let l=je;o.isZero()||(l=c==="base"?Cr(o.mul(u),a):Cr(o.mul(a),u));let m=Cr(o.mul(new Bt(e.lpAmount).mul(new Bt(10).pow(new Bt(e.lpMint.decimals)))),new Bt(c==="base"?e.mintAmountA:e.mintAmountB).mul(new Bt(10).pow(new Bt(e[c==="base"?"mintA":"mintB"].decimals)))),d=new et(Sr).add(n).mul(l).quotient,y=new ge(s,l),f=new ge(s,d);return this.logDebug("anotherAmount:",y.toFixed(),"maxAnotherAmount:",f.toFixed()),{anotherAmount:y,maxAnotherAmount:f,liquidity:m}}async addLiquidity(e){let{poolInfo:t,amountInA:n,amountInB:i,fixedSide:o,config:s,txVersion:a}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region");let u=this.scope.mintToTokenAmount({mint:vt(t.mintA.address),amount:n.toString()}),c=this.scope.mintToTokenAmount({mint:vt(t.mintB.address),amount:i.toString()});this.logDebug("amountInA:",u,"amountInB:",c),(u.isZero()||c.isZero())&&this.logAndCreateError("amounts must greater than zero","amountInA & amountInB",{amountInA:u.toFixed(),amountInB:c.toFixed()});let{account:l}=this.scope,{bypassAssociatedCheck:m,checkCreateATAOwner:p}=M({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},s),[d,y]=[u.token,c.token],f=await l.getCreatedTokenAccount({mint:d.mint,associatedOnly:!1}),b=await l.getCreatedTokenAccount({mint:y.mint,associatedOnly:!1});!f&&!b&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",l.tokenAccounts);let w=await l.getCreatedTokenAccount({mint:new Qt(t.lpMint.address)}),h=[d,y],A=[f,b],P=[u.raw,c.raw],T=u.token.mint.toBase58()===t.mintA.address?"base":"quote",I="base";["quote","base"].includes(T)||this.logAndCreateError("invalid fixedSide","fixedSide",o),T==="quote"?(h.reverse(),A.reverse(),P.reverse(),I=o==="a"?"quote":"base"):T==="base"&&(I=o==="a"?"base":"quote");let[x,O]=h,[N,L]=A,[E,Z]=P,W=await this.scope.api.fetchPoolKeysById({id:t.id}),ee=this.createTxBuilder(),fr=await l.handleTokenAccount({side:"in",amount:E,mint:x.mint,tokenAccount:N,bypassAssociatedCheck:m,checkCreateATAOwner:p}),{tokenAccount:Q}=fr,te=Ne(fr,["tokenAccount"]);ee.addInstruction(te);let Bn=await l.handleTokenAccount({side:"in",amount:Z,mint:O.mint,tokenAccount:L,bypassAssociatedCheck:m,checkCreateATAOwner:p}),{tokenAccount:at}=Bn,ii=Ne(Bn,["tokenAccount"]);ee.addInstruction(ii);let Sn=await l.handleTokenAccount({side:"out",amount:0,mint:new Qt(t.lpMint.address),tokenAccount:w,bypassAssociatedCheck:m,checkCreateATAOwner:p}),{tokenAccount:oi}=Sn,jt=Ne(Sn,["tokenAccount"]);return ee.addInstruction(jt),ee.addInstruction({instructions:[ua({poolInfo:t,poolKeys:W,userKeys:{baseTokenAccount:Q,quoteTokenAccount:at,lpTokenAccount:oi,owner:this.scope.ownerPubKey},baseAmountIn:E,quoteAmountIn:Z,fixedSide:I})],instructionTypes:[t.pooltype.includes("StablePool")?_.AmmV5AddLiquidity:_.AmmV4AddLiquidity],lookupTableAddress:W.lookupTableAccount?[W.lookupTableAccount]:[]}),a===0&&await ee.buildV0(),ee.build()}async removeLiquidity(e){this.scope.availability.removeStandardPosition===!1&&this.logAndCreateError("remove liquidity feature disabled in your region");let{poolInfo:t,amountIn:n,config:i,txVersion:o}=e,s=await this.scope.api.fetchPoolKeysById({id:t.id}),[a,u,c]=[new Qt(t.mintA.address),new Qt(t.mintB.address),new Qt(t.lpMint.address)];this.logDebug("amountIn:",n),n.isZero()&&this.logAndCreateError("amount must greater than zero","amountIn",n.toString());let{account:l}=this.scope,m=await l.getCreatedTokenAccount({mint:c,associatedOnly:!1});m||this.logAndCreateError("cannot found lpTokenAccount","tokenAccounts",l.tokenAccounts);let p=await l.getCreatedTokenAccount({mint:a}),d=await l.getCreatedTokenAccount({mint:u}),y=this.createTxBuilder(),{bypassAssociatedCheck:f,checkCreateATAOwner:b}=M({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},i),T=await l.handleTokenAccount({side:"out",amount:0,mint:a,tokenAccount:p,bypassAssociatedCheck:f,checkCreateATAOwner:b}),{tokenAccount:w}=T,h=Ne(T,["tokenAccount"]);y.addInstruction(h);let I=await l.handleTokenAccount({side:"out",amount:0,mint:u,tokenAccount:d,bypassAssociatedCheck:f,checkCreateATAOwner:b}),{tokenAccount:A}=I,P=Ne(I,["tokenAccount"]);return y.addInstruction(P),y.addInstruction({instructions:[mo({poolInfo:t,poolKeys:s,userKeys:{lpTokenAccount:m,baseTokenAccount:w,quoteTokenAccount:A,owner:this.scope.ownerPubKey},amountIn:n})],lookupTableAddress:s.lookupTableAccount?[s.lookupTableAccount]:[],instructionTypes:[t.pooltype.includes("StablePool")?_.AmmV5RemoveLiquidity:_.AmmV4RemoveLiquidity]}),o===0?await y.buildV0():y.build()}async removeAllLpAndCreateClmmPosition({poolInfo:e,clmmPoolInfo:t,removeLpAmount:n,createPositionInfo:i,farmInfo:o,userFarmLpAmount:s,base:a,computeBudgetConfig:u,payer:c,tokenProgram:l=ei,checkCreateATAOwner:m=!0,getEphemeralSigners:p,txVersion:d}){if((this.scope.availability.removeStandardPosition===!1||this.scope.availability.createConcentratedPosition===!1)&&this.logAndCreateError("remove liquidity or create position feature disabled in your region"),!(e.mintA.address===t.mintA.address||e.mintA.address===t.mintB.address)||!(e.mintB.address===t.mintA.address||e.mintB.address===t.mintB.address))throw Error("mint check error");let y=this.createTxBuilder();y.addCustomComputeBudget(u);let f={};for(let ee of this.scope.account.tokenAccountRawInfos)(f[ee.accountInfo.mint.toString()]===void 0||we(this.scope.ownerPubKey,ee.accountInfo.mint,ei).publicKey.equals(ee.pubkey))&&(f[ee.accountInfo.mint.toString()]=ee.pubkey);let b=f[e.lpMint.address];if(b===void 0)throw Error("find lp account error in trade accounts");let w=n.add(s!=null?s:new Bt(0)),h=e.mintA.address===ce.WSOL.mint.toString(),A=e.mintB.address===ce.WSOL.mint.toString(),{account:P,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:ei,mint:new Qt(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:h?{payer:this.scope.ownerPubKey}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:!0,checkCreateATAOwner:m});if(y.addInstruction(T||{}),P===void 0)throw new Error("base token account not found");let{account:I,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:ei,mint:new Qt(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:A?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!A,notUseTokenAccount:A,associatedOnly:!0,checkCreateATAOwner:m});if(y.addInstruction(x||{}),I===void 0)throw new Error("quote token account not found");if(f[e.mintA.address]=P,f[e.mintB.address]=I,o!==void 0&&!(s!=null&&s.isZero())){let ee=[];for(let jt of o.rewardInfos){let fr=jt.mint.address===ce.WSOL.mint.toString();if(f[jt.mint.address])ee.push(f[jt.mint.address]);else{let{account:Bn,instructionParams:Sn}=await this.scope.account.getOrCreateTokenAccount({mint:new Qt(jt.mint.address),tokenProgram:l,owner:this.scope.ownerPubKey,skipCloseAccount:!fr,createInfo:{payer:c||this.scope.ownerPubKey},associatedOnly:!0,checkCreateATAOwner:m});Bn||this.logAndCreateError("farm reward account not found:",jt.mint.address),Sn&&y.addInstruction(Sn),ee.push(Bn)}}let Q=(await this.scope.api.fetchFarmKeysById({ids:o.id}))[0],te={amount:s,owner:this.scope.ownerPubKey,farmInfo:o,farmKeys:Q,lpAccount:b,rewardAccounts:ee},at=pt[o.programId],ii=at===6?jn(te):at===5?Hn(te):Zn(te),oi={3:_.FarmV3Withdraw,5:_.FarmV5Withdraw,6:_.FarmV6Withdraw};y.addInstruction({instructions:[ii],instructionTypes:[oi[at]]})}let O=await this.scope.api.fetchPoolKeysById({id:e.id}),N=mo({poolInfo:e,poolKeys:O,userKeys:{lpTokenAccount:b,baseTokenAccount:P,quoteTokenAccount:I,owner:this.scope.ownerPubKey},amountIn:w});y.addInstruction({instructions:[N],instructionTypes:[e.pooltype.includes("StablePool")?_.AmmV5RemoveLiquidity:_.AmmV4RemoveLiquidity],lookupTableAddress:O.lookupTableAccount?[O.lookupTableAccount]:[]});let[L,E]=e.mintA.address===t.mintA.address?[P,I]:[I,P],Z=await this.scope.api.fetchPoolKeysById({id:t.id}),W=await Pe.openPositionFromBaseInstructions(D(M({poolInfo:t,poolKeys:Z,ownerInfo:{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:L,tokenAccountB:E},withMetadata:"create"},i),{base:a,getEphemeralSigners:p}));return y.addInstruction({instructions:[...W.instructions],signers:W.signers,instructionTypes:[...W.instructionTypes],lookupTableAddress:Z.lookupTableAccount?[Z.lookupTableAccount]:[]}),d===0?y.sizeCheckBuildV0():y.sizeCheckBuild()}async createPoolV4({programId:e,marketInfo:t,baseMintInfo:n,quoteMintInfo:i,baseAmount:o,quoteAmount:s,startTime:a,ownerInfo:u,associatedOnly:c=!1,checkCreateATAOwner:l=!1,tokenProgram:m,txVersion:p,feeDestinationId:d,computeBudgetConfig:y}){var E;let f=u.feePayer||((E=this.scope.owner)==null?void 0:E.publicKey),b=u.useSOLBalance&&n.mint.equals(Ma),w=u.useSOLBalance&&i.mint.equals(Ma),h=this.createTxBuilder(),{account:A,instructionParams:P}=await this.scope.account.getOrCreateTokenAccount({mint:n.mint,owner:this.scope.ownerPubKey,createInfo:b?{payer:f,amount:o}:void 0,notUseTokenAccount:b,skipCloseAccount:!b,associatedOnly:b?!1:c,checkCreateATAOwner:l});h.addInstruction(P||{});let{account:T,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({mint:i.mint,owner:this.scope.ownerPubKey,createInfo:w?{payer:f,amount:s}:void 0,notUseTokenAccount:w,skipCloseAccount:!w,associatedOnly:w?!1:c,checkCreateATAOwner:l});if(h.addInstruction(I||{}),A===void 0||T===void 0)throw Error("you don't has some token account");let x=Na({version:4,marketVersion:3,marketId:t.marketId,baseMint:n.mint,quoteMint:i.mint,baseDecimals:n.decimals,quoteDecimals:i.decimals,programId:e,marketProgramId:t.programId}),O={programId:e,ammId:x.id,ammAuthority:x.authority,ammOpenOrders:x.openOrders,lpMint:x.lpMint,coinMint:x.baseMint,pcMint:x.quoteMint,coinVault:x.baseVault,pcVault:x.quoteVault,withdrawQueue:x.withdrawQueue,ammTargetOrders:x.targetOrders,poolTempLp:x.lpVault,marketProgramId:x.marketProgramId,marketId:x.marketId,ammConfigId:x.configId,feeDestinationId:d},{instruction:N,instructionType:L}=ca(D(M({},O),{userWallet:this.scope.ownerPubKey,userCoinVault:A,userPcVault:T,userLpVault:we(this.scope.ownerPubKey,x.lpMint,m).publicKey,nonce:x.nonce,openTime:a,coinAmount:o,pcAmount:s}));return h.addInstruction({instructions:[N],instructionTypes:[L]}),h.addCustomComputeBudget(y),h.versionBuild({txVersion:p,extInfo:{address:O}})}async getCreatePoolFee({programId:e}){let t=Po({programId:e}),n=await this.scope.connection.getAccountInfo(t,{dataSlice:{offset:536,length:8}});if(n===null)throw Error("get config account error");return ia.decode(n.data).fee}};import{PublicKey as ue}from"@solana/web3.js";import it from"bn.js";var ur=class extends Te{constructor(e){super(e)}async load(e){await this.scope.token.load(e)}async createPool(e){var h;let{programId:t,owner:n=((h=this.scope.owner)==null?void 0:h.publicKey)||ue.default,mint1:i,mint2:o,ammConfig:s,initialPrice:a,startTime:u,computeBudgetConfig:c,forerunCreate:l,txVersion:m}=e,p=this.createTxBuilder(),[d,y,f]=new it(new ue(i.address).toBuffer()).gt(new it(new ue(o.address).toBuffer()))?[o,i,new v(1).div(a)]:[i,o,a],b=j.priceToSqrtPriceX64(f,d.decimals,y.decimals),w=await Pe.createPoolInstructions({connection:this.scope.connection,programId:t,owner:n,mintA:d,mintB:y,ammConfigId:s.id,initialPriceX64:b,startTime:u,forerunCreate:l});return p.addInstruction(w),p.addCustomComputeBudget(c),p.versionBuild({txVersion:m,extInfo:{address:D(M({},w.address),{programId:t.toString(),id:w.address.poolId.toString(),mintA:d,mintB:y,openTime:u.toNumber(),vault:{A:w.address.mintAVault.toString(),B:w.address.mintBVault.toString()},rewardInfos:[],config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]}}),mockPoolInfo:M({type:"Concentrated",rewardDefaultPoolInfos:"Clmm",id:w.address.poolId.toString(),mintA:d,mintB:y,feeRate:s.tradeFeeRate,openTime:u.toNumber(),programId:t.toString(),price:f.toNumber(),config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]}},Ta),forerunCreate:l}})}async openPositionFromBase({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:o,base:s,baseAmount:a,otherAmountMax:u,associatedOnly:c=!0,checkCreateATAOwner:l=!1,withMetadata:m="create",getEphemeralSigners:p,computeBudgetConfig:d,txVersion:y}){this.scope.availability.addConcentratedPosition===!1&&this.logAndCreateError("add position feature disabled in your region"),this.scope.checkOwner();let f=this.createTxBuilder(),b=null,w=null,h=n.useSOLBalance&&e.mintA.address===$.toString(),A=n.useSOLBalance&&e.mintB.address===$.toString(),[P,T]=s==="MintA"?[a,u]:[u,a],{account:I,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new ue(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:h||P.isZero()?{payer:this.scope.ownerPubKey,amount:P}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:h?!1:c,checkCreateATAOwner:l});I&&(b=I),f.addInstruction(x||{});let{account:O,instructionParams:N}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new ue(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:A||T.isZero()?{payer:this.scope.ownerPubKey,amount:T}:void 0,skipCloseAccount:!A,notUseTokenAccount:A,associatedOnly:A?!1:c,checkCreateATAOwner:l});O&&(w=O),f.addInstruction(N||{}),(!b||!w)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let L=t||await this.scope.api.fetchPoolKeysById({id:e.id}),E=await Pe.openPositionFromBaseInstructions({poolInfo:e,poolKeys:L,ownerInfo:D(M({},n),{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:w}),tickLower:i,tickUpper:o,base:s,baseAmount:a,otherAmountMax:u,withMetadata:m,getEphemeralSigners:p});return f.addInstruction(E),f.addCustomComputeBudget(d),f.versionBuild({txVersion:y,extInfo:E.address})}async openPositionFromLiquidity({poolInfo:e,poolKeys:t,ownerInfo:n,amountMaxA:i,amountMaxB:o,tickLower:s,tickUpper:a,liquidity:u,associatedOnly:c=!0,checkCreateATAOwner:l=!1,withMetadata:m="create",txVersion:p,getEphemeralSigners:d}){this.scope.availability.createConcentratedPosition===!1&&this.logAndCreateError("open position feature disabled in your region");let y=this.createTxBuilder(),f=null,b=null,w=n.useSOLBalance&&e.mintA.address===$.toBase58(),h=n.useSOLBalance&&e.mintB.address===$.toBase58(),{account:A,instructionParams:P}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new ue(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:w?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!w,notUseTokenAccount:w,associatedOnly:w?!1:c,checkCreateATAOwner:l});A&&(f=A),y.addInstruction(P||{});let{account:T,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new ue(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:h?{payer:this.scope.ownerPubKey,amount:o}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:h?!1:c,checkCreateATAOwner:l});T&&(b=T),y.addInstruction(I||{}),(f===void 0||b===void 0)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let x=t||await this.scope.api.fetchPoolKeysById({id:e.id}),O=await Pe.openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:x,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:f,tokenAccountB:b},tickLower:s,tickUpper:a,liquidity:u,amountMaxA:i,amountMaxB:o,withMetadata:m,getEphemeralSigners:d});return y.addInstruction(O),y.versionBuild({txVersion:p,extInfo:{address:O.address}})}async increasePositionFromLiquidity(e){let{poolInfo:t,ownerPosition:n,amountMaxA:i,amountMaxB:o,liquidity:s,ownerInfo:a,associatedOnly:u=!0,checkCreateATAOwner:c=!1,computeBudgetConfig:l,txVersion:m}=e,p=this.createTxBuilder(),d,y,f=a.useSOLBalance&&t.mintA.address===$.toString(),b=a.useSOLBalance&&t.mintB.address===$.toString(),{account:w,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new ue(t.mintA.address),notUseTokenAccount:f,owner:this.scope.ownerPubKey,createInfo:f?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!f,associatedOnly:f?!1:u,checkCreateATAOwner:c});w&&(d=w),p.addInstruction(h||{});let{account:A,instructionParams:P}=await this.scope.account.getOrCreateTokenAccount({mint:new ue(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:b?{payer:this.scope.ownerPubKey,amount:o}:void 0,notUseTokenAccount:b,skipCloseAccount:!b,associatedOnly:b?!1:u,checkCreateATAOwner:c});A&&(y=A),p.addInstruction(P||{}),!d&&!y&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let T=await this.scope.api.fetchPoolKeysById({id:t.id}),I=Pe.increasePositionFromLiquidityInstructions({poolInfo:t,poolKeys:T,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:d,tokenAccountB:y},liquidity:s,amountMaxA:i,amountMaxB:o});return p.addInstruction(I),p.addCustomComputeBudget(l),p.versionBuild({txVersion:m,extInfo:{address:I.address}})}async increasePositionFromBase(e){let{poolInfo:t,ownerPosition:n,base:i,baseAmount:o,otherAmountMax:s,ownerInfo:a,associatedOnly:u=!0,checkCreateATAOwner:c=!1,computeBudgetConfig:l,txVersion:m}=e,p=this.createTxBuilder(),d,y,f=a.useSOLBalance&&t.mintA.address===$.toString(),b=a.useSOLBalance&&t.mintB.address===$.toString(),{account:w,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new ue(t.mintA.address),notUseTokenAccount:f,owner:this.scope.ownerPubKey,createInfo:f?{payer:this.scope.ownerPubKey,amount:i==="MintA"?o:s}:void 0,skipCloseAccount:!f,associatedOnly:f?!1:u,checkCreateATAOwner:c});w&&(d=w),p.addInstruction(h||{});let{account:A,instructionParams:P}=await this.scope.account.getOrCreateTokenAccount({mint:new ue(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:b?{payer:this.scope.ownerPubKey,amount:i==="MintA"?s:o}:void 0,notUseTokenAccount:b,skipCloseAccount:!b,associatedOnly:b?!1:u,checkCreateATAOwner:c});A&&(y=A),p.addInstruction(P||{}),!d&&!y&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let T=await this.scope.api.fetchPoolKeysById({id:t.id}),I=Pe.increasePositionFromBaseInstructions({poolInfo:t,poolKeys:T,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:d,tokenAccountB:y},base:i,baseAmount:o,otherAmountMax:s});return p.addInstruction(I),p.addCustomComputeBudget(l),p.versionBuild({txVersion:m,extInfo:{address:I.address}})}async decreaseLiquidity(e){let{poolInfo:t,ownerPosition:n,ownerInfo:i,amountMinA:o,amountMinB:s,liquidity:a,associatedOnly:u=!0,checkCreateATAOwner:c=!1,computeBudgetConfig:l,txVersion:m}=e;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let p=this.createTxBuilder(),d=i.useSOLBalance&&t.mintA.address===$.toString(),y=i.useSOLBalance&&t.mintB.address===$.toString(),f,b,{account:w,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new ue(t.mintA.address),notUseTokenAccount:d,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!d,associatedOnly:d?!1:u,checkCreateATAOwner:c});f=w,h&&p.addInstruction(h);let{account:A,instructionParams:P}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new ue(t.mintB.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!y,associatedOnly:y?!1:u,checkCreateATAOwner:c});b=A,P&&p.addInstruction(P);let T=[];for(let N of t.rewardDefaultInfos){let L=i.useSOLBalance&&N.mint.address===$.toString(),E;if(N.mint.address===t.mintA.address)E=f;else if(N.mint.address===t.mintB.address)E=b;else{let{account:Z,instructionParams:W}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ue(N.mint.programId),mint:new ue(N.mint.address),notUseTokenAccount:L,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!L,associatedOnly:L?!1:u,checkCreateATAOwner:c});E=Z,W&&p.addInstruction(W)}T.push(E)}!f&&!b&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccountRawInfos);let I=await this.scope.api.fetchPoolKeysById({id:t.id}),x=await Pe.decreaseLiquidityInstructions({poolInfo:t,poolKeys:I,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:f,tokenAccountB:b,rewardAccounts:T},liquidity:a,amountMinA:o,amountMinB:s});p.addInstruction({instructions:x.instructions,instructionTypes:[_.ClmmDecreasePosition]});let O=M({},x.address);if(i.closePosition){let N=await Pe.closePositionInstructions({poolInfo:t,poolKeys:I,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:n});p.addInstruction({endInstructions:N.instructions,endInstructionTypes:N.instructionTypes}),O=M(M({},O),N.address)}return p.addCustomComputeBudget(l),p.versionBuild({txVersion:m,extInfo:{address:O}})}async closePosition({poolInfo:e,ownerPosition:t,txVersion:n}){this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let i=this.createTxBuilder(),o=await this.scope.api.fetchPoolKeysById({id:e.id}),s=Pe.closePositionInstructions({poolInfo:e,poolKeys:o,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:t});return i.addInstruction(s).versionBuild({txVersion:n,extInfo:{address:s.address}})}async initReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:i=!0,checkCreateATAOwner:o=!1,computeBudgetConfig:s,txVersion:a}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let u=this.createTxBuilder(),c=t.useSOLBalance&&n.mint.address.toString()===$.toString(),l=n.perSecond.mul(n.endTime-n.openTime),{account:m,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ue(n.mint.address),mint:new ue(n.mint.address),notUseTokenAccount:!!c,skipCloseAccount:!c,owner:this.scope.ownerPubKey,createInfo:c?{payer:t.feePayer||this.scope.ownerPubKey,amount:new it(new v(l.toFixed(0)).gte(l)?l.toFixed(0):l.add(1).toFixed(0))}:void 0,associatedOnly:c?!1:i,checkCreateATAOwner:o});p&&u.addInstruction(p),m||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let d=await this.scope.api.fetchPoolKeysById({id:e.id}),y=Pe.initRewardInstructions({poolInfo:e,poolKeys:d,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:m},rewardInfo:{programId:new ue(n.mint.programId),mint:new ue(n.mint.address),openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:H.decimalToX64(n.perSecond)}});return u.addInstruction(y),u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:y.address}})}async initRewards({poolInfo:e,ownerInfo:t,rewardInfos:n,associatedOnly:i=!0,checkCreateATAOwner:o=!1,computeBudgetConfig:s,txVersion:a}){for(let l of n)l.endTime<=l.openTime&&this.logAndCreateError("reward time error","rewardInfo",l);let u=this.createTxBuilder(),c={};for(let l of n){let m=t.useSOLBalance&&l.mint.address===$.toString(),p=l.perSecond.mul(l.endTime-l.openTime),{account:d,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ue(l.mint.programId),mint:new ue(l.mint.address),notUseTokenAccount:!!m,skipCloseAccount:!m,owner:this.scope.ownerPubKey,createInfo:m?{payer:t.feePayer||this.scope.ownerPubKey,amount:new it(new v(p.toFixed(0)).gte(p)?p.toFixed(0):p.add(1).toFixed(0))}:void 0,associatedOnly:m?!1:i,checkCreateATAOwner:o});y&&u.addInstruction(y),d||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let f=await this.scope.api.fetchPoolKeysById({id:e.id}),b=Pe.initRewardInstructions({poolInfo:e,poolKeys:f,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:d},rewardInfo:{programId:new ue(l.mint.programId),mint:new ue(l.mint.address),openTime:l.openTime,endTime:l.endTime,emissionsPerSecondX64:H.decimalToX64(l.perSecond)}});c=M(M({},c),b.address),u.addInstruction(b)}return u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:c}})}async setReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:i=!0,checkCreateATAOwner:o=!1,computeBudgetConfig:s,txVersion:a}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let u=this.createTxBuilder(),c=t.useSOLBalance&&n.mint.equals($),{account:l,instructionParams:m}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:n.programId,mint:n.mint,notUseTokenAccount:c,owner:this.scope.ownerPubKey,createInfo:c?{payer:t.feePayer||this.scope.ownerPubKey,amount:new it(new v(n.perSecond.sub(n.endTime-n.openTime).toFixed(0)).gte(n.perSecond.sub(n.endTime-n.openTime))?n.perSecond.sub(n.endTime-n.openTime).toFixed(0):n.perSecond.sub(n.endTime-n.openTime).add(1).toFixed(0))}:void 0,associatedOnly:c?!1:i,checkCreateATAOwner:o});m&&u.addInstruction(m),l||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let p=await this.scope.api.fetchPoolKeysById({id:e.id}),d=Pe.setRewardInstructions({poolInfo:e,poolKeys:p,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:l},rewardInfo:{mint:n.mint,openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:H.decimalToX64(n.perSecond)}});return u.addInstruction(d),u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:d.address}})}async setRewards({poolInfo:e,ownerInfo:t,rewardInfos:n,associatedOnly:i=!0,checkCreateATAOwner:o=!1,computeBudgetConfig:s,txVersion:a}){let u=this.createTxBuilder(),c={};for(let l of n){l.endTime<=l.openTime&&this.logAndCreateError("reward time error","rewardInfo",l);let m=t.useSOLBalance&&l.mint.address===$.toString(),{account:p,instructionParams:d}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ue(l.mint.programId),mint:new ue(l.mint.address),notUseTokenAccount:m,owner:this.scope.ownerPubKey,createInfo:m?{payer:t.feePayer||this.scope.ownerPubKey,amount:new it(new v(l.perSecond.sub(l.endTime-l.openTime).toFixed(0)).gte(l.perSecond.sub(l.endTime-l.openTime))?l.perSecond.sub(l.endTime-l.openTime).toFixed(0):l.perSecond.sub(l.endTime-l.openTime).add(1).toFixed(0))}:void 0,associatedOnly:m?!1:i,checkCreateATAOwner:o});d&&u.addInstruction(d),p||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let y=await this.scope.api.fetchPoolKeysById({id:e.id}),f=Pe.setRewardInstructions({poolInfo:e,poolKeys:y,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:p},rewardInfo:{mint:new ue(l.mint.address),openTime:l.openTime,endTime:l.endTime,emissionsPerSecondX64:H.decimalToX64(l.perSecond)}});u.addInstruction(f),c=M(M({},c),f.address)}return u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:c}})}async collectReward({poolInfo:e,ownerInfo:t,rewardMint:n,associatedOnly:i=!0,checkCreateATAOwner:o=!1}){let s=e.rewardDefaultInfos.find(d=>d.mint.address===n.toString());s||this.logAndCreateError("reward mint error","not found reward mint",n);let a=this.createTxBuilder(),u=t.useSOLBalance&&n.equals($),{account:c,instructionParams:l}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ue(s.mint.programId),mint:n,notUseTokenAccount:u,owner:this.scope.ownerPubKey,skipCloseAccount:!u,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:u?!1:i,checkCreateATAOwner:o});l&&a.addInstruction(l),c||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let m=await this.scope.api.fetchPoolKeysById({id:e.id}),p=Pe.collectRewardInstructions({poolInfo:e,poolKeys:m,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:c},rewardMint:n});return a.addInstruction(p),a.build({address:p.address})}async collectRewards({poolInfo:e,ownerInfo:t,rewardMints:n,associatedOnly:i=!0,checkCreateATAOwner:o=!1}){let s=this.createTxBuilder(),a={};for(let u of n){let c=e.rewardDefaultInfos.find(f=>f.mint.address===u.toString());if(!c){this.logAndCreateError("reward mint error","not found reward mint",u);continue}let l=t.useSOLBalance&&u.equals($),{account:m,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ue(c.mint.programId),mint:u,notUseTokenAccount:l,owner:this.scope.ownerPubKey,skipCloseAccount:!l,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:l?!1:i,checkCreateATAOwner:o});m||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos),p&&s.addInstruction(p);let d=await this.scope.api.fetchPoolKeysById({id:e.id}),y=Pe.collectRewardInstructions({poolInfo:e,poolKeys:d,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:m},rewardMint:u});s.addInstruction(y),a=M(M({},a),y.address)}return s.build({address:a})}async harvestAllRewards({allPoolInfo:e,allPositions:t,ownerInfo:n,associatedOnly:i=!0,checkCreateATAOwner:o=!1,programId:s,txVersion:a,computeBudgetConfig:u}){let c={};for(let m of this.scope.account.tokenAccountRawInfos)i?we(this.scope.ownerPubKey,m.accountInfo.mint,s).publicKey.equals(m.pubkey)&&(c[m.accountInfo.mint.toString()]=m.pubkey):c[m.accountInfo.mint.toString()]=m.pubkey;let l=this.createTxBuilder();l.addCustomComputeBudget(u);for(let m of Object.values(e)){if(t[m.id]===void 0||!t[m.id].find(A=>!A.liquidity.isZero()||A.rewardInfos.find(P=>!P.rewardAmountOwed.isZero())))continue;let p=m,d=n.useSOLBalance&&p.mintA.address===$.toString(),y=n.useSOLBalance&&p.mintB.address===$.toString(),f=c[p.mintA.address];if(!f){let{account:A,instructionParams:P}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:p.mintA.programId,mint:new ue(p.mintA.address),notUseTokenAccount:d,owner:this.scope.ownerPubKey,skipCloseAccount:!0,createInfo:{payer:n.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:d?!1:i,checkCreateATAOwner:o});f=A,P&&l.addInstruction(P)}let b=c[p.mintB.address];if(!b){let{account:A,instructionParams:P}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:p.mintB.programId,mint:new ue(p.mintB.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,skipCloseAccount:!0,createInfo:{payer:n.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:y?!1:i,checkCreateATAOwner:o});b=A,P&&l.addInstruction(P)}c[p.mintA.address]=f,c[p.mintB.address]=b;let w=[];for(let A of p.rewardDefaultInfos){let P=n.useSOLBalance&&A.mint.address===$.toString(),T=c[A.mint.address];if(!T){let{account:I,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ue(A.mint.programId),mint:new ue(A.mint.address),notUseTokenAccount:P,owner:this.scope.ownerPubKey,skipCloseAccount:!P,createInfo:{payer:n.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:P?!1:i});T=I,x&&l.addInstruction(x)}c[A.mint.address]=T,w.push(T)}let h=await this.scope.api.fetchPoolKeysById({id:p.id});for(let A of t[m.id]){let P=Pe.decreaseLiquidityInstructions({poolInfo:p,poolKeys:h,ownerPosition:A,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:f,tokenAccountB:b,rewardAccounts:w},liquidity:new it(0),amountMinA:new it(0),amountMinB:new it(0)});l.addInstruction(P)}}return a===0?l.sizeCheckBuildV0():l.sizeCheckBuild()}async getWhiteListMint({programId:e}){let t=await this.scope.connection.getAccountInfo(tr(e).publicKey);return t?Sa.decode(t.data).whitelistMints.filter(i=>!i.equals(ue.default)):[]}async computeAmountIn({poolInfo:e,tickArrayCache:t,baseMint:n,token2022Infos:i,amountOut:o,slippage:s,priceLimit:a=new v(0)}){var I;let u=await this.scope.fetchEpochInfo(),c;a.equals(new v(0))?c=n.toString()===e.mintB.address?Tt.add(De):It.sub(De):c=j.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let l=wn(o,(I=i[n.toString()])==null?void 0:I.feeConfig,u,!0),{expectedAmountIn:m,remainingAccounts:p,executionPrice:d,feeAmount:y}=Ve.getInputAmountAndRemainAccounts(e,t,n,l.amount.sub(l.fee||new it(0)),c),f=j.sqrtPriceX64ToPrice(d,e.mintA.decimals,e.mintB.decimals),b=n.toString()===e.mintA.address?f:new v(1).div(f),w=m.mul(new it(Math.floor((1+s)*1e10))).div(new it(1e10)),h=e.mintA.address===n.toString()?e.price:new v(1).div(e.price),A=new v(b).sub(h).abs(),P=h,T=new et(new v(A).mul(10**15).toFixed(0),new v(P).mul(10**15).toFixed(0));return{amountIn:m,maxAmountIn:w,currentPrice:new v(e.price),executionPrice:b,priceImpact:T,fee:y,remainingAccounts:p}}};import{PublicKey as ym}from"@solana/web3.js";import{createTransferInstruction as bm}from"@solana/spl-token";import{TOKEN_PROGRAM_ID as xo,TOKEN_2022_PROGRAM_ID as To}from"@solana/spl-token";import{PublicKey as ot,TransactionInstruction as Bo,SystemProgram as Va}from"@solana/web3.js";import Io from"bn.js";function SP(r,e,t,n,i,o,s,a,u,c,l,m){let p=R([V("instruction"),g("amountIn"),g("amountOut")]),d=[{pubkey:Va.programId,isSigner:!1,isWritable:!1},{pubkey:xo,isSigner:!1,isWritable:!1},{pubkey:new ot(t.programId),isSigner:!1,isWritable:!1},{pubkey:new ot(t.id),isSigner:!1,isWritable:!0},{pubkey:new ot(n.id),isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!1}];if(e.type==="Concentrated"){let f=pe(t);d.push({pubkey:f.config.id,isSigner:!1,isWritable:!1},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.mintA.address.equals(u)?f.vault.A:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.mintA.address.equals(u)?f.vault.B:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0},...m.map(b=>({pubkey:b,isSigner:!1,isWritable:!0})))}else if(e.pooltype.includes("StablePool")){let f=pe(t);d.push({pubkey:f.authority,isSigner:!1,isWritable:!1},{pubkey:f.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:new ot("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:f.openOrders,isSigner:!1,isWritable:!0},{pubkey:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.marketId,isSigner:!1,isWritable:!0},{pubkey:f.marketBids,isSigner:!1,isWritable:!0},{pubkey:f.marketAsks,isSigner:!1,isWritable:!0},{pubkey:f.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0})}else{let f=pe(t);d.push({pubkey:f.authority,isSigner:!1,isWritable:!1},{pubkey:f.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:f.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:f.openOrders,isSigner:!1,isWritable:!0},{pubkey:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.marketId,isSigner:!1,isWritable:!0},{pubkey:f.marketBids,isSigner:!1,isWritable:!0},{pubkey:f.marketAsks,isSigner:!1,isWritable:!0},{pubkey:f.marketEventQueue,isSigner:!1,isWritable:!0},...f.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:f.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:f.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0}])}let y=Buffer.alloc(p.span);return p.encode({instruction:4,amountIn:c,amountOut:l},y),new Bo({keys:d,programId:r,data:y})}function KP(r,e,t,n,i,o,s,a,u,c){let l=R([V("instruction")]),m=[{pubkey:Va.programId,isSigner:!1,isWritable:!1},{pubkey:xo,isSigner:!1,isWritable:!1},{pubkey:new ot(String(n.programId)),isSigner:!1,isWritable:!1},{pubkey:new ot(String(n.id)),isSigner:!1,isWritable:!0},{pubkey:new ot(String(t.id)),isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!1}];if(e.type==="Concentrated"){let d=pe(n);m.push({pubkey:d.config.id,isSigner:!1,isWritable:!1},{pubkey:d.id,isSigner:!1,isWritable:!0},{pubkey:d.mintA.address.equals(u)?d.vault.A:d.vault.B,isSigner:!1,isWritable:!0},{pubkey:d.mintA.address.equals(u)?d.vault.B:d.vault.A,isSigner:!1,isWritable:!0},{pubkey:d.id,isSigner:!1,isWritable:!0},...c.map(y=>({pubkey:y,isSigner:!1,isWritable:!0})))}else if(e.pooltype.includes("StablePool")){let d=pe(n);m.push({pubkey:d.authority,isSigner:!1,isWritable:!1},{pubkey:d.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:d.id,isSigner:!1,isWritable:!0},{pubkey:new ot("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:d.openOrders,isSigner:!1,isWritable:!0},{pubkey:d.vault.A,isSigner:!1,isWritable:!0},{pubkey:d.vault.B,isSigner:!1,isWritable:!0},{pubkey:d.marketId,isSigner:!1,isWritable:!0},{pubkey:d.marketBids,isSigner:!1,isWritable:!0},{pubkey:d.marketAsks,isSigner:!1,isWritable:!0},{pubkey:d.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:d.id,isSigner:!1,isWritable:!0},{pubkey:d.id,isSigner:!1,isWritable:!0})}else{let d=pe(n);m.push({pubkey:d.authority,isSigner:!1,isWritable:!1},{pubkey:d.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:d.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:d.openOrders,isSigner:!1,isWritable:!0},{pubkey:d.vault.A,isSigner:!1,isWritable:!0},{pubkey:d.vault.B,isSigner:!1,isWritable:!0},{pubkey:d.marketId,isSigner:!1,isWritable:!0},{pubkey:d.marketBids,isSigner:!1,isWritable:!0},{pubkey:d.marketAsks,isSigner:!1,isWritable:!0},{pubkey:d.marketEventQueue,isSigner:!1,isWritable:!0},...d.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:d.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:d.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:d.id,isSigner:!1,isWritable:!0},{pubkey:d.id,isSigner:!1,isWritable:!0}])}let p=Buffer.alloc(l.span);return l.encode({instruction:5},p),new Bo({keys:m,programId:r,data:p})}function _a(r,e,t,n,i,o){if(r.pooltype.includes("StablePool")){let s=pe(e);return[{pubkey:s.programId,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s.id,isSigner:!1,isWritable:!0},{pubkey:s.authority,isSigner:!1,isWritable:!1},{pubkey:s.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:s.id,isSigner:!1,isWritable:!0},{pubkey:new ot("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:s.openOrders,isSigner:!1,isWritable:!0},{pubkey:s.vault.A,isSigner:!1,isWritable:!0},{pubkey:s.vault.B,isSigner:!1,isWritable:!0},{pubkey:s.marketId,isSigner:!1,isWritable:!0},{pubkey:s.marketBids,isSigner:!1,isWritable:!0},{pubkey:s.marketAsks,isSigner:!1,isWritable:!0},{pubkey:s.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:s.id,isSigner:!1,isWritable:!0},{pubkey:s.id,isSigner:!1,isWritable:!0}]}else if(r.type==="Concentrated"){let s=r,a=pe(e),u=s.mintA.address===t;return[{pubkey:new ot(String(r.programId)),isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:a.config.id,isSigner:!1,isWritable:!1},{pubkey:a.id,isSigner:!1,isWritable:!0},{pubkey:u?a.vault.A:a.vault.B,isSigner:!1,isWritable:!0},{pubkey:u?a.vault.B:a.vault.A,isSigner:!1,isWritable:!0},{pubkey:a.id,isSigner:!1,isWritable:!0},...a.mintA.programId.equals(To)||a.mintB.programId.equals(To)?[{pubkey:To,isSigner:!1,isWritable:!1},{pubkey:dn,isSigner:!1,isWritable:!1},{pubkey:u?a.mintA.address:a.mintB.address,isSigner:!1,isWritable:!1},{pubkey:u?a.mintB.address:a.mintA.address,isSigner:!1,isWritable:!1}]:[],...(o!=null?o:[]).map(c=>({pubkey:c,isSigner:!1,isWritable:!0})),{pubkey:ht(new ot(String(r.programId)),new ot(r.id)).publicKey,isSigner:!1,isWritable:!0}]}else{let s=pe(e);return[{pubkey:s.programId,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s.id,isSigner:!1,isWritable:!0},{pubkey:s.authority,isSigner:!1,isWritable:!1},{pubkey:s.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:s.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:s.openOrders,isSigner:!1,isWritable:!0},{pubkey:s.vault.A,isSigner:!1,isWritable:!0},{pubkey:s.vault.B,isSigner:!1,isWritable:!0},{pubkey:s.marketId,isSigner:!1,isWritable:!0},{pubkey:s.marketBids,isSigner:!1,isWritable:!0},{pubkey:s.marketAsks,isSigner:!1,isWritable:!0},{pubkey:s.marketEventQueue,isSigner:!1,isWritable:!0},...s.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:s.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:s.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:s.id,isSigner:!1,isWritable:!0},{pubkey:s.id,isSigner:!1,isWritable:!0}]]}}function fm(r,e,t,n,i,o,s,a,u,c,l,m,p,d){let y=R([V("instruction"),g("amountIn"),g("amountOut")]),f=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:xo,isSigner:!1,isWritable:!1}];f.push(..._a(a,c,o,t,n,d[0])),f.push(..._a(u,l,s,n,i,d[1]));let b=Buffer.alloc(y.span);return y.encode({instruction:8,amountIn:m,amountOut:p},b),new Bo({keys:f,programId:r,data:b})}async function Ea({routeProgram:r,ownerInfo:e,inputMint:t,swapInfo:n}){var i,o,s,a,u,c;if(n.routeType==="amm")if(n.poolInfo[0].type==="Concentrated"){let l=pe(n.poolKey[0]),m=t.equals(l.mintA.address)?Tt.add(De):It.sub(De);return await Pe.makeSwapBaseInInstructions({poolInfo:l,poolKeys:l,ownerInfo:{wallet:e.wallet,tokenAccountA:l.mintA.address.equals(t)?e.sourceToken:e.destinationToken,tokenAccountB:l.mintA.address.equals(t)?e.destinationToken:e.sourceToken},inputMint:t,amountIn:n.amountIn.amount.raw,amountOutMin:n.minAmountOut.amount.raw.sub((o=(i=n.minAmountOut.fee)==null?void 0:i.raw)!=null?o:new Io(0)),sqrtPriceLimitX64:m,remainingAccounts:n.remainingAccounts[0]})}else{let l=n.poolKey[0];return{signers:[],instructions:[la({poolKeys:l,version:n.poolInfo[0].pooltype.includes("StablePool")?5:4,userKeys:{tokenAccountIn:e.sourceToken,tokenAccountOut:e.destinationToken,owner:e.wallet},amountIn:n.amountIn.amount.raw,amountOut:n.minAmountOut.amount.raw.sub((a=(s=n.minAmountOut.fee)==null?void 0:s.raw)!=null?a:new Io(0)),fixedSide:"in"})],lookupTableAddress:l.lookupTableAccount?[l.lookupTableAccount]:[],instructionTypes:[n.poolInfo[0].pooltype.includes("StablePool")?_.AmmV5SwapBaseIn:_.AmmV4SwapBaseIn],address:{}}}else if(n.routeType==="route"){let l=n.poolInfo[0],m=n.poolInfo[1],p=n.poolKey[0],d=n.poolKey[1];if(e.routeToken===void 0)throw Error("owner route token account check error");return{signers:[],instructions:[fm(r,e.wallet,e.sourceToken,e.routeToken,e.destinationToken,t.toString(),n.minMiddleAmountFee.token.mint.toString(),l,m,p,d,n.amountIn.amount.raw,n.minAmountOut.amount.raw.sub((c=(u=n.minAmountOut.fee)==null?void 0:u.raw)!=null?c:new Io(0)),n.remainingAccounts)],instructionTypes:[_.RouteSwap],lookupTableAddress:[p.lookupTableAccount,d.lookupTableAccount].filter(y=>y!==void 0),address:{}}}else throw Error("route type error")}var cr=class extends Te{constructor(e){super(e)}static getAddLiquidityDefaultPool({addLiquidityPools:e,poolInfosCache:t}){if(e.length===0)return;if(e.length===1||(e.sort((i,o)=>o.version-i.version),e[0].version!==e[1].version))return e[0];let n=e.filter(i=>i.version===e[0].version);return n.sort((i,o)=>this.comparePoolSize(i,o,t)),n[0]}static comparePoolSize(e,t,n){let i=n[e.id],o=n[t.id];return i===void 0?1:o===void 0?-1:e.baseMint===t.baseMint?i.baseReserve.sub(o.baseReserve).gte(je)?-1:1:i.baseReserve.sub(o.quoteReserve).gte(je)?-1:1}async getWSolAccounts(){this.scope.checkOwner(),await this.scope.account.fetchWalletTokenAccounts();let e=this.scope.account.tokenAccounts.filter(t=>t.mint.equals($));return e.sort((t,n)=>t.isAssociated?1:n.isAssociated||t.amount.lt(n.amount)?-1:1),e}async unWrapWSol(e){let{amount:t,tokenProgram:n}=e,i=await this.getWSolAccounts(),o=this.createTxBuilder();o.addCustomComputeBudget(e.computeBudgetConfig);let s=await kt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:0});o.addInstruction(s);let a=X(t);for(let u=0;u<i.length;u++)a.gte(i[u].amount)?(o.addInstruction({instructions:[Lt({tokenAccount:i[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]}),a.sub(i[u].amount)):(o.addInstruction({instructions:[Lt({tokenAccount:i[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]}),Dn({destination:s.addresses.newAccount,source:i[u].publicKey,amount:a,owner:this.scope.ownerPubKey,tokenProgram:n}));return o.build()}async wrapWSol(e,t){let n=await this.getWSolAccounts(),i=this.createTxBuilder(),o=await kt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:e,skipCloseAccount:!0});return i.addInstruction(o),n.length&&i.addInstruction({instructions:[Dn({destination:n[0].publicKey,source:o.addresses.newAccount,amount:e,owner:this.scope.ownerPubKey,tokenProgram:t})],endInstructions:[Lt({tokenAccount:o.addresses.newAccount,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:t})]}),i.build()}async swap({swapInfo:e,associatedOnly:t,checkCreateATAOwner:n,checkTransaction:i,routeProgram:o=new ym("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS")}){let s=D(M({},e),{amountIn:this.scope.solToWsolTransferAmountFee(e.amountIn),amountOut:this.scope.solToWsolTransferAmountFee(e.amountOut),minAmountOut:this.scope.solToWsolTransferAmountFee(e.minAmountOut),middleMint:e.minMiddleAmountFee?vt(e.middleToken.mint):void 0}),a=s.amountIn,u=s.amountOut,c=a.amount.token.mint.equals(ce.WSOL.mint)||a.amount.token.mint.equals(de),l=u.amount.token.mint.equals(ce.WSOL.mint)||u.amount.token.mint.equals(de),m=a.amount.token.mint,p=s.middleMint,d=u.amount.token.mint,y=this.createTxBuilder(),{account:f,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({mint:m,notUseTokenAccount:c,createInfo:c?{payer:this.scope.ownerPubKey,amount:a.amount.raw}:void 0,owner:this.scope.ownerPubKey,skipCloseAccount:!c,associatedOnly:c?!1:t,checkCreateATAOwner:n});if(b&&y.addInstruction(b),f===void 0)throw Error("input account check error");let{account:w,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({mint:d,skipCloseAccount:!l,createInfo:{payer:this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,associatedOnly:t,checkCreateATAOwner:n});h&&y.addInstruction(h);let A;if(s.routeType==="route"){let Q=await this.scope.account.getOrCreateTokenAccount({mint:p,createInfo:{payer:this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,associatedOnly:!1,checkCreateATAOwner:n});A=Q.account,Q.instructionParams&&y.addInstruction(Q.instructionParams)}let P=await Ea({routeProgram:o,inputMint:m,swapInfo:s,ownerInfo:{wallet:this.scope.ownerPubKey,sourceToken:f,routeToken:A,destinationToken:w}}),T=s.feeConfig!==void 0?[bm(f,s.feeConfig.feeAccount,this.scope.ownerPubKey,s.feeConfig.feeAmount.toNumber())]:[],I=s.feeConfig!==void 0?[_.TransferAmount]:[],x=[],O=[],N=await y.getComputeBudgetConfig();if(N){let{instructions:Q,instructionTypes:te}=yn(N);x.push(...Q),O.push(...te)}let L=[],E=[...x,...T,...y.AllTxData.instructions,...P.instructions,...y.AllTxData.endInstructions],Z=[...O,...I,...y.AllTxData.instructionTypes,...P.instructionTypes,...y.AllTxData.endInstructionTypes],W=[...y.AllTxData.signers,...P.signers];if(i)if(Ct(E,[this.scope.ownerPubKey,...W.map(Q=>Q.publicKey)]))L.push(this.createTxBuilder().addInstruction({instructions:E,signers:W,instructionTypes:Z}));else{if(y.AllTxData.instructions.length>0&&L.push(this.createTxBuilder().addInstruction({instructions:y.AllTxData.instructions,signers:y.AllTxData.signers,instructionTypes:y.AllTxData.instructionTypes})),Ct([...x,...T,...P.instructions],[this.scope.ownerPubKey]))L.push(this.createTxBuilder().addInstruction({instructions:[...x,...T,...P.instructions],signers:P.signers,instructionTypes:[...O,...I,...P.instructionTypes]}));else if(Ct([...x,...P.instructions],[this.scope.ownerPubKey]))L.push(this.createTxBuilder().addInstruction({instructions:[...x,...P.instructions],signers:P.signers,instructionTypes:P.instructionTypes}));else if(Ct(P.instructions,[this.scope.ownerPubKey]))L.push(this.createTxBuilder().addInstruction({instructions:[...P.instructions],signers:P.signers,instructionTypes:P.instructionTypes}));else for(let Q=0;Q<P.instructions.length;Q++)L.push(this.createTxBuilder().addInstruction({instructions:[...x,P.instructions[Q]],signers:P.signers,instructionTypes:[...O,P.instructionTypes[Q]]}));y.AllTxData.endInstructions.length>0&&L.push(this.createTxBuilder().addInstruction({instructions:y.AllTxData.endInstructions,instructionTypes:y.AllTxData.endInstructionTypes}))}else s.routeType==="amm"?L.push(this.createTxBuilder().addInstruction({instructions:E,signers:W,instructionTypes:Z})):(y.AllTxData.instructions.length>0&&L.push(this.createTxBuilder().addInstruction({instructions:y.AllTxData.instructions,signers:y.AllTxData.signers,instructionTypes:y.AllTxData.instructionTypes})),L.push(this.createTxBuilder().addInstruction({instructions:P.instructions,signers:P.signers,instructionTypes:P.instructionTypes})),y.AllTxData.endInstructions.length>0&&L.push(this.createTxBuilder().addInstruction({instructions:y.AllTxData.endInstructions,instructionTypes:y.AllTxData.endInstructionTypes})));return L.shift().buildMultiTx({extraPreBuildData:L.map(Q=>Q.build())})}};import{TOKEN_PROGRAM_ID as gm}from"@solana/spl-token";import{PublicKey as wm,Transaction as So,TransactionInstruction as km}from"@solana/web3.js";import Fa from"bn.js";var Ue=class extends Te{static getPdaPoolId(e,t){return le([Ue.SEED_CONFIG.pool.id,t.toBuffer()],e)}static getPdaOwnerId(e,t,n,i){return le([Ue.SEED_CONFIG.owner.id,t.toBuffer(),n.toBuffer(),Buffer.from(new Fa(i).toArray())],e)}static async getAllInfo({connection:e,programId:t,poolIds:n,wallet:i,chainTime:o}){if(n.length===0)return[];let s=n.map(l=>Ue.getPdaPoolId(t,l).publicKey),a=[];for(let l=0;l<Ue.VERSION_PROJECT.length;l++)a.push(...s.map(m=>Ue.getPdaOwnerId(t,m,i,l).publicKey));let u=await gt(e,[...s,...a]),c=[];for(let l=0;l<u.length;l++){let m=Math.floor(l/n.length),p=l%n.length,d=s[p],y=a[l],f=u[p],b=u[n.length+l];if(!(f&&b)||f.data.length!==Ue.POOL_LAYOUT.span||b.data.length!==Ue.OWNER_LAYOUT.span)continue;let w=Ue.POOL_LAYOUT.decode(f.data),h=Ue.OWNER_LAYOUT.decode(b.data),A=w.openTime.toNumber(),P=w.endTime.toNumber(),T=h.tokenInfo.map(O=>O.debtAmount.gt(new Fa(0))).filter(O=>!O).length!==3,I=o>A&&o<P&&w.status===1,x=T&&I;c.push({programId:t,poolId:d,ammId:w.ammId,ownerAccountId:y,snapshotLpAmount:h.lpAmount,project:Ue.VERSION_PROJECT[m],openTime:A,endTime:P,canClaim:x,canClaimErrorType:T?I?void 0:"outOfOperationalTime":"alreadyClaimIt",tokenInfo:w.tokenInfo.map((O,N)=>({mintAddress:O.mintAddress,mintVault:O.mintVault,mintDecimals:O.mintDecimals,perLpLoss:O.perLpLoss,debtAmount:h.tokenInfo[N].debtAmount.add(h.tokenInfo[N].claimedAmount)}))})}return c}async makeClaimTransaction({poolInfo:e,ownerInfo:t}){t.wallet||this.scope.checkOwner();let n=this.createTxBuilder(),i=t.wallet||this.scope.ownerPubKey,o=[];for(let u of e.tokenInfo){let{account:c,instructionParams:l}=await this.scope.account.getOrCreateTokenAccount({mint:u.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:u.mintAddress.equals(ce.WSOL.mint),createInfo:{payer:i,amount:0},skipCloseAccount:!u.mintAddress.equals(ce.WSOL.mint),associatedOnly:u.mintAddress.equals(ce.WSOL.mint)?!1:t.associatedOnly});l&&n.addInstruction(l),o.push(c)}n.addInstruction({instructions:[Ue.makeClaimInstruction({programId:e.programId,poolInfo:e,ownerInfo:{wallet:i,ownerPda:e.ownerAccountId,claimAddress:o}})]});let{transaction:s,signers:a}=n.build();return[{transaction:s,signer:a}]}async makeClaimAllTransaction({poolInfos:e,ownerInfo:t}){let n=this.createTxBuilder(),i=t.wallet||this.scope.ownerPubKey,o={};for(let c of e){let l=[];for(let m of c.tokenInfo){let{account:p,instructionParams:d}=await this.scope.account.getOrCreateTokenAccount({mint:m.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:m.mintAddress.equals(ce.WSOL.mint),createInfo:{payer:i,amount:0},skipCloseAccount:!m.mintAddress.equals(ce.WSOL.mint),associatedOnly:m.mintAddress.equals(ce.WSOL.mint)?!1:t.associatedOnly});d&&n.addInstruction(d),p&&(o[m.mintAddress.toString()]=p,l.push(p))}n.addInstruction({instructions:[Ue.makeClaimInstruction({programId:c.programId,poolInfo:c,ownerInfo:{wallet:i,ownerPda:c.ownerAccountId,claimAddress:l}})]})}let{transaction:s,signers:a}=n.build(),u=n.allInstructions;return Ct(u,[i,...a.map(c=>c.publicKey)])?[{transaction:s,signer:a}]:[{transaction:new So().add(...u.slice(0,n.AllTxData.instructions.length-1)),signer:a},{transaction:new So().add(...u.slice(n.AllTxData.instructions.length-1)),signer:[]},{transaction:new So().add(...n.AllTxData.endInstructions),signer:[]}]}static makeClaimInstruction({programId:e,poolInfo:t,ownerInfo:n}){let i=R([]),o=[{pubkey:n.wallet,isSigner:!0,isWritable:!0},{pubkey:t.poolId,isSigner:!1,isWritable:!0},{pubkey:n.ownerPda,isSigner:!1,isWritable:!0},...n.claimAddress.map(u=>({pubkey:u,isSigner:!1,isWritable:!0})),...t.tokenInfo.map(({mintVault:u})=>({pubkey:u,isSigner:!1,isWritable:!0})),{pubkey:gm,isSigner:!1,isWritable:!1}],s=Buffer.alloc(i.span);i.encode({},s);let a=Buffer.from([10,66,208,184,161,6,191,98,...s]);return new km({keys:o,programId:e,data:a})}},st=Ue;st.CLAIMED_NUM=3,st.POOL_LAYOUT=R([ke(8),V("bump"),V("status"),g("openTime"),g("endTime"),B("ammId"),G(R([V("mintDecimals"),B("mintAddress"),B("mintVault"),g("perLpLoss"),g("totalClaimedAmount")]),Ue.CLAIMED_NUM,"tokenInfo"),G(g(),10,"padding")]),st.OWNER_LAYOUT=R([ke(8),V("bump"),V("version"),B("poolId"),B("owner"),g("lpAmount"),G(R([B("mintAddress"),g("debtAmount"),g("claimedAmount")]),Ue.CLAIMED_NUM,"tokenInfo"),G(g(),4,"padding")]),st.DEFAULT_POOL_ID=["58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2","6UmmUiYoBjSrhakAobJw8BvkmJtDVxaeBtbt7rxWo1mg","AVs9TA4nWDzfPJE9gGVNJMVhcQy3V9PGazuz33BfG2RA","DVa7Qmb5ct9RCpaU7UTpSaf3GVMYz17vNVU67XpdCRut","7XawhbbxtsRcQA8KTkHT9f9nc6d69UwqCDh6U5EEbEmX","6a1CsrpeZubDjEJE9s1CMVheB6HWM5d7m1cj2jkhyXhj","EoNrn8iUhwgJySD1pHu8Qxm5gSQqLK3za4m8xzD2RuEb","AceAyRTWt4PyB2pHqf2qhDgNZDtKVNaxgL8Ru3V4aN1P","6tmFJbMk5yVHFcFy7X2K8RwHjKLr6KVFLYXpgpBNeAxB"].map(e=>new wm(e)),st.SEED_CONFIG={pool:{id:Buffer.from("pool_seed","utf8")},owner:{id:Buffer.from("user_claim_seed","utf8")}},st.VERSION_PROJECT=[void 0,"Francium","Tulip","Larix"];import{PublicKey as Co}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Ua}from"@solana/spl-token";import lr from"bn.js";import{TransactionInstruction as hm,SYSVAR_RENT_PUBKEY as Pm}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as va}from"@solana/spl-token";import{createInitializeAccountInstruction as Wa}from"@solana/spl-token";import{SystemProgram as un,Transaction as Da}from"@solana/web3.js";function Am(r="accountFlags"){let e=new Wr(r);return e.addBoolean("initialized"),e.addBoolean("market"),e.addBoolean("openOrders"),e.addBoolean("requestQueue"),e.addBoolean("eventQueue"),e.addBoolean("bids"),e.addBoolean("asks"),e}var Ko=R([ke(5),Am("accountFlags"),B("ownAddress"),g("vaultSignerNonce"),B("baseMint"),B("quoteMint"),B("baseVault"),g("baseDepositsTotal"),g("baseFeesAccrued"),B("quoteVault"),g("quoteDepositsTotal"),g("quoteFeesAccrued"),g("quoteDustThreshold"),B("requestQueue"),B("eventQueue"),B("bids"),B("asks"),g("baseLotSize"),g("quoteLotSize"),g("feeRateBps"),g("referrerRebatesAccrued"),ke(7)]);function Tm({programId:r,marketInfo:e}){let t=R([V("version"),ve("instruction"),g("baseLotSize"),g("quoteLotSize"),Dt("feeRateBps"),g("vaultSignerNonce"),g("quoteDustThreshold")]),n=[{pubkey:e.id,isSigner:!1,isWritable:!0},{pubkey:e.requestQueue,isSigner:!1,isWritable:!0},{pubkey:e.eventQueue,isSigner:!1,isWritable:!0},{pubkey:e.bids,isSigner:!1,isWritable:!0},{pubkey:e.asks,isSigner:!1,isWritable:!0},{pubkey:e.baseVault,isSigner:!1,isWritable:!0},{pubkey:e.quoteVault,isSigner:!1,isWritable:!0},{pubkey:e.baseMint,isSigner:!1,isWritable:!1},{pubkey:e.quoteMint,isSigner:!1,isWritable:!1},{pubkey:e.authority?e.quoteMint:Pm,isSigner:!1,isWritable:!1}].concat(e.authority?{pubkey:e.authority,isSigner:!1,isWritable:!1}:[]).concat(e.authority&&e.pruneAuthority?{pubkey:e.pruneAuthority,isSigner:!1,isWritable:!1}:[]),i=Buffer.alloc(t.span);return t.encode({version:0,instruction:0,baseLotSize:e.baseLotSize,quoteLotSize:e.quoteLotSize,feeRateBps:e.feeRateBps,vaultSignerNonce:e.vaultSignerNonce,quoteDustThreshold:e.quoteDustThreshold},i),new hm({keys:n,programId:r,data:i})}async function qa({connection:r,wallet:e,marketInfo:t}){let n=new Da,i=await r.getMinimumBalanceForRentExemption(165);n.add(un.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.baseVault.seed,newAccountPubkey:t.baseVault.publicKey,lamports:i,space:165,programId:va}),un.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.quoteVault.seed,newAccountPubkey:t.quoteVault.publicKey,lamports:i,space:165,programId:va}),Wa(t.baseVault.publicKey,t.baseMint,t.vaultOwner),Wa(t.quoteVault.publicKey,t.quoteMint,t.vaultOwner));let o=new Da;return o.add(un.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.id.seed,newAccountPubkey:t.id.publicKey,lamports:await r.getMinimumBalanceForRentExemption(Ko.span),space:Ko.span,programId:t.programId}),un.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.requestQueue.seed,newAccountPubkey:t.requestQueue.publicKey,lamports:await r.getMinimumBalanceForRentExemption(5120+12),space:5120+12,programId:t.programId}),un.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.eventQueue.seed,newAccountPubkey:t.eventQueue.publicKey,lamports:await r.getMinimumBalanceForRentExemption(262144+12),space:262144+12,programId:t.programId}),un.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.bids.seed,newAccountPubkey:t.bids.publicKey,lamports:await r.getMinimumBalanceForRentExemption(65536+12),space:65536+12,programId:t.programId}),un.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.asks.seed,newAccountPubkey:t.asks.publicKey,lamports:await r.getMinimumBalanceForRentExemption(65536+12),space:65536+12,programId:t.programId}),Tm({programId:t.programId,marketInfo:{id:t.id.publicKey,requestQueue:t.requestQueue.publicKey,eventQueue:t.eventQueue.publicKey,bids:t.bids.publicKey,asks:t.asks.publicKey,baseVault:t.baseVault.publicKey,quoteVault:t.quoteVault.publicKey,baseMint:t.baseMint,quoteMint:t.quoteMint,baseLotSize:t.baseLotSize,quoteLotSize:t.quoteLotSize,feeRateBps:t.feeRateBps,vaultSignerNonce:t.vaultSignerNonce,quoteDustThreshold:t.quoteDustThreshold}})),[{transaction:n,signer:[],instructionTypes:[_.CreateAccount,_.CreateAccount,_.InitAccount,_.InitAccount]},{transaction:o,signer:[],instructionTypes:[_.CreateAccount,_.CreateAccount,_.CreateAccount,_.CreateAccount,_.CreateAccount,_.InitMarket]}]}var Tn=class extends Te{async create({baseInfo:e,quoteInfo:t,lotSize:n,tickSize:i,dexProgramId:o,txVersion:s,computeBudgetConfig:a}){let u=this.scope.ownerPubKey,c=We({fromPublicKey:u,programId:o}),l=We({fromPublicKey:u,programId:o}),m=We({fromPublicKey:u,programId:o}),p=We({fromPublicKey:u,programId:o}),d=We({fromPublicKey:u,programId:o}),y=We({fromPublicKey:u,programId:Ua}),f=We({fromPublicKey:u,programId:Ua}),b=0,w=new lr(100);function h(){let L=new lr(0);for(;;)try{return{vaultOwner:Co.createProgramAddressSync([c.publicKey.toBuffer(),L.toArrayLike(Buffer,"le",8)],o),vaultSignerNonce:L}}catch{if(L.iaddn(1),L.gt(new lr(25555)))throw Error("find vault owner error")}}let{vaultOwner:A,vaultSignerNonce:P}=h(),T=new lr(Math.round(10**e.decimals*n)),I=new lr(Math.round(n*10**t.decimals*i));if(T.eq(je))throw Error("lot size is too small");if(I.eq(je))throw Error("tick size or lot size is too small");let x=await qa({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:o,id:c,baseMint:e.mint,quoteMint:t.mint,baseVault:y,quoteVault:f,vaultOwner:A,requestQueue:l,eventQueue:m,bids:p,asks:d,feeRateBps:b,quoteDustThreshold:w,vaultSignerNonce:P,baseLotSize:T,quoteLotSize:I}}),O=this.createTxBuilder();O.addCustomComputeBudget(a),O.addInstruction({instructions:x[0].transaction.instructions,signers:x[0].signer});let N=[];for await(let L of x.slice(1,x.length)){let E=this.createTxBuilder();E.addCustomComputeBudget(a),E.addInstruction({instructions:L.transaction.instructions,signers:L.signer,instructionTypes:L.instructionTypes});let Z=await E.versionBuild({txVersion:s});N.push(Z)}return O.versionMultiBuild({extraPreBuildData:N,extInfo:{address:{marketId:c.publicKey,requestQueue:l.publicKey,eventQueue:m.publicKey,bids:p.publicKey,asks:d.publicKey,baseVault:y.publicKey,quoteVault:f.publicKey,baseMint:new Co(e.mint),quoteMin:new Co(t.mint)}},txVersion:s})}};import{PublicKey as dr}from"@solana/web3.js";import{PublicKey as Im,TransactionInstruction as Lo,SYSVAR_CLOCK_PUBKEY as xm}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Oo}from"@solana/spl-token";var Ro=R([V("instruction"),Is("amount")]),mr=R([V("instruction")]);function _T({programId:r,amount:e,instructionKeys:t}){let n=[{pubkey:new Im("11111111111111111111111111111111"),isSigner:!1,isWritable:!1},{pubkey:Oo,isSigner:!1,isWritable:!1},{pubkey:rt,isSigner:!1,isWritable:!1},{pubkey:yi,isSigner:!1,isWritable:!1},...Object.entries(t).map(([o,s])=>({pubkey:s,isSigner:o==="userOwner",isWritable:!["authority","userOwner","userIdoCheck","userStakeInfo"].includes(o)}))],i=Buffer.alloc(Ro.span);return Ro.encode({instruction:1,amount:Number(e)},i),new Lo({keys:n,programId:r,data:i})}function ti({programId:r},e){let t=[{pubkey:Oo,isSigner:!1,isWritable:!1},{pubkey:yi,isSigner:!1,isWritable:!1},...Object.entries(e).map(([i,o])=>({pubkey:o,isSigner:i==="userOwner",isWritable:!["authority","userOwner"].includes(i)}))],n=Buffer.alloc(mr.span);return mr.encode({instruction:2},n),new Lo({keys:t,programId:r,data:n})}function No(r){let{poolConfig:e,userKeys:t,side:n}=r,i=n==="base"?t.baseTokenAccount:t.quoteTokenAccount,o=n==="base"?e.baseVault:e.quoteVault,s=Buffer.alloc(mr.span);mr.encode({instruction:2},s);let a=[{pubkey:Oo,isWritable:!1,isSigner:!1},{pubkey:xm,isWritable:!1,isSigner:!1},{pubkey:e.id,isWritable:!0,isSigner:!1},{pubkey:e.authority,isWritable:!1,isSigner:!1},{pubkey:o,isWritable:!0,isSigner:!1},{pubkey:i,isWritable:!0,isSigner:!1},{pubkey:t.ledgerAccount,isWritable:!0,isSigner:!1},{pubkey:t.owner,isWritable:!1,isSigner:!0}];return new Lo({programId:e.programId,keys:a,data:s})}import Ga from"bn.js";var Bm={[Wn.IDO_PROGRAM_ID_V1.toString()]:1,[Wn.IDO_PROGRAM_ID_V2.toString()]:2,[Wn.IDO_PROGRAM_ID_V3.toString()]:3,[Wn.IDO_PROGRAM_ID_V4.toString()]:4},In=class extends Te{async claim({ownerInfo:e,idoKeys:t,associatedOnly:n=!0,checkCreateATAOwner:i=!1,txVersion:o}){let s=this.createTxBuilder(),a=Bm[t.programId];a||this.logAndCreateError("invalid version",a);let u=pe(t),[c,l]=[!new Ga(e.coin).isZero(),!new Ga(e.pc).isZero()],m=u.projectInfo.mint.address.equals($),{account:p,instructionParams:d}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.projectInfo.mint.programId,mint:u.projectInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!m,notUseTokenAccount:m,associatedOnly:m?!1:n,checkCreateATAOwner:i});!p&&c&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),c&&d&&s.addInstruction(d);let y=u.buyInfo.mint.address.equals($),{account:f,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.buyInfo.mint.programId,mint:u.buyInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!y,notUseTokenAccount:y,associatedOnly:y?!1:n,checkCreateATAOwner:i});if(!p&&l&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),l&&b&&s.addInstruction(b),(!p||!f)&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address,t.buyInfo.mint.address),a===3)return s.addInstruction({instructions:[...c?[ti({programId:u.programId},{idoId:u.id,authority:u.authority,poolTokenAccount:u.projectInfo.vault,userTokenAccount:p,userIdoInfo:new dr(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[],...l?[ti({programId:new dr(t.programId)},{idoId:u.id,authority:u.authority,poolTokenAccount:u.buyInfo.vault,userTokenAccount:f,userIdoInfo:new dr(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[]]}).versionBuild({txVersion:o});if(a<3)return!c&&!l&&this.logAndCreateError("no claimable rewards"),s.addInstruction({instructions:[ti({programId:u.programId},{idoId:u.id,authority:u.authority,poolQuoteTokenAccount:u.buyInfo.vault,poolBaseTokenAccount:u.projectInfo.vault,userQuoteTokenAccount:f,userBaseTokenAccount:p,userIdoInfo:new dr(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]}).versionBuild({txVersion:o});let w={poolConfig:{id:u.id,programId:u.programId,authority:u.authority,baseVault:u.projectInfo.vault,quoteVault:u.buyInfo.vault,baseToken:t.projectInfo.mint,quoteToken:t.buyInfo.mint},userKeys:{baseTokenAccount:p,quoteTokenAccount:f,ledgerAccount:new dr(e.userIdoInfo),owner:this.scope.ownerPubKey}};return s.addInstruction({instructions:[...c?[No(D(M({},w),{side:"base"}))]:[],...l?[No(D(M({},w),{side:"quote"}))]:[]]}).versionBuild({txVersion:o})}};import{MintLayout as Sm,TOKEN_2022_PROGRAM_ID as xn,TOKEN_PROGRAM_ID as Mo}from"@solana/spl-token";import Xa from"bn.js";var pr=class extends Te{constructor(t){super(t);this._tokenList=[];this._tokenMap=new Map;this._blackTokenMap=new Map;this._tokenPrice=new Map;this._tokenPriceOrg=new Map;this._tokenPriceFetched={prevCount:0,fetched:0};this._mintGroup={official:new Set,jup:new Set,extra:new Set};this._extraTokenList=[]}async load(t){this.checkDisabled();let{forceUpdate:n=!1,type:i="strict"}=t||{},{mintList:o,blacklist:s}=await this.scope.fetchV3TokenList(n),a=await this.scope.fetchJupTokenList(i,n);this._tokenList=[],this._tokenMap=new Map,this._blackTokenMap=new Map,this._mintGroup={official:new Set,jup:new Set,extra:new Set},this._tokenMap.set(Ge.address,Ge),this._mintGroup.official.add(Ge.address),s.forEach(u=>{this._blackTokenMap.set(u.address,D(M({},u),{priority:-1}))}),o.forEach(u=>{var c;this._blackTokenMap.has(u.address)||(this._tokenMap.set(u.address,D(M({},u),{type:"raydium",priority:2,programId:(c=u.programId)!=null?c:u.tags.includes("token-2022")?xn.toBase58():Mo.toBase58()})),this._mintGroup.official.add(u.address))}),a.forEach(u=>{var c;this._blackTokenMap.has(u.address)||this._tokenMap.has(u.address)||(this._tokenMap.set(u.address,D(M({},u),{type:"jupiter",priority:1,programId:(c=u.programId)!=null?c:u.tags.includes("token-2022")?xn.toBase58():Mo.toBase58()})),this._mintGroup.jup.add(u.address))}),this._extraTokenList.forEach(u=>{this._blackTokenMap.has(u.address)||this._tokenMap.has(u.address)||(this._tokenMap.set(u.address,D(M({},u),{type:"extra",priority:1,programId:u.programId||u.tags.includes("token-2022")?xn.toBase58():Mo.toBase58()})),this._mintGroup.extra.add(u.address))}),this._tokenList=Array.from(this._tokenMap).map(u=>u[1])}get tokenList(){return this._tokenList}get tokenMap(){return this._tokenMap}get blackTokenMap(){return this._blackTokenMap}get mintGroup(){return this._mintGroup}async getChainTokenInfo(t){let n=mn({publicKey:t}),i=n.toBase58(),o=n.toString().substring(0,6);if(n.equals(de))return{token:new ce({decimals:Ge.decimals,name:Ge.name,symbol:Ge.symbol,skipMint:!0,mint:""}),tokenInfo:Ge};let a=await this.scope.api.getTokenInfo(n);if(a){this._mintGroup.extra.add(i);let m=D(M({},a),{priority:2});return this._tokenMap.set(i,m),{token:new ce({mint:n,decimals:a.decimals,symbol:a.symbol||o,name:a.name||o,isToken2022:a.programId===xn.toBase58()}),tokenInfo:m}}let u=await this.scope.connection.getAccountInfo(n);u||this.logAndCreateError("On chain token not found, mint:",n.toBase58());let c=Sm.decode(u.data),l={chainId:101,address:i,programId:u.owner.toBase58(),logoURI:"",symbol:o,name:o,decimals:c.decimals,tags:[],extensions:{},priority:0};return this._tokenMap.has(i)||(this._mintGroup.extra.add(i),this._tokenMap.set(i,l)),{token:new ce({mint:n,decimals:c.decimals,symbol:o,name:o,isToken2022:u.owner.equals(xn)}),tokenInfo:l}}mintToToken(t){let n=mn({publicKey:t}),i=this._tokenMap.get(n.toBase58());i||this.logAndCreateError("token not found, mint:",n.toBase58(),", use getChainTokenInfo to get info instead");let{decimals:o,name:s,symbol:a}=i,u=n.equals(de);return new ce({decimals:o,name:s,symbol:a,skipMint:u,mint:u?"":t,isToken2022:i.programId===xn.toBase58()})}mintToTokenAmount({mint:t,amount:n,decimalDone:i,token:o}){let s=o||this.mintToToken(t);if(i){let a=fn(n),u=hi(new ie(a.numerator,a.denominator));return new ge(s,u)}return new ge(s,this.decimalAmount({mint:t,amount:n,decimalDone:i}))}decimalAmount({mint:t,amount:n,token:i}){let o=fn(n),s=i||this.mintToToken(t);return hi(new ie(o.numerator,o.denominator).mul(new Xa(10**s.decimals)))}uiAmount({mint:t,amount:n,token:i}){let o=fn(n),s=i||this.mintToToken(t);return s?new ie(o.numerator,o.denominator).div(new Xa(10**s.decimals)).toSignificant(s.decimals):""}};var ni=class{constructor(e){this.rawBalances=new Map;let{connection:t,cluster:n,owner:i,api:o,defaultChainTime:s,defaultChainTimeOffset:a,apiCacheTime:u}=e;this._connection=t,this.cluster=n,this._owner=i?new lt(i):void 0,this._signAllTransactions=e.signAllTransactions,this.api=o,this._apiCacheTime=u||5*60*1e3,this.logger=oe("Raydium"),this.farm=new Jn({scope:this,moduleName:"Raydium_Farm"}),this.account=new qn({scope:this,moduleName:"Raydium_Account",tokenAccounts:e.tokenAccounts,tokenAccountRawInfos:e.tokenAccountRawInfos}),this.liquidity=new ar({scope:this,moduleName:"Raydium_LiquidityV2"}),this.token=new pr({scope:this,moduleName:"Raydium_tokenV2"}),this.tradeV2=new cr({scope:this,moduleName:"Raydium_tradeV2"}),this.clmm=new ur({scope:this,moduleName:"Raydium_clmm"}),this.utils1216=new st({scope:this,moduleName:"Raydium_utils1216"}),this.marketV2=new Tn({scope:this,moduleName:"Raydium_marketV2"}),this.ido=new In({scope:this,moduleName:"Raydium_ido"}),this.availability={};let c=new Date().getTime();this.apiData={},a&&(this._chainTime={fetched:c,value:{chainTime:s||Date.now()-a,offset:a}})}static async load(e){let t=Km({cluster:"mainnet",owner:null,apiRequestInterval:3e5,apiRequestTimeout:1e4},e),{cluster:n,apiRequestTimeout:i,logCount:o,logRequests:s,urlConfigs:a}=t,u=new Er({cluster:n,timeout:i,urlConfigs:a,logCount:o,logRequests:s}),c=new ni(D(M({},t),{api:u}));return await c.fetchAvailabilityStatus(e.disableFeatureCheck),await c.token.load({type:e.jupTokenType,fetchTokenPrice:e.preloadTokenPrice}),c}get owner(){return this._owner}get ownerPubKey(){if(!this._owner)throw new Error(Fr);return this._owner.publicKey}setOwner(e){return this._owner=e?new lt(e):void 0,this}get connection(){if(!this._connection)throw new Error(hs);return this._connection}setConnection(e){return this._connection=e,this}get signAllTransactions(){return this._signAllTransactions}setSignAllTransactions(e){return this._signAllTransactions=e,this}checkOwner(){if(!this.owner)throw this.logger.error(Fr),new Error(Fr)}isCacheInvalidate(e){return new Date().getTime()-e>this._apiCacheTime}async fetchChainTime(){try{let e=await this.api.getChainTimeOffset();this._chainTime={fetched:Date.now(),value:{chainTime:Date.now()-e.offset*1e3,offset:e.offset*1e3}}}catch{this._chainTime=void 0}}async fetchV3TokenList(e){if(this.apiData.tokenList&&!this.isCacheInvalidate(this.apiData.tokenList.fetched)&&!e)return this.apiData.tokenList.data;let t=await this.api.getTokenList(),n={fetched:Date.now(),data:t};return this.apiData.tokenList=n,n.data}async fetchJupTokenList(e,t){var o;let n=(o=this.apiData.jupTokenList)==null?void 0:o[e];if(n&&!this.isCacheInvalidate(n.fetched)&&!t)return n.data;let i=await this.api.getJupTokenList(e);return this.apiData.jupTokenList=D(M({},this.apiData.jupTokenList),{[e]:{fetched:Date.now(),data:i}}),this.apiData.jupTokenList[e].data}get chainTimeData(){var e;return(e=this._chainTime)==null?void 0:e.value}async chainTimeOffset(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.offset:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.offset)||0)}async currentBlockChainTime(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.chainTime:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.chainTime)||Date.now())}async fetchEpochInfo(){return this._epochInfo&&Date.now()-this._epochInfo.fetched<=1e3*30?this._epochInfo.value:(this._epochInfo={fetched:Date.now(),value:await this.connection.getEpochInfo()},this._epochInfo.value)}async getChainTokenInfo(e){return this.token.getChainTokenInfo(e)}async fetchAvailabilityStatus(e){if(e)return{};try{let t=await this.api.fetchAvailabilityStatus(),n=t.all===!1;return this.availability={all:t.all,swap:n?!1:t.swap,createConcentratedPosition:n?!1:t.createConcentratedPosition,addConcentratedPosition:n?!1:t.addConcentratedPosition,addStandardPosition:n?!1:t.addStandardPosition,removeConcentratedPosition:n?!1:t.removeConcentratedPosition,removeStandardPosition:n?!1:t.removeStandardPosition,addFarm:n?!1:t.addFarm,removeFarm:n?!1:t.removeFarm},t}catch{return{}}}mintToToken(e){return this.token.mintToToken(e)}mintToTokenAmount(e){return this.token.mintToTokenAmount(e)}solToWsolTokenAmount(e){return e.token.mint.equals(de)?this.token.mintToTokenAmount({mint:$,amount:e.toExact()}):e}solToWsolTransferAmountFee(e){return e.amount.token.mint.equals(de)?{amount:this.token.mintToTokenAmount({mint:$,amount:e.amount.toExact()}),fee:e.fee?this.token.mintToTokenAmount({mint:$,amount:e.fee.toExact()}):e.fee,expirationTime:e.expirationTime}:e}decimalAmount(e){return this.token.decimalAmount(e)}uiAmount(e){return this.token.uiAmount(e)}};var za={[Si.toBase58()]:3},Ya={3:Si};var Cm=R([ke(5),ke(8),B("ownAddress"),g("vaultSignerNonce"),B("baseMint"),B("quoteMint"),B("baseVault"),g("baseDepositsTotal"),g("baseFeesAccrued"),B("quoteVault"),g("quoteDepositsTotal"),g("quoteFeesAccrued"),g("quoteDustThreshold"),B("requestQueue"),B("eventQueue"),B("bids"),B("asks"),g("baseLotSize"),g("quoteLotSize"),g("feeRateBps"),g("referrerRebatesAccrued"),ke(7)]),Qa={3:Cm};import{PublicKey as ja}from"@solana/web3.js";var ri=oe("Serum"),Ha=class{static getProgramId(e){let t=Ya[e];return t||ri.logWithError("invalid version","version",e),t}static getVersion(e){let t=e.toBase58(),n=za[t];return n||ri.logWithError("invalid program id","programId",t),n}static getStateLayout(e){let t=Qa[e];return t||ri.logWithError(!!t,"invalid version","version",e),t}static getLayouts(e){return{state:this.getStateLayout(e)}}static getAssociatedAuthority({programId:e,marketId:t}){let n=[t.toBuffer()],i=0,o;for(;i<100;){try{let s=n.concat(Buffer.from([i]),Buffer.alloc(7));o=ja.createProgramAddressSync(s,e)}catch(s){if(s instanceof TypeError)throw s;i++;continue}return{publicKey:o,nonce:i}}return ri.logWithError("unable to find a viable program address nonce","params",{programId:e,marketId:t}),{publicKey:ja.default,nonce:i}}};var fx=r=>r;export{Yl as AMM_CONFIG_SEED,KA as AmmConfigLayout,ka as BIT_PRECISION,ur as Clmm,Pe as ClmmInstrument,Ol as DataElement,go as EXTENSION_TICKARRAY_BITMAP_SIZE,Gs as FARM_LOCK_MINT,Xs as FARM_LOCK_VAULT,pt as FARM_PROGRAM_TO_VERSION,Ys as FARM_VERSION_TO_LEDGER_LAYOUT,zs as FARM_VERSION_TO_STATE_LAYOUT,$r as FEE_RATE_DENOMINATOR,tm as FETCH_TICKARRAY_COUNT,em as Fee,jA as LIQUIDITY_FEES_DENOMINATOR,QA as LIQUIDITY_FEES_NUMERATOR,um as LIQUIDITY_VERSION_TO_SERUM_VERSION,Dw as LIQUIDITY_VERSION_TO_STATE_LAYOUT,Aa as LOG_B_2_X32,ha as LOG_B_P_ERR_MARGIN_LOWER_X64,Pa as LOG_B_P_ERR_MARGIN_UPPER_X64,se as LiquidityMath,Ko as MARKET_STATE_LAYOUT_V2,Cm as MARKET_STATE_LAYOUT_V3,Qa as MARKET_VERSION_TO_STATE_LAYOUT,It as MAX_SQRT_PRICE_X64,Ye as MAX_TICK,Tt as MIN_SQRT_PRICE_X64,qe as MIN_TICK,hn as MODEL_DATA_PUBKEY,Ha as Market,H as MathUtil,bo as MaxU64,wa as MaxUint128,Nt as NEGATIVE_ONE,De as ONE,Jl as OPERATION_SEED,ko as ObservationInfoLayout,im as ObservationLayout,Sa as OperationLayout,Hl as POOL_REWARD_VAULT_SEED,Ql as POOL_SEED,$l as POOL_TICK_ARRAY_BITMAP_SEED,jl as POOL_VAULT_SEED,ya as POSITION_SEED,CA as PoolInfoLayout,Ve as PoolUtils,xa as PositionInfoLayout,sm as PositionRewardInfoLayout,or as PositionUtils,RA as ProtocolPositionLayout,Jr as Q128,nt as Q64,ni as Raydium,om as RewardInfo,za as SERUM_PROGRAMID_TO_VERSION,Ya as SERUM_VERSION_TO_PROGRAMID,Ge as SOL_INFO,kw as SPL_MINT_LAYOUT,j as SqrtPriceMath,jr as StableLayout,on as SwapMath,rn as TICK_ARRAY_BITMAP_SIZE,Zl as TICK_ARRAY_SEED,Ke as TICK_ARRAY_SIZE,gk as TICK_SPACINGS,Se as TOKEN_WSOL,Mt as TickArrayBitmap,Ba as TickArrayBitmapExtensionLayout,ir as TickArrayBitmapExtensionUtils,rr as TickArrayLayout,am as TickLayout,sn as TickMath,ae as TickQuery,q as TickUtils,nr as U64Resolution,kk as U64_IGNORE_RANGE,qs as Voter,dl as VoterDepositEntry,ml as VoterLockup,Ds as VoterRegistrar,ll as VoterVotingMintConfig,me as ZERO,ao as addLiquidityLayout,Di as associatedLedgerAccountLayout,eo as calFarmRewardAmount,mr as claimLayout,Lt as closeAccountInstruction,Hs as createAssociatedLedgerAccountInstruction,ia as createPoolFeeLayout,ca as createPoolV4InstructionV2,Ww as createPoolV4Layout,kt as createWSolAccountInstructions,ze as dwLayout,Xi as farmAddRewardLayout,ig as farmLedgerLayoutV3_1,Gn as farmLedgerLayoutV3_2,og as farmLedgerLayoutV5_1,vs as farmLedgerLayoutV5_2,Ws as farmLedgerLayoutV6_1,js as farmRewardInfoToConfig,Ui as farmRewardLayout,Gi as farmRewardRestartLayout,cl as farmRewardTimeInfoLayout,Es as farmStateV3Layout,Fs as farmStateV5Layout,Un as farmStateV6Layout,Rg as fetchMultipleFarmInfoAndUpdate,uh as fetchMultipleInfo,io as fixedSwapInLayout,oo as fixedSwapOutLayout,ql as formatLayout,We as generatePubKey,Qs as getAssociatedAuthority,Po as getAssociatedConfigId,Je as getAssociatedLedgerAccount,zn as getAssociatedLedgerPoolAccount,dm as getAssociatedOpenOrders,Na as getAssociatedPoolKeys,to as getDepositEntryIndex,Yw as getDxByDyBaseIn,zw as getDyByDxBaseIn,Yr as getFarmLedgerLayout,pl as getFarmStateLayout,pm as getLiquidityAssociatedAuthority,an as getLiquidityAssociatedId,iA as getLiquidityFromAmounts,fk as getPdaAmmConfigId,ht as getPdaExBitmapAccount,Zr as getPdaMetadataKey,tr as getPdaOperationAccount,At as getPdaPersonalPositionAddress,ba as getPdaPoolId,ga as getPdaPoolRewardVaulId,yo as getPdaPoolVaultId,nn as getPdaProtocolPositionAddress,ye as getPdaTickArrayAddress,Qi as getRegistrarAddress,Qw as getStablePrice,$i as getTokenOwnerRecordAddress,Zi as getVoterAddress,Ji as getVoterWeightRecordAddress,Hi as getVotingMintAuthority,ji as getVotingTokenMint,Pl as governanceCreateTokenOwnerRecord,ck as i16ToBytes,Hr as i32ToBytes,so as initPoolLayout,vi as initTokenAccountInstruction,Tm as initializeMarket,zi as isValidFarmVersion,er as isZero,Lg as judgeFarmType,po as leadingZeros,fa as leastSignificantBit,Cl as liquidityStateV4Layout,Rl as liquidityStateV5Layout,la as makeAMMSwapInstruction,ua as makeAddLiquidityInstruction,ro as makeAddNewRewardInstruction,ti as makeClaimInstruction,No as makeClaimInstructionV4,Zs as makeCreateFarmInstruction,qa as makeCreateMarketInstruction,Js as makeCreatorWithdrawFarmRewardInstruction,$s as makeDepositInstructionV3,ea as makeDepositInstructionV5,ta as makeDepositInstructionV6,Qg as makeDepositTokenInstruction,Hg as makeDepositWithdrawInstruction,ak as makeInitPoolInstructionV4,_T as makePurchaseInstruction,no as makeRestartRewardInstruction,ma as makeSimulatePoolInfoInstruction,Xl as makeSwapFixedInInstruction,zl as makeSwapFixedOutInstruction,Ea as makeSwapInstruction,Dn as makeTransferInstruction,Zn as makeWithdrawInstructionV3,Hn as makeWithdrawInstructionV5,jn as makeWithdrawInstructionV6,jg as makeWithdrawTokenInstruction,wk as mockCreatePoolInfo,Ta as mockV3CreatePoolInfo,Nl as modelDataInfoLayout,pa as mostSignificantBit,Vs as parseTokenAccountResp,Sw as parseTokenInfo,zt as poolTypeV6,Ro as purchaseLayout,sl as realFarmStateV3Layout,al as realFarmStateV5Layout,ul as realFarmV6Layout,mo as removeLiquidityInstruction,uo as removeLiquidityLayout,SP as route1Instruction,KP as route2Instruction,fm as routeInstruction,sk as simulatePoolInfoInstruction,Rw as solToWSolToken,qt as splAccountLayout,ra as toToken,Cw as toTokenAmount,Kw as toTokenInfo,fo as trailingZeros,da as u16ToBytes,lk as u32ToBytes,fx as unionArr,fl as updateFarmPoolInfo,Yi as validateFarmRewards,Il as voterStakeRegistryCreateDepositEntry,Tl as voterStakeRegistryCreateVoter,kl as voterStakeRegistryDeposit,Al as voterStakeRegistryUpdateVoterWeightRecord,hl as voterStakeRegistryWithdraw,Lw as wSolToSolToken,qi as withdrawRewardLayout};
/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */
//# sourceMappingURL=index.mjs.map